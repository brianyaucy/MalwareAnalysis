# Lab 09 - Working with DLLs and DLL Injections

- [Lab 09 - Working with DLLs and DLL Injections](#lab-09---working-with-dlls-and-dll-injections)
  - [Scenario](#scenario)
  - [Tools](#tools)
  - [Task 1: Basic DLL Analysis](#task-1-basic-dll-analysis)
    - [Welcome3.dll](#welcome3dll)
      - [Static Analysis](#static-analysis)
      - [Dynamic Analysis](#dynamic-analysis)
  - [Task 2: Analyzing a malicious DLL](#task-2-analyzing-a-malicious-dll)
    - [Static Analysis using CFF Explorer](#static-analysis-using-cff-explorer)
    - [Dynamic Analysis](#dynamic-analysis-1)
  - [Task 3: DLL Injection](#task-3-dll-injection)
  - [Task 4: Use IOCs to scan the memory](#task-4-use-iocs-to-scan-the-memory)

---

## Scenario

You have been called by a client to examine a couple of weird samples (DLLs) that were found on some of their systems. The network security engineers noticed weird connection activity to the device that some of these samples were found on.

<br/>

The goal of this lab is to understand how to run a DLL, analyze a DLL and how we could use basic techniques to detect DLL Injections by checking the processâ€™s memory. In this lab, we will focus on an injection known as "Reflective DLL Injection (RDI)". Please check the course material for more information about RDI.

After completing this lab, you will be able to analyze suspicious DLLs using basic dynamic analysis techniques using tools such as RunDLL32, Process Explorer, Process Monitor, VMMap, AptDNS, and Wireshark.

<br/>

64-bit - 192.168.210.10 / AdminELS / Nu3pmkfyX
32-bit - 192.168.210.11 / AdminELS / pippo123!

<br/>

---

## Tools

- Microsoft RunDLL32 
- Sysinternals Process Explorer (procexp.exe) 
- Sysinternals Process Monitor (procmon.exe) 
- Sysinternals VMMap 
- Sysinternals ListDLLs 
- AptDNS 
- Yara 
- Wireshark

<br/>

---

## Task 1: Basic DLL Analysis

**Question**

Analyze the given DLL sample and understand what it is doing. This is a non-malicious sample, so use it to explain how you would approach DLL analysis and how you can run and list it being loaded by a process.

<br/>

**Answer**

### Welcome3.dll

#### Static Analysis

Use **CFFExplorer** to open `Welcome3.dll`. First check the charactertics of the file in the **File Header**

![picture 183](images/468ee8a286c34a18a192d9444f6721c4561a520e0b36cc8468da8ad3b16fe0db.png)  

- Executable
- DLL
- 32-bit

<br/>

Checking the **Export Directory**, we can see 3 API entries:

![picture 184](images/f2e6bc99edd02113c8c6f5651c76d610f81152a19016c4dbbf81e4475afee32a.png)  

- `_DllMain@12`
- `_messageBoxThread@4`
- `loadme`

- `_DllMain@12` is usually added by **MSCRVT**, which is not worth looking into it

<br/>

For DLLs, we can write program to call and use them; we can also use a default windows program `RunDLL32` to run them as well.

<br/>

#### Dynamic Analysis

Open **Process Monitor** (as admin) first, and use the filter `ProcessName = rundll32.exe`.

Also open **Process Explorer**

![picture 185](images/9c232e49fed4cda85d2343d3f52b0b1b7f597e0d3bca424a436a6a6fbf16bf41.png)  

<br/>

Run `cmd.exe` as admin, and use `rundll32.exe` to run to sample:

```
cd C:\Users\AdminELS\Desktop\Lab_09_Samples\Lab_09_Samples
rundll32.exe Welcome3.dll,loadme
```

![picture 186](images/896a65bb48db9fe08cea4d0389f15cb69113ed0e728a8b2626410a24faacf382.png)  

- It shows a message box - highly likely to be related to another API `_messageBoxThread@4`

<br/>

In **Process Explorer**, click **View > Show Lower Pane** and **View > Lower Pane View > DLL**. Then find and click the process `rundll32.exe > rundll32.exe`:

![picture 187](images/12ce9430f7d0e9402a9d2d0bee42c95839ce2f108629c6db4f757e1160f2ba51.png)  

- All of the libraries loaded are shown

<br/>

In **Process Monitor**, we can see the operation `Load Image` as well:

![picture 188](images/3a7d83ead74fc178af1b00b292061292dfe2e71beb5314efd1a43b61ccf6b341.png)  

<br/>

We can also use **listdlls.exe** from Sysinternals to inspect the DLLs that are currently loaded by `rundll32.exe`:

```
listdlls.exe rundll32.exe
```

![picture 189](images/069aed5a0c38de5e735e703c97a8720c4b9491c46c63eac326cfbec9b728aa8c.png)  

![picture 190](images/1b2c24105b3312a0db9b1c4348786e440c7c454976d45e14bc8ff12d1d32f521.png)  

- Command Line
- The base where the DLL is loaded
- The size of the DLL
- The path where the DLL is located in the system

<br/>

Also, we may use the `PID` to show the dlls loaded and list DLLs that are not signed by Microsoft:

```
listdlls.exe -u 7376
```

![picture 191](images/7d55aa40d89735b0aeee0fdb950436776447bef9176b4afd839b7ae5ad5687fb.png)  

<br/>

---

## Task 2: Analyzing a malicious DLL

**Question**

A malicious DLL sample was collected, and you are required to analyze it and provide as much information to what activity it is doing.

<br/>

**Answer**

### Static Analysis using CFF Explorer

Open `Downloader.exe` in CFF Explorer.

![picture 192](images/5ed63c2cc44886813599fae7aaeb056f5e498107db484e598cf5fa885ca8961c.png)  

<br/>

Inspect the **Export Directory**:

![picture 193](images/e961b449bf05d643a5028a60672fc6b0cbc2b585c7149d72798c91c8e328d4df.png)  

- Two APIs are found:
  - `_ThreadProc@4`
  - `loadme`

<br/>

Also inspect the **Import Directory** to see the libraries that the DLL uses:

![picture 194](images/ce222762d9bdbcdf63a747da626e4fab3fb7ec493bbd25779ffdbb5b1ec22373.png)  

- kernel32.dll
- urlmon.dll
  - https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85)
  - One of the functions is to download files

![picture 195](images/4f53910a4b0934daa7ed0b6654911955d039e8f7cb74e4aed7a05a0295056a5a.png)  

<br/>

### Dynamic Analysis

Open (as admin) **Process Explorer** and **Process Monitor** (filter out `rundll32.exe`). Then run the sample in `cmd.exe` (privileged):

```
rundll32.exe Downloader.dll,loadme
```

![picture 196](images/4c7e855b569c0e937a1e6dab4fcd0819697c4554ae97ae81c9beebfe4120296f.png)  

- Nothing obvious is shown in the user perspective

<br/>

In **Procmon**, filter out `Operation is Process Create`:

![picture 197](images/600548c58acb29f9fc98f5dee5b834079b8efbd24f70fe84e0ed2dcb7d0d76d3.png)  

![picture 199](images/43f918ff491b80b371e1541fd62e37fce5c7db4cb9bab8a1f83547661691de4b.png)  

- `C:\Windows\SysWOW64\rundll32.exe`, the fact that it is using the version in `SysWOW64` is that the DLL is a 32-bit one. That's why Windows will use WoW64 (Win32 on Win64).

<br/>

Filter out `Operation is Load Image`:

![picture 200](images/b60fd5f1b6385c0a4595cdb673ee8ef0543ed9bac8e9eb82f8c48ee96032d43d.png)  

![picture 201](images/00915108da0779a551900c245441d788266bdc3b52ec2be914f3e5808587be30.png)  

- The sample loaded `urlmon.dll` - which can be used to download file

<br/>

Open Wireshark and track the HTTP and DNS traffic - re-run the sample:

- HTTP:

![picture 202](images/65512085d4af4ab9fad07a1e48f461157cc6c271e0046bee0f59ceb1136ae332.png)  

- DNS:

![picture 203](images/9b8fff624616314025147c45878fcd6ad398d3501048256f41901dcf0cb3d5ad.png)  

- Found DNS query `www.elsmap.com`

<br/>

Create the `FileCreate` operations in **Procmon**:

![picture 204](images/bd430f3a337a7dc2274688820d925d0bcf4ae2d85c7f29c86015706fe7480120.png)  

- `C:\User\AdminELS\Desktop\Lab_09_Samples\Lab_09_Samples\runme.exe` has been created

<br/>

Open it in **CFF EXplorer**:

![picture 205](images/510d0778727fff2231d262465cde0d5451431e9d67dfd617864230a5cfe15901.png)  

- MD5: `321319BEEA18860C5A6E8DB15525A0EC`
- It is in fact not a PE

Open it in **BinText**, it is a HTML document:

![picture 206](images/7bc5c73824dff5c45b8fe06b27b61dbe8e2145a7482a81f6977d0c50d0e18f2a.png)  

<br/>

![picture 207](images/3d8f0aea91ab717d564aacdba225087b0c0aa1650126e4de51823d7cfc61a7e1.png)  


<br/>

---

## Task 3: DLL Injection

**Question**

You are required to perform DLL injection and show why we cannot use the techniques we have seen in both tasks 1 and 2 with this sample. 

Also, show an easy way of finding the injected DLL by looking at memory (no memory forensics are required at this point).

<br/>

**Answer**

> Reflective DLL injection creates a DLL that can map itself into memory for execution instead of relying on the Windows loader.

<br/>

**Answer**

Open `rdi64.dll` in **PE Studio**:

![picture 210](images/431dc088468702d10a3047befbfcbc149c4fccaa2a26d59a6af789e56206e1ce.png)  


- MD5: `7733CE3F656238816E347E4291D0CC36`

<br/>

Inspect the strings:

![picture 208](images/4a56d3e58309a559ee3794c8c07a49f3bf34d8c140ad635b04c65ed6dcea0ae2.png)  

- Interesting strings:
  - `MAP DLL Injection`
  - `Hello from Injected DLL!`

<br/>

Export:

![picture 209](images/68eb8e7c1d8a96288ef161734517cd58307def1cc9a02f8fd6edadc67f720fae.png)  

- ReflectiveLoader

<br/>

Download `inject.x64.exe` from https://www.pconlife.com/download/otherfile/287999/dbda80da592b526568e2642ee52ed37b/.

<br/>

First run an instance of `notepad.exe` and check the PID in **Process Explorer**:

![picture 211](images/e9ce452f5a8b0a7616a5d92808b87c1bab0eb2108cee16ee755e990413b760b1.png)  

- PID: 2488

<br/>

Next, try to inject the DLL `rdi64.dll`:

```
inject.x64.exe 2488 rdi64.dll
```

![picture 212](images/0dbe3c0933c96bcbe91f4537508cca0f7d6864d19e08d6ea9a351ceff9f961a2.png)  

- As shown, message box appears - the DLL is injected into the notepad process successfully

In **Process Explorer**, `rdi64.dll` is not shown:

![picture 213](images/9a0dce714afbb6394147cc54371ab30653b453d6f68b3e0888d384f03f6839d4.png)  

<br/>

If we look for the appeared string `Hello` in **Process Explorer** strings tab, we cannot find it neither in Image nor Memory:

![picture 214](images/b8440841b3180e139bb1c4889fc441281d06a7b1455c31ed2a9cd1e49c360bf4.png)  

![picture 215](images/a62872d4d75a0c3e7a383fcc809da922ed2cef8581e58d99be0cab3ad7b68818.png)  

<br/>




<br/>

---

## Task 4: Use IOCs to scan the memory

**Question**

Determine the IOCs you could prepare to help detect all three samples used in this lab and show how to use Yara to scan memory for them.

<br/>