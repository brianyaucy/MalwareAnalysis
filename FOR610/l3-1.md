# Lab 3.1: Examining Network Traffic to Understand Web Infection Components

- [Lab 3.1: Examining Network Traffic to Understand Web Infection Components](#lab-31-examining-network-traffic-to-understand-web-infection-components)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1,2 - Use Fiddler to locate the malicious code served](#12---use-fiddler-to-locate-the-malicious-code-served)
  - [3 - Locate obfuscated JavaScript in response to the first requested that the victim's browser made](#3---locate-obfuscated-javascript-in-response-to-the-first-requested-that-the-victims-browser-made)
  - [4 - Locate the response that serves a Flash file](#4---locate-the-response-that-serves-a-flash-file)
  - [5 - Locate the requests for a JPEG image that received a non-image response](#5---locate-the-requests-for-a-jpeg-image-that-received-a-non-image-response)
  - [6,7 - Load session.pcap in Wireshark on the Windows REM Workstation and find suspicious traffic associated with 195.154.122.33](#67---load-sessionpcap-in-wireshark-on-the-windows-rem-workstation-and-find-suspicious-traffic-associated-with-19515412233)
  - [8 - Use CapTipper to extract files from session.pcap, and locate the suspicious Flash program](#8---use-captipper-to-extract-files-from-sessionpcap-and-locate-the-suspicious-flash-program)

---

## Objectives

- Learn how to gain visibility into the nature of a web‐based attack by examining network traffic artifacts associated with an exploit kit.
-  Become familiar with web traffic analysis capabilities of Fiddler and CapTipper.

<br/>

---

## Steps

1. Load `session‐fiddler.saz` in **Fiddler** on the Windows REM Workstation.
2. Using **Fiddler**, locate the malicious code served by `www.hiltongardeninnoakville.com`.
3. Locate obfuscated JavaScript in response to the first request that the victim's browser made to `my.georgethorpebourbon.com`.
4. Locate the response that serves a Flash file to the victim's browser.
5. Locate the requests for a JPEG image that received a non‐image response.
6. Load `session.pcap` in **Wireshark** on the **Windows REM Workstation**.
7. Using **Wireshark**, examine suspicious traffic associated with `195.154.122.33`.
8. Use **CapTipper** on **REMnux** to extract files from `session.pcap`, and then locate the
suspicious Flash program.

<br/>

---

## 1,2 - Use Fiddler to locate the malicious code served

Double click on `session-fiddler.saz` to load the session file:

![picture 193](../images/b43d8d6b2460da267fcd0a049396c775aa4e9865118f8915ecc6f116187763ee.png)  

- Traffic #3 is a 301 (redirect)
- Traffic #4 show the root page of the website

<br/>

Click on traffic #4 and go to the **Textview**:

![picture 195](../images/6b0a1d1f3e3e0b095d2c07cf850969b546741c1e29e5eb72fd6b0f35f0644ddc.png)  

- Click `View in Notepad`

<br/>

There is a suspicious `<script>` block located at the end of the document:

![picture 196](../images/21608b74223f74e04766319cefeccc1edf3d727a6083592d0b30fd5d89880273.png)  

<br/>

---

## 3 - Locate obfuscated JavaScript in response to the first requested that the victim's browser made

Scroll down the traffic entries, the 1st traffic to `my.georgethorpebourbon.com` is located in #78:

![picture 197](../images/229f2bef7fc1f025799496599224fd887e6e2bf1eccdecd0d1e2507d22c7eda3.png)  

- As shown the content is an obfuscated javascript file.

<br/>

---

## 4 - Locate the response that serves a Flash file

Note in the leftmost of the traffic entries, the icon shows the response content type:

![picture 198](../images/888f2ff1a9d307bd723fb481c0c597d93f1db37e611f24588b0bee4ce41a1702.png)  

- The flash file is found in #85

<br/>

Note that we can export the response file and save it locally:

![picture 200](../images/28a2d21f107496b767ede2933d0069f6f8ff50e3a9ab1d36b1150856ae58c5fb.png)  

<br/>

---

## 5 - Locate the requests for a JPEG image that received a non-image response

Note there are requests to `195.154.122.33/default.jpg` - however, the response is simply `default` in plaintext:

![picture 199](../images/5c11330f5045296aef0f8f05b0889c908d939eeeea10472db42520fecddfdad8.png)  

<br/>

---

## 6,7 - Load session.pcap in Wireshark on the Windows REM Workstation and find suspicious traffic associated with 195.154.122.33

Double click the PCAP to launch **Wireshark**. Use the filter `ip.addr == 195.154.122.33 and http` to filter out the related traffic:

![picture 203](../images/7400d3684c45be5b34e721624ad31509353e088be018b8e813669491809e3e83.png)  
 
- In addition to `/default.jpg` found in **Fiddler**, we find `POST /setting/get_setting.php` as well

<br/>

Follow HTTP Stream to inspect the traffic:

![picture 204](../images/c331843a0b85e128ce71cff2ab431e951f5c8084a94f640159cff11896173be7.png)  

![picture 205](../images/bb5e75a9c2b59936023f5abc0f07c0585b085af52621034dc6a8b06afc1fd00d.png)  

- The POST traffic contains 2 parameters:
  - `idn`: look like an identifier
  - `key`: could be related to ransomware / encryption key

<br/>

---

## 8 - Use CapTipper to extract files from session.pcap, and locate the suspicious Flash program

On **REMnux**, execute the following commands:

```
cd ~/malware/day3
unzip session.zip -d session
cd session
mkdir out
/opt/remnux-captipper/CapTipper.py -g -d ./out ./session.pcap
```

![picture 206](../images/f8bdaed2fc23bd24b9cd1cf0850fc1167986e0cdd218a16eb9ffa72906df9eed.png)  

<br/>

To check the output file type and filter out Flash file, we can do:

```
file ./out/* | grep Flash
```

![picture 207](../images/cfcc91772fd268ae19e73e7275562e8c002b57062ee0810ddd533bd920f1e531.png)  

<br/>

We can also run the following command to generate a report:

```
cd /opt/remnux-captipper; mkdir /tmp/out; ./CapTipper.py -g -r /tmp/out ~/malware/day3/session/session.pcap
```

![picture 208](../images/504b8e16ca429fc1d996281ec3b1b41378e29dfbd6eda021efe6081a76a1d1d5.png)  


<br/>

View the report:

```
firefox /tmp/out/session.html
```

![picture 210](../images/fbdcfc34252ebe517b2ea5f816672184b81bb4bf1d8688140fba90760a257a4b.png)  


![picture 209](../images/671c4c7b24b5120c4cf7bf5bc1919eaafe5862dfe4ec449fd7909a98f83d3802.png)  

<br/>

---