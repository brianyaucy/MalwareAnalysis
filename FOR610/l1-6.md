# Ex 1.6: Intercepting HTTPS Connections Initiated by ghyte.exe

- [Ex 1.6: Intercepting HTTPS Connections Initiated by ghyte.exe](#ex-16-intercepting-https-connections-initiated-by-ghyteexe)
  - [Objective](#objective)
  - [Steps](#steps)
  - [0 - Static Analysis](#0---static-analysis)
  - [1,2 - Observe DNS traffic of ghyte.exe](#12---observe-dns-traffic-of-ghyteexe)
  - [3 - Activate **INetSim** on **REMnux**, and then reinfect the Windows REM Workstation with ghyte.exe](#3---activate-inetsim-on-remnux-and-then-reinfect-the-windows-rem-workstation-with-ghyteexe)
  - [4 - Analyze INetSim logs](#4---analyze-inetsim-logs)
  - [5 - Use Fiddler to inspect the traffic](#5---use-fiddler-to-inspect-the-traffic)

---

## Objective

- Learn how to intercept and examine HTTPS connections initiated by malware in the lab.

<br/>

----

## Steps

1. Launch **Wireshark** and **fakedns** on **REMnux**, and then infect the **Windows REM Workstation** virtual machine with `ghyte.exe`, observing DNS traffic in the lab.
2. Terminate `ghyte.exe` on the **REM Workstation** and stop monitoring in **Wireshark**.
3. Activate **INetSim** on **REMnux**, and then reinfect the Windows REM Workstation with `ghyte.exe`.
4. Observe the malicious network traffic by looking at the **INetSim** log, and then terminate `ghyte.exe`.

<br/>

---

## 0 - Static Analysis

The executable itself uses PDF icon to mislead the user. By combining this with **double extensions** technique, normal users would fall into trap.

![picture 55](../images/eb18722e690f0d02ee0bb98418a9e4cdc909f88345c78cdea7bf1f35b5b815c0.png)  

<br/>

Use **PEStudio** to open the executable:

![picture 56](../images/e408fe0cdf598819b181c0735b3a901d7ffb149d8c63451ee1643c2cd32109e3.png)  

- Hashes:

```
md5,E9699457FFC92C1B1C0B26588B2FAB56
sha1,76B843F5789E19508680FB64FE287FCD242A7286
sha256,A59B2CB9F6C706635B4D97EDC574A72AC54FBA47F9A4A1EAE77CF58A96CCF567
```

- First bytes = `MZ`, which is likely a PE

<br/>

No interesting string is found.

<br/>

---

## 1,2 - Observe DNS traffic of ghyte.exe

With **fakedns** and **Wireshark** capturing running on **REMnux**, run `ghyte.exe` on the Windows machine:

![picture 57](../images/2733d7c7f8667a88b9eb5ac6989e9f136b8745e686557b27c8ebbc682ccdf450.png)  

- It launches a child process but it exits quickly
- The sample itself disappears from the executed location

<br/>

On **fakedns**:

![picture 58](../images/b851bb34900107add8227bcd6b7d67a3518dfd8eaf8f8172f18792f25e8d2e8a.png)  

- A suspicious DNS request with the domain name `talonstamed.com` is observed

<br/>

On **Wireshark**:

![picture 59](../images/1d8d73163b2fa66d48bdc1f86bd9f3a1cf478b3d3e994a9b4fad4d11608411b6.png)  

- It requests to `tcp/443` - the server respond `RST,ACK` since it is not listening on `tcp/443`

<br/>

Terminate the `ghyte.exe` process on **Process Hacker** and stop **Wireshark** capturing on **REMnux**.

---

## 3 - Activate **INetSim** on **REMnux**, and then reinfect the Windows REM Workstation with ghyte.exe

On **Remnux**, run the following command to run **INetSim**:

```
inetsim
```

![picture 60](../images/404e425527c8cdcde210566765a2ad6d56884a3f1753f8e7c2294b1ef751959f.png)  

- Note: The configuration file is at `/etc/inetsim/inetsim.conf`

<br/>

Also restart **Wireshark** capturing. Then re-infect the Windows machine with `ghyte.exe`:

![picture 61](../images/0fe451aaf01d087649cb78f824f5ced8ff4ba4eba9d57be49ec1a37012157f19.png)  

![picture 62](../images/6dd6ff1df973be7356b5e3e860c79f6767a949e88cf5f9587e8655d6c13c178a.png)  

- A message box showing **INetSim** appears on the Windows box. In fact this is the signature when the client requests an EXE file to **INetSim** and the client executes it.
- On **Wireshark**, we see the full HTTPS connection this time

<br/>

---

## 4 - Analyze INetSim logs

To check the **INetSim** logs:

```
less /var/log/inetsim/service.log 
```

![picture 64](../images/af7f9d12d6923b15d9e4143c25d929648b37347535d4e0b42f5113a73db16cbd.png)  

- The sample requests URL `https://talonstamed.com/images/1m6r.exe` upon successful TLS connection
- Note the `User-Agent` used by the sample is `Updates downloader` - which can be used as an IOC for threat hunting
- The **INetSim** server respond a DOS program we see on the Windows machine

<br/>

---

## 5 - Use Fiddler to inspect the traffic

Also, we may use **Fiddler** on the Windows machine to inspect the traffic.

With **fakedns** and **INetSim** running on **REMnux**, on the Windows machine, run **Fiddler**.

Click `Tools > Options ...`:

![picture 65](../images/802a4b0dce37657436baa57ae0a9a2ddaa11395c2c99e596f8b5fed6cd42ed6d.png)  

<br/>

Make sure the following configs are set:

- Decrypt HTTPS traffic
- Ignore server certificate errors (unsafe)

![picture 66](../images/ee520f1afba82b590ee0ea20ab227c9a100fcbd6e4795f68159cc3bbab990446.png)  

<br/>

Also check `Enable rule` under `AutoResponder`:

![picture 67](../images/ceb5ba3ddbe62efaf2c956af349e715b6a4bc426b02df33378ac2564435b9d49.png)  

<br/>

Then run the sample `ghyte.exe`:

![picture 68](../images/498f03e851d6a26f1699d9741f8abc70e993ee63ce7e8793709c80a975822ec4.png)  

![picture 69](../images/2047b8cfece251793fe6c8117c411d58b47b4cd4f68fb1c38fdbe1fad13e6f1e.png)  

- We see the same HTTPS traffic as in **INetSim**
- Windows pops up an error of `Unsupported 16-but Application` since the response file generated by **Fiddler** is not a valid Windows executable, but the `ghyte.exe` tried to execute it.

<br/>

---