# Lab 2.5: Loop Components

- [Lab 2.5: Loop Components](#lab-25-loop-components)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Modify the IDA strings configuration to show Unicode strings](#1---modify-the-ida-strings-configuration-to-show-unicode-strings)
  - [2 - Identify the address where the Application Data string is referenced](#2---identify-the-address-where-the-application-data-string-is-referenced)
  - [3 - A group of strings is located at 418CD8. Identify the address where this group of strings is referenced.](#3---a-group-of-strings-is-located-at-418cd8-identify-the-address-where-this-group-of-strings-is-referenced)
  - [4 - Investigate the loop that references off_418CD8. First, identify the addresses and instructions of the stopping condition](#4---investigate-the-loop-that-references-off_418cd8-first-identify-the-addresses-and-instructions-of-the-stopping-condition)
  - [5 - Identify the address and instruction that update the control variable](#5---identify-the-address-and-instruction-that-update-the-control-variable)
  - [6 - Identify the address and instruction of the loop initialization](#6---identify-the-address-and-instruction-of-the-loop-initialization)
  - [7 - Identify the address range for the loop body](#7---identify-the-address-range-for-the-loop-body)
  - [8 - Investigate the purpose of the loop. Also, explore another loop at 407E28](#8---investigate-the-purpose-of-the-loop-also-explore-another-loop-at-407e28)

---

## Objectives

- Use string references to find code of interest.
- Familiarize yourself with loop components as they appear in assembly code.
- Continue immersion in assembly language.

<br/>

---

## Steps

1. Modify the IDA strings configuration to show Unicode strings.
2. Identify the address where the Application Data string is referenced (to clarify, we are looking for where the string is referenced and not stored).
3. A group of strings is located at `418CD8`. Identify the address where this group of strings is referenced.
4. Investigate the loop that references `off_418CD8`. First, identify the addresses and instructions of the stopping condition.
5. Next, identify the address and instruction that update the control variable.
6. Identify the address and instruction of the loop initialization.
7. Lastly, identify the address range for the loop body.
8. Do you have more time? Investigate the purpose of the loop. Also, consider exploring another loop at `407E28`.

<br/>

---

## 1 - Modify the IDA strings configuration to show Unicode strings

To show Unicode strings, navigate to `View > Open subviews > Strings`:

![picture 122](../images/7372728bf00fc3d2b9e3bff5c4fd0c177ab3655bb079bf28b4b6f28c48f627e2.png)  

<br/>

Then right click anywhere on the **Strings window** and click `Setup`:

![picture 123](../images/4f1d394ebcd50672959b0d4c176cc11fa2d1581129515b13aace3c224768edac.png)  

<br/>

Check `Unicode C-style (16 bits)`:

![picture 124](../images/dd07cc5b2d5a3e500701cc3d52cd92bb62af2587c8b414fafb81cb6a1c1bb14d.png)  

<br/>

---

## 2 - Identify the address where the Application Data string is referenced

Locate the strings `Application Data` in the **Strings window** - you can type it out and it brings you to the location:

![picture 125](../images/09860d5d54c888f113a8663bcd92794c8e902bcc8e349515a8a5eec6df8c754d.png)  

<br/>

Double click this entry and we will be brought to the assembly view. Click on the string and hit `X` to get the xref:

![picture 126](../images/6226db8a2b459923a8b1752a739c39917dc056e3fb904f5d5335d21eab685221.png)  

- Reference address is `418CFC`

<br/>

Click `OK` and we will be brought to a strings table:

![picture 127](../images/7535ba853cdff21268c4a65b7e857283a1450ab6f9cb3fc4c65fd693e9019772.png)  

- Note the interesting strings surrounding as well like:
  - `418D08` - `_Locky_recover_instructions.txt`
  - `418D0C` - `_Locky_recover_instructions.bmp`

<br/>

---

## 3 - A group of strings is located at 418CD8. Identify the address where this group of strings is referenced.

Click on `418CD8` and hit `X` to see the xref:

![picture 128](../images/170a4e38c36a45383ba0600cde9fc9b39f1cb754360630a90d59114ee3a1b63c.png)  

- Referenced at `loc_407D84` in subroutine `sub_407CA7`
- Therefore the address in concern is `407D84`

<br/>

Click `OK` to navigate to the referenced code:

![picture 129](../images/b822d3315229e04348ad7a76feec4caab2d33e1676562d2893d9b67746c8b876.png)  

<br/>

To make it easy to read, change the name of `off_418CD8` and hit `N` to rename it as `InterestingStringsWithLocky`:

![picture 130](../images/4822b9bcc8e346e3f3d2b2f018e9f1078c507af477aa8485250fef49c5097c20.png)  

<br/>

---

## 4 - Investigate the loop that references off_418CD8. First, identify the addresses and instructions of the stopping condition

Take a look at the following code block:

![picture 131](../images/869733af48d322dc85fb347acf63237aa4dcf4fd60dff88b08a8a558b16b7714.png)  

- (`407DA3 - 407dA6`) Conditional jump to `loc_407D84`. It compares `esi` with `38h` (`56` in decimal).
  - If `esi` is below `56`, jump to `loc_407D84`

<br/>

---

## 5 - Identify the address and instruction that update the control variable

In the `cmp esi, 38h` instruction, the register `esi` is being compared. Right before this instruction, there is an update instruction at `407DA0`:

![picture 132](../images/74e9cd8bc07dca25dbcce6b7653a12e6aa27997c8fd58708a78ac316909c72ee.png)  

- `add esi, 4` - This is the update instruction on the control vairable `esi`
- Therefore `0x407DA0` is the control variable updating insturction address

<br/>

---

## 6 - Identify the address and instruction of the loop initialization

We analyzed that `esi` is being used as the control variable. Look backward to find the related instructions:

![picture 133](../images/b705d51dcb98391c80f752532bec0773f54d2b8a4229a4498555337654633468.png)  

- (`407D82`) - `xor esi, esi` - This set `esi` to be `0`
- Therefore the loop initialization address is `407D82`

<br/>

---

## 7 - Identify the address range for the loop body

To identify the range of loop body, we can rely on IDA notation below:

![picture 134](../images/f49e07c4caa84ca5e8d81da98215e94d6e0ee1defaabe23fc93013292db88272.png)  

- The loop body range is `407D84 - 407DA6`

<br/>

---

## 8 - Investigate the purpose of the loop. Also, explore another loop at 407E28

