# Lab 4.10: Examining Code Injection Artifacts in great.vmem

- [Lab 4.10: Examining Code Injection Artifacts in great.vmem](#lab-410-examining-code-injection-artifacts-in-greatvmem)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Set the VOLATILITY_PROFILE environment variable on REMnux to match the Volatility profile appropriate for analyzing the great.vmem file](#1---set-the-volatility_profile-environment-variable-on-remnux-to-match-the-volatility-profile-appropriate-for-analyzing-the-greatvmem-file)
  - [2 - Use Volatility to extract contents of the suspicious batch file that was executed on the great.vmem system](#2---use-volatility-to-extract-contents-of-the-suspicious-batch-file-that-was-executed-on-the-greatvmem-system)
  - [3,4 - Use Volatility's malfind plugin to examine great.vmem to locate injected code](#34---use-volatilitys-malfind-plugin-to-examine-greatvmem-to-locate-injected-code)

---

## Objectives

- Learn essential aspects of using Volatility for memory forensics.
- Understand how to specify the right Volatility profile for a memory image file.
- Learn to examine processes represented in the memory image by using `pslist` and `cmdline` plugins.
- Learn the benefits of the dumping process's virtual memory using the `memdump` plugin.
- Learn to use the `malfind` plugin to discover injected code.
- Reinforce code injection concepts from the perspective of memory forensics.

<br/>

---

## Steps

1. Set the `VOLATILITY_PROFILE` environment variable on REMnux to match the Volatility profile appropriate for analyzing the `great.vmem` file.
2. Use Volatility to extract contents of the suspicious batch file that was executed on the `great.vmem` system.
3. Use Volatility's `malfind` plugin to examine `great.vmem` to locate injected code.
4. Compare the fuzzy hash of one of the 236K files that malfind extracted from `great.vmem` to that of `great.exe`, confirming that the files are very similar.

<br/>

---

## 1 - Set the VOLATILITY_PROFILE environment variable on REMnux to match the Volatility profile appropriate for analyzing the great.vmem file

On **REMnux**, first use `vol.py` with `kdbgscan` to scan the memory image file for the profile to be used:

```
vol.py -f great.vmem kdbgscan
```

![picture 498](../images/8858f973673fac0300e44ae294e778cc4509ec04bb3b5d4d85c5a0f4bf71ef58.png)  

- Possible profiles:
  - Win10x86_10586
  - Win10x86
  - Win81U1x86
  - Win8SP1x86
  - Win8SP0x86

<br/>

Then try them one by one with `--profile=<> pslist`

```
vol.py -f great.vmem --profile=Win10x86_10586 pslist
```

![picture 499](../images/6516e72a4f6d052a6b3811d0b32d38560f2d37a134a21ece02f971fdbdff191c.png)  

- Not working

<br/>

```
vol.py -f great.vmem --profile=Win10x86 pslist
```

![picture 500](../images/e4ca12b6aaad9b3f9793ae13dd5a4ec2dd14862f76f9a770fa25d1a44a227d88.png)  

- The command runs successfully

<br/>

Therefore the correct memory profile to be used is `Win10x86`.

To avoid typing the profile name repeatedtively, we can export it as an env:

```
export VOLATILITY_PROFILE=Win10x86
```

<br/>

Then we can avoid the `--profile` argument:

```
vol.py -f great.vmem pslist
```

![picture 501](../images/099ebf91bdf8ba28e3158e492f700a58c2939bb6989a9e5e1aded4aaadba8597.png)  

<br/>

---

## 2 - Use Volatility to extract contents of the suspicious batch file that was executed on the great.vmem system

First try using `cmdline` plugin to look into the command line of the processes:

```
vol.py -f great.vmem cmdline
```

![picture 502](../images/ee9447060f677fc87a260990fa6eef269ee4dfb436f6edf5de9101e24f2f0584.png)  

- There is a suspicious `BAT` file
  - PID = `872`
  - CMDLINE = `"C:\Windows\system32\cmd.exe" /c "C:\Users\REM\AppData\Local\Temp\tmp1dcc7dd2.bat"`

<br/>

Then we can use `memdump` plugin to dump the virtual memory of the process out:

```
mkdir -p ./great/memdump-p872-bat
vol.py -f great.vmem memdump -p 872 -D ./great/memdump-p872-bat/
```

![picture 503](../images/c0261435c0eef338864886f03e86cce2e1bd26ea31c30f440b2d1c91eb856524.png)  

<br/>

Then we can inspect the dump file using `strings`:

```
strings ./great/memdump-p872-bat/872.dmp | grep -A 5 -B 5 "tmp1dcc7dd2.bat"
```

![picture 504](../images/d7037bef636a769ebe9fc44ca8d26ad4380d9e9973dbf76f3b9df894cfb9715c.png)  

- The following content is found:

```
@echo off
del "C:\Users\REM\Desktop\great.exe"
if exist "C:\Users\REM\Desktop\great.exe" goto d
del /F "C:\Users\REM\AppData\Local\Temp\tmp1dcc7dd2.bat"
```

<br/>

We can also use `strings --encoding=l` to reveal the UNICODE strings:

```
strings --encoding=l ./great/memdump-p872-bat/872.dmp | grep -A 5 -B 5 "tmp1dcc7dd2.bat"
```

![picture 505](../images/473b607bd97585bdcada5a16d28ded627d8cb969bad6c4caeafbc9ea1722fcc3.png)  

<br/>

---

## 3,4 - Use Volatility's malfind plugin to examine great.vmem to locate injected code

`malfind` is a Volatility plugin to examin the Virtual Address Descriptor (VAD) tree, which tracks memory pages allocated to a process.

<br/>

```
mkdir -p ./great/malfind
vol.py -f great.vmem malfind -p 872 -D ./great/malfind/ > ./great/malfind/malfind.txt
scite ./great/malfind/malfind.txt &
```

![picture 506](../images/e79a9483b4199f10b182bbcd8e7c1e8cece7ffa3877d77b58e66f2a437138332.png)  

![picture 507](../images/a720159a9e24b8e7e7ce11ae2ec1f101b7a50f1462752a8b8eae1a6307369271.png)  

- `MZ` indicates a Windows PE
- `PAGE_EXECUTE_READWRITE` is a property commonly seen in Code Injection
- The virtual address is `0x3c00000`

<br/>

We can also check all of the processes:

```
mkdir -p ./great/malfind-all
vol.py -f great.vmem malfind -D ./great/malfind-all/ > ./great/malfind-all/malfind.txt
scite ./great/malfind-all/malfind.txt &
```

![picture 508](../images/8273ccf015ea5a0cb8f905a2962d8e06db1fcebc217f7a43ff9d6c41cc0f43ee.png)  

- Similar result to that of `cmd.exe`
  - PID: 2524
  - ProcessName: sihost.exe
  - Virtual Address: 0x3e30000
- Similar result for many processes as well

<br/>

We can check the size of the `.DMP` files:

```
ls ./great/malfind-all/*.dmp -lsh | sort
```

![picture 509](../images/2a68c968ffbebbb7a31689c95e062e4133e43595d7f960a9b58498fc99a71bda.png)  

- Many of them are of the same size
- This could be an indicator of a similar code getting injected into different processes

<br/>

To save the file path of the dmp of 236K, we can do:

```
ls ./great/malfind-all/*.dmp -lsh | grep 236K | cut -d ' ' -f 10 > ./great/236K-dmp.txt
```

<br/>

Then get the strings using `pestr`:

```
for file in $(cat ./great/236K-dmp.txt); do (echo $file; pestr $file | grep -A 5 -B 5 echo); done
```

![picture 511](../images/22a67f9d14936db393fd7ceedda2d1cdd438957fdd0a55ba4f8248ed26f8fa8f.png)  


<br/>

To further confirm they are nearly identical, we can use `ssdeep` to calculate the **fuzzhash** of the dump files:

```
ls ./great/malfind-all/*.dmp -lsh | grep 236K | cut -d ' ' -f 10 > ./great/236K-dmp.txt
for file in $(cat ./great/236K-dmp.txt); do ssdeep $file; done
```

![picture 510](../images/cb4b9abee7b30a07feec153134b443114ca329a233acf99e266302acdca5204d.png)  


---