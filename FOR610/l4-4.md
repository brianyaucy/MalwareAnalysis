# Lab 4.4: Debugging the Packed Version of brbbot.exe

- [Lab 4.4: Debugging the Packed Version of brbbot.exe](#lab-44-debugging-the-packed-version-of-brbbotexe)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Run the packed brbbot.exe specimen in x64dbg](#1---run-the-packed-brbbotexe-specimen-in-x64dbg)
  - [2 - Examine the contents of brbbot.exe's NPX0 region by starting from the Memory Map tab, and then displaying its code in the disassembler of x64dbg.](#2---examine-the-contents-of-brbbotexes-npx0-region-by-starting-from-the-memory-map-tab-and-then-displaying-its-code-in-the-disassembler-of-x64dbg)
  - [3 - Using x64dbg, locate the code in brbbot.exe that calls CryptDecrypt.](#3---using-x64dbg-locate-the-code-in-brbbotexe-that-calls-cryptdecrypt)
  - [4 - Set a hardware breakpoint after the instruction after the call to CryptDecrypt, and then restart the process and run it to reach the breakpoint.](#4---set-a-hardware-breakpoint-after-the-instruction-after-the-call-to-cryptdecrypt-and-then-restart-the-process-and-run-it-to-reach-the-breakpoint)

---

## Objectives

- Learn to navigate through a packed executable using a debugger such as x64dbg.

<br/>

---

## Steps

1. Run the packed `brbbot.exe` specimen in `x64dbg`.
2. Examine the contents of `brbbot.exe`'s `NPX0` region by starting from the **Memory Map tab**, and then displaying its code in the disassembler of **x64dbg**.
3. Using x64dbg, locate the code in `brbbot.exe` that calls `CryptDecrypt`.
4. Set a hardware breakpoint after the instruction after the call to `CryptDecrypt`, and then restart the process and run it to reach the breakpoint.

<br/>

---

## 1 - Run the packed brbbot.exe specimen in x64dbg

Click the `Run` button after loading `brbbot.exe` on x64dbg:

![picture 397](../images/33281e1920d40f0f3404a5b5a139843bc081a82353cf9d5e3d045dd4d03c5ff1.png)  

<br/>

---

## 2 - Examine the contents of brbbot.exe's NPX0 region by starting from the Memory Map tab, and then displaying its code in the disassembler of x64dbg.

Navigate to the `Memory Map` tab and check the **Protection** column - find the ones with **Execute (E)** flag:

![picture 398](../images/1c02e07e9a341023f5b10e651cca7c5e021bff6e2525ed6bf7853c8753f9192a.png)  

- `NPX0` and `UPX1` has the `E` flag set

<br/>

Right click `NPX0` and click `Follow in Disassembler`:

![picture 399](../images/67003c0bae51fc72c9618e1710306856498eb595f200318d06e0461e75968db2.png)  

<br/>

---

## 3 - Using x64dbg, locate the code in brbbot.exe that calls CryptDecrypt.

To examine the code, we can check some API calls. Right click on disassembled panel, and `Search for > Current Region > Intermodular calls`:

![picture 400](../images/d10b7b7b388e88c65e59ddf99076ef390196ad3bbe820f9b90058ed5995077f6.png)  

<br/>

Search for `CryptDecrypt`:

![picture 401](../images/358e57d82fceabf972326246915b070be0936f230983602d5d15be4fc5f97874.png)  

<br/>

Right click the found address and click `Follow in Disassembler`:

![picture 402](../images/b0d291cf7ecca57b22b687c4f1fad9911a67bb336d1ca4e358420f34f4e95be5.png)  

<br/>

![picture 403](../images/09e30e40b99db7c1bae4e22195528503475696aa2e98774e50c4dc74f49cb306.png)  

<br/>

---

## 4 - Set a hardware breakpoint after the instruction after the call to CryptDecrypt, and then restart the process and run it to reach the breakpoint.

Click on `test eax,eax` and right click on it, click `Breakpoint > Set hardware on execution`:

![picture 404](../images/5462e9cc19211cc7417a17d2548f31c6d8ca8ba49a152e228531c529cf248ae2.png)  

<br/>

![picture 405](../images/8d23372cfcbd7c1141db4d5bc35fe2d83f044c605c1697ffea013fb981cd7f55.png)  

- The "Red dot" indicates a hardware breakpoint

<br/>

Then restart the program by clicking `Debug > Restart`:

![picture 406](../images/7dd3580ebf266e702b7ed560bdd2cb1eed761ebcf9d2407f99c6b84be0f69247.png)  

<br/>

After restarting, run the program again:

![picture 407](../images/0dc736df7717ef7b0220bb1294f7076e91bfc7c701c515547e9e4aea606346a4.png)  

<br/>

Now we stop right after the `CryptDecrypt` call:

![picture 408](../images/199b7460421b9b88d5e80913f612d329b35a9c5ed61da299bed8555f3d86685d.png)  

- The Memory Panel shows the decrypted configuration file content

<br/>

---