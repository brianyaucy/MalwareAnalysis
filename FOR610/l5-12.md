# Lab 5.12: Unpacking yep.exe with the Help of x32dbg and pe_unmapper

- [Lab 5.12: Unpacking yep.exe with the Help of x32dbg and pe_unmapper](#lab-512-unpacking-yepexe-with-the-help-of-x32dbg-and-pe_unmapper)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Examine yep.exe in PeStudio to determine which DLLs are in the specimen's IAT](#1---examine-yepexe-in-pestudio-to-determine-which-dlls-are-in-the-specimens-iat)
  - [2 - Run yep.exe in x32dbg until the specimen attempts to load a DLL that's not listed in its IAT](#2---run-yepexe-in-x32dbg-until-the-specimen-attempts-to-load-a-dll-thats-not-listed-in-its-iat)
  - [3 - Allow yep.exe to execute in x32dbg until it returns from LoadLibraryA after loading msvcrt.dll](#3---allow-yepexe-to-execute-in-x32dbg-until-it-returns-from-loadlibrarya-after-loading-msvcrtdll)
  - [4 - Locate the call to VirtualProtect that yep.exe executes after returning from LoadLibrary, and then use x32dbg to pause the specimen before it calls VirtualProtect](#4---locate-the-call-to-virtualprotect-that-yepexe-executes-after-returning-from-loadlibrary-and-then-use-x32dbg-to-pause-the-specimen-before-it-calls-virtualprotect)
  - [5 - Examine yep.exe's memory region upon which VirtualProtect is operating by displaying it in the Dump area of x32dbg's CPU tab](#5---examine-yepexes-memory-region-upon-which-virtualprotect-is-operating-by-displaying-it-in-the-dump-area-of-x32dbgs-cpu-tab)
  - [6 - Allow yep.exe to execute until the second call to VirtualProtect in x32dbg, which is 35 instructions below the VirtualProtect call where the specimen is currently paused](#6---allow-yepexe-to-execute-until-the-second-call-to-virtualprotect-in-x32dbg-which-is-35-instructions-below-the-virtualprotect-call-where-the-specimen-is-currently-paused)
  - [7 - Use x32dbg to set a breakpoint in the newly allocated memory region to catch yep.exe when it attempts to execute code extracted into that part of memory](#7---use-x32dbg-to-set-a-breakpoint-in-the-newly-allocated-memory-region-to-catch-yepexe-when-it-attempts-to-execute-code-extracted-into-that-part-of-memory)
  - [8 - Use the Memory Map tab in x32dbg to save contents of the memory region that contain yep.exe's unpacked code as the file named yep-dumped.exe](#8---use-the-memory-map-tab-in-x32dbg-to-save-contents-of-the-memory-region-that-contain-yepexes-unpacked-code-as-the-file-named-yep-dumpedexe)
  - [9 - Use pe_unmapper on the Windows REM Workstation to fix up yep-dumped.exe, naming the new file yep-dumped-fixed.exe](#9---use-pe_unmapper-on-the-windows-rem-workstation-to-fix-up-yep-dumpedexe-naming-the-new-file-yep-dumped-fixedexe)
  - [10 - Invoke Scylla from within x32dbg and fix the IAT in the yep-dumped-fixed.exe file](#10---invoke-scylla-from-within-x32dbg-and-fix-the-iat-in-the-yep-dumped-fixedexe-file)

---

## Objectives

- Reinforce the method of unpacking malware by anticipating the specimen's need to invoke API calls such as LoadLibrary and VirtualProtect close to the OEP.
- Experiment with pe_unmapper for fixing up PE files extracted from memory.
- Gain additional experience performing dynamic code-level analysis in x32dbg.

<br/>

---

## Steps

1. Examine `yep.exe` in **PeStudio** to determine which DLLs are in the specimen's IAT.
2. Run `yep.exe` in `x32dbg` until the specimen attempts to load a DLL that's not listed in its IAT.
3. Allow `yep.exe` to execute in **x32dbg** until it returns from `LoadLibraryA` after loading `msvcrt.dll`.
4. Locate the call to `VirtualProtect` that `yep.exe` executes after returning from `LoadLibrary`, and then use **x32dbg** to pause the specimen before it calls `VirtualProtect`.
5. Examine `yep.exe`'s memory region upon which `VirtualProtect` is operating by displaying it in the Dump area of **x32dbg**'s CPU tab.
6. Allow `yep.exe` to execute until the second call to `VirtualProtect` in **x32dbg**, which is 35 instructions below the `VirtualProtect` call where the specimen is currently paused.
7. Use **x32dbg** to set a breakpoint in the newly allocated memory region to catch `yep.exe` when it attempts to execute code extracted into that part of memory.
8. Use the Memory Map tab in `x32dbg` to save contents of the memory region that contain `yep.exe`'s unpacked code as the file named `yep-dumped.exe`.
9. Use `pe_unmapper` on the Windows REM Workstation to fix up `yep-dumped.exe`, naming the new file `yep-dumped-fixed.exe`.
10. Invoke **Scylla** from within **x32dbg** and fix the IAT in the `yep-dumped-fixed.exe` file.

<br/>

---

## 1 - Examine yep.exe in PeStudio to determine which DLLs are in the specimen's IAT

Load `yep.exe` into **PeStudio** and check the libraries:

![picture 207](../images/c5bb003733c3facd3cf90a1c3100e5ae4f3ef990088c28166b0d3fae49c9cf5a.png)  

- By looking into the IAT, only the following DLLs present:
  - user32.dll
  - kernel32.dll
  - comctl32.dll
  - shell32.dll

<br/>

---

## 2 - Run yep.exe in x32dbg until the specimen attempts to load a DLL that's not listed in its IAT

Load `yep.exe` into **x32dbg**.

<br/>

When loading libraries, it is like that `LoadLibraryA` or `LoadLibraryW` will be used. Let's set breakpoints for those API calls:

```
SetBPX LoadLibraryA
```

```
SetBPX LoadLibraryW
```

<br/>

Click on the `Breakpoints tab` to review the breakpoints set:

![picture 208](../images/5fcbbb81d19f5ff8c7a35527be91981f1c893b3a3c45720116c8757357729b9a.png)  

- `763D5980`
- `763D59E0`

<br/>

Run the program:

![picture 210](../images/846c8bbab355e74175f75a020aaeaf9cb0936d56f2bb535f32ed5b31b6b3df6f.png)  

- Loading `kernel32.dll`, which is in the IAT

<br/>

Run until something not in the IAT appears:

![picture 211](../images/373d2f3155e0c8c488a733cf297d8452fa2ebe990df853670253199e6efe8eaa.png)  

- ntdll.dll

<br/>

![picture 212](../images/3d098d69199a5a22dddf69d9dff9b063843f8dc0a198ffd332e680ae2e3d75d0.png)  

- msvcrt.dll

<br/>

Then the program exits.

<br/>

---

## 3 - Allow yep.exe to execute in x32dbg until it returns from LoadLibraryA after loading msvcrt.dll

Click `Run` 5 times and we see it loads `msvcrt.dll`:

![picture 213](../images/28e068310fbeedcab65b92ee48c110a4853b26e6746a17669dff3b9417f26cab.png)  

<br/>

Removed the current breakpoint by hitting `F2`. Now we have to determine which part of `yep.exe` invoked `LoadLibraryA`.

<br/>

To do so, click on the top of the Stack area in the **CPU tab**. Right click and choose `Follow DWORD in Disassembler`:

![picture 214](../images/3a70c4cf71bd3c7dc16db322c517a79347ebd13f43aefd9f2c23b461a9794008.png)  

<br/>

![picture 215](../images/d68aa2014d43824ad1a8fcd32ec20e909f18a5cce85de0d0ae6b57c4730f4666.png)  

- Click on `43A02B0` and hit `F4` to allow the program finish the execution of `LoadLibraryA`

![picture 216](../images/3c775fa38cfea345915fc0b7e6c7c83a9c80c97a31836126ee3bdcc2660aa883.png)  


<br/>

---

## 4 - Locate the call to VirtualProtect that yep.exe executes after returning from LoadLibrary, and then use x32dbg to pause the specimen before it calls VirtualProtect

At `43A02B0`, scroll down and we can see an API call to `VirtualProtect`:

![picture 217](../images/d8dce548a22a0c6e8390cb8643f1802860f69cf4861e6e08801195e325785429.png)  

- VA: `43A03B5`
- `VirtualProtect` worths checking since it is related to code injection and unpacking

<br/>

Click on the row of `43A03B5` and hit `F4`:

![picture 218](../images/71d815eb905559cbdbb5d320b5b15f1b5e2231c1bcb38bf7730d39e309c0623b.png)  

- https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect
- Purpose:
  - Changes the protection on a region of committed pages in the virtual address space of the calling process.
- Parameters:
  - `lpAddress`: The address of the starting page of the region of pages whose access protection attributes are to be changed.
    - `[ebp-28]` --> `00400000` --> The address of the starting page of the region will be `0x400000`
  - `dwSize`: The size of the region whose access protection attributes are to be changed, in bytes.
    - `1000` --> 1000 bytes
  - `flNewProtect`: The memory protection option.
    - https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants
    - `2` --> `PAGE_READONLY`
  - `lpflOldProtect`: A pointer to a variable that receives the previous access protection value of the first page in the specified region of pages. If this parameter is NULL or does not point to a valid variable, the function fails.
    - `esi` --> `0019EE70`

<br/>

---

## 5 - Examine yep.exe's memory region upon which VirtualProtect is operating by displaying it in the Dump area of x32dbg's CPU tab

On the top of the parameters, where the parameter `lpAddress` resides, right-click and `Follow [19EE20] in Dump`:

![picture 219](../images/f1597d829bd2d73dd281f0f4614b1522c333c156892b0626431a8afb181e560c.png)  

![picture 220](../images/2f1f7263f9ef3436b77503d6e5cc799b085e7521ca6b4ca4ea5bfe0abe47d788.png)  

- Start with `PE` --> Windows executable

<br/>

---

## 6 - Allow yep.exe to execute until the second call to VirtualProtect in x32dbg, which is 35 instructions below the VirtualProtect call where the specimen is currently paused

Scroll down further we can see another `VirtualProtect` call:

![picture 221](../images/ba1e036f2dc267d8defc0a36e7acf8cd3c90d293b286914f38f26743d415fde0.png)  

- VA: `43A0404`

<br/>

Click on the call and hit `F2` to toggle a breakpoint. Then run the program:

![picture 222](../images/51cee7b6c528fc0678be07449c9a321490c819d8e98c8e77484209b63716f23e.png)  

- https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect
- Purpose:
  - Changes the protection on a region of committed pages in the virtual address space of the calling process.
- Parameters:
  - `lpAddress`: The address of the starting page of the region of pages whose access protection attributes are to be changed.
    - `401000` --> This is right after the previous `VirtualProtect` call
  - `dwSize`: The size of the region whose access protection attributes are to be changed, in bytes.
    - `2000` --> 2000 bytes
  - `flNewProtect`: The memory protection option.
    - https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants
    - `20` --> `PAGE_EXECUTE_READ`
  - `lpflOldProtect`: A pointer to a variable that receives the previous access protection value of the first page in the specified region of pages. If this parameter is NULL or does not point to a valid variable, the function fails.
    - `0019EE70`

<br/>

---

## 7 - Use x32dbg to set a breakpoint in the newly allocated memory region to catch yep.exe when it attempts to execute code extracted into that part of memory

First, on the stack, right-click the 1st parameter and choose `Follow [...] in Dump`:

![picture 223](../images/15445fa0ab7edcdc7318f721570a155f336276b8239e6e559cb4ecfae3d5180a.png)  

<br/>

In the **Dump area**, right click and choose `Breakpoint > Hardware, Execute`:

![picture 224](../images/173f13223a1dde34b8310b73474edeb6c24c9ae61c032ed73d5786f291839cf5.png)  

<br/>

Remove the breakpoint set on the `VirtualProtect`  call. Run the program by hitting `F9`:

![picture 225](../images/322f9ffb0e2ba0f4f8a98efa7816c00b75832bb5d9f9d9580af97203f5cadf8d.png)  

<br/>

---

## 8 - Use the Memory Map tab in x32dbg to save contents of the memory region that contain yep.exe's unpacked code as the file named yep-dumped.exe

Right click on the Dump area, choose `Follow in Memory Map`:

![picture 226](../images/d5dd0df336e524c5e485ee4b9021ac0e7658abb73989d5d628f49347994f6217.png)  

<br/>

On that row, right click and select `Dump Memory to File`:

![picture 227](../images/4bad4212f003d62d1dc8e5e47cb88d2956675518bcc2819c9a7ac6f8b6a92881.png)  

<br/>

Note in the **Memory Map** the region is showing `R` only.

However, if we inspect `Set Page Memory Right`, we can see `401000-402000` has execute `E` flag set:

![picture 228](../images/983a00a36b9d38712b501fbdf26dd6a52f9cdfc84343675d953ed2b5689bf05c.png)  

<br/>

---

## 9 - Use pe_unmapper on the Windows REM Workstation to fix up yep-dumped.exe, naming the new file yep-dumped-fixed.exe

Sometimes the PE file dumped requires post-processing to make rebasing and other tweaks. We can use `pe_unmapper` to accomplish this:

```
pe_unmapper yep-dumped.exe 400000 yep-dumped-fixed.exe
```

![picture 229](../images/9aa35fef3bf513b64e56f8183d2c9806de81a39cb64f76b59b58b3a41f5ff2ff.png)  

<br/>

---

## 10 - Invoke Scylla from within x32dbg and fix the IAT in the yep-dumped-fixed.exe file

On `x32dbg`, click `Plugins > Scylla`:

![picture 230](../images/4f260cc4f6e931e0efa34bde6ac0a977f9efc391c01627b40f69115f5e484808.png)  

<br/>

1. IAT Autosearch
2. Get Imports
3. Fix Dump

![picture 231](../images/e4961142d46458cf61e869345c44ceff38ddc6d514f9c4ea560b226178e598c2.png)  

![picture 232](../images/895ece0adabf7f7fc801b16dddbf9a643957e6d9fe6f5fc5dc3d525bfe8ca8b4.png)  

<br/>

After clicking `Fix Dump`, choose `yep-dumped-fixed.exe`.

![picture 233](../images/76cfb1cd5216fda9a6151b34ff4d0266a83d0f21ee821ade1a75978ddd66ae51.png)  

![picture 234](../images/e768593f96f87be324913c3b56705d16e998ac9a06ec533ac8c640d72e45b65a.png)  


<br/>

---