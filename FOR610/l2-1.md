# Lab 2.1: Introduction to Assembly and IDA

- [Lab 2.1: Introduction to Assembly and IDA](#lab-21-introduction-to-assembly-and-ida)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1,2,3,4 - Disassemble svchost.exe and examine the Graph view, exports and imports](#1234---disassemble-svchostexe-and-examine-the-graph-view-exports-and-imports)
  - [5,6 - Locate the second reference to the RegOpenKeyExA and check the arguments](#56---locate-the-second-reference-to-the-regopenkeyexa-and-check-the-arguments)
  - [7 - Use a standard symbolic constant for another RegOpenKeyExA argument](#7---use-a-standard-symbolic-constant-for-another-regopenkeyexa-argument)
  - [8 - Analyze the conditional jump at 4047F8 and describe it in a sentence. Research RegOpenKeyExA on Microsoft Document(msdn.microsoft.com) to assign meaning to the conditional jump.](#8---analyze-the-conditional-jump-at-4047f8-and-describe-it-in-a-sentence-research-regopenkeyexa-on-microsoft-documentmsdnmicrosoftcom-to-assign-meaning-to-the-conditional-jump)
  - [9 - Add a comment to the conditional jump to document your progress](#9---add-a-comment-to-the-conditional-jump-to-document-your-progress)

--- 

## Objectives

- Familiarize yourself with basic assembly concepts.
- Grasp the core features used in IDA (free edition).
- Learn to navigate the IDA interface.
- Familiarize yourself with `CALL` and `PUSH` instructions.
- Understand conditional jumps as they appear in assembly code.

<br/>

---

## Steps

1. Disassemble `svchost.exe` using IDA.
2. Examine IDA's Graph view.
3. Examine `svchost.exe`'s exports.
4. Examine `svchost.exe`'s imports.
5. Locate the second reference to the `RegOpenKeyExA` API.
6. Observe that one argument passed to `RegOpenKeyExA` is a pointer to a string.
7. Use a standard symbolic constant for another `RegOpenKeyExA` argument.
8. Analyze the conditional jump at `4047F8` and describe it in a sentence. Research `RegOpenKeyExA` on [Microsoft Document](msdn.microsoft.com) to assign meaning to the conditional jump.
9. Add a comment to the conditional jump to document your progress.

<br/>

---

## 1,2,3,4 - Disassemble svchost.exe and examine the Graph view, exports and imports

First launch **IDA Freeware** and drag `svchost.exe` in it:

![picture 76](../images/03f012e41bb361b18109bf2242282f33a6a337992e584e156185e7cfed6d59a9.png)  

- Leave these as default and click `OK`

<br/>

To view the **Graph View**, press `<SPACE>` bar:

![picture 77](../images/2baad9ab6f05cb6c65955113646ef3a649871e353c28c9bde2409c756075f32c.png)  

<br/>

To view the **Exports**, click on the `Exports` tab:

![picture 78](../images/1a83c34757c013e90e6bea327a18c0292e145d18fe20f5ef05717e9da7ca6915.png)  

- This shows the entry point of the program, which is labelled by IDA as `start` function

<br/>

To view the **Imports**, click on the `Imports` tab:

![picture 79](../images/c342a15a9d27a21ca7ef2914484cb34b317f6e3a25105e364edffb38f9f59a87.png)  

- This tab contains the APIs (functions) used by the program hat is contained in external libraries

<br/>

---

## 5,6 - Locate the second reference to the RegOpenKeyExA and check the arguments

To locate the API `RegOpenKeyExA`, sort the table by **Name** type `RegOpen` and you will be brought to the related entry:

![picture 80](../images/61c553b2e0b8434f995ac1d9ac007cb7c107613b8d76a39bc1930a357de88441.png)  

<br/>

Double click the API:

![picture 81](../images/5c90893be1442be86007220f47fae5e9ebf8c65e2c35aaa95d661901d37a96ab.png)  

<br/>

Then right click the `RegOpenKeyExA` function and choose **Jump to xref to operand ...**:

![picture 82](../images/5c9ba3c6471e60e57b540610cda873c8750e3680eaabe5c1a7c4177f72b56d64.png)  

<br/>

Choose the 2nd one and click `OK` to analyze further:

![picture 83](../images/193d463657c57f2e23508c4b3f1f1ffcb5e19b9dc23dcc09eb8ea9b2d167b8c8.png)  

![picture 84](../images/c6fc51472b2be4bd4e30eca1c20935554a8e1d88fac133958e7ee465fb72b016.png)  

<br/>

To understand more about the API `RegOpenKeyExA`, we have to search for it in Microsoft Document:

- https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa

```
LSTATUS RegOpenKeyExA(
  HKEY   hKey,
  LPCSTR lpSubKey,
  DWORD  ulOptions,
  REGSAM samDesired,
  PHKEY  phkResult
);
```

- Parameters
  - `hKey` - A handle to an open registry key. 
  - `lpSubKey` - The name of the registry subkey to be opened.
  - `ulOptions` - Specifies the option to apply when opening the key. Set this parameter to zero or the following:
    - `REG_OPTION_OPEN_LINK` - The key is a symbolic link. Registry symbolic links should only be used when absolutely necessary.
  - `samDesired` - A mask that specifies the desired access rights to the key to be opened. 
  - `phkResult` - A pointer to a variable that receives a handle to the opened key.

- Return value
  - If the function **succeeds**, the return value is `ERROR_SUCCESS`.
  - If the function fails, the return value is a **nonzero** error code defined in `Winerror.h`.

<br/>

Now take a look at the a few lines before the actual function call `call ds:RegOpenKeyExA`:

![picture 85](../images/4bf06e91d754a8dfeacfc7971ee28b48dfc126823bd932b338705ee7b69d0a6f.png)  

- The line with memory location `004047E2` has a comment `Software\\Microsoft\\Windows\\CurrentVe...`

<br/>

Double click `aSoftwareMicros`:

![picture 86](../images/5b85576f780d1e5225f23c6f3580ad4b5e87440ae41b53944fc3f157488017df.png)  

- This brings us to the actual value at `00413C70` in the `.rdata` section
- Therefore, the value we find in `004047E2` is a pointer to the memory location `00413C70`, which contains a string of `Software\Microsoft\Windows\CurrentVersion\Run` - which is a registry key commonly used for persistence
- Note there is another interesting string `vssadmin.exe Delete Shadows /All /Quiet` - which is a command for deleting Shadow Copy in Windows and is commonly used by Ransomwares

<br/>

---

## 7 - Use a standard symbolic constant for another RegOpenKeyExA argument

Compilers convert symbolic constants into HEX representations of that value:

![picture 87](../images/5f5899c93633d227ff8bc3857061b6b9abc2a569fdda6b729476644e1e29ee57.png)  

<br/>

Right click the value and click `Use standard symbolic constant`:

![picture 88](../images/e30a247bd502021e3493b77c4f00448642000bde239edbffcfdde9f4821b7a45.png)  

<br/>

Now we see a list of possible constants that match the HEX value:

![picture 89](../images/e04ce38cab460db4681f2df1fb6c9839aa7da5f3c71ae5f21cfd850d200ca3eb.png)  

- Choose the one matches the context of the code
- Since we are dealing with a Registry function, `HKEY_CURRENT_USER` makes the most sense to us

<br/>

Choose `HKEY_CURRENT_USER` and click `OK`, the HEX value will be replaced by the symbolic constant `HKEY_CURRENT_USER`:

![picture 90](../images/8ac25a2d02f848838e4f7174c550e24e1d8081aa1ed0ba84fa354bdfbf3af097.png)  

<br/>

---

## 8 - Analyze the conditional jump at 4047F8 and describe it in a sentence. Research RegOpenKeyExA on Microsoft Document(msdn.microsoft.com) to assign meaning to the conditional jump.

![picture 91](../images/564dd74228cc26c555b0d6cccde07a595a40926ea52c15479efb924123d53913.png)  

- `test eax eax` compares `eax` and `eax`, which will be `TRUE` if the value in `eax` is not `0`.
- `jz` means "Jump if zero"

<br/>

As mentioned in the MS document, if the function call `RegOpenKeyExA` fails, the return value is a **nonzero** error code defined in `Winerror.h`.

- `eax` will be `0` if the function call is successful
- `jz` will mean "Jump if the function call is successful"


<br/>

In summary, `jz short loc_404817` means:

> Jump to loc_404817 if the function call `RegOpenKeyExA` succeeds

<br/>

---

## 9 - Add a comment to the conditional jump to document your progress

Click on the end of the line `004047F8` and type `;`:

![picture 92](../images/6e064da9a699eaea657a35c0e3e5ccf349e0105a72e1cf49e26f564696a7ab1d.png)  

- Type our summary in step 8

<br/>

![picture 93](../images/6d37ddca6036e0a12d4650b46bfda5fd8614d033c9efcb14f0b4abf10bf3f7a4.png)  

<br/>

---