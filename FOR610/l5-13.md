# Lab 5.13: Extracting the Code Injected by known.exe Using Process Hacker

- [Lab 5.13: Extracting the Code Injected by known.exe Using Process Hacker](#lab-513-extracting-the-code-injected-by-knownexe-using-process-hacker)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - If time allows, examine known.vmem on REMnux by using Volatility to locate the code that known.exe might have injected into legitimate processes, such as explorer.exe](#1---if-time-allows-examine-knownvmem-on-remnux-by-using-volatility-to-locate-the-code-that-knownexe-might-have-injected-into-legitimate-processes-such-as-explorerexe)
  - [2 - Infect the Windows REM Workstation with known.exe, and locate the newly spawned explorer.exe process in the Process Hacker listing](#2---infect-the-windows-rem-workstation-with-knownexe-and-locate-the-newly-spawned-explorerexe-process-in-the-process-hacker-listing)
  - [3 - Use Process Hacker to extract injected code from the memory of the newly spawned explorer.exe process, naming the file explorer-dumped.exe](#3---use-process-hacker-to-extract-injected-code-from-the-memory-of-the-newly-spawned-explorerexe-process-naming-the-file-explorer-dumpedexe)
  - [4 - Use pe_unmapper to fix up the explorer-dumped.exe file, generating the file named explorer-dumped-fixed.exe](#4---use-pe_unmapper-to-fix-up-the-explorer-dumpedexe-file-generating-the-file-named-explorer-dumped-fixedexe)

---

## Objectives

- Use memory forensics to reinforce the key principles of code injection techniques.
- Learn know to use Process Hacker together with pe_unmapper to locate and extract code injected into legitimate processes.

<br/>

---

## Steps

1. If time allows, examine `known.vmem` on REMnux by using **Volatility** to locate the code that `known.exe` might have injected into legitimate processes, such as `explorer.exe`.
2. Infect the Windows REM Workstation with `known.exe`, and locate the newly spawned `explorer.exe` process in the **Process Hacker** listing.
3. Use **Process Hacker** to extract injected code from the memory of the newly spawned `explorer.exe` process, naming the file `explorer-dumped.exe`.
4. Use `pe_unmapper` to fix up the `explorer-dumped.exe` file, generating the file named `explorer-dumped-fixed.exe`.
   
<br/>

---

## 1 - If time allows, examine known.vmem on REMnux by using Volatility to locate the code that known.exe might have injected into legitimate processes, such as explorer.exe

First a suitable volatility profile to use:

```
vol.py -f known.vmem kdbgscan
```

![picture 235](../images/9f595863e24090da15bb0be8ecc97f384c40adcf4b0edbbb8b5d48188fac3e39.png)  

<br/>

Export the name of the suitable profile:

```
export VOLATILITY_PROFILE=Win10x86
```

<br/>

To look for code injection, we can use the `malfind` plugin:

```
vol.py -f known.vmem malfind -D /tmp > known-malfind.txt
scite known-malfind.txt &
```

![picture 236](../images/4489c1daa1f45b14ccf7dace3c5da24d6f5fb5d34d45433bdc507880ae8808a5.png)  

- There is a PE file injected into the `explorer.exe` process starting at `0x614000`

<br/>

We can check the strings of the dump:

```
pestr /tmp/process*614000* | more
```

![picture 237](../images/609bfc39ccaa0d283055ed7ca10f16c60f142f8255b84e90b6dba0edfc102c1d.png)  

<br/>

Make a copy of the dump file:

```
cp /tmp/process*614000* 614000-explorer-dumped.bin
```

<br/>

Download this on Windows and use `pe_unmapper` to fix it:

```
sudo python -m SimpleHTTPServer 80
```

<br/>

```
certutil -urlcache -f http://172.16.252.128/614000-explorer-dumped.bin .\614000-explorer-dumped.bin
pe_unmapper 614000-explorer-dumped.bin 614000 614000-explorer-dumped-fixed.bin
```

![picture 238](../images/2e1fc58a146785952a9410769a24434ef918185f0e3653d5efb40e2666498f71.png)  

![picture 239](../images/8ca0a5c382715d9c5cb4e56c24c0d83b79f0c41eed166a18cde604b23358ba35.png)  

<br/>

Inspect it on **PEStudio**:

![picture 240](../images/4af8187cc408a47b1067dee043c0f04c94399718b9ef762cbb0261fe6a5671a9.png)  

<br/>

---

## 2 - Infect the Windows REM Workstation with known.exe, and locate the newly spawned explorer.exe process in the Process Hacker listing

Launch **Process Hacker**:

![picture 241](../images/9213e7a2a8aaa7f0c4e8b093d3229203cf95c7df15ebf0fa81c3e6b12f6cccea.png)  

<br/>

Then run `known.exe` as admin:

![picture 242](../images/cfb2f5de85087429f4b896935276cfa7574dd582b5dd518d923832dcc2029836.png)  

- We can see a new `explorer.exe`
- `PID` = 1176 in this case

<br/>

---

## 3 - Use Process Hacker to extract injected code from the memory of the newly spawned explorer.exe process, naming the file explorer-dumped.exe

In **Process Hacker**, right click the spawned `explorer.exe` and select `Properties`.

![picture 243](../images/8da9d826a2f52b9466c73e5f9f327975f33810cd6446cf82e7d88c93e2d4bf12.png)  

<br/>

From the memory analysis, we know that the injected code is around 132K bytes. Locate a memory region with size of 132K bytes:

![picture 244](../images/810a86d99b2c19297296aeec08cbdbb87ffa52b15241fb6e2e8af7032b3cec4d.png)  

- Note the Execute flag `X`
- Base address: `2bb0000`

<br/>

Double click the region and we can see the Windows PE magic bytes `MZ`:

![picture 245](../images/1a06fb4bc4233eefaf5c25893659156a50806e580b44bc6fe56ec0f233c748e0.png)  

<br/>

Click `Save ...` and name it `explorer-dumped.exe`:

![picture 246](../images/54abe79eb646b8569a491b421976a468e597d4e79957efa24a56246f2dae8a48.png)  

<br/>

---

## 4 - Use pe_unmapper to fix up the explorer-dumped.exe file, generating the file named explorer-dumped-fixed.exe

Try to open the dump file in **PeStudio**:

![picture 247](../images/b4114f4f83e326998362031f495edc089caef50f4c4514e69ffe1c33588002d8.png)  

- Null import table

<br/>

To fix, use `pe_unmapper`:

```
pe_unmapper explorer-dumped.exe 2bb0000 explorer-dumped-fixed.exe
```

![picture 248](../images/82f76ab673eb228f20e1cf84948748a6f71c90e38ee1c45da14f1531ca30c50b.png)  

![picture 249](../images/9262e16a9db37526cb9b79c5422df4a6ed507085e6dd411d2ee393d754b126f6.png)  

<br/>

Check it on **PeStudio** again:

![picture 250](../images/ebfe66069d8a7199d6fed3633cfc83fcba20ec9658ff90e85e70d6beb9153109.png)  

<br/>

---