# Lab 4.2: Dumping and Fixing brbbot.exe Using Scylla

- [Lab 4.2: Dumping and Fixing brbbot.exe Using Scylla](#lab-42-dumping-and-fixing-brbbotexe-using-scylla)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Try to use UPX on Windows to unpack brbbot.exe](#1---try-to-use-upx-on-windows-to-unpack-brbbotexe)
  - [2 - Use setdllcharacteristics to disable Dynamic Base](#2---use-setdllcharacteristics-to-disable-dynamic-base)
  - [3 - Infect the Windows machine with brbbot.exe](#3---infect-the-windows-machine-with-brbbotexe)
  - [4 - Dump brbbot.exe using Scylla x64](#4---dump-brbbotexe-using-scylla-x64)
  - [5 - Use Scylla x64 to fix the IAT](#5---use-scylla-x64-to-fix-the-iat)
  - [6 - Examine the dumped and fixed file in PeStudio](#6---examine-the-dumped-and-fixed-file-in-pestudio)

---

## Objectives

- Learn to unpack malware by dumping it from memory using tools such as **Scylla**.

<br/>

---

## Steps

1. Attempt using UPX on the Windows REM Workstation to unpack `brbbot.exe`.
2. Use setdllcharacteristics to designate brbbot.exe as being incompatible with ASLR.
3. Infect the Windows REM Workstation with brbbot.exe.
4. Dump the brbbot.exe using Scylla x64.
5. Use Scylla x64 to fix the IAT of the dumped brbbot.exe file.
6. Examine the dumped and fixed file in PeStudio.

<br/>

---

## 1 - Try to use UPX on Windows to unpack brbbot.exe

Using `cmd.exe`, navigate to `%APPDATA%` and run:

```
upx -d brbbot.exe
```

![picture 361](../images/d74087607c50d9d6f2fa2db6d520db54c551e97b501d8b104f95a59d2c6effd8.png)  

- Unsuccessful - It is modified / hacked / protected

<br/>

---

## 2 - Use setdllcharacteristics to disable Dynamic Base

Continuing using the CMD in #1, run:

```
setdllcharacteristics -d brbbot.exe
```

![picture 362](../images/cd5cbb1ce1bcfbdd0cc1e6f2f44b45aae90c918d5c574f26d0cc17069a6b755a.png)  

- As shown, the `DYNAMIC_BASE` flag has changed from 1 to 0.

<br/>

---

## 3 - Infect the Windows machine with brbbot.exe

Double click the shortcut on the Desktop created in Lab 4.1.

Run **Process Hacker** to confirm it is running:

![picture 363](../images/738e240e80e91d3a37a3b51039b6a8084c5f7d38441ecd58ffe69b54a7f458f7.png)  

<br/>

Inspect the Memory String by navigating to `Memory > Strings`:

![picture 364](../images/9b7febeb58a927595bc2ab43b99a555cd2626ccde0d3c43520e1860e10d4b80f.png)  

- Some artifacts and suspicious URL are found


<br/>

---

## 4 - Dump brbbot.exe using Scylla x64

Launch **Scylla x64** and pick the active process `brbbot.exe`:

![picture 365](../images/41ce716565614f3fb5e8da82f0a6d3bb4255bad91a0909bd1d759f03bb5493f0.png)  

<br/>

Dump it by clicking `Dump`:

![picture 366](../images/e185742f7dfbb917c0dd8acd5682196b36c3f71a9182fb39caab90c8034f0b2c.png)  

<br/>

![picture 367](../images/7a8dd6e8b4318ff4915bdd24e840d29bc40193f93604c341f7e97051ee2f0dfc.png)  

<br/>

---

## 5 - Use Scylla x64 to fix the IAT

Click `IAT Autosearch`:

![picture 368](../images/d009ac3f0e94a44a57f10f9f0ebbc3a59d10dcd6e11ab212d42c7edb25fa2964.png)  

![picture 369](../images/953dba70bc46270c4f24974b53eee50a8ec5bf950521c0757fdc3c5cebf2f674.png)  

<br/>

Then click `Get Imports`:

![picture 370](../images/4fe5b7bf3578a2914f790fe80dbebe3bd0cb7fbf1e386b2e5a7da675eb4126cd.png)  

![picture 371](../images/16c13bc018af18ad6cc6c69c92c05fbbb117b43d45f54f281889778f617a0578.png)  

<br/>

Finally click `Fix Dump`:

![picture 372](../images/a8b833e7f9437ab3cc204de05082dc4dadb19cf7191eec09b381c36ce50091e3.png)  

![picture 373](../images/1f3368b76dba982d58ee4e30070f1fdbbf41a7883b7394644dd412c150582d3b.png)  

<br/>

---

## 6 - Examine the dumped and fixed file in PeStudio

Open `brbbot_dump_SCY.exe` on **PeStudio**. Inspect the sections:

![picture 374](../images/ab31ab44b00ae60643c5158d89f2758fa21ce8b97fe41328ea3cb2363a1ea31b.png)  

- Raw size of `NPX0` is not 0 now

<br/>

Inspect the imports:

![picture 375](../images/501ca636447a47dff98f51b59566c0a2969937c88388f51ca20b3abf8cb53172.png)  

- Many more imports compared with before

<br/>

---