# Lab 3.14: Examing sbb.xlsx using oledump.py, zipdump.py and other tools

- [Lab 3.14: Examing sbb.xlsx using oledump.py, zipdump.py and other tools](#lab-314-examing-sbbxlsx-using-oledumppy-zipdumppy-and-other-tools)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Examine the streams in sbb.xlsx using oledump](#1---examine-the-streams-in-sbbxlsx-using-oledump)
  - [2 - Use oledump.py the extract the content of stream A3](#2---use-oledumppy-the-extract-the-content-of-stream-a3)
  - [3 - Edit sbb-out.js and remove non-JavaScript text](#3---edit-sbb-outjs-and-remove-non-javascript-text)
  - [4 - Use oledump and zipdump to confirm other aspects of sbb.xlsx do not contain anomalies](#4---use-oledump-and-zipdump-to-confirm-other-aspects-of-sbbxlsx-do-not-contain-anomalies)
  - [5 - Use SpiderMonkey and rev to deobfuscate sbb-out.js](#5---use-spidermonkey-and-rev-to-deobfuscate-sbb-outjs)
  - [6 - Use box-js to deobfuscate sbb-out.js](#6---use-box-js-to-deobfuscate-sbb-outjs)

---

## Objectives

- Learn how to analyze Microsoft Office documents that contain embedded JavaScript.
- Learn how to use `zipdump.py` for examining XML‐based Microsoft Office files.
- Reinforce the use of `oledump.py`, `box‐js`, and **SpiderMonkey** for the analysis of documents.

<br/>

---

## Steps
1. Examine the streams in `sbb.xlsx` using `oledump.py` to locate suspicious contents.
2. Use `oledump.py` to extract the contents of stream `A3` from `sbb.xlsx` to `sbb‐out.js`.
3. Edit `sbb‐out.js` using **SciTE** to delete non‐JavaScript text and save the modified file.
4. Optionally, use `oledump.py` and `zipdump.py` to confirm that other aspects of `sbb.xlsx` don't appear to contain anomalies.
5. Use **SpiderMonkey** and rev to deobfuscate `sbb‐out.js` and examine the results for malicious components.
6. If there is time, use `box‐js` to deobfuscate `sbb‐out.js` and examine the results to locate malicious components.

<br/>

---

## 1 - Examine the streams in sbb.xlsx using oledump

```
unzip sbb.zip -d sbb; cd sbb; ls
```

![picture 339](../images/a4f888bcc16958e5abfbe303d61ce4ddd680fffd958a162f25593cbc9e18a4d1.png)  

<br/>

Use `oledump.py` to examine the file `sbb.xlsx`:

```
oledump.py sbb.xlsx
```

![picture 340](../images/91e38ef7654afbd7bf30e3a3b4bd61e3ac1bc232112aedc464527fbf13841953.png)  

- `A3` has the largest size

<br/>

---

## 2 - Use oledump.py the extract the content of stream A3

```
oledump.py sbb.xlsx -s A3 -i
```

- `-i` shows the general information about the stream like `MD5` and header

![picture 341](../images/2448f4c661c2b805e6e13d9ec7ce2fbc949f6d795de43e95433ec2ec3283d1b8.png)  

- The text `eval(function(p` reveals codes related to JavaScript

<br/>

Dump stream A3 out:

```
oledump.py sbb.xlsx -s A3 -d > sbb-out.js
```

<br/>

---

## 3 - Edit sbb-out.js and remove non-JavaScript text

```
scite sbb-out.js
```

![picture 342](../images/22179a1b1f4cf44371a45d47e55a4794a8eaca1c9a4c9934973bd092f4c77bcd.png)  

- The content is obfuscated

<br/>

Remove the non-JavaScript components:

![picture 343](../images/d01052fda4273fdbbf23fa43d872aac6cf5e2e5aca5de7b73c7176a27250a6bd.png)  

![picture 344](../images/a6b10d2a1cd446d7b5384590ee1f7385954f6c7d2c9f290a4d14895b8ffceebf.png)  

<br/>

---

## 4 - Use oledump and zipdump to confirm other aspects of sbb.xlsx do not contain anomalies

-- Skipped

<br/>

---

## 5 - Use SpiderMonkey and rev to deobfuscate sbb-out.js

Use `js` to run the script in SpiderMonkey with the standard object:

```
js -f /usr/share/remnux/objects.js -f sbb-out.js > sbb-out2.js
```

![picture 345](../images/74c07a9c49b5d0d35aeaf33b549c6902c604160497ec37058618c705a55afdb6.png)  

- It complains there is no `ActiveXObject`

<br/>

Inspect the output file using `scite`:

![picture 346](../images/c25e3f42ec3494c9654723f11dd1fbf1bb7cf8d1cb0179375c3fecdab744d606.png)  

- It looks like there are some reversed words

<br/>

Try to use `rev` to reverse the content and inspect again:

```
rev sbb-out2.js > sbb-out3.js; scite sbb-out3.js
```

![picture 347](../images/70555466ad5ae022f512fbf5c8a5f6722ef00aed8c6a16fd0b28b70fa8d22a70.png)  

![picture 348](../images/6f6d49b0846b76c2b7ac28b8c473ad6c46a533c6e42b4cf8b4d551291725567e.png)  

![picture 349](../images/684c00224e7f8f4cd346bf5a810d0eacb4ec72c8f432585bf324d5cf88a2d20c.png)  

- Some interesting strings are revealed
- It tries to view/set the browser proxy settings
  - `"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\AutoConfigURL"`
  - `"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\AutoDetect"`
- `certutil -addstore -f -user "\ROOT` - Add SSL certificate
- `powershell -ExecutionPolicy Unrestricted` - Powershell execution

<br/>

---

## 6 - Use box-js to deobfuscate sbb-out.js

```
box-js sbb-out.js
```

![picture 350](../images/c309897b288d5cdc5db9e7e4b33f4e31d7f456f0970b4187488b22de5e3cfb13.png)  

<br/>

```
box-js sbb-out.js --no-file-exists --no-shell-error
```

![picture 351](../images/6179fe4199afd692fd5277479d39753a516a10d91e0a0c66443cbabfe0c19ff1.png)  

- Configure the victim system so the internet traffic is sent to the attacker's server in TOR network

<br/>

Also check the produced file `.\sbb-out.js.2.results/resources.json`:

![picture 352](../images/cedb71b894d49fa27c26f8171912ea6e8a22ab39816763f5ba9cbf1183445f37.png)  

- It generates some cert and ps files

<br/>

Try to convert the `der` file into text:

```
openssl x509 -in 2a7d9* -inform der -text -noout > cert.txt
```

![picture 353](../images/8a6a51816bd4ae9465e88d3e7ebee5ae012af75adc74a4dee3afeedc9edcc948.png)  

- Fake cert claiming to correspond to COMODO

<br/>

---