# Lab 4.11: Examining API Hooking Artifacts in great.vmem

- [Lab 4.11: Examining API Hooking Artifacts in great.vmem](#lab-411-examining-api-hooking-artifacts-in-greatvmem)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1,2 - Use the Volatility plugin apihooks to locate hooks in process 3228, captured in the great.vmem file](#12---use-the-volatility-plugin-apihooks-to-locate-hooks-in-process-3228-captured-in-the-greatvmem-file)
  - [3 - Determine which of the files generated by malfind in the previous exercise corresponds to the code injected into process 3228](#3---determine-which-of-the-files-generated-by-malfind-in-the-previous-exercise-corresponds-to-the-code-injected-into-process-3228)

---

## Objectives

- Learn to use the Volatility plugin apihooks to examine API hooks.
- Reinforce API hooking concepts from the perspective of memory forensics.

<br/>

---

## Steps

1. Use the Volatility plugin `apihooks` to locate hooks in process 3228, captured in the `great.vmem` file.
2. Examine the Inline/Trampoline hook reported by apihooks to determine which function was hooked and where the corresponding malicious code might reside.
3. Determine which of the files generated by `malfind` in the previous exercise corresponds to the code injected into process 3228.

<br/>

---

## 1,2 - Use the Volatility plugin apihooks to locate hooks in process 3228, captured in the great.vmem file

Use the `apihooks` plugin to scan the process 3228. Focus on the inline hook:

```
vol.py -f great.vmem apihooks -p 3228 --skip-kernel > apihooks.txt
scite apihooks.txt
```

![picture 512](../images/c2a70843356e4153e4b2d810fa8122df560013333528c6812f05b5fb903a0823.png)  

- `PUSH --> RET` pattern reveals a Tricky Jump
- This output determines `ntdll.dll` in memory of PID 3228 has been modified, and the DLL's function `LdrLoadDll` has been hooked
- The function will end up jumping to and execuing the probably malicious code at `0x1a05dbe` in the process 3228. This offset indicates the locaiton of the malicious code htat was injected in to this process

<br/>

There is also another similar hook:

![picture 513](../images/069a62b2a1624cdfdea208394817484eec3866ccf32fb4a217ea3fdaa15badb1.png)  

- The function `NtCreateUserProcess` is hooked
- The malicious code looks starting at `0x1a05c93`

<br/>

- With these 2 information, the address range where the jump lead is relatively small and is around `0x1a00000:0x1a05c93`
- We may look at the memory region that encapsulates these addresses

<br/>

---

## 3 - Determine which of the files generated by malfind in the previous exercise corresponds to the code injected into process 3228

First use `pslist` to get the virtual offset of the process 3228:

```
vol.py -f great.vmem pslist -p 3228
```

![picture 514](../images/7b0ac32a7ac091a51d9a37fb4817ed62d4b19586c43036be250d7d12b9891a01.png)  

- The offset is `0xa97fcc40`

<br/>

Then we can try to find the `DMP` file with offset `0xa97fcc40` in the `malfind` outputs:

```
ls -slh ./great/malfind-all/process.0xa97fcc40*
```

![picture 515](../images/ed5a6fb03224bca7dfc12e5780c73463086f9cbca53a1c6e31befb29774683ef.png)  

- We have 4 files match found
- In our `apihooks` result, the injected code is near `0x1a00000`
  - `process.0xa97fcc40.0x19e0000.dmp` begins with `0x19e0000` which falls into the potential malicious code range

<br/>

Make a copy of this file:

```
cp ./great/malfind-all/process.0xa97fcc40.0x19e0000.dmp ./great/malicious-jump.dmp
```

<br/>

Transfer this to the Windows machine and open it on IDA as a binary.

- Loading offset = `0x19e0000`

![picture 516](../images/b3b6c69b04338cc24b427c83bf749d692f3dc88e055da8bbee69e7bbfabc1368.png)  

<br/>

![picture 517](../images/cc7036aba70e88e6de881080e737fe068ec7d0b94c1ecd3d8ae137b3b7702755.png)  

- 32-bit mode

<br/>

Next we have to rebuild the import table so we can use it in IDA. First on REMnux, use `impscan` to identify API call names:

```
vol.py -f great.vmem impscan -p 3228 -b 0x19e0000 --output=idc > ./great/great.idc
scite ./great/great.idc &
```

<br/>

Add the following lines at the beginning of `great.idc`:

```
#include <idc.idc>
static main(void) {

```

<br/>

Add this at the end of `great.idc`:

```

}
```

<br/>

Then transfer this to Windows machine. On IDA, `File > Script file`:

![picture 518](../images/9b8682ea395e65356bcd162ca27e396f7a546610d21bfedf99f94448a8b180c6.png)  


<br/>

Then open the `Name` Subview:

![picture 519](../images/b2aa5359ddfe1630fb3b9775b004983f29b6a11c529e454b6e9265c2df4d29de.png)  

![picture 520](../images/077938ccfd6f5f2b363aa8c422f9dba71ba13abf0ecb26560f046e85f6df43e5.png)  

<br/>

---