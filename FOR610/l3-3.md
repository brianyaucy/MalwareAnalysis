# Lab 3.3: Deobfuscating fgg.js using SpiderMonkey

- [Lab 3.3: Deobfuscating fgg.js using SpiderMonkey](#lab-33-deobfuscating-fggjs-using-spidermonkey)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - View fgg.js and locate the object & method to define](#1---view-fggjs-and-locate-the-object--method-to-define)
  - [2 - Define location.href to contain the URL where the script resided](#2---define-locationhref-to-contain-the-url-where-the-script-resided)

---

## Objectives

- Learn how to deobfuscate JavaScript using script interpreters such as **SpiderMonkey**.

<br/>

---

## Steps

1. View `fgg.js` in **SciTE** to locate the object and method that we might need to define.
2. Define `location.href` to contain the URL where the script resided, which was http://www.gitporg.com/cgi‚Äêbin/index.cgi?fgg.

<br/>

---

## 1 - View fgg.js and locate the object & method to define

First on **REMnux**, unzip `fgg.zip`:

```
unzip fgg.zip -d fgg
cd fgg
```

![picture 228](../images/5320ba8b5abe9315f09583a705622a96c754f226778d86e0cdd0c16ff1ef47f6.png)  

<br/>

View `fgg.js` using **Scite**:

```
scite fgg.js
```

![picture 229](../images/28b1e588c421bd7293ef53069a28c61b6ced5a6b227310df2243ce76c9d9f14e.png)  

<br/>

Note the variable referencing `location.href`:

![picture 230](../images/5e4f2dd561df6d7d146e894031ec2f8e864895dabc63a7d0102c963f02d97f3e.png)  

<br/>

When we try to use **SpiderMonkey** on `fgg.js`:

```
js -f fgg.js
```

![picture 231](../images/66b5ca97c5bf27393518a1d273ff88bb8279d918d95ec72e4d350f5d8a2ae50a.png)  

- It shows `ReferenceError: location is not defined`

<br/>

In this case, include the **REMnux** common object:

```
js -f /usr/share/remnux/objects.js -f fgg.js > fgg_new.js
scite fgg_new.js &
```

![picture 232](../images/aff0f2842101431c6123e594beea6813883bf3e5fa319c4d52cbcfc03a82ad3d.png)  

![picture 233](../images/87f9abf84f0d7668ffc3937ac080da354aada6b836a45d013688a9fb3419e944.png)  

- However, the output is unreadable
- A possibility will be it needs a correct href location to allow the script to properly decode itself
- When doing investigation, always save details and metadata related to the malicious page

<br/>

---

## 2 - Define location.href to contain the URL where the script resided

Copy the common object to the current directory:

```
cp /usr/share/remnux/objects.js ./
nano objects.js
```

![picture 234](../images/e979c8368a8e7ce36e7f1e6991503862468e42e86bd7ed75cca15d0d4866e791.png)  

- Modify this section

<br/>

Save it and regenerate:

```
js -f objects.js -f fgg.js > fgg_new_update.js
scite fgg_new_update.js &
```

![picture 235](../images/223b86e5216d884c65a11cec6ab7ecd5ca43a7417540e5ddee966fb4174f986e.png)  

![picture 236](../images/969e6ea641756522af952c6f8f3ddb5fa2ec5012ae014927e7c39b6d76cf1252.png)  

- A suspicious URL is discovered

<br/>

---