# Lab 5.9: Understanding the SEH Defense in windowsxp2.exe

- [Lab 5.9: Understanding the SEH Defense in windowsxp2.exe](#lab-59-understanding-the-seh-defense-in-windowsxp2exe)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Load windowsxp2.exe in x32dbg, and then detach the SEH tab so that it floats as its own window in x32dbg](#1---load-windowsxp2exe-in-x32dbg-and-then-detach-the-seh-tab-so-that-it-floats-as-its-own-window-in-x32dbg)
  - [2 - Observe how windowsxp2.exe defines the SEH handler by single-stepping through the first four instructions of the specimen in x32dbg](#2---observe-how-windowsxp2exe-defines-the-seh-handler-by-single-stepping-through-the-first-four-instructions-of-the-specimen-in-x32dbg)
  - [3 - Use x32dbg to set a breakpoint in the beginning of the malicious SEH handler function 519870 in windowsxp2.exe](#3---use-x32dbg-to-set-a-breakpoint-in-the-beginning-of-the-malicious-seh-handler-function-519870-in-windowsxp2exe)
  - [4 - Run windowsxp2.exe in x32dbg to reach the breakpoint at the beginning of the malicious SEH handler function 519870](#4---run-windowsxp2exe-in-x32dbg-to-reach-the-breakpoint-at-the-beginning-of-the-malicious-seh-handler-function-519870)

---

## Objectives

- Understand how malware can use Structured Exception Handling (SEH) to misdirect the analyst.
- Understand how to use x32dbg to examine the suspicious use of SEH by malware.

<br/>

---

## Steps

1. Load `windowsxp2.exe` in **x32dbg**, and then detach the **SEH tab** so that it floats as its own window in **x32dbg**.
2. Observe how `windowsxp2.exe` defines the **SEH handler** by single-stepping through the first four instructions of the specimen in **x32dbg**.
3. Use **x32dbg** to set a breakpoint in the beginning of the malicious SEH handler function `519870` in windowsxp2.exe.
4. Run `windowsxp2.exe` in **x32dbg** to reach the breakpoint at the beginning of the malicious **SEH handler** function `519870`.

<br/>

---

## 1 - Load windowsxp2.exe in x32dbg, and then detach the SEH tab so that it floats as its own window in x32dbg

Before doing so, inspect `windowsxp2.exe` on **Exeinfo PE**:

![picture 152](../images/56c19253c6b3a96322a71576272e7e109a158dcb5199ca00f2089cbd54d1428c.png)  

- It looks like packed by `PECompact`

<br/>

Load it into **x32dbg**:

![picture 153](../images/f58a54d2bb67432879d144e44e1b33a8510f8692d9d2138bc95121fcd471a46c.png)  

<br/>

Navigate to the **SEH tab**:

![picture 154](../images/a6cc52f54869ce81855ba5da54061bced3f6f4c042b3bcbe9fca4eec939899a4.png)  


<br/>

Right-click the 1st row and choose `Follow Address`:

![picture 155](../images/ae869295a0b46e58a378d99fb3f74147d432ea0886b9b11e9cf91000673f6f48.png)  

<br/>

Note on the stack we can see `End of SEH Chain` with the value `FFFFFFFF` at `0019FFE4`:

![picture 156](../images/51d99ef625d77b7740c2d9464d1eaf16c31fc3685c50e573938771fa56739e03.png)  

<br/>

Also we can click on the `Watch` tab and right click in it, choose `Add ...`:

![picture 157](../images/777cca4679b09cf3f6f0d79d37dd7a3d591f8cfecb3f42be8df57bd054bcc7d9.png)  

![picture 158](../images/916fa38ab320f90f987fd08bb572d2ec03d619965acd5f0c128de78b79dd1482.png)  


<br/>

Then we can see it has a value of `0019FFCC`, which is a pointer to `SEH_Record[1]`:

![picture 159](../images/a8e951e1b8e81e06116200dbb0785de41595df132d551cf4ca8c6fcad478d78d.png)  

<br/>

---

## 2 - Observe how windowsxp2.exe defines the SEH handler by single-stepping through the first four instructions of the specimen in x32dbg

1st instruction: `mov eax,windowsxp2.519870`

- Save `519870` into `EAX`
- This is the address of the function that will be defined as the new SEH handler

<br/>

2nd instruction: `push eax`

- Push the value in `EAX` to the top of the stack
- This constitutes one of the 2 elements of the SEH structure that the code is defining

<br/>

3rd instruction: `push dword ptr fs:[0]`

- Save the address of the current start of the SEH chain to the stack, which is stored in `fs:[0]`
- Combined with the 2nd instruction, this value completes the new SEH structure

<br/>

4th instruction: `mov dwaord ptr fs:[0],esp`

- Set the start of the chain `fs:[0]` to point to the new SEH structure

<br/>

---

## 3 - Use x32dbg to set a breakpoint in the beginning of the malicious SEH handler function 519870 in windowsxp2.exe

At `4028FE`, `mov dword ptr ds:[eax],ecx` - this represents a common way of defining any SEH record.

<br/>

Press `CTRL-G` to jump to `519870`:

![picture 160](../images/09c2e6a02d261765c679474e9cd4f7ae24e165e6e811a6aa005663d46297adad.png)  

<br/>

Set a breakpoint at `519870`:

![picture 161](../images/0fc11ab474199b2b114e5f91bde8e06c049764f6865aff11ad8f257d0efa676a.png)  

<br/>

---

## 4 - Run windowsxp2.exe in x32dbg to reach the breakpoint at the beginning of the malicious SEH handler function 519870

![picture 162](../images/56ed1732e3203ae2bfe1931ff82b3dceb62ddeca3c409fae7cf4deb6cef16ffc.png)  

Remove the breakpoint at `519870`.

<br/>

The specimen will cause an exception by attempting to write to the part of memory that's write-protectede. This will cause Windows to execute the SEH handler that the malicious program defined, bringing you to the beginning of the function `519870`.

<br/>

---