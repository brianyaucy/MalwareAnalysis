# Lab 5.1: Patching getdown.exe to Bypass Debugger Detection

- [Lab 5.1: Patching getdown.exe to Bypass Debugger Detection](#lab-51-patching-getdownexe-to-bypass-debugger-detection)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Infect the Windows REM Workstation with getdown.exe while monitoring the specimen's network traffic using Wireshark on REMnux](#1---infect-the-windows-rem-workstation-with-getdownexe-while-monitoring-the-specimens-network-traffic-using-wireshark-on-remnux)
  - [2 - Load getdown.exe in x64dbg and locate the API call that the specimen probably uses to detect the debugger](#2---load-getdownexe-in-x64dbg-and-locate-the-api-call-that-the-specimen-probably-uses-to-detect-the-debugger)
  - [3 - Use a breakpoint in x64dbg to observe how getdown.exe detects the debugger](#3---use-a-breakpoint-in-x64dbg-to-observe-how-getdownexe-detects-the-debugger)
  - [4 - Use x64dbg to patch getdown.exe (in memory), so that the specimen is no longer effective at detecting the debugger](#4---use-x64dbg-to-patch-getdownexe-in-memory-so-that-the-specimen-is-no-longer-effective-at-detecting-the-debugger)

---

## Objectives

- Learn how to use x64dbg to patch malware that attempts to detect analysis tools.
- Start learning about the approaches that malware can employ to detect the presence of a debugger.

<br/>

---

## Steps

1. Infect the Windows REM Workstation with `getdown.exe` while monitoring the specimen's network traffic using Wireshark on REMnux.
2. Load `getdown.exe` in **x64dbg** and locate the API call that the specimen probably uses to detect the debugger.
3. Use a breakpoint in **x64dbg** to observe how `getdown.exe` detects the debugger.
4. Use **x64dbg** to patch `getdown.exe` (in memory), so that the specimen is no longer effective at detecting the debugger.

<br/>

---

## 1 - Infect the Windows REM Workstation with getdown.exe while monitoring the specimen's network traffic using Wireshark on REMnux

First on REMnux, start `fakedns` and `wireshark`:

```
wireshark &
fakedns
```

![picture 1](../images/3693d6e1ddec118c94a2d4a73d9f6079b2b82279f46fe91ee67a0bb826e71445.png)  

<br/>

On Windows, run `getdown.exe` with admin privilege. Inspect **Wireshark**:

![picture 2](../images/36a63e77566e9da48e1dbcfe4566ffd70a301394865d73767a74ef3cab426be4.png)  

- A web traffic to `1.234.27.146:80` is observed.

<br/>

If we load it into **x64dbg** and run it, the web traffic is undetected by **Wireshark**:

![picture 14](../images/032cf331c2e730a27d5aa0c190074bdaf23f4e363399573419d999f7dbcc9d6c.png)  

![picture 15](../images/55183448dfa0ab9028b3d21627481fe59be36ebbd8b3d88310cb11926926ef76.png)  

<br/>

---

## 2 - Load getdown.exe in x64dbg and locate the API call that the specimen probably uses to detect the debugger

Drag and drop `getdown.exe` into x64dbg.

<br/>

Check the API calls by right-clicking the CPU region, `Search for > Current Region > Intermodular calls`:

![picture 3](../images/db28dda5ef19f7125404ff0ade0cac5b1ec45fb87c40548f361f5e2884255a81.png)  

![picture 4](../images/d160db80564cee30aeea1ef9c73ba0a8ba09828710326732c445425fb113b709.png)  

- `IsDebuggerPresent` can be used to detect if the program is opened by a debugger

<br/>

Click on the row and right-click. Choose `Follow in Disassembler`:

![picture 5](../images/57a7de187466e9aaeede5894d1569c5c112c0ad8a57996d3c7f928597fea17b4.png)  

![picture 6](../images/44f069fd4a76d6ea91ad5627b5ca38d9cb734e16148758799dfdba9c25ebfba1.png)  

- MSDOC for `IsDebuggerPresent`:
  - https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-isdebuggerpresent
  - Return value:
    - In the context of debuggers = `non-zero`
    - Not in the context of debuggers = `0`
- At `14000102A`, it does `test eax,eax`, where `eax` has the return value of `IsDebuggerPresent`
  - At `14000102C`, `jne getdown.140001216`, it jumps if `eax` is `non-zero`

<br/>

---

## 3 - Use a breakpoint in x64dbg to observe how getdown.exe detects the debugger

Add a breakpoint at the instruction `test eax,eax` by clicking this row, and hit `F2`:

![picture 7](../images/9705541f82942ab9c1a06f587666c1d6cb0f425ce588316a8462f22171114852.png)  

<br/>

Then run the program:

![picture 8](../images/824c660cef02cf074a69a1431cd64d0b550144dbb7d16097f09d646fcb0b349f.png)  

<br/>

Note the value in the register `RAX` (which includes `EAX`) becomes `1`:

![picture 9](../images/3006d0734a0b83ba70d972d32e2a4cb9c179c5cd042e70d9dcc732538fe33d81.png)  

- Non-zero = In the context of a debugger

<br/>

This is how the program uses `IsDebuggerPresent` to detect debugger.

<br/>

---

## 4 - Use x64dbg to patch getdown.exe (in memory), so that the specimen is no longer effective at detecting the debugger

Since it jumps if it detects `EAX` is non-zero, we can modify the `jmp` instruction so the program will not jump after it.

<br/>

To do this, we can patch the program by replacing the `jne` instruction at `14000102C` by `NOP`.

Click on the line of `jne`, and hit `<SPACE>`:

![picture 10](../images/7c106e4a77ae8ce00be5b114cce364606678a8ee2c48293906ffe04ac0fc92b3.png)  

- Input `NOP`
- Check `Fill with NOP's`
- Click `OK`

<br/>

![picture 11](../images/fd999780647955264f684b209e151ba3b00cb0cbef3d0622d1571c773a503900.png)  

- As shown, the `jne` instruction has been replaced by a series of `NOP`

<br/>

Then save the patched file by clicking `File > Patch file ... > Patch File`:

![picture 12](../images/58f42632639e2af90e663e20fb56fe9252f50bf1a84982c947ab5b1becb794ed.png)  

![picture 13](../images/12fc7c7a9d8b9c8bef699556b1cbbbd18ae6ba741be75f6d6e3a52d8af52b2b4.png)  

- Save as `getdown-patched.exe`

<br/>

Now load `getdown-patched.exe` into **x64dbg**, and try to run it again with Wireshark running in REMnux:

![picture 16](../images/1b4e5a3c8e6d82001c932eb3baee49d2840f6b619a9d78fab2c277df5023fd1c.png)  

![picture 17](../images/68b50ccf4ba61f4b174034d19c1f1d7a067b23afdc64f087d3559e345417eacb.png)  

- We see the web traffic again!

<br/>

Remember we can fake a response by enabling `iptables` NAT redirection with a WebServer:

```
accept-all-ips start
sudo python -m SimpleHTTPServer 80
```

<br/>

Re-run the sample and inspect on **Wireshark**:

![picture 18](../images/e3d2f0e049caaf8aa67fdd84868d5d60b3432de6cf44cb604ae3c67b0d0b6e16.png)  

- The sample try to download `pcfix.exe` and supply a parameter `affid`, which is likely to be used to track the infection
- Lab 1.7

<br/>

---