# Lab 5.7: Getting Around the Sandbox Detection Capabilities of winhost32-dumped.exe

- [Lab 5.7: Getting Around the Sandbox Detection Capabilities of winhost32-dumped.exe](#lab-57-getting-around-the-sandbox-detection-capabilities-of-winhost32-dumpedexe)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Use IDA to locate the code in winhost32-dumped.exe that references the string http://google.com](#1---use-ida-to-locate-the-code-in-winhost32-dumpedexe-that-references-the-string-httpgooglecom)
  - [2 - Use IDA to examine sub_401550 in winhost32-dumped.exe to understand the purpose of this function](#2---use-ida-to-examine-sub_401550-in-winhost32-dumpedexe-to-understand-the-purpose-of-this-function)
  - [3 - Use IDA to examine sub_401A90 in winhost32-dumped.exe to understand the purpose of this function](#3---use-ida-to-examine-sub_401a90-in-winhost32-dumpedexe-to-understand-the-purpose-of-this-function)
  - [4 - Determine how winhost32-dumped.exe reacts to a failed or successful google.com connection by examining the code that calls function sub_401A90 in IDA](#4---determine-how-winhost32-dumpedexe-reacts-to-a-failed-or-successful-googlecom-connection-by-examining-the-code-that-calls-function-sub_401a90-in-ida)
  - [5 - Rename winhost32-dumped.exe to WinHost32.exe, move the file from the Desktop to the C:\Users\REM folder, and then disable DynamicBase of the file](#5---rename-winhost32-dumpedexe-to-winhost32exe-move-the-file-from-the-desktop-to-the-cusersrem-folder-and-then-disable-dynamicbase-of-the-file)
  - [6 - Patch WinHost32.exe in x32dbg so that it infects the system, even when the specimen is unable to connect to http://google.com](#6---patch-winhost32exe-in-x32dbg-so-that-it-infects-the-system-even-when-the-specimen-is-unable-to-connect-to-httpgooglecom)
  - [7 - If there is time, save the patched file from within x32dbg to the file system](#7---if-there-is-time-save-the-patched-file-from-within-x32dbg-to-the-file-system)

---

## Objectives

- Understand how malware can detect the presence of a sandbox by checking the state of network connectivity.
- Reinforce static code analysis techniques that employ IDA.
- Reinforce the code patching capabilities of x32dbg.

<br/>

---

## Steps

1. Use **IDA** to locate the code in `winhost32-dumped.exe` that references the string `http://google.com`.
2. Use **IDA** to examine `sub_401550` in `winhost32-dumped.exe` to understand the purpose of this function.
3. Use **IDA** to examine `sub_401A90` in `winhost32-dumped.exe` to understand the purpose of this function.
4. Determine how `winhost32-dumped.exe` reacts to a failed or successful `google.com` connection by examining the code that calls function `sub_401A90` in IDA.
5. Rename `winhost32-dumped.exe` to `WinHost32.exe`, move the file from the Desktop to the `C:\Users\REM` folder, and then disable DynamicBase of the file.
6. Patch `WinHost32.exe` in `x32dbg` so that it infects the system, even when the specimen is unable to connect to `http://google.com`.
7. If there is time, save the patched file from within **x32dbg** to the file system.

<br/>

---

## 1 - Use IDA to locate the code in winhost32-dumped.exe that references the string http://google.com

First load `winhost32-dumped.exe` into **IDA**. Click `View > Open subviews > Strings`:

![picture 89](../images/f14ae656690bb88bf600aef8218530592ed26ec4b896382da6d3467ee2f4bcd1.png)  

<br/>

![picture 90](../images/52fa5953757803eb555b01a22596a41af39dd56dd39ff0bad1ca7b8af09450e3.png)  

- `http://google.com` is referenced at `004041F8` in `.rdata`

<br/>

Double click and we can find **IDA** calls this as `aHttpGoogleCom`. Click on it and hit `x`:

![picture 91](../images/354a15d421ad81e381220167a088c1a601ab363a810292d3d78fb24e8f348c95.png)  

- Click `OK` to jump to the referencing location

<br/>

![picture 92](../images/25bafa3299de511d2bf4fb9470c6f99a39e2f275cf40a786c4ad35b9dea5ff8d.png)  

- `aHttpGoogleCom` is referenced at `401ACC`

<br/>

---

## 2 - Use IDA to examine sub_401550 in winhost32-dumped.exe to understand the purpose of this function

![picture 93](../images/7c1a03a8c71744dd6f7223754bcc8d0b12bbc33c95057c80e9bcb86c2c9aa87d.png)  

- At `401AD1`, there is a function call `sub_401550`, which used the value `http://google.com`

<br/>

Double click on `sub_401550` to inspect.

![picture 95](../images/6c01c40b32b721abc7b04321794dac0fdd78b5df080d7d0304c5a9522de9dd0e.png)  


![picture 94](../images/33777090c8e9e53f6595b7ac44c8b089ab4d89a760ac14ea819604a9d9ebf0a4.png)  

- There is a function call `InternetCrackUrlA`
- The 1st parameter is `lpszUrl`, which is `http://google.com`

<br/>

Look up MSDOC to understand the API call `InternetCrackUrlA`:

- https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetcrackurla
- Purpose:
  - Cracks a URL into its component parts.
- Parameters:
  - `lpszUrl`:
    - Pointer to a string that contains the canonical URL to be cracked.
  - `dwUrlLength`:
    - Size of the lpszUrl string, in TCHARs, or `zero` if `lpszUrl` is an ASCIIZ string.
  - `dwFlags`:
    - Controls the operation. This parameter can be one of the following values.
      - ICU_DECODE
      - ICU_ESCAPE
  - `lpUrlComponents`:
    - Pointer to a `URL_COMPONENTS` structure that receives the URL components.
- Return value:
  - `TRUE` if the function succeeds
  - `FALSE` otherwise

<br/>

The `InternetCrackUrlA` call at `4015BB` will break the URL into its components and save it to the pointer location of `lpUrlComponents`.

<br/>

Examine the function call parameter assignements:

- `lpszUrl`: Will be the pointer go `http://google.com`
- `dwUrlLength`: 
  - `0` = ASCII string
- `dwFlags`:   
  - `0` = ?
- `lpUrlComponents`
  - `eax`, which is pointing to `[ebp+UrlComponent]`

<br/>

For the instructions here, we can see how the URL will be broken:

![picture 96](../images/07936a4dfa610609e111c11ab5302887d4fd9688810169eb8745cd6626dc753c.png)  

- `UrlComponents.dwStructSize`
- `UrlComponents.lpszHostName` - this points to the local variable `szServerName`
- `UrlComponents.dwHostNameLength`
- `UrlComponents..lpszUrlPath`
- `UrlComponents.dwUrlPathLength`

<br/>

It is expected that `google.com` will be placed in `szServerName`

<br/>

Scroll down and we can see a function call `InternetConnectA` at `401670`:

![picture 97](../images/bff5569aba237560b6f6b5a08280cf439955912bdc5e1a4b86fdb4c7eaa9de7a.png)  

- https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetconnecta
- Purpose:
  - Opens an File Transfer Protocol (FTP) or HTTP session for a given site.
- Return:
  - Returns a valid handle to the session if the connection is successful, or NULL otherwise. 

<br/>

This program tries to connect to `lpszServerName`, and save the return value to `hConnect`. If the connection succeed, it jumps to `40168C`.

<br/>

![picture 98](../images/5643c9a139bcf1711b3cb20a571412c3de60394c408ff524f475a1ca10f7edc6.png)  

- Then it call `HttpOpenRequestA` at `4016B1`
- Then some other Internet / HTTP related API calls

<br/>

![picture 99](../images/d43e1617dde80f152120c3980c5d8abee53311537c8e0c897643822a4a1bdb37.png)  

- At `4017C5`, there is an API call `InternetReadFile`
- https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetreadfile
  - Purpose:
    - Reads data from a handle opened by the InternetOpenUrl, FtpOpenFile, or HttpOpenRequest function.
  - Parameters:
    - `hFile`: Handle returned from a previous call to InternetOpenUrl, FtpOpenFile, or HttpOpenRequest.
    - `lpBuffer`: Pointer to a buffer that receives the data.
    - ...
- That's to say, the HTTP response from `google.com` will be save to the location specified in `lpBuffer`

<br/>

![picture 100](../images/58392e4b3f8b3de43b56b435bf63a7d2bdb83b69d953868f3270438713a5a3f1.png)  

- If the request is successful, `eax` will be set to `1` and jump to `401840`
- Otherwise, `eax` will be set to `0`

<br/>

Overall, this subroutine is used to check the Internet connectivity by trying to resolve `google.com`

<br/>

---

## 3 - Use IDA to examine sub_401A90 in winhost32-dumped.exe to understand the purpose of this function

Continue to examine the instruction in the subroutine `401A90`, which calls `401550` to try resolving `google.com`.

<br/>

In #2, if `google.com` is resolved successfully, `eax` will be `1`.

<br/>

![picture 101](../images/8afddd26f33fb55328b9c5f778e04c08b7e04f022189bad82613d93654a16974.png)  

- At `401AD9`, it compares `1` with `eax`, which is essentially checking if there is an internet connectivity
- It jumps away if the request to `google.com` fails

<br/>

Then we can see a series of `cmp` instructions:

![picture 102](../images/8e75864d5f8a7a58ae2dd861ee46bdbd2d6dee7c6fd319c331fbebc227b8f22f.png)  

- `Buffer` contains the response content of `google.com`

<br/>

Convert the hex value to ASCII by right-clicking each of them:

![picture 103](../images/3af17852d7d254bb461720933480ec15a6f10a67743d043ef0aba0dc16aba6b5.png)  

- Basically this check the first 4 bytes of the buffer and compare with the strings `<!do`

<br/>

In fact if we inspect `https://google.com`, the source code will be starting with `<!doctype html>`:

![picture 104](../images/a888eb6098b269f7e7524f5f6fb808114bd89bc95f1cda45ace71da5981de002.png)  

<br/>

In summary, this subroutine is checking if the web page it downloaded from `http://google.com` begines with the string `<!do`.

<br/>

---

## 4 - Determine how winhost32-dumped.exe reacts to a failed or successful google.com connection by examining the code that calls function sub_401A90 in IDA

If any character is unmatched, it jumps to `loc_401B3B`. If the checking is successful, `var_20C` will be assigned with `1`.

![picture 105](../images/ead0f51aceb519471fa19c808156cd0131124538e4db36e3fd86f07b66ef5208.png)  


- At `401B3B`, `eax` will be assinged with the value set in `var_20C`
- The function return will be `1` if it successfully requests `google.com` and gets the content starting with `<!do`

<br/>

Examine the function calling `sub_401A90`. Click on `sub_401A90` and hit `x`:

![picture 106](../images/6f554840f2923a70173c6a968c464334e7d6cedba27ea8a08804c1ca403dfe40.png)  

<br/>

![picture 107](../images/5d0d15347af3426a0bd6db268bb27f6e64aaf52a661c850da2f6f482c83c5440.png)  

- `test eax, eax` - Check if it is `1`
  - `jnz`: If `1` (request to Google successfully), jump to `loc_4023C6`
  - Otherwise, sleep `60000 ms` before jumping to `loc_4023A3`

<br/>

---

## 5 - Rename winhost32-dumped.exe to WinHost32.exe, move the file from the Desktop to the C:\Users\REM folder, and then disable DynamicBase of the file

![picture 108](../images/4ec46d4d2866c630677309e9774766c33a75d44ee7aaf3b2045b19e5d9ead0af.png)  

<br/>

To disable DynamicBase, open `WinHost32.exe` in **CFF Explorer**:

![picture 109](../images/3a65e68b71cd12e39bdb646b5fba62f46bb31c3607d67730def7aeafb0b8362a.png)  

- Uncheck `DLL can move` here in the `DllCharacteristics`

<br/>

---

## 6 - Patch WinHost32.exe in x32dbg so that it infects the system, even when the specimen is unable to connect to http://google.com

Open `WinHost32.exe` in **x32dbg**. Click `Ctrl+G` and jump to `4023B6`:

![picture 110](../images/0d63d71c7334ab8ff9aefefa929c4ea7f7e689595aae66382336720bd02b5110.png)  

<br/>

To patch, we can modify the jump instruction at `004023B7` from `jne` to be `jmp`. Double click it and change `jne` to `jmp`:

![picture 111](../images/1b23cdb810a559279604be9d44d8b90d262d45d02e53af08cc21efd75b38b28e.png)  

![picture 112](../images/440323f887abcaa8a5225b6fd0e1fa88a337bf0e8bbdf4b883610bb2e80f8a13.png)  

<br/>

---

## 7 - If there is time, save the patched file from within x32dbg to the file system

`File > Patch file ...`:

![picture 113](../images/99848491707a26e41331c34fb580bfebe86358121566aa6fe723f70744f2a114.png)  

<br/>

![picture 114](../images/a4ce518a200294e09d6587f300dcf6c743c5fca069735f36fee28c05a8ea414b.png)  

- Click `Patch File` and save as `winhost32-dumped-patched.exe`

<br/>

Now compare the result of patched and unpatched.

<br/>

First run `fakedns` on **REMnux**. Then run the unpatched `winhost32-dumped.exe`:

![picture 115](../images/bad27ad43f7c84b241587e719f25a12745bc654fbed28b5c9185bb50510353b7.png)  

- We can only see the request to `google.com`

<br/>

Then run the patched `winhost32-dumped-patched.exe`:

![picture 116](../images/1efd911c944957b2c739413d000c7e86b3b660ef6305bcd2e43bee1e179c3188.png)  

- We can see some more DNS queries to `api.ipify.org`, `callereb.com`, `supketwron.ru` and `witjono.ru`

<br/>

---