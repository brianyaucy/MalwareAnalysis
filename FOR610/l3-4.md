# Lab 3.4: Deobfuscating contact_vcf.wsf using box-js

- [Lab 3.4: Deobfuscating contact_vcf.wsf using box-js](#lab-34-deobfuscating-contact_vcfwsf-using-box-js)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Use SpiderMonkey to deobfuscate contact_vcf.wsf](#1---use-spidermonkey-to-deobfuscate-contact_vcfwsf)
  - [2 - Use box-js to deobfuscate the script](#2---use-box-js-to-deobfuscate-the-script)
  - [3 - Examine the content of the contact_vcf.wsf.2.results directory](#3---examine-the-content-of-the-contact_vcfwsf2results-directory)

---

## Objectives

Learn how to use JavaScript environment emulators such as `box‐js` to deobfuscate scripts.

<br/>

---

## Steps

1. Use **SpiderMonkey** to deobfuscate the `contact_vcf.wsf` script.
2. Use **box‐js** to deobfuscate the `contact_vcf.wsf` script and examine the results.
3. Examine the contents of the `contact_vcf.wsf.2.results` directory.

<br/>

---

## 1 - Use SpiderMonkey to deobfuscate contact_vcf.wsf

First unzip the file:

```
unzip contact.zip -d contact
cd contact
```

![picture 237](../images/d7063eb5976928218de40bc5b71aa521ac76107e29a6010686d04624b972dc8b.png)  

<br/>

Inspect the file `contact_vcf.wsf`:

```
scite contact_vcf.wsf
```

![picture 238](../images/c9656634ab516c9aa8bcd9db76a61f0517a51bcb760de784b06111184e8dc49a.png)  

- As shown, it is obfuscated

<br/>

Try to deobfuscate it using **SpiderMonkey**:

![picture 239](../images/2b77d53a4a774c3045f0758d95d32a3c4e32b56ad11663d0a91498afa43698bd.png)  

- Reference error occurs

<br/>

Try to apply the common object and try again:

```
js -f /usr/share/remnux/objects.js -f contact_vcf.wsf > contact_vcf_new.wsf
scite contact_vcf_new.wsf &
```

![picture 240](../images/15c6bff0ac66076b83783ad8708a1d33fab53676c6e52fe234a7c54309637fb6.png)  

![picture 241](../images/6e1264699bbab8f5bcb24976aa6c5259212711ac1755d374b08116deda726c7f.png)  

- The said undefined variable is highlighted

<br/>

---

## 2 - Use box-js to deobfuscate the script

Instead use `box-js` to deobfuscate - which emulates common runtime components:

```
box-js contact_vcf.wsf
```

![picture 242](../images/5ce91a9148059b9f4a29e6c9785c17de1e96a055797335d8f8fe67afeff7ba66.png)  

- It makes request to `http://sapanboon.com/ne7ptotr`

<br/>

We can inspect all of the URL captured in the result directory:

```
more contact_vcf.wsf.results/urls.json
```

![picture 243](../images/127c8b896d48ae6171c778fc05bdda02c595e143dd39e645ea8e57c5aa9eba6f.png)  

- URLs found:

```
http://sapanboon.com/ne7ptotr
http://raiaepeuhl.net/7d5c8q
http://kf-design.com/nea9o
http://kikitikor.com/8pyd413
```

<br/>

---

## 3 - Examine the content of the contact_vcf.wsf.2.results directory

First we can check the file type:

```
cd contact_vcf.wsf.2.results/
file *
```

![picture 244](../images/4da89fadda903815a4748d620530ae0d5840245ff745ffec2125ff9ab504de2f.png)  

<br/>

Obtain the hashes of the PE file:

```
md5sum 795fd790-3b68-4727-a571-595d16504831; sha256sum 795fd790-3b68-4727-a571-595d16504831
```

- Result:

```
861ee719ced3e7054db60864c669619d  795fd790-3b68-4727-a571-595d16504831
67fb85ceb25ec29723c962e58f273b85b5e834814bf0c24dc99f55a26aa0fe2e  795fd790-3b68-4727-a571-595d16504831
```

<br/>

Examine it using `peframe`:

```
peframe 795fd790-3b68-4727-a571-595d16504831
```

![picture 245](../images/cf04c754abb7c0eb0cbf50582a0c93b0001d13120c3811af233d696bf1192f3f.png)  

![picture 246](../images/388c6ff02fba02462dbf74630a727cd5bbbe850ad1e67d578b986dca73b1cccb.png)  

- Suspicious API function imported

<br/>

---