# Lab 5.2: Deobfuscating String Encoded Using Simple and Common Algorithms

- [Lab 5.2: Deobfuscating String Encoded Using Simple and Common Algorithms](#lab-52-deobfuscating-string-encoded-using-simple-and-common-algorithms)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Use XORSearch on REMnux to locate the malicious URL obfuscated inside getdown.exe](#1---use-xorsearch-on-remnux-to-locate-the-malicious-url-obfuscated-inside-getdownexe)
  - [2 - Use brxor.py and bbcrack.py on REMnux to deobfuscate strings concealed within hubert.dll](#2---use-brxorpy-and-bbcrackpy-on-remnux-to-deobfuscate-strings-concealed-within-hubertdll)
  - [3 - Load 9.exe into IDA on the Windows REM Workstation and examine the code between 40133D and 4013B8 to locate a concealed stack string](#3---load-9exe-into-ida-on-the-windows-rem-workstation-and-examine-the-code-between-40133d-and-4013b8-to-locate-a-concealed-stack-string)
  - [4 - Use strdeob.pl and FLOSS on REMnux to automatically decode stack strings from 9.exe](#4---use-strdeobpl-and-floss-on-remnux-to-automatically-decode-stack-strings-from-9exe)

---

## Objectives

- Learn common string obfuscation techniques employed by malware.
- Become familiar with using XORSearch, brxor.py, bbcrack.py, strdeon.pl, and FLOSS for decoding strings encoded using common simple techniques.

<br/>

---

## Steps

1. Use `XORSearch` on REMnux to locate the malicious URL obfuscated inside `getdown.exe`.
2. Use `brxor.py` and `bbcrack.py` on REMnux to deobfuscate strings concealed within `hubert.dll`.
3. Load `9.exe` into **IDA** on the Windows REM Workstation and examine the code between `40133D` and `4013B8` to locate a concealed stack string.
4. Use `strdeob.pl` and `FLOSS` on REMnux to automatically decode stack strings from `9.exe`.

<br/>

---

## 1 - Use XORSearch on REMnux to locate the malicious URL obfuscated inside getdown.exe

First try to use `strings` to obtain the IP address we know:

```
strings getdown.exe | grep "1."
strings --encoding=l getdown.exe | grep "1."
```

![picture 19](../images/8717e54c32624fa43e01e28318e243444ae24a67c7e857916886bcc9ced29b4f.png)  

- As shown, the IP address `1.234.27.146` is not detected

<br/>

Try to use `xorsearch` to look for the pattern `1.`:

```
xorsearch -i -s getdown.exe 1.
```

- `-i` switch = case-insensitive

![picture 20](../images/be2c37e6c64d947d0a57c5789ccae8ab231864000f4e5bb5deab9d19c8f838d5.png)  

- As shown, we can see the URL `1.234.27.146/pcfix.exe`

<br/>

---

## 2 - Use brxor.py and bbcrack.py on REMnux to deobfuscate strings concealed within hubert.dll

`brxor.py` can be used to extract obfuscated English words. Try to use it to scan `hubert.dll`:

```
brxor.py hubert.dll > brxor-hubert.txt
scite brxor-hubert.txt &
```

![picture 21](../images/f94fb30b11c6d4bd15345a1fadc13e890243e574968845117b4c58766ee45fe0.png)  

<br/>

`bbcrack.py` can be used to identify patterns within the file that might need to be decoded using basic algorithms based on XOR, ROL and ADD, or even multi-level mixture of them.

To use it to scan `hubert.dll` (try only 1 level of transformation):

```
bbcrack.py -l 1 hubert.dll > bbcrack-hubert.txt
scite bbcrack-hubert.txt &
```

![picture 22](../images/28ddabd5cdc16a30cdff8abcbfbc7d53f84f0fdba9a2be30c8faa3ae2fada476.png)  

- `hubert_identity.dll` and `hubert_xor05.dll` are the highest score files

<br/>

Use `strings` command against them:

```
strings hubert_xor05.dll | more
```

![picture 23](../images/6b4cd9d6f0b588da7cfbc7978c926e49862d86df619734258e302049e17c2e93.png)  


<br/>

---

## 3 - Load 9.exe into IDA on the Windows REM Workstation and examine the code between 40133D and 4013B8 to locate a concealed stack string

Load `9.exe` into IDA. Hit `g` and type `40133D`:

![picture 24](../images/5f73a119aea62018523ef0fa19f9aa5978729b999a531409781f85911ad3491e.png)  

![picture 25](../images/c538eb3abde83dc48df549816c02f13ff4aabbab959bb26683a13b1b09dd6a50.png)  

- Many `mov [], xxx` instructions
- Could be a stack strings

<br/>

Click on the HEX value and hit `R` to get the ASCII representation:

![picture 26](../images/13f7aa564a41c68ba6ed926855ae1c488d144f7039e33c7cb6b08f91c26d5455.png)  

- `Program Files\Common Files\` is revealed

<br/>

---

## 4 - Use strdeob.pl and FLOSS on REMnux to automatically decode stack strings from 9.exe

Also we can use `strdeob.pl` to decode stack strings on REMnux:

```
strdeob.pl 9.exe | more
```

![picture 27](../images/ab1777ab0cb446bbac026f54c6239cb7fd174f0d365bd7555abc3500986bc57e.png)  

<br/>

Additionally `floss` can also be used:

```
floss 9.exe > 9-floss.txt
scite 9-floss.txt &
```

![picture 28](../images/d329e91babf230b165ae22e3e605b99bbbe125463312396b696bc1c289eaaef0.png)  

![picture 29](../images/a9c3c67ec65f89b8fe4b54f69c7c8d32798dd5a5f42ec949ddadacc372b5ea69.png)  

<br/>

---