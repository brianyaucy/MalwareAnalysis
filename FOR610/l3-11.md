# Lab 3.11: Examining poc.doc using olevba.py, oledump.py and pcodedmp.py

- [Lab 3.11: Examining poc.doc using olevba.py, oledump.py and pcodedmp.py](#lab-311-examining-pocdoc-using-olevbapy-oledumppy-and-pcodedmppy)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Use olevba.py on poc.doc](#1---use-olevbapy-on-pocdoc)
  - [2 - Use oledump.py to check poc.doc](#2---use-oledumppy-to-check-pocdoc)
  - [3 - Use pcodedmp.py to extract and disassemble macro p-code](#3---use-pcodedmppy-to-extract-and-disassemble-macro-p-code)

---

## Objectives

- Gain familiarity with Microsoft Office documents that store macros as p‐code, rather than traditional source code.
- Learn how to use `pcodedmp.py` to extract and decompile macro p-code.

<br/>

---

## Steps

1. Use `olevba.py` to confirm that the tool finds no macros in poc.doc.
2. Use `oledump.py` to locate the potential presence of macro p‐code in `poc.doc`.
3. Use `pcodedmp.py` to extract and disassemble macro p‐code located in `poc.doc`.

<br/>

---

## 1 - Use olevba.py on poc.doc

First unzip the ZIP file:

```
unzip poc.zip -d poc; cd poc; ls
```

![picture 304](../images/b7709fab5a877e3186df009b59a813f314fd62c16728aa91db8892971ad93557.png)  

<br/>

Use `olevba.py` to check if `poc.doc` has any macro:

```
olevba.py poc.doc
```

![picture 305](../images/1ceb707aa18159782079c8950055ce749afb1ee00980f68f707fe852473f3072.png)  

- Nothing found in poc.doc

<br/>

---

## 2 - Use oledump.py to check poc.doc

Use `oledump.py` again `poc.doc`:

![picture 306](../images/97e5ad7eece387500a0aa00e4db6fe17016a295edc1d7e5eefe02e3d53240613.png)  

- The doc doesn't look like having any macro in the output of `oledump.py`

<br/>

Try to use `-s` to inspect the stream 1 by 1:

```
oledump.py poc.doc -s <stream_number>
```

![picture 307](../images/8f62e0598c7a7efa37e5178d46a5b636972afc0dbc52b4339e69272f719768a1.png)  


<br/>

![picture 308](../images/3e2ed94b708d6b286be52853c7996a9a706c89f3fdd381a070a0ddee769ee050.png)  

![picture 309](../images/0a5ce5091dda93ceb72c3e8b57aaebacfb9e62feea18378ebe5013ee22a3a57f.png)  

- Stream 7 looks suspicious since `calc.exe` is shown

<br/>

---

## 3 - Use pcodedmp.py to extract and disassemble macro p-code

Use `pcodedmp.py` to extract the macro p-code:

```
pcodedmp.py -d poc.doc
```

![picture 310](../images/171d533172323312d54f83a8755efe0bd3be5f26759cc0e1c911a3b49a1d0d37.png)  

```
Module streams:
Macros/VBA/ThisDocument - 1517 bytes
Line #0:
	FuncDefn (Private Sub Document_Open())
Line #1:
	LitStr 0x001D "This could have been a virus!"
	Ld vbOKOnly 
	Ld vbInformation 
	Add 
	LitStr 0x0006 "Virus!"
	ArgsCall MsgBox 0x0003 
Line #2:
	LitStr 0x0008 "calc.exe"
	Paren 
	ArgsCall Shell 0x0001 
Line #3:
	EndSub
```

- `ArgsCall MsgBox 0x0003 ` -> Show a message box of `This could have been a virus!`
- `ArgsCall Shell 0x0001` -> Use `Shell` to run `calc.exe`

<br/>

---