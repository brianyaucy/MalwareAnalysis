# Lab 5.10: Unpacking windowsxp2.exe Using a Stack Breakpoint

- [Lab 5.10: Unpacking windowsxp2.exe Using a Stack Breakpoint](#lab-510-unpacking-windowsxp2exe-using-a-stack-breakpoint)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Execute the first two instructions of windowsxp2.exe within x32dbg, allowing the specimen to write something to the stack](#1---execute-the-first-two-instructions-of-windowsxp2exe-within-x32dbg-allowing-the-specimen-to-write-something-to-the-stack)
  - [2 - Use x32dbg to set a breakpoint on the top of the stack in windowsxp32.exe after the specimen executes its first two instructions](#2---use-x32dbg-to-set-a-breakpoint-on-the-top-of-the-stack-in-windowsxp32exe-after-the-specimen-executes-its-first-two-instructions)
  - [3 - Run windowsxp32.exe in x32dbg until it reaches the stack breakpoint the fifth time](#3---run-windowsxp32exe-in-x32dbg-until-it-reaches-the-stack-breakpoint-the-fifth-time)
  - [4 - Check whether the specimen is unpacked by examining string references in x32dbg](#4---check-whether-the-specimen-is-unpacked-by-examining-string-references-in-x32dbg)
  - [5 - Allow windowsxp32.exe to jump to the OEP in x32dbg, and then dump the specimen using OllyDumpEx, saving the file as windowsxp2_dump.exe](#5---allow-windowsxp32exe-to-jump-to-the-oep-in-x32dbg-and-then-dump-the-specimen-using-ollydumpex-saving-the-file-as-windowsxp2_dumpexe)
  - [6 - Fix the IAT of the windowsxp2_dump.exe file by invoking Scylla from within x32dbg](#6---fix-the-iat-of-the-windowsxp2_dumpexe-file-by-invoking-scylla-from-within-x32dbg)
  - [7 - Execute the windowsxp2_dump_SCY.exe file to confirm that it runs and then, if time permits, load it in BinText to confirm that it's unpacked](#7---execute-the-windowsxp2_dump_scyexe-file-to-confirm-that-it-runs-and-then-if-time-permits-load-it-in-bintext-to-confirm-that-its-unpacked)

----

## Objectives

- Learn how to unpack malware by setting a stack breakpoint in anticipation of the unpacker cleaning up the stack close to the Original Entry Point (OEP).
- Reinforce the use of OllyDumpEx and Scylla as part of the unpacking process

<br/>

---

## Steps

1. Execute the first two instructions of `windowsxp2.exe` within **x32dbg**, allowing the specimen to write something to the stack.
2. Use **x32dbg** to set a breakpoint on the top of the stack in `windowsxp32.exe` after the specimen executes its first two instructions.
3. Run `windowsxp32.exe` in **x32dbg** until it reaches the stack breakpoint the fifth time.
4. Check whether the specimen is unpacked by examining string references in **x32dbg**.
5. Allow `windowsxp32.exe` to jump to the `OEP` in **x32dbg**, and then dump the specimen using **OllyDumpEx**, saving the file as `windowsxp2_dump.exe`.
6. Fix the IAT of the `windowsxp2_dump.exe` file by invoking **Scylla** from within **x32dbg**.
7. Execute the `windowsxp2_dump_SCY.exe` file to confirm that it runs and then, if time permits, load it in **BinText** to confirm that it's unpacked.

<br/>

---

## 1 - Execute the first two instructions of windowsxp2.exe within x32dbg, allowing the specimen to write something to the stack

Hit `F7` 2 times:

![picture 163](../images/205cd0ca4881023d1aca36136e15cb0c098e260773700274ddbb3d33b8f6f11b.png)  

- `519870` is saved in `EAX`

<br/>

---

## 2 - Use x32dbg to set a breakpoint on the top of the stack in windowsxp32.exe after the specimen executes its first two instructions

On the stack, right click the top one, `Breakpoint > Hardware,Access > Dword`:

![picture 164](../images/32c41f7ff24ca1f31a29e92a67672487df4e7ff0f23a86d7fbf672c8b604e831.png)  

<br/>

---

## 3 - Run windowsxp32.exe in x32dbg until it reaches the stack breakpoint the fifth time

Click on the `Run` button:

![picture 165](../images/d1c0f0d98caea366943776a172e581acfcb69a127847b625290c00b92c5fd221.png)  

<br/>

![picture 166](../images/df5fd6d3988456a738b9804c8f5fdeb80819a73521bfa4d79bed92f3498709b2.png)  

- Note the module now is `ntdll.dll`

<br/>

Hit `Run` again, till the module shows `windowsxp2.exe`:

![picture 167](../images/4d190e9c0179b201cfd57d8a8daf69e20bd7154ad615702a7225533c29ae59ee.png)  

<br/>

---

## 4 - Check whether the specimen is unpacked by examining string references in x32dbg

Right click on the panel > `Search for > Current Module > String References`:

![picture 168](../images/4c06b1659c84bced1535cb4876a27e4010ccc8b81087cf146ab41c0692e4ad89.png)  

<br/>

![picture 169](../images/949b9332104c1418bdd701cb29f6533bd5ccb0ddc12625f9628eb72f73571df4.png)  

- There are only 2 string references.
- This shows the specimen is still not unpacked

<br/>

---

## 5 - Allow windowsxp32.exe to jump to the OEP in x32dbg, and then dump the specimen using OllyDumpEx, saving the file as windowsxp2_dump.exe

Click Run once more, the program stops at `51993D`:

![picture 170](../images/e210c69e914aa4fee89a1fb4c476a375be8902cacdcc9686296a5c2aea797115.png)  

<br/>

The first instruction is `jmp eax` - which is probably jumping to the `OEP`.

<br/>

Hit `F8` to step over - which brings us to `4028E8`:

![picture 171](../images/79b045690004df80ddc8b2f8ed48dd59db7bddea791dcfd854486fec58dc8b2e.png)  

<br/>

Right click on the panel > `Search for > Current Module > String References`:

![picture 172](../images/fc32b699642e28417003d1e448ff812699ad2e7ba8c973641f55806d8345bfb0.png)  

![picture 173](../images/763d943fea9e5d72ef291e665866b6fda0911f06f790138e019d24501d50d000.png)  

- Many strings references
- This is likely unpacked

<br/>

When the `EIP` at `4028E8`, click `Plugins > OllyDumpEx > Dump process`:

![picture 174](../images/c754e9600bb331f253bbb28e603872aab6cd73f0028568c0aa6ebf34cf1eb57f.png)  

<br/>

Dump:

![picture 175](../images/2b72406cbcc5a8307807801ef23011f32f4d107b2a9fab3dc61f5e61d64e8b6a.png)  

<br/>

---

## 6 - Fix the IAT of the windowsxp2_dump.exe file by invoking Scylla from within x32dbg

Click on `Plugins > Scylla`:

![picture 176](../images/64fe47cf7d22a76aa922a1eb5a7860615f0b72dfcf3c530a5217e8c826f6dd8a.png)  

<br/>

![picture 177](../images/c34bdfc6776a2a0c47bdb609ec2ca1cb05911141f292314b931355a16883f4b2.png)  

<br/>

![picture 178](../images/f39f1ff025a847b91f4c72135298848b4c7997a424af2f9c471a5a25a5ef7395.png)  

<br/>

---

## 7 - Execute the windowsxp2_dump_SCY.exe file to confirm that it runs and then, if time permits, load it in BinText to confirm that it's unpacked

Launch **Process Hacker**. Then run `windowsxp2_dump_SCY.exe`:

![picture 179](../images/c436908a15e9d01424a43b53a8cae9f9cf25179e08a1f572bc1a2190a4548a29.png)  

<br/>

![picture 180](../images/89716cef50693ec71c4385b3699023aed59065280119958e29c21f627da9947f.png)  

<br/>

Load the unpacked file into **BinText** and check if it is unpacked:

![picture 181](../images/5ea0e113b2c0f10bf2bbc00bd88f3882238e78e0695811a2e3deb23a7b2c2491.png)  

<br/>

---