# Lab 4.7: Unpacking Shellcode That Was Used by PDFXCview.exe

- [Lab 4.7: Unpacking Shellcode That Was Used by PDFXCview.exe](#lab-47-unpacking-shellcode-that-was-used-by-pdfxcviewexe)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Use x32dbg to set a breakpoint on VirtualAlloc](#1---use-x32dbg-to-set-a-breakpoint-on-virtualalloc)
  - [2 - Allow VirtualAlloc to complete its execution, and then direct x32dbg to display contents of the allocated memory region in the Dump 1 pane of the CPU tab](#2---allow-virtualalloc-to-complete-its-execution-and-then-direct-x32dbg-to-display-contents-of-the-allocated-memory-region-in-the-dump-1-pane-of-the-cpu-tab)
  - [3,4,5 - Continue running the specimen in x32dbg, so that it reaches the VirtualAlloc breakpoint the second time. Direct the EAX to Dump 2](#345---continue-running-the-specimen-in-x32dbg-so-that-it-reaches-the-virtualalloc-breakpoint-the-second-time-direct-the-eax-to-dump-2)
  - [6 - Extract the program in Dump 2 by using x32dbg Memory Map](#6---extract-the-program-in-dump-2-by-using-x32dbg-memory-map)

---

## Objectives

- Learn to unpack malware by setting a breakpoint on VirtualAlloc.

<br/>

---

## Steps

1. Use **x32dbg** to set a breakpoint on `VirtualAlloc` in the `jmp2it` process and allow the specimen to reach this breakpoint for the first time.
2. Allow `VirtualAlloc` to complete its execution, and then direct **x32dbg** to display contents of the allocated memory region in the Dump 1 pane of the CPU tab.
3. Continue running the specimen in **x32dbg**, so that it reaches the `VirtualAlloc` breakpoint the second time.
4. Allow the second instance of VirtualAlloc to complete its execution, and then direct x32dbg to display contents of the allocated memory region in the Dump 2 pane of the CPU tab.
5. Continue running the specimen in x32dbg, so that it reaches the VirtualAlloc breakpoint the third time.
6. Extract the program displayed in the Dump 2 area to disk by using x32dbg's Memory Map.

<br/>

---

## 1 - Use x32dbg to set a breakpoint on VirtualAlloc

Continuing Lab 4.6, we found an API call `VirutalAlloc`. Set a breakpoint at the instruction by using the command `SetBPX VirutalAlloc`

![picture 462](../images/cf0c96c91999e02a3570ccb96e958d041c07a74d198d5692b5a2aa563a1878c8.png)  


<br/>

Then run the process by hitting `F9`.

![picture 463](../images/126dcf80403039d4817e3ed808f0d9c1f2a409e785e3cc84864cfe4adbe0a89e.png)  


<br/>

---

## 2 - Allow VirtualAlloc to complete its execution, and then direct x32dbg to display contents of the allocated memory region in the Dump 1 pane of the CPU tab

Now, use `Debug > Execute till return` (or hitting `Ctrl + F9`) to allow `VirtualAlloc` to execute its code and pause at the return.

![picture 464](../images/886e24c7695cd36b5fbac2fdc45c393d00c614247ab1f7335ecdb26196c96da5.png)  

<br/>

Now, `EAX` contains the return value of the function call `VirtualAlloc`. To see the memory at that address, click the `EAX` register and right-click, and then `Floow in Dump > Dump 1`:

![picture 465](../images/f80d32542cb7500668372eee14e18c44048ac52612f5e3ddf300632ddeb5eef0.png)  

<br/>

Since this is just a process of Virtual Memory space allocation, it is expected the data should be NULL:

![picture 466](../images/a3bfd6ebd91e47087bdafc026b712e7e90e993dabb0a784ce1833d6f242547f4.png)  

<br/>

---

## 3,4,5 - Continue running the specimen in x32dbg, so that it reaches the VirtualAlloc breakpoint the second time. Direct the EAX to Dump 2

Hit `F9` again to arrive at the next breakpoint (`VirtualAlloc` API call):

![picture 467](../images/4708088de8b1672b7e974ca6facf07012751fd8812256ee0671c9e352ad14d96.png)  

- Note **Dump 1** is no longer empty

<br/>

Remember in the previous analysis, it reads content from `HKLM\\software\\gxyhwinsg`. Note the data in this registry matches the content in **Dump 1**:

![picture 468](../images/c53969eb9ae518234007e00807e7175d72c44500d43a73c41c8eda62b2e7abcb.png)  

<br/>

Again, hit `Ctrl + F9` to execute till return.

![picture 469](../images/02b4015d74fdeb49d27e3b8f01207a5022787c40f2e67b1f27b09cb832e8e7a9.png)  

- `EAX` should be pointing to the address allocated

<br/>

Right click `EAX` and `Follow > Follow in Dump > Dump 2`:

![picture 470](../images/339b92eabbdb1c0c62b4eafe42a252a0670348ea5f708681375c2e045128cbfe.png)  

![picture 471](../images/af935fd44df5ade1b28e6ca62cf54cf18cd2da51b52bc4b0c450a18f330ce88f.png)  


<br/>

Again, allow the program to run and hit the next `VirtualAlloc` by hitting `F9`:

![picture 472](../images/ee9e6acfce7f1233d3f114e6fd8ceb912482624c60f705696d5199a843b201ad.png)  

- Note **Dump 2** contains a Windows PE

<br/>

--- 

## 6 - Extract the program in Dump 2 by using x32dbg Memory Map

Right click the area in **Dump 2** and click `Follow in Memory Map`:

![picture 473](../images/a1dbe0585a3face499a2154040e6485bf449ca8632a1699671f52fe32577fc58.png)  

<br/>

Right click the highlighted entry and click `Dump Memory to File`:

![picture 474](../images/c55327a7928e51e3e952f280f911d2f776698cd2276fcc29f12954001804f5cd.png)  

<br/>

![picture 475](../images/a3735302972bc62c107a8c23fdcab57133e68c9d9c3312b95d23587aa4041810.png)  

- md5,B691691EDFAFC22A2A17E4F9FD7C6E2D
- sha1,27B446AAF26D1FD780199D3FBF46B12A3F4142C2
- sha256,ACBC94EDE1E0408E2881715EB66BC766BE6856E47CA1EC75513C77219D9AF737

<br/>

---