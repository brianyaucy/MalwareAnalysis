# Ex 1.4: Decrypting brbbot.exe's Configuration File

- [Ex 1.4: Decrypting brbbot.exe's Configuration File](#ex-14-decrypting-brbbotexes-configuration-file)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1 - Load brbbot.exe on x64dgb and set breakpoint](#1---load-brbbotexe-on-x64dgb-and-set-breakpoint)
  - [2 - Confirm the specimen is using ReadFile to read brbconfig.tmp](#2---confirm-the-specimen-is-using-readfile-to-read-brbconfigtmp)
  - [3 - Decrypt brbconfig.tmp by setting and triggering a breakpoint after the call to CryptDecrypt](#3---decrypt-brbconfigtmp-by-setting-and-triggering-a-breakpoint-after-the-call-to-cryptdecrypt)
  - [3 (Alternative) - API Monitor](#3-alternative---api-monitor)
  - [4 - Decode the exfiltrated web session payload](#4---decode-the-exfiltrated-web-session-payload)
  - [Analysis update](#analysis-update)

---

## Objectives

- Understand essential aspects of examining malware at the code level using a debugger.
- Learn how to decode protected content by intercepting the specimen's use of relevant API calls.

<br/>

---

## Steps

1. Load `brbbot.exe` into **x64dbg** and set a breakpoint on `ReadFile`.
2. Confirm that the specimen is using `ReadFile` to read `brbconfig.tmp`.
3. Decrypt `brbconfig.tmp` by setting and triggering a breakpoint after the call to `CryptDecrypt`.
4. On **REMnux**, decode the exfiltrated web session payload, which was captured earlier.

<br/>

---

## 1 - Load brbbot.exe on x64dgb and set breakpoint

![picture 32](../images/5b89de6fdd6aa06ca917c3d5e037127e31cdb05bb6ea74712a1211c786ebbffe.png)  

<br/>

To locate `ReadFile` api call, in the **Command** at the bottom, enter the following command and navigate to the **Breakpoint tab**:

```
SetBPX ReadFile
```

![picture 33](../images/d9f5fbd62ae91c1e3375f1fcada48407bb6d50b8c3f248e27103542a1de485cc.png)  

<br/>

---

## 2 - Confirm the specimen is using ReadFile to read brbconfig.tmp

Next, use **Debug > Run (F9)** and arrive at the `ReadFile` breakpoint:

![picture 34](../images/828b0dd307a7f1e156ec9fbc0e0847da069a84f00650250e813a086bcc2998c4.png)  

- As shown, the **RIP** is pointing to the `ReadFile` API call.

<br/>

Now take a look at the MS document about this function:

- https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile
- Here is the function syntax:

```
BOOL ReadFile(
  HANDLE       hFile,
  LPVOID       lpBuffer,
  DWORD        nNumberOfBytesToRead,
  LPDWORD      lpNumberOfBytesRead,
  LPOVERLAPPED lpOverlapped
);
```

<br/>

These 5 arguments are corresponding to the pane here:

![picture 35](../images/5afe43167c5a5457a37e997e874cb9ac64ba2523a28832c58671681430ec4c1a.png)  

- `RCX` = `hFile` - This is the file handle (a pointer to an object). In this case, the handle is `0x100`

<br/>

To see what is pointed by the pointer, navigate to **Handles tab**. Right click on the pane and `Refresh`:

![picture 36](../images/c32b2e2e06e11da1574ee7ca3b0cd29601d6fdc044871673aeb791d92c27de0a.png)  

<br/>

Now our handle is at `0x100` - scroll down to find it out:

![picture 37](../images/a9c0c38313967c68d53e4d6204d1568ab08ebae9ab5d5733f674d6e9fca07822.png)  

- This confirms the `ReadFile` call reads the file `\Device\HarddiskVolume1\Users\REM\AppData\Roaming\brbconfig.tmp`

<br/>

---

## 3 - Decrypt brbconfig.tmp by setting and triggering a breakpoint after the call to CryptDecrypt

Go back to the **CPU tab**. Click **Debug > Run to user code (Alt+F9)**.

![picture 38](../images/539b1a314d13b4c32abe756d4d1418ac81da434926557670a28382c108d4f256.png)  

- The `RIP` is pointing to `test eax,eax` now.
- We can also see the API call `CryptoDecrypt` after several instructions
- Reference API doc: https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptdecrypt

<br/>

Now click the instruction right after the `CryptoDecrypt` call, then click **Debug > Run until selection (F4)**:

![picture 39](../images/4be657d022cda202300ed6fdc696576e428f910fee3b6e18c18378dc976e97c3.png)  

![picture 40](../images/4df7bb8dce219a286968e8273f7751078087d202f2ce61b3b729955c60b47cee.png)  

- Now in the register, we can see ASCII strings in `RSP` and `RSI` and it is likely the decrypted content

```
uri=ads.php;exec=cexe;file=elif;conf=fnoc;exit=tixe;encode=5b;sleep=30000
```

<br/>

---

## 3 (Alternative) - API Monitor

Launch **API Monitor (x64)**. Click `Enable Monitoring`:

![picture 44](../images/fe846c06cbd002650663d89c7bd00c59bd65f47d923650ac3eae3575c191ad8e.png)  

<br/>

Then run the sample. On the **API Filter**, filter out `Security and Identity > Cryptography > Data Encryption and Decryption`:

![picture 45](../images/5e08811ca165fdff26524aa00a20c29a8a683c94335f469def2ff78e7d8a21cb.png)  

<br/>

Start `brbbot.exe` by clicking `Monitor New Process` on the right:

![picture 46](../images/158e71f5c27f47e5c82beefa18fed5b939bfe9e8fbf85af6b95a01855617f342.png)  

<br/>

Check the `CryptoDecrypt` API call and inspect the hex/ascii content:

![picture 47](../images/0285f1e64141c04db3c205da3b06214f4b167c1f5bcd5661ec736a67344f5652.png)  

- It shows the decrypted content in the **Hex Buffer**


<br/>

---

## 4 - Decode the exfiltrated web session payload

Analyze the payload:

```
uri=ads.php;exec=cexe;file=elif;conf=fnoc;exit=tixe;encode=5b;sleep=30000
```

- `uri`: The URI we see in Wireshark capture
- `exec=cexe;file=elif;conf=fnoc;exit=tixe`: These look like command set. The value is in reverse order - could be an evasion.
- `encode=5b`: Could be a key for encode / encryption
- `sleep`: The callback interval

<br/>

On **REMnux**, use `xxd` to convert our captured HEX (from Wireshark capture) to BIN:

```
xxd -r -p encoded.hex > encoded.bin
```

![picture 41](../images/c61ccbc27b71cf9e59416c37292e2170ca32c0a3ad82aeca587345fea136dabc.png)  

<br/>

Decode the binary by XOR'ing each of its bytes with the key `5b`:

```
translate.py encoded.bin decoded.txt 'byte ^ 0x5b'
cat decoded.txt
```

![picture 42](../images/78ac11701e9655d41196dd145742b535024af24245337128d39cbea57c828859.png)  

- The decoded content looks like the current running processes of the infected host.

<br/>

---

## Analysis update

1. The sample uses `brbconfig.tmp` as a configuration file
2. It obfuscates exfiltrated data using a simple XOR algorithm
3. The configuration file suggests possible C2 commands

<br/>

---