# Lab 5.4: Performing Behavioral Analysis of the WinHost32.exe Infection

- [Lab 5.4: Performing Behavioral Analysis of the WinHost32.exe Infection](#lab-54-performing-behavioral-analysis-of-the-winhost32exe-infection)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1,2 - Activate Wireshark on REMnux, and activate Process Hacker and Process Monitor on the Windows REM Workstation. Infect Windows with WinHost32.exe for half a minute and terminate.](#12---activate-wireshark-on-remnux-and-activate-process-hacker-and-process-monitor-on-the-windows-rem-workstation-infect-windows-with-winhost32exe-for-half-a-minute-and-terminate)
  - [3,4 - Pause capture in Process Monitor and Wireshark. Examine the Wireshark log.](#34---pause-capture-in-process-monitor-and-wireshark-examine-the-wireshark-log)
  - [5 - Export the Process Monitor log in CSV format, load the log file in ProcDOT, and generate the ProcDOT graph to examine the infection activities](#5---export-the-process-monitor-log-in-csv-format-load-the-log-file-in-procdot-and-generate-the-procdot-graph-to-examine-the-infection-activities)

---

## Objectives

- Reinforce behavioral analysis skills.
- Set the groundwork for subsequent experimentation with WinHost32.exe.

<br/>

---

## Steps

1. Activate **Wireshark** on REMnux, and activate **Process Hacker** and **Process Monitor** on the Windows REM Workstation.
2. Infect the Windows REM Workstation with `WinHost32.exe`, allowing it to run for half a minute and then terminating the malicious process.
3. Pause capture in Process Monitor and Wireshark.
4. Examine the Wireshark log, looking for anomalous traffic.
5. Export the Process Monitor log in CSV format, load the log file in ProcDOT, and generate the ProcDOT graph to examine the infection activities.

<br/>

---

## 1,2 - Activate Wireshark on REMnux, and activate Process Hacker and Process Monitor on the Windows REM Workstation. Infect Windows with WinHost32.exe for half a minute and terminate.

On REMnux, run **Wireshark**:

```
wireshark &
```

<br/>

On Windowsm run **Process Hacker** and **Process Monitor**:

![picture 52](../images/10d5147c434387cb98b4cfa658d9bcd75e2391efe54a9aeb297d06f0295b4f49.png)  

<br/>

Start capturing on both **Wireshark** and **Process Monitor**. After that, put `WinHost32.exe` in `C:\Users\REM` and start `WinHost32.exe`:

![picture 53](../images/c0f77884b3c5bc071c0ae64b83047f72a4485750f78e7a4bbdcf92032676d58a.png)  

<br/>

Kill the `WinHost32.exe` process after 30 seconds.

![picture 54](../images/015d6dbe16057918ddb72b94717525f5a00d35fd4ba9bdf5781ab55b2b62b584.png)  

<br/>

---

## 3,4 - Pause capture in Process Monitor and Wireshark. Examine the Wireshark log.

Stop capturing on **Process Monitor** by clicking the `capture` button:

![picture 55](../images/f95bb784629f3e4e4d07ac6e6a07fc4ecdc09814237a7ada910fe6aa53571463.png)  

<br/>

Inspecting the **Wireshark** logs, apart from the Windows default DNS traffic to `xxx.microsoft.com`, there are some DNS queries trying to resolve `google.com`.

![picture 57](../images/fc0edd05270471f93be855f1430c502ec1fac04cb90a435aca695ed597308331.png)  

- This would be suspicious since we haven't done anything to resolve `google.com`

<br/>

---

## 5 - Export the Process Monitor log in CSV format, load the log file in ProcDOT, and generate the ProcDOT graph to examine the infection activities

On **Process Monitor**, click `File > Save ...`:

![picture 58](../images/5703e21539df810b1bf6f325e72164e4b0dbc11497903ab55de76d36dc5d1653.png)  

<br/>

Choose `All events` and use `CSV` format:

![picture 59](../images/d481dd4399f01e30cb610b52cc7480862583c3fc237fef455d7691df1b205021.png)  

<br/>

Also we can click `Tools > Process Tree` to inspect the process tree:

![picture 60](../images/7e3705d29c945d42e2755f638ab39a87e53b2899d3c09a3ccf30545302fec2dd.png)  

- It looks like the `WinHost32.exe` run by us spawns another `WinHost32.exe` process

<br/>

Load the `LogFile.CSV` into **ProcDOT**:

![picture 61](../images/0cf58cd18de0840ac0c8e87e3a0ff131a851b0787cbc1e8e838d054766b44892.png)  

<br/>

Choose the `Win32Host.exe` process run by ourselves (PID `4908` in this case):

![picture 62](../images/e13975a1a3f2a3ebe845b02c9facff41437e6f5313f9ebe8a28cdfb887ba1021.png)  

<br/>

Then click `Refresh`:

![picture 63](../images/8a1edb7f17f053d00ee9fcaba5bc4e4ea4c9254b52df2f618f9e3a85f328ae3c.png)  

- Same result when checking the process tree.
- No convincing malicious artifact so far.

<br/>



---