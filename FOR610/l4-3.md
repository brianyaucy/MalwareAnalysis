# Lab 4.3: Unpacking brbbot.exe by Using x64dbg and OllyDumpEx

- [Lab 4.3: Unpacking brbbot.exe by Using x64dbg and OllyDumpEx](#lab-43-unpacking-brbbotexe-by-using-x64dbg-and-ollydumpex)
  - [Objectives](#objectives)
  - [Steps](#steps)
  - [1,2,3 - Load packed brbbot.exe into x64dbg and locate the end of the unpacker. Set a breakpoint and run. Then step into and arrive at the OEP.](#123---load-packed-brbbotexe-into-x64dbg-and-locate-the-end-of-the-unpacker-set-a-breakpoint-and-run-then-step-into-and-arrive-at-the-oep)
  - [4 - Confirm that you're looking at unpacked code by searching this region for referenced strings and intermodular calls.](#4---confirm-that-youre-looking-at-unpacked-code-by-searching-this-region-for-referenced-strings-and-intermodular-calls)
  - [5 - Use OllyDumpEx to dump the brbbot.exe process, which is paused at its OEP in x64dbg.](#5---use-ollydumpex-to-dump-the-brbbotexe-process-which-is-paused-at-its-oep-in-x64dbg)
  - [6 - Use the Scylla plugin in x64dbg to fix IAT in the dumped file.](#6---use-the-scylla-plugin-in-x64dbg-to-fix-iat-in-the-dumped-file)

---

## Objectives

- Learn to unpack malware by dumping it from x64dbg with the assistance of OllyDumpEx.

<br/>

---

## Steps

1. Load the packed version of brbbot.exe from %AppData% in x64dbg and locate the likely end of the unpacker in the disassembler area of the tool.
2. Set a breakpoint at the end of the unpacker in brbbot.exe; then, run the specimen in x64dbg to reach this breakpoint.
3. Allow the specimen to execute the jump at the end of the unpacker so that it reaches and pauses at the OEP.
4. Confirm that you're looking at unpacked code by searching this region for referenced strings and intermodular calls.
5. Use **OllyDumpEx** to dump the `brbbot.exe` process, which is paused at its OEP in **x64dbg**.
6. Use the **Scylla** plugin in **x64dbg** to fix IAT in the dumped file.

<br/>

---

## 1,2,3 - Load packed brbbot.exe into x64dbg and locate the end of the unpacker. Set a breakpoint and run. Then step into and arrive at the OEP.

Load `brbbot.exe` into `x64bdg`:

![picture 376](../images/927bd366eb1814279e24982b751ab92301a79c1cfe18d60aecf754d2c8392c80.png)  

<br/>

Scroll down on the disassembled panel, until we find a bunch of `00 00` hex instruction:

![picture 377](../images/bf4cb72b65876a6633d52e8d3bb1ecb1c7407a01b833075ed829354a6e25b8e6.png)  

<br/>

Set a breakpoint at `14001A6EC` by hitting `F2`:

![picture 378](../images/11502663dc99644d0b3873d28ec6411f878460abe8a11ab49fa968e24e9b73b5.png)  

<br/>

Then run the program by clicking the `Run` button:

![picture 379](../images/88a9066d100c3dc8c996de23957c66ee9f792ef9200503965d9705b2c850b4a6.png)  

<br/>

![picture 380](../images/96ed5507d976604047880f2fccb8dde553a8d405b7e33081a963122b4604ae36.png)  

- The RIP points at the end of the unpacker

<br/>

To enter the unpacked code, single-step by hitting `F7`:

![picture 381](../images/25f7b54f8b373b68cf4a3d377d7c49b233bab7293708cbaf1a9bed078064e5c6.png)  

- Now the `RIP` is at the OEP.

<br/>


---

## 4 - Confirm that you're looking at unpacked code by searching this region for referenced strings and intermodular calls.

Right click on the disassembled panel and click `Search for > Current Region > String references`:

![picture 382](../images/cea1776c60e6fc1c5f7319c5ea6d12ec6e1470aacc9e2ad10ec1a380667e616c.png)  

<br/>

Many more strings (probably artifacts) can be found as compared to before:

![picture 383](../images/4e00ea177dfd9159e46848d3ef14cc35bcfb9c904acc2300c46526007c424a8c.png)  

<br/>

Go back to the CPU tab and again right click on the dissembled panel and click `Search for > Current Region > Intermodular calls`:

![picture 384](../images/9dbdf96521f790c477ae7c9d9e51a662b005bf73ae387eae5e1139b1a5a58aa2.png)  

<br/>

There are many more API calls as compared when unpacked:

![picture 385](../images/129e7caaea77679377043f190655faec589b097cbb83b7b2c796c646d37f9597.png)  

<br/>

These 2 signatures indicate that it is now unpacked.

<br/>

---

## 5 - Use OllyDumpEx to dump the brbbot.exe process, which is paused at its OEP in x64dbg.

Click `Plugins > OllyDumpEx > Dump process`:

![picture 386](../images/4b5760c245444a1dc7bc489b016281184a3b133cb9205eeef91f1b2e3c9f1211.png)  

<br/>

Click `Get EIP as OEP`:

![picture 387](../images/09770c84dd943b29f1fde107f1ef4737cbdaea47a11c5931c93c56dd415f8c26.png)  

![picture 388](../images/8e93bfca61eb844915d39e2aab2328c146dd5c7ef0e22ae737b78916f6d1a568.png)  


<br/>

Then to prevent memory access violation, double-click `UPX1` and enable the `MEM_WRITE` flag:

![picture 389](../images/1f7dbd4350b4c96bc18c4c302f717fb159a96aca5b2398b08d88deb22b1c43cd.png)  

<br/>

Start dumping the process by clicking `Dump` - save as `brbbot_dump_64.exe`:

![picture 390](../images/632213f1c329cb4ead76005563a586084796c950c44528d7bfc612b69822a24d.png)  

![picture 391](../images/eb5bcffa483152247cbe069aa5cbe58094fcd12b92f7a0d4de4164442cc68e61.png)  

<br/>

---

## 6 - Use the Scylla plugin in x64dbg to fix IAT in the dumped file.

Click `Plugins > Scylla`:

![picture 392](../images/6a0b0b412b55cfd56ab5665d1a8d12881996134eb3a64d2cb2de641e97facf26.png)  

<br/>

Click `IAT Autosearch`, then `Get Imports`, and `Fix Dump` finally:

![picture 393](../images/414809c4f8b7af968613fd4a78173aa45f2a6a6b950d964fdc63603aca325f86.png)  

![picture 394](../images/02852864714e015d86b24045d1e056b2e8b43cd42a62046b9d5daa3a6fd2c0a3.png)  

![picture 395](../images/d82b4a2d8fd8b5917b1d7f1d3c0e3fa27f7747058e91ef2c623700cc5400ac7d.png)  

![picture 396](../images/3c7f8485c3d0021ed6fb2451a08fe3934ccc8764d595888c5c41a2a4dec30506.png)  

<br/>

---