<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>eCMAP Exam</title>
        <style>
/* From extension vscode.markdown-math */
@font-face{font-family:KaTeX_AMS;src:url(fonts/KaTeX_AMS-Regular.woff2) format("woff2"),url(fonts/KaTeX_AMS-Regular.woff) format("woff"),url(fonts/KaTeX_AMS-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Caligraphic;src:url(fonts/KaTeX_Caligraphic-Bold.woff2) format("woff2"),url(fonts/KaTeX_Caligraphic-Bold.woff) format("woff"),url(fonts/KaTeX_Caligraphic-Bold.ttf) format("truetype");font-weight:700;font-style:normal}@font-face{font-family:KaTeX_Caligraphic;src:url(fonts/KaTeX_Caligraphic-Regular.woff2) format("woff2"),url(fonts/KaTeX_Caligraphic-Regular.woff) format("woff"),url(fonts/KaTeX_Caligraphic-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Fraktur;src:url(fonts/KaTeX_Fraktur-Bold.woff2) format("woff2"),url(fonts/KaTeX_Fraktur-Bold.woff) format("woff"),url(fonts/KaTeX_Fraktur-Bold.ttf) format("truetype");font-weight:700;font-style:normal}@font-face{font-family:KaTeX_Fraktur;src:url(fonts/KaTeX_Fraktur-Regular.woff2) format("woff2"),url(fonts/KaTeX_Fraktur-Regular.woff) format("woff"),url(fonts/KaTeX_Fraktur-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Main;src:url(fonts/KaTeX_Main-Bold.woff2) format("woff2"),url(fonts/KaTeX_Main-Bold.woff) format("woff"),url(fonts/KaTeX_Main-Bold.ttf) format("truetype");font-weight:700;font-style:normal}@font-face{font-family:KaTeX_Main;src:url(fonts/KaTeX_Main-BoldItalic.woff2) format("woff2"),url(fonts/KaTeX_Main-BoldItalic.woff) format("woff"),url(fonts/KaTeX_Main-BoldItalic.ttf) format("truetype");font-weight:700;font-style:italic}@font-face{font-family:KaTeX_Main;src:url(fonts/KaTeX_Main-Italic.woff2) format("woff2"),url(fonts/KaTeX_Main-Italic.woff) format("woff"),url(fonts/KaTeX_Main-Italic.ttf) format("truetype");font-weight:400;font-style:italic}@font-face{font-family:KaTeX_Main;src:url(fonts/KaTeX_Main-Regular.woff2) format("woff2"),url(fonts/KaTeX_Main-Regular.woff) format("woff"),url(fonts/KaTeX_Main-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Math;src:url(fonts/KaTeX_Math-BoldItalic.woff2) format("woff2"),url(fonts/KaTeX_Math-BoldItalic.woff) format("woff"),url(fonts/KaTeX_Math-BoldItalic.ttf) format("truetype");font-weight:700;font-style:italic}@font-face{font-family:KaTeX_Math;src:url(fonts/KaTeX_Math-Italic.woff2) format("woff2"),url(fonts/KaTeX_Math-Italic.woff) format("woff"),url(fonts/KaTeX_Math-Italic.ttf) format("truetype");font-weight:400;font-style:italic}@font-face{font-family:"KaTeX_SansSerif";src:url(fonts/KaTeX_SansSerif-Bold.woff2) format("woff2"),url(fonts/KaTeX_SansSerif-Bold.woff) format("woff"),url(fonts/KaTeX_SansSerif-Bold.ttf) format("truetype");font-weight:700;font-style:normal}@font-face{font-family:"KaTeX_SansSerif";src:url(fonts/KaTeX_SansSerif-Italic.woff2) format("woff2"),url(fonts/KaTeX_SansSerif-Italic.woff) format("woff"),url(fonts/KaTeX_SansSerif-Italic.ttf) format("truetype");font-weight:400;font-style:italic}@font-face{font-family:"KaTeX_SansSerif";src:url(fonts/KaTeX_SansSerif-Regular.woff2) format("woff2"),url(fonts/KaTeX_SansSerif-Regular.woff) format("woff"),url(fonts/KaTeX_SansSerif-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Script;src:url(fonts/KaTeX_Script-Regular.woff2) format("woff2"),url(fonts/KaTeX_Script-Regular.woff) format("woff"),url(fonts/KaTeX_Script-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Size1;src:url(fonts/KaTeX_Size1-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size1-Regular.woff) format("woff"),url(fonts/KaTeX_Size1-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Size2;src:url(fonts/KaTeX_Size2-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size2-Regular.woff) format("woff"),url(fonts/KaTeX_Size2-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Size3;src:url(fonts/KaTeX_Size3-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size3-Regular.woff) format("woff"),url(fonts/KaTeX_Size3-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Size4;src:url(fonts/KaTeX_Size4-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size4-Regular.woff) format("woff"),url(fonts/KaTeX_Size4-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Typewriter;src:url(fonts/KaTeX_Typewriter-Regular.woff2) format("woff2"),url(fonts/KaTeX_Typewriter-Regular.woff) format("woff"),url(fonts/KaTeX_Typewriter-Regular.ttf) format("truetype");font-weight:400;font-style:normal}.katex{font:normal 1.21em KaTeX_Main,Times New Roman,serif;line-height:1.2;text-indent:0;text-rendering:auto;border-color:currentColor}.katex *{-ms-high-contrast-adjust:none!important}.katex .katex-version:after{content:"0.13.0"}.katex .katex-mathml{position:absolute;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden}.katex .katex-html>.newline{display:block}.katex .base{position:relative;white-space:nowrap;width:-webkit-min-content;width:-moz-min-content;width:min-content}.katex .base,.katex .strut{display:inline-block}.katex .textbf{font-weight:700}.katex .textit{font-style:italic}.katex .textrm{font-family:KaTeX_Main}.katex .textsf{font-family:KaTeX_SansSerif}.katex .texttt{font-family:KaTeX_Typewriter}.katex .mathnormal{font-family:KaTeX_Math;font-style:italic}.katex .mathit{font-family:KaTeX_Main;font-style:italic}.katex .mathrm{font-style:normal}.katex .mathbf{font-family:KaTeX_Main;font-weight:700}.katex .boldsymbol{font-family:KaTeX_Math;font-weight:700;font-style:italic}.katex .amsrm,.katex .mathbb,.katex .textbb{font-family:KaTeX_AMS}.katex .mathcal{font-family:KaTeX_Caligraphic}.katex .mathfrak,.katex .textfrak{font-family:KaTeX_Fraktur}.katex .mathtt{font-family:KaTeX_Typewriter}.katex .mathscr,.katex .textscr{font-family:KaTeX_Script}.katex .mathsf,.katex .textsf{font-family:KaTeX_SansSerif}.katex .mathboldsf,.katex .textboldsf{font-family:KaTeX_SansSerif;font-weight:700}.katex .mathitsf,.katex .textitsf{font-family:KaTeX_SansSerif;font-style:italic}.katex .mainrm{font-family:KaTeX_Main;font-style:normal}.katex .vlist-t{display:inline-table;table-layout:fixed;border-collapse:collapse}.katex .vlist-r{display:table-row}.katex .vlist{display:table-cell;vertical-align:bottom;position:relative}.katex .vlist>span{display:block;height:0;position:relative}.katex .vlist>span>span{display:inline-block}.katex .vlist>span>.pstrut{overflow:hidden;width:0}.katex .vlist-t2{margin-right:-2px}.katex .vlist-s{display:table-cell;vertical-align:bottom;font-size:1px;width:2px;min-width:2px}.katex .vbox{display:inline-flex;flex-direction:column;align-items:baseline}.katex .hbox{width:100%}.katex .hbox,.katex .thinbox{display:inline-flex;flex-direction:row}.katex .thinbox{width:0;max-width:0}.katex .msupsub{text-align:left}.katex .mfrac>span>span{text-align:center}.katex .mfrac .frac-line{display:inline-block;width:100%;border-bottom-style:solid}.katex .hdashline,.katex .hline,.katex .mfrac .frac-line,.katex .overline .overline-line,.katex .rule,.katex .underline .underline-line{min-height:1px}.katex .mspace{display:inline-block}.katex .clap,.katex .llap,.katex .rlap{width:0;position:relative}.katex .clap>.inner,.katex .llap>.inner,.katex .rlap>.inner{position:absolute}.katex .clap>.fix,.katex .llap>.fix,.katex .rlap>.fix{display:inline-block}.katex .llap>.inner{right:0}.katex .clap>.inner,.katex .rlap>.inner{left:0}.katex .clap>.inner>span{margin-left:-50%;margin-right:50%}.katex .rule{display:inline-block;border:0 solid;position:relative}.katex .hline,.katex .overline .overline-line,.katex .underline .underline-line{display:inline-block;width:100%;border-bottom-style:solid}.katex .hdashline{display:inline-block;width:100%;border-bottom-style:dashed}.katex .sqrt>.root{margin-left:.27777778em;margin-right:-.55555556em}.katex .fontsize-ensurer.reset-size1.size1,.katex .sizing.reset-size1.size1{font-size:1em}.katex .fontsize-ensurer.reset-size1.size2,.katex .sizing.reset-size1.size2{font-size:1.2em}.katex .fontsize-ensurer.reset-size1.size3,.katex .sizing.reset-size1.size3{font-size:1.4em}.katex .fontsize-ensurer.reset-size1.size4,.katex .sizing.reset-size1.size4{font-size:1.6em}.katex .fontsize-ensurer.reset-size1.size5,.katex .sizing.reset-size1.size5{font-size:1.8em}.katex .fontsize-ensurer.reset-size1.size6,.katex .sizing.reset-size1.size6{font-size:2em}.katex .fontsize-ensurer.reset-size1.size7,.katex .sizing.reset-size1.size7{font-size:2.4em}.katex .fontsize-ensurer.reset-size1.size8,.katex .sizing.reset-size1.size8{font-size:2.88em}.katex .fontsize-ensurer.reset-size1.size9,.katex .sizing.reset-size1.size9{font-size:3.456em}.katex .fontsize-ensurer.reset-size1.size10,.katex .sizing.reset-size1.size10{font-size:4.148em}.katex .fontsize-ensurer.reset-size1.size11,.katex .sizing.reset-size1.size11{font-size:4.976em}.katex .fontsize-ensurer.reset-size2.size1,.katex .sizing.reset-size2.size1{font-size:.83333333em}.katex .fontsize-ensurer.reset-size2.size2,.katex .sizing.reset-size2.size2{font-size:1em}.katex .fontsize-ensurer.reset-size2.size3,.katex .sizing.reset-size2.size3{font-size:1.16666667em}.katex .fontsize-ensurer.reset-size2.size4,.katex .sizing.reset-size2.size4{font-size:1.33333333em}.katex .fontsize-ensurer.reset-size2.size5,.katex .sizing.reset-size2.size5{font-size:1.5em}.katex .fontsize-ensurer.reset-size2.size6,.katex .sizing.reset-size2.size6{font-size:1.66666667em}.katex .fontsize-ensurer.reset-size2.size7,.katex .sizing.reset-size2.size7{font-size:2em}.katex .fontsize-ensurer.reset-size2.size8,.katex .sizing.reset-size2.size8{font-size:2.4em}.katex .fontsize-ensurer.reset-size2.size9,.katex .sizing.reset-size2.size9{font-size:2.88em}.katex .fontsize-ensurer.reset-size2.size10,.katex .sizing.reset-size2.size10{font-size:3.45666667em}.katex .fontsize-ensurer.reset-size2.size11,.katex .sizing.reset-size2.size11{font-size:4.14666667em}.katex .fontsize-ensurer.reset-size3.size1,.katex .sizing.reset-size3.size1{font-size:.71428571em}.katex .fontsize-ensurer.reset-size3.size2,.katex .sizing.reset-size3.size2{font-size:.85714286em}.katex .fontsize-ensurer.reset-size3.size3,.katex .sizing.reset-size3.size3{font-size:1em}.katex .fontsize-ensurer.reset-size3.size4,.katex .sizing.reset-size3.size4{font-size:1.14285714em}.katex .fontsize-ensurer.reset-size3.size5,.katex .sizing.reset-size3.size5{font-size:1.28571429em}.katex .fontsize-ensurer.reset-size3.size6,.katex .sizing.reset-size3.size6{font-size:1.42857143em}.katex .fontsize-ensurer.reset-size3.size7,.katex .sizing.reset-size3.size7{font-size:1.71428571em}.katex .fontsize-ensurer.reset-size3.size8,.katex .sizing.reset-size3.size8{font-size:2.05714286em}.katex .fontsize-ensurer.reset-size3.size9,.katex .sizing.reset-size3.size9{font-size:2.46857143em}.katex .fontsize-ensurer.reset-size3.size10,.katex .sizing.reset-size3.size10{font-size:2.96285714em}.katex .fontsize-ensurer.reset-size3.size11,.katex .sizing.reset-size3.size11{font-size:3.55428571em}.katex .fontsize-ensurer.reset-size4.size1,.katex .sizing.reset-size4.size1{font-size:.625em}.katex .fontsize-ensurer.reset-size4.size2,.katex .sizing.reset-size4.size2{font-size:.75em}.katex .fontsize-ensurer.reset-size4.size3,.katex .sizing.reset-size4.size3{font-size:.875em}.katex .fontsize-ensurer.reset-size4.size4,.katex .sizing.reset-size4.size4{font-size:1em}.katex .fontsize-ensurer.reset-size4.size5,.katex .sizing.reset-size4.size5{font-size:1.125em}.katex .fontsize-ensurer.reset-size4.size6,.katex .sizing.reset-size4.size6{font-size:1.25em}.katex .fontsize-ensurer.reset-size4.size7,.katex .sizing.reset-size4.size7{font-size:1.5em}.katex .fontsize-ensurer.reset-size4.size8,.katex .sizing.reset-size4.size8{font-size:1.8em}.katex .fontsize-ensurer.reset-size4.size9,.katex .sizing.reset-size4.size9{font-size:2.16em}.katex .fontsize-ensurer.reset-size4.size10,.katex .sizing.reset-size4.size10{font-size:2.5925em}.katex .fontsize-ensurer.reset-size4.size11,.katex .sizing.reset-size4.size11{font-size:3.11em}.katex .fontsize-ensurer.reset-size5.size1,.katex .sizing.reset-size5.size1{font-size:.55555556em}.katex .fontsize-ensurer.reset-size5.size2,.katex .sizing.reset-size5.size2{font-size:.66666667em}.katex .fontsize-ensurer.reset-size5.size3,.katex .sizing.reset-size5.size3{font-size:.77777778em}.katex .fontsize-ensurer.reset-size5.size4,.katex .sizing.reset-size5.size4{font-size:.88888889em}.katex .fontsize-ensurer.reset-size5.size5,.katex .sizing.reset-size5.size5{font-size:1em}.katex .fontsize-ensurer.reset-size5.size6,.katex .sizing.reset-size5.size6{font-size:1.11111111em}.katex .fontsize-ensurer.reset-size5.size7,.katex .sizing.reset-size5.size7{font-size:1.33333333em}.katex .fontsize-ensurer.reset-size5.size8,.katex .sizing.reset-size5.size8{font-size:1.6em}.katex .fontsize-ensurer.reset-size5.size9,.katex .sizing.reset-size5.size9{font-size:1.92em}.katex .fontsize-ensurer.reset-size5.size10,.katex .sizing.reset-size5.size10{font-size:2.30444444em}.katex .fontsize-ensurer.reset-size5.size11,.katex .sizing.reset-size5.size11{font-size:2.76444444em}.katex .fontsize-ensurer.reset-size6.size1,.katex .sizing.reset-size6.size1{font-size:.5em}.katex .fontsize-ensurer.reset-size6.size2,.katex .sizing.reset-size6.size2{font-size:.6em}.katex .fontsize-ensurer.reset-size6.size3,.katex .sizing.reset-size6.size3{font-size:.7em}.katex .fontsize-ensurer.reset-size6.size4,.katex .sizing.reset-size6.size4{font-size:.8em}.katex .fontsize-ensurer.reset-size6.size5,.katex .sizing.reset-size6.size5{font-size:.9em}.katex .fontsize-ensurer.reset-size6.size6,.katex .sizing.reset-size6.size6{font-size:1em}.katex .fontsize-ensurer.reset-size6.size7,.katex .sizing.reset-size6.size7{font-size:1.2em}.katex .fontsize-ensurer.reset-size6.size8,.katex .sizing.reset-size6.size8{font-size:1.44em}.katex .fontsize-ensurer.reset-size6.size9,.katex .sizing.reset-size6.size9{font-size:1.728em}.katex .fontsize-ensurer.reset-size6.size10,.katex .sizing.reset-size6.size10{font-size:2.074em}.katex .fontsize-ensurer.reset-size6.size11,.katex .sizing.reset-size6.size11{font-size:2.488em}.katex .fontsize-ensurer.reset-size7.size1,.katex .sizing.reset-size7.size1{font-size:.41666667em}.katex .fontsize-ensurer.reset-size7.size2,.katex .sizing.reset-size7.size2{font-size:.5em}.katex .fontsize-ensurer.reset-size7.size3,.katex .sizing.reset-size7.size3{font-size:.58333333em}.katex .fontsize-ensurer.reset-size7.size4,.katex .sizing.reset-size7.size4{font-size:.66666667em}.katex .fontsize-ensurer.reset-size7.size5,.katex .sizing.reset-size7.size5{font-size:.75em}.katex .fontsize-ensurer.reset-size7.size6,.katex .sizing.reset-size7.size6{font-size:.83333333em}.katex .fontsize-ensurer.reset-size7.size7,.katex .sizing.reset-size7.size7{font-size:1em}.katex .fontsize-ensurer.reset-size7.size8,.katex .sizing.reset-size7.size8{font-size:1.2em}.katex .fontsize-ensurer.reset-size7.size9,.katex .sizing.reset-size7.size9{font-size:1.44em}.katex .fontsize-ensurer.reset-size7.size10,.katex .sizing.reset-size7.size10{font-size:1.72833333em}.katex .fontsize-ensurer.reset-size7.size11,.katex .sizing.reset-size7.size11{font-size:2.07333333em}.katex .fontsize-ensurer.reset-size8.size1,.katex .sizing.reset-size8.size1{font-size:.34722222em}.katex .fontsize-ensurer.reset-size8.size2,.katex .sizing.reset-size8.size2{font-size:.41666667em}.katex .fontsize-ensurer.reset-size8.size3,.katex .sizing.reset-size8.size3{font-size:.48611111em}.katex .fontsize-ensurer.reset-size8.size4,.katex .sizing.reset-size8.size4{font-size:.55555556em}.katex .fontsize-ensurer.reset-size8.size5,.katex .sizing.reset-size8.size5{font-size:.625em}.katex .fontsize-ensurer.reset-size8.size6,.katex .sizing.reset-size8.size6{font-size:.69444444em}.katex .fontsize-ensurer.reset-size8.size7,.katex .sizing.reset-size8.size7{font-size:.83333333em}.katex .fontsize-ensurer.reset-size8.size8,.katex .sizing.reset-size8.size8{font-size:1em}.katex .fontsize-ensurer.reset-size8.size9,.katex .sizing.reset-size8.size9{font-size:1.2em}.katex .fontsize-ensurer.reset-size8.size10,.katex .sizing.reset-size8.size10{font-size:1.44027778em}.katex .fontsize-ensurer.reset-size8.size11,.katex .sizing.reset-size8.size11{font-size:1.72777778em}.katex .fontsize-ensurer.reset-size9.size1,.katex .sizing.reset-size9.size1{font-size:.28935185em}.katex .fontsize-ensurer.reset-size9.size2,.katex .sizing.reset-size9.size2{font-size:.34722222em}.katex .fontsize-ensurer.reset-size9.size3,.katex .sizing.reset-size9.size3{font-size:.40509259em}.katex .fontsize-ensurer.reset-size9.size4,.katex .sizing.reset-size9.size4{font-size:.46296296em}.katex .fontsize-ensurer.reset-size9.size5,.katex .sizing.reset-size9.size5{font-size:.52083333em}.katex .fontsize-ensurer.reset-size9.size6,.katex .sizing.reset-size9.size6{font-size:.5787037em}.katex .fontsize-ensurer.reset-size9.size7,.katex .sizing.reset-size9.size7{font-size:.69444444em}.katex .fontsize-ensurer.reset-size9.size8,.katex .sizing.reset-size9.size8{font-size:.83333333em}.katex .fontsize-ensurer.reset-size9.size9,.katex .sizing.reset-size9.size9{font-size:1em}.katex .fontsize-ensurer.reset-size9.size10,.katex .sizing.reset-size9.size10{font-size:1.20023148em}.katex .fontsize-ensurer.reset-size9.size11,.katex .sizing.reset-size9.size11{font-size:1.43981481em}.katex .fontsize-ensurer.reset-size10.size1,.katex .sizing.reset-size10.size1{font-size:.24108004em}.katex .fontsize-ensurer.reset-size10.size2,.katex .sizing.reset-size10.size2{font-size:.28929605em}.katex .fontsize-ensurer.reset-size10.size3,.katex .sizing.reset-size10.size3{font-size:.33751205em}.katex .fontsize-ensurer.reset-size10.size4,.katex .sizing.reset-size10.size4{font-size:.38572806em}.katex .fontsize-ensurer.reset-size10.size5,.katex .sizing.reset-size10.size5{font-size:.43394407em}.katex .fontsize-ensurer.reset-size10.size6,.katex .sizing.reset-size10.size6{font-size:.48216008em}.katex .fontsize-ensurer.reset-size10.size7,.katex .sizing.reset-size10.size7{font-size:.57859209em}.katex .fontsize-ensurer.reset-size10.size8,.katex .sizing.reset-size10.size8{font-size:.69431051em}.katex .fontsize-ensurer.reset-size10.size9,.katex .sizing.reset-size10.size9{font-size:.83317261em}.katex .fontsize-ensurer.reset-size10.size10,.katex .sizing.reset-size10.size10{font-size:1em}.katex .fontsize-ensurer.reset-size10.size11,.katex .sizing.reset-size10.size11{font-size:1.19961427em}.katex .fontsize-ensurer.reset-size11.size1,.katex .sizing.reset-size11.size1{font-size:.20096463em}.katex .fontsize-ensurer.reset-size11.size2,.katex .sizing.reset-size11.size2{font-size:.24115756em}.katex .fontsize-ensurer.reset-size11.size3,.katex .sizing.reset-size11.size3{font-size:.28135048em}.katex .fontsize-ensurer.reset-size11.size4,.katex .sizing.reset-size11.size4{font-size:.32154341em}.katex .fontsize-ensurer.reset-size11.size5,.katex .sizing.reset-size11.size5{font-size:.36173633em}.katex .fontsize-ensurer.reset-size11.size6,.katex .sizing.reset-size11.size6{font-size:.40192926em}.katex .fontsize-ensurer.reset-size11.size7,.katex .sizing.reset-size11.size7{font-size:.48231511em}.katex .fontsize-ensurer.reset-size11.size8,.katex .sizing.reset-size11.size8{font-size:.57877814em}.katex .fontsize-ensurer.reset-size11.size9,.katex .sizing.reset-size11.size9{font-size:.69453376em}.katex .fontsize-ensurer.reset-size11.size10,.katex .sizing.reset-size11.size10{font-size:.83360129em}.katex .fontsize-ensurer.reset-size11.size11,.katex .sizing.reset-size11.size11{font-size:1em}.katex .delimsizing.size1{font-family:KaTeX_Size1}.katex .delimsizing.size2{font-family:KaTeX_Size2}.katex .delimsizing.size3{font-family:KaTeX_Size3}.katex .delimsizing.size4{font-family:KaTeX_Size4}.katex .delimsizing.mult .delim-size1>span{font-family:KaTeX_Size1}.katex .delimsizing.mult .delim-size4>span{font-family:KaTeX_Size4}.katex .nulldelimiter{display:inline-block;width:.12em}.katex .delimcenter,.katex .op-symbol{position:relative}.katex .op-symbol.small-op{font-family:KaTeX_Size1}.katex .op-symbol.large-op{font-family:KaTeX_Size2}.katex .accent>.vlist-t,.katex .op-limits>.vlist-t{text-align:center}.katex .accent .accent-body{position:relative}.katex .accent .accent-body:not(.accent-full){width:0}.katex .overlay{display:block}.katex .mtable .vertical-separator{display:inline-block;min-width:1px}.katex .mtable .arraycolsep{display:inline-block}.katex .mtable .col-align-c>.vlist-t{text-align:center}.katex .mtable .col-align-l>.vlist-t{text-align:left}.katex .mtable .col-align-r>.vlist-t{text-align:right}.katex .svg-align{text-align:left}.katex svg{display:block;position:absolute;width:100%;height:inherit;fill:currentColor;stroke:currentColor;fill-rule:nonzero;fill-opacity:1;stroke-width:1;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1}.katex svg path{stroke:none}.katex img{border-style:none;min-width:0;min-height:0;max-width:none;max-height:none}.katex .stretchy{width:100%;display:block;position:relative;overflow:hidden}.katex .stretchy:after,.katex .stretchy:before{content:""}.katex .hide-tail{width:100%;position:relative;overflow:hidden}.katex .halfarrow-left{position:absolute;left:0;width:50.2%;overflow:hidden}.katex .halfarrow-right{position:absolute;right:0;width:50.2%;overflow:hidden}.katex .brace-left{position:absolute;left:0;width:25.1%;overflow:hidden}.katex .brace-center{position:absolute;left:25%;width:50%;overflow:hidden}.katex .brace-right{position:absolute;right:0;width:25.1%;overflow:hidden}.katex .x-arrow-pad{padding:0 .5em}.katex .cd-arrow-pad{padding:0 .55556em 0 .27778em}.katex .mover,.katex .munder,.katex .x-arrow{text-align:center}.katex .boxpad{padding:0 .3em}.katex .fbox,.katex .fcolorbox{box-sizing:border-box;border:.04em solid}.katex .cancel-pad{padding:0 .2em}.katex .cancel-lap{margin-left:-.2em;margin-right:-.2em}.katex .sout{border-bottom-style:solid;border-bottom-width:.08em}.katex .angl{box-sizing:border-content;border-top:.049em solid;border-right:.049em solid;margin-right:.03889em}.katex .anglpad{padding:0 .03889em}.katex .eqn-num:before{counter-increment:katexEqnNo;content:"(" counter(katexEqnNo) ")"}.katex .mml-eqn-num:before{counter-increment:mmlEqnNo;content:"(" counter(mmlEqnNo) ")"}.katex .mtr-glue{width:50%}.katex .cd-vert-arrow{display:inline-block;position:relative}.katex .cd-label-left{display:inline-block;position:absolute;right:calc(50% + .3em);text-align:left}.katex .cd-label-right{display:inline-block;position:absolute;left:calc(50% + .3em);text-align:right}.katex-display{display:block;margin:1em 0;text-align:center}.katex-display>.katex{display:block;text-align:center;white-space:nowrap}.katex-display>.katex>.katex-html{display:block;position:relative}.katex-display>.katex>.katex-html>.tag{position:absolute;right:0}.katex-display.leqno>.katex>.katex-html>.tag{left:0;right:auto}.katex-display.fleqn>.katex{text-align:left;padding-left:2em}body{counter-reset:katexEqnNo mmlEqnNo}

/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.katex-error {
	color: var(--vscode-editorError-foreground);
}

</style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        
        <script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
        
    </head>
    <body class="vscode-body vscode-light">
        <h1 id="ecmap-exam">eCMAP Exam</h1>
<ul>
<li><a href="#ecmap-exam">eCMAP Exam</a>
<ul>
<li><a href="#document-information">Document Information</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#1---initial-assessments---final-examexe">1 - Initial Assessments - Final Exam.exe</a>
<ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#1-1---hashes">1-1 - Hashes</a></li>
<li><a href="#1-2---optional-header">1-2 - Optional Header</a></li>
<li><a href="#1-3---sections">1-3 - Sections</a></li>
<li><a href="#1-4---functions">1-4 - Functions</a></li>
<li><a href="#1-5---attck-analysis">1-5 - ATT&amp;CK Analysis</a></li>
<li><a href="#1-6---resources">1-6 - Resources</a></li>
<li><a href="#1-7---strings-analysis">1-7 - Strings analysis</a></li>
</ul>
</li>
<li><a href="#2---reverse-engineering">2 - Reverse Engineering</a>
<ul>
<li><a href="#finalexamexe">FinalExam.exe</a>
<ul>
<li><a href="#preparation">Preparation</a></li>
<li><a href="#urldownloadtofilea---1400015c0">URLDownloadToFileA - 1400015C0</a></li>
<li><a href="#urldownloadtofilea---140002080">URLDownloadToFileA - 140002080</a></li>
<li><a href="#cryptstringtobinarya---140001320">CryptStringToBinaryA - 140001320</a></li>
<li><a href="#regopenkeyexa-regsetvalueexa-regclosekey---140001b80">RegOpenKeyExA, RegSetValueExA, RegCloseKey - 140001B80</a></li>
<li><a href="#regopenkeyexa-regsetvalueexa-regclosekey---140001c70">RegOpenKeyExA, RegSetValueExA, RegCloseKey - 140001C70</a></li>
<li><a href="#internetcheckconnectiona-in-sub_140001ae0">InternetCheckConnectionA in sub_140001AE0</a></li>
<li><a href="#messageboxw-in-main-function">MessageBoxW in main function</a></li>
<li><a href="#messageboxw-in-140001aa0">MessageBoxW in 140001AA0</a></li>
<li><a href="#messageboxw-in-140001740">MessageBoxW in 140001740</a></li>
<li><a href="#shellexecutea-in-main-function">ShellExecuteA in main function</a></li>
<li><a href="#anti-x-functions">Anti-X functions</a></li>
<li><a href="#debugger-detection-at-subroutine-140001740">Debugger Detection at subroutine 140001740</a></li>
<li><a href="#sandbox-detection-at-subroutine-1400017d0">Sandbox detection at subroutine 1400017D0</a></li>
<li><a href="#vm-detection-at-subroutine-140001950">VM Detection at subroutine 140001950</a></li>
<li><a href="#sandbox-detection-by-number-of-processes">Sandbox detection by Number of Processes</a></li>
<li><a href="#debugger-detection-by-using-tickcount">Debugger detection by using TickCount</a></li>
</ul>
</li>
<li><a href="#bannerjpg">banner.jpg</a></li>
<li><a href="#loaderexe">loader.exe</a></li>
<li><a href="#phexe">ph.exe</a></li>
</ul>
</li>
<li><a href="#1a---static-analysis-of-bannerjpg">1a - Static analysis of banner.jpg</a>
<ul>
<li><a href="#summary-1">Summary</a></li>
<li><a href="#1a-1---basic-information">1a-1 - Basic Information</a></li>
<li><a href="#1a-2---optional-header">1a-2 - Optional Header</a></li>
<li><a href="#1a-3---sections">1a-3 - Sections</a></li>
<li><a href="#1a-4---functions">1a-4 - Functions</a></li>
<li><a href="#1a-5---attck-analysis">1a-5 - ATT&amp;CK Analysis</a></li>
<li><a href="#1a-6---resources">1a-6 - Resources</a></li>
<li><a href="#1a-7---strings-analysis">1a-7 - Strings analysis</a></li>
</ul>
</li>
<li><a href="#2a---reverse-engineering---bannerjpg--conbasedll">2a - Reverse Engineering - banner.jpg / conbase.dll</a>
<ul>
<li><a href="#wsastartup-wsasocketa-htons-inet_addr-wsaconnect-and-createprocessa-in-routine-180001000">WSAStartup, WSASocketA, htons, inet_addr, WSAConnect and CreateProcessA in routine 180001000</a></li>
</ul>
</li>
<li><a href="#3---running-the-malware">3 - Running the malware</a>
<ul>
<li><a href="#summmary-table">Summmary table</a></li>
<li><a href="#first-time-running-the-malware">First time running the malware</a></li>
<li><a href="#bypassing-the-self-defensive-mechanism">Bypassing the self-defensive mechanism</a>
<ul>
<li><a href="#debugger-detection-at-subroutine-140001740-1">Debugger Detection at subroutine 140001740</a></li>
<li><a href="#detection-at-subroutine-1400017d0-140001950-140002274-14000227d">Detection at subroutine 1400017D0, 140001950, 140002274, 14000227D</a></li>
</ul>
</li>
<li><a href="#running-the-patched-executable">Running the patched executable</a></li>
<li><a href="#processes-involved-by-the-sample">Processes involved by the sample</a>
<ul>
<li><a href="#first-cmdexe">First cmd.exe</a></li>
<li><a href="#loaderexe-1">Loader.exe</a></li>
<li><a href="#second-cmdexe">Second cmd.exe</a></li>
<li><a href="#pingexe">ping.exe</a></li>
</ul>
</li>
<li><a href="#file-accessed-downloaded-or-used-and-their-path">File accessed, downloaded, or used, and their PATH</a></li>
<li><a href="#registry-activities">Registry Activities</a>
<ul>
<li><a href="#portmonitor">PortMonitor</a></li>
<li><a href="#run-key">Run Key</a></li>
</ul>
</li>
<li><a href="#obfuscation">Obfuscation</a></li>
<li><a href="#bannerjpg--conbasedll">banner.jpg / conbase.dll</a></li>
<li><a href="#extracting-loaderexe">Extracting Loader.exe</a></li>
</ul>
</li>
<li><a href="#1b---static-analysis-of-loaderexe">1b - Static analysis of loader.exe</a>
<ul>
<li><a href="#summary-2">Summary</a></li>
<li><a href="#1b-1-general-information">1b-1 General Information</a></li>
<li><a href="#1b-2-optional-header">1b-2 Optional Header</a></li>
<li><a href="#1b-3-sections">1b-3 Sections</a></li>
<li><a href="#1b-4-functions">1b-4 Functions</a></li>
<li><a href="#1b-5-attck-analysis">1b-5 ATT&amp;CK Analysis</a></li>
<li><a href="#1b-6-resources">1b-6 Resources</a></li>
<li><a href="#1b-7-strings">1b-7 Strings</a></li>
</ul>
</li>
<li><a href="#2b---reverse-engineering---loaderexe">2b - Reverse Engineering - loader.exe</a></li>
<li><a href="#1c---static-analysis-of-phexe">1c - Static analysis of ph.exe</a>
<ul>
<li><a href="#summary-3">Summary</a></li>
<li><a href="#1c-1-general-information">1c-1 General Information</a></li>
<li><a href="#1c-2-optional-header">1c-2 Optional Header</a></li>
<li><a href="#1c-3-sections">1c-3 Sections</a></li>
<li><a href="#1c-4-functions">1c-4 Functions</a></li>
<li><a href="#1c-5-attck-analysis">1c-5 ATT&amp;CK Analysis</a></li>
<li><a href="#1c-6-resources">1c-6 Resources</a></li>
<li><a href="#1c-7-strings">1c-7 Strings</a></li>
</ul>
</li>
<li><a href="#2c---reverse-engineering---phexe">2c - Reverse Engineering - ph.exe</a>
<ul>
<li><a href="#readfile-in-the-main-function">ReadFile in the main function</a></li>
<li><a href="#createfilea-in-the-main-function">CreateFileA in the main function</a></li>
<li><a href="#createprocessa-in-the-main-function">CreateProcessA in the main function</a></li>
</ul>
</li>
<li><a href="#3c---dynamic-analysis---pdexe">3c - Dynamic Analysis - pd.exe</a></li>
<li><a href="#4---unpacking">4 - Unpacking</a>
<ul>
<li><a href="#unpacking-loaderexe">Unpacking loader.exe</a></li>
<li><a href="#disassemble-unpacked-loaderexe">Disassemble unpacked loader.exe</a>
<ul>
<li><a href="#createremotethread-in-the-main-function">CreateRemoteThread in the main function</a></li>
<li><a href="#openprocess-in-the-main-function">OpenProcess in the main function</a></li>
<li><a href="#virtualalloxex-in-the-main-function">VirtualAlloxEx in the main function</a></li>
<li><a href="#writeprocessmemory-in-the-main-function">WriteProcessMemory in the main function</a></li>
<li><a href="#getmodulehandlea-and-getprocaddress-in-the-main-function">GetModuleHandleA and GetProcAddress in the main function</a></li>
<li><a href="#short-summary-of-loaderexe">Short summary of loader.exe</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#5---network-activity">5 - Network Activity</a>
<ul>
<li><a href="#http">HTTP</a>
<ul>
<li><a href="#bannerjpg-1">banner.jpg</a></li>
<li><a href="#startjpg">start.jpg</a></li>
<li><a href="#pic1jpg">pic1.jpg</a></li>
<li><a href="#pic2jpg">pic2.jpg</a></li>
<li><a href="#pic3jpg">pic3.jpg</a></li>
<li><a href="#pic4jpg">pic4.jpg</a></li>
<li><a href="#pic5jpg">pic5.jpg</a></li>
<li><a href="#footerjpg">footer.jpg</a></li>
<li><a href="#runmebat">runme.bat</a></li>
</ul>
</li>
<li><a href="#icmp">ICMP</a></li>
</ul>
</li>
<li><a href="#6---persistence">6 - Persistence</a>
<ul>
<li><a href="#method-1---using-persistence-run-key">Method 1 - Using Persistence Run key</a></li>
<li><a href="#method-2---inject-dll-into-spoolsvexe-port-monitors">Method 2 - Inject DLL into spoolsv.exe (Port Monitors)</a></li>
</ul>
</li>
<li><a href="#7---dropped-and-downloaded-files">7 - Dropped and Downloaded Files</a></li>
<li><a href="#8---iocs">8 - IOCs</a></li>
<li><a href="#9---visualization">9 - Visualization</a></li>
<li><a href="#10---summary--conclusion">10 - Summary &amp; Conclusion</a></li>
</ul>
</li>
</ul>
<hr>
<h2 id="document-information">Document Information</h2>
<ul>
<li>Name: eLearnSecurity eCMAP Exam Report</li>
<li>Author: Brian Yau</li>
<li>Date: 10 Aug 2021</li>
<li>Description: Exam report for eLearnSecurity eCMAP Exam</li>
</ul>
<br/>
<hr>
<h2 id="configuration">Configuration</h2>
<p>Sample:</p>
<ul>
<li><code>C:\Users\AdminELS\Downloads\Samples\Final_Exam</code></li>
</ul>
<br/>
<hr>
<h2 id="1---initial-assessments---final-examexe">1 - Initial Assessments - Final Exam.exe</h2>
<p><strong>Questions</strong></p>
<p>Please provide background information about the malware sample given and any other malicious file(s) that gets downloaded. Use the questions below to help you when providing details about the file being analyzed.</p>
<ol>
<li>What are the hashes of the malware sample?</li>
<li>What is the file type?</li>
<li>What is the compilation time stamp?</li>
<li>What are the file characteristics (e.g. EXE, DLL, 32-bit, 64-bit, etc.)?</li>
<li>What is the Image Base and the Entry Point address?</li>
<li>Provide details about each section found in terms of their names, sizes, permissions, entropy, and what each is used for.</li>
<li>What are the libraries (DLLs) referenced by this sample and which functions do you think are suspicious?</li>
<li>What are the MITRE techniques being used?</li>
<li>Is this sample packed or not and what proof do you have?</li>
<li>What interesting findings can you extract from the resources section?</li>
<li>What interesting strings (ASCII and Unicode) did you find and could they be used later as an IOC? Provide a brief explanation for each string found.</li>
<li>Are there any crypto functions being used by the sample and what are they?</li>
</ol>
<br/>
<p><strong>Answer</strong></p>
<h3 id="summary">Summary</h3>
<table>
<thead>
<tr>
<th>Question</th>
<th>Answer</th>
<th>Reference section</th>
</tr>
</thead>
<tbody>
<tr>
<td>1. What are the hashes of the malware sample?</td>
<td>MD5: 28783D3A3D0FC76385A471D782141C04<br/>SHA1: D98E17F3A7A28454E96031792D3CBAD3B1B64e2<br/>SHA256: A4C1473ADD35A0409FC49C12C344DECF8FF71B1029F77DE2D20C9794CE387AB9<br/>IMPHASH: B60C0B539449AFE6F81105D67CA5D7EC</td>
<td>1-1</td>
</tr>
<tr>
<td>2. What is the file type?</td>
<td>Windows PE</td>
<td>1-1</td>
</tr>
<tr>
<td>3. What is the compilation time stamp?</td>
<td>Thu Jun 25 06:30:41 2020</td>
<td>1-1</td>
</tr>
<tr>
<td>4. What are the file characteristics (e.g. EXE, DLL, 32-bit, 64-bit, etc.)?</td>
<td>EXE, 64-bit</td>
<td>1-1</td>
</tr>
<tr>
<td>5. What is the Image Base and the Entry Point address?</td>
<td>EntryPoint: 0x2ADC<br/>ImageBase: 0x140000000</td>
<td>1-2</td>
</tr>
<tr>
<td>6. Provide details about each section found in terms of their names, sizes, permissions, entropy, and what each is used for.</td>
<td>See details in the reference 1-3</td>
<td>1-3</td>
</tr>
<tr>
<td>7. What are the libraries (DLLs) referenced by this sample and which functions do you think are suspicious?</td>
<td>See details in the reference 1-4</td>
<td>1-4</td>
</tr>
<tr>
<td>8. What are the MITRE techniques being used?</td>
<td>T1497, T1124, T1112, T1106, T1082</td>
<td>1-5</td>
</tr>
<tr>
<td>9. Is this sample packed or not and what proof do you have?</td>
<td>Not packed based on the section names and entropy</td>
<td>1-3</td>
</tr>
<tr>
<td>10.  What interesting findings can you extract from the resources section?</td>
<td>It requires administrator privilege to run</td>
<td>1-6</td>
</tr>
<tr>
<td>11. What interesting strings (ASCII and Unicode) did you find and could they be used later as an IOC? Provide a brief explanation for each string found.</td>
<td>See the details in 1-7</td>
<td>1-7</td>
</tr>
<tr>
<td>12. Are there any crypto functions being used by the sample and what are they?</td>
<td>Yes - CryptStringToBinaryA (from crypt32.dll)</td>
<td>1-4</td>
</tr>
</tbody>
</table>
<br/>
<h3 id="1-1---hashes">1-1 - Hashes</h3>
<p>Use <strong>PeStudio</strong> to open the sample to inspect it statically.</p>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/15c9b0635b354b68513490fa358f6aca313f9bd0db6226896d704d0ca17c2b84.png" alt="picture 1"></p>
<p>Based on this screenshot of summary page on <strong>PeStudio</strong> we can get the following information:</p>
<ul>
<li><strong>1. File hashes:</strong>
<ul>
<li>MD5: 28783D3A3D0FC76385A471D782141C04</li>
<li>SHA1: D98E17F3A7A28454E96031792D3CBAD3B1B64e2</li>
<li>SHA256: A4C1473ADD35A0409FC49C12C344DECF8FF71B1029F77DE2D20C9794CE387AB9</li>
<li>IMPHASH: B60C0B539449AFE6F81105D67CA5D7EC</li>
</ul>
</li>
<li><strong>2. File type:</strong>
<ul>
<li>Windows PE (Based on the first-bytes being <code>MZ</code> (<code>0x4D5A</code>))</li>
</ul>
</li>
<li><strong>3. Compilation timestamp:</strong>
<ul>
<li>Thu Jun 25 06:30:41 2020</li>
</ul>
</li>
<li><strong>4. File characteristics:</strong>
<ul>
<li>Type: EXE (Based on the <strong>file-type</strong> field)</li>
<li>Architect: 64-bit (AMD64)</li>
<li>Subsystem: Console</li>
</ul>
</li>
</ul>
<br/>
<h3 id="1-2---optional-header">1-2 - Optional Header</h3>
<p>Check the <strong>optional header</strong>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/edeb48faa3284e5d1852e69f98497e38c5a2689e41a4e611abc5b497a2454bcd.png" alt="picture 2"></p>
<ul>
<li><strong>5. Image Base &amp; Entrypoint:</strong>
<ul>
<li>EntryPoint: 0x2ADC</li>
<li>ImageBase: 0x140000000</li>
</ul>
</li>
<li>Also note that <strong>ASLR</strong> is enabled for this executable - we may have to turn it off later so we can analyze it on disassembler more easily.</li>
</ul>
<br/>
<h3 id="1-3---sections">1-3 - Sections</h3>
<p>Check the <strong>sections</strong>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/e7cefa801b791c52d8102a305b9c1739a2b89150c52932d95fdcedbff5aef192.png" alt="picture 3"></p>
<ul>
<li><strong>6. Sections information</strong>
<ul>
<li><strong>Section Name:</strong> .text
<ul>
<li>Usage: Executable code</li>
<li>Raw Size: 9216 bytes</li>
<li>Virtual Size: 9180 bytes</li>
<li>Permissions: Executable</li>
<li>Entropy: 5.802 <br/></li>
</ul>
</li>
<li><strong>Section Name:</strong> .rdata
<ul>
<li>Usage: Read-only initialized data</li>
<li>Raw Size: 8704 bytes</li>
<li>Virtual Size: 8488 bytes</li>
<li>Permissions: N/A</li>
<li>Entropy: 4.497</li>
</ul>
</li>
<li><strong>Section Name:</strong> .data
<ul>
<li>Usage: Initialized data</li>
<li>Raw Size: 29696 bytes</li>
<li>Virtual Size: 31176 bytes</li>
<li>Permissions: Writable</li>
<li>Entropy: 4.717</li>
</ul>
</li>
<li><strong>Section Name:</strong> .pdata
<ul>
<li>Usage: Exception information</li>
<li>Raw Size: 1024 bytes</li>
<li>Virtual Size: 732 bytes</li>
<li>Permissions: N/A</li>
<li>Entropy: 3.037</li>
</ul>
</li>
<li><strong>Section Name:</strong> .rsrc
<ul>
<li>Usage: Resource directory</li>
<li>Raw Size: 47616 bytes</li>
<li>Virtual Size: 47228 bytes</li>
<li>Permissions: N/A</li>
<li>Entropy: 4.031</li>
</ul>
</li>
<li><strong>Section Name:</strong> .reloc
<ul>
<li>Usage: Image relocations</li>
<li>Raw Size: 512 bytes</li>
<li>Virtual Size: 48 bytes</li>
<li>Permissions: N/A</li>
<li>Entropy: 0.647</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Based on the Entropy score and section names, this sample is unlikely packed.</p>
<br/>
<p>Check the <strong>libraries</strong> section:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/04be4d9672f3ba17bf87fdf437005b4f3ec39d19df4fab6e59b5ecc74860013b.png" alt="picture 4"></p>
<ul>
<li><strong>Library:</strong> wininet.dll
<ul>
<li>Usage: This DLL contains higher-level networking functions that implement protocols such as FTP, HTTP and NTP.</li>
<li>Suspicious?
<ul>
<li>Yes - It can be used to establish internet connections.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Library:</strong> urlmon.dll
<ul>
<li>Usage: Perform internet communications</li>
<li>Suspicious?
<ul>
<li>Yes - It can be used to establish internet connections.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Library:</strong> crypt32.dll
<ul>
<li>Usage: Handle cryptographic messaging functions</li>
<li>Suspicious?
<ul>
<li>Yes - This is commonly seen in malware for encrypted data, or even in ransomware</li>
</ul>
</li>
</ul>
</li>
<li><strong>Library:</strong> kernel32.dll
<ul>
<li>Usage: Contain core functionlity, like access and manipulation of memory, files, and hardware</li>
<li>Suspicious?
<ul>
<li>No - This is a very common DLL for any Windows executable</li>
</ul>
</li>
</ul>
</li>
<li><strong>Library:</strong> user32.dll
<ul>
<li>Usage: Contain all the user-interface components, such as buttons, scroll bars, and components for controlling and responding to user actions</li>
<li>Suspicious?
<ul>
<li>Could be - The subsystem is Console while having UI components, which is not consistent</li>
</ul>
</li>
</ul>
</li>
<li><strong>Library:</strong> advapi32.dll
<ul>
<li>Usage: Provide access to advanced core Windows components such as the Service Manager and Registry</li>
<li>Suspicious?
<ul>
<li>Could be - Commonly used for addign registry keys for persistence</li>
</ul>
</li>
</ul>
</li>
<li><strong>Library:</strong> shell32.dll
<ul>
<li>Usage: Contain Windows Shell API functions, which are used when opening webpages and files.</li>
<li>Suspicious?
<ul>
<li>No</li>
</ul>
</li>
</ul>
</li>
<li>Other libraries are added by Windows Visual C++, which can be likely ignored</li>
</ul>
<br/>
<h3 id="1-4---functions">1-4 - Functions</h3>
<p>Check the <strong>imports</strong> section to see the functions referenced by each library:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/2202e6698041d6cc8e41ceee4ee64e87ee1048adcf2581bc8e7960c2659e9a6f.png" alt="picture 5"></p>
<ul>
<li><strong>wininet.dll</strong>
<ul>
<li><strong>Function:</strong> DeleteUrlCacheEntry
<ul>
<li>Usage: Removes the file associated with the source name from the cache, if the file exists.</li>
<li>Suspicious?
<ul>
<li>Not obvious</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-deleteurlcacheentry">https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-deleteurlcacheentry</a></li>
</ul>
</li>
</ul>
</li>
<li><strong>Function:</strong> InternetCheckConnectionA
<ul>
<li>Usage: Allows an application to check if a connection to the Internet can be established.</li>
<li>Suspicious?
<ul>
<li>Yes - Can be used by the malware to check internet connectivity</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetcheckconnectiona">https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetcheckconnectiona</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/398ff4b69563164ea7a325cb712f13bfa96ab42a9b89b43d5146b52a8f94a92.png" alt="picture 9"></p>
<ul>
<li><strong>crypt32.dll</strong>
<ul>
<li><strong>Function:</strong> CryptStringToBinaryA
<ul>
<li>Usage: The CryptStringToBinary function converts a formatted string into an array of bytes.</li>
<li>Suspicious?
<ul>
<li>Yes - Could be used to decrypt componenets in the suspicious executable and execute it somehow.</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptstringtobinarya">https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptstringtobinarya</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/4c283ed2a66e5ce48911b238335a8486150fd7c5ba7943ac0582be97eb69b735.png" alt="picture 7"></p>
<ul>
<li><strong>urlmon.dll</strong>
<ul>
<li><strong>Function:</strong> URLDownloadToFileA
<ul>
<li>Usage: Downloads bits from the Internet and saves them to a file.</li>
<li>Suspicious?
<ul>
<li>Yes - Can be used by the malware to download additional files from the internet</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85)">https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/53d7c050715f5c3e01673896ff4d713e88a6777d1bee432a66c90b381aa22db8.png" alt="picture 6"></p>
<ul>
<li><strong>user32.dll</strong>
<ul>
<li><strong>Function:</strong> MessageBoxW
<ul>
<li>Usage: Displays a modal dialog box that contains a system icon, a set of buttons, and a brief application-specific message, such as status or error information.</li>
<li>Suspicious: Yes - commonly used by malware to mislead the user</li>
<li>Reference: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messageboxw">https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messageboxw</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c9339c22490e41670455d4ce93c779a278c72542848f9c23e1660a454c0284c3.png" alt="picture 10"></p>
<ul>
<li><strong>advapi32.dll</strong>
<ul>
<li><strong>Function:</strong> RegOpenKeyExA / RegOpenKeyExW
<ul>
<li>Usage: Opens the specified registry key.</li>
<li>Suspicious: Yes - Could be used for persistence</li>
<li>Reference: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa">https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa</a></li>
</ul>
</li>
<li><strong>Function:</strong> RegSetValueExA
<ul>
<li>Usage: Sets the data and type of a specified value under a registry key.</li>
<li>Suspicious: Yes - Could be used for persistence</li>
<li>Reference: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa">https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa</a></li>
</ul>
</li>
<li><strong>Function:</strong> RegCloseKey
<ul>
<li>Usage: Closes a handle to the specified registry key.</li>
<li>Suspicious: Yes - Could be used for persistence</li>
<li>Reference: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regclosekey">https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regclosekey</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/ae21c5d0741dca0ef6743e243d50bf73e155156315c09551aebbe00c7438c60.png" alt="picture 49"></p>
<ul>
<li><strong>shell32.dll</strong>
<ul>
<li><strong>Function:</strong> ShellExecuteA
<ul>
<li>Usage: Performs an operation on a specified file.</li>
<li>Suspicious: Yes - Can be used to execute malicious commands</li>
<li>Reference: <a href="https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecutea">https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecutea</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<h3 id="1-5---attck-analysis">1-5 - ATT&amp;CK Analysis</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/18bc05820be8b909419f1e7e3ddd197d3ec7741ae69ce2ae6470733ee432c4.png" alt="picture 11"></p>
<ul>
<li>Also there are MITRE ATT&amp;CK techniques with reference to the imports:
<ul>
<li><strong>Defense Evasion - T1497.003 - Virtulization/Sandbox Evasion: Time Based Evasion</strong>
<ul>
<li>Library: kernel32.dll</li>
<li>Function: Sleep</li>
<li>Description:
<ul>
<li>Adversaries may employ various time-based evasions, such as delaying malware functionality upon initial execution using programmatic sleep commands or native system scheduling functionality (ex: Scheduled Task/Job). Delays may also be based on waiting for specific victim conditions to be met (ex: system time, events, etc.)</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://attack.mitre.org/techniques/T1497/003/">https://attack.mitre.org/techniques/T1497/003/</a></li>
</ul>
</li>
</ul>
</li>
<li><strong>Discovery - T1124 - System Time Discovery</strong>
<ul>
<li>Description:
<ul>
<li>Library: kernel32.dll</li>
<li>Function: GetSystemTimeAsFileTime</li>
<li>Description:
<ul>
<li>An adversary may gather the system time and/or time zone from a local or remote system.</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://attack.mitre.org/techniques/T1124/">https://attack.mitre.org/techniques/T1124/</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>Defense Evasion - T1112 - Modify Registry</strong>
<ul>
<li>Description:
<ul>
<li>Library: advapi32.dll</li>
<li>Function: RegSetValueExA</li>
<li>Description:
<ul>
<li>Adversaries may interact with the Windows Registry to hide configuration information within Registry keys, remove information as part of cleaning up, or as part of other techniques to aid in persistence and execution.</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://attack.mitre.org/techniques/T1112/">https://attack.mitre.org/techniques/T1112/</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>Execution - T1106 - Native API</strong>
<ul>
<li>Description:
<ul>
<li>Library: kernel32.dll</li>
<li>Function: CreateProcessA</li>
<li>Description:
<ul>
<li>Functionality provided by native APIs are often also exposed to user-mode applications via interfaces and libraries. For example, functions such as the Windows API <code>CreateProcess()</code> or GNU <code>fork()</code> will allow programs and scripts to start other processes.</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://attack.mitre.org/techniques/T1106/">https://attack.mitre.org/techniques/T1106/</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>Execution - T1106 - Native API</strong>
<ul>
<li>Description:
<ul>
<li>Library: shell32.dll</li>
<li>Function: ShellExecuteA</li>
<li>Description:
<ul>
<li>Functionality provided by native APIs are often also exposed to user-mode applications via interfaces and libraries. For example, functions such as the Windows API <code>CreateProcess()</code> or GNU <code>fork()</code> will allow programs and scripts to start other processes.</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://attack.mitre.org/techniques/T1106/">https://attack.mitre.org/techniques/T1106/</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>Discovery - T1082 - System Information Discovery</strong>
<ul>
<li>Description:
<ul>
<li>Library: kernel32.dll</li>
<li>Function: IsDebuggerPresent</li>
<li>Description:
<ul>
<li>An adversary may attempt to get detailed information about the operating system and hardware, including version, patches, hotfixes, service packs, and architecture. IsDebuggerPresent is commonly seen in self-defense malware to detect if it is being debugged.</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://attack.mitre.org/techniques/T1082/">https://attack.mitre.org/techniques/T1082/</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<h3 id="1-6---resources">1-6 - Resources</h3>
<p>Check the resources section:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/19f859216e6becdb983d9144d6656105da875dd95824af137723cdc89612e38e.png" alt="picture 12"></p>
<ul>
<li>Most of them are icons</li>
</ul>
<br/>
<p>Check the manifest as well:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/250cc19b3ad88b1faaa1a08a7be052d0b26f60fc3652b4b7408b2b6b2fb9ace4.png" alt="picture 13"></p>
<ul>
<li>The sample requires running as administrator.</li>
</ul>
<br/>
<h3 id="1-7---strings-analysis">1-7 - Strings analysis</h3>
<p>Use <strong>BinText</strong> to look for interesting strings:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/694eb36b5210cf48737f52bc3741b97f0f27d634b8dfcbfb41f318ab143ae74f.png" alt="picture 14"></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>File position</th>
<th>Memory position</th>
<th>Text</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ASCII</td>
<td>2F50</td>
<td>2EDD</td>
<td>ph.exe</td>
<td>Unknown executable name</td>
</tr>
<tr>
<td>ASCII</td>
<td>2F58</td>
<td>2EE5</td>
<td>loader.exe</td>
<td>Unknown executable name</td>
</tr>
<tr>
<td>ASCII</td>
<td>2F68</td>
<td>2EF5</td>
<td><a href="http://www.elsmap.com/banner.jpg">http://www.elsmap.com/banner.jpg</a></td>
<td>URL of a JPG file from an unknown site</td>
</tr>
<tr>
<td>ASCII</td>
<td>2F90</td>
<td>2F1D</td>
<td>cmd.exe /C ping 1.1.1.1 -n 1 -w 3000 &gt; Nul &amp; Del /f /q &quot;%s&quot;</td>
<td>A cmd command for execute a one-time ping to 1.1.1.1 (possibly check internet connection) and delete a file quitely.</td>
</tr>
<tr>
<td>ASCII</td>
<td>3320</td>
<td>32AD</td>
<td><a href="http://update.microsoft.com">http://update.microsoft.com</a></td>
<td>URL of Microsoft Update - possibly used for internet connectivity</td>
</tr>
<tr>
<td>ASCII</td>
<td>3340</td>
<td>32CD</td>
<td>SOFTWARE\Microsoft\Windows\CurrentVersion\Run</td>
<td>A persistence run key by running a process automatically when a user login.</td>
</tr>
<tr>
<td>ASCII</td>
<td>3370</td>
<td>32FD</td>
<td>SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor</td>
<td>A persistence run key by injecting a DLL into the spoolsv.exe process.<br/>Ref: <a href="https://pentestlab.blog/2019/10/28/persistence-port-monitors/">https://pentestlab.blog/2019/10/28/persistence-port-monitors/</a></td>
</tr>
<tr>
<td>ASCII</td>
<td>33B0</td>
<td>333D</td>
<td>Yzpcd2luZG93c1xzdmNob3N0LmV4ZQ==</td>
<td>Base64 encoded string. Decoded version is <code>c:\windows\svchost.exe</code></td>
</tr>
<tr>
<td>ASCII</td>
<td>33D8</td>
<td>3365</td>
<td>WizLoader</td>
<td>Uncommon string</td>
</tr>
<tr>
<td>ASCII</td>
<td>33E8</td>
<td>3375</td>
<td>aHR0cDovL3d3dy5lbHNtYXAuY29tL2Jhbm5lci5qcGc=</td>
<td>Base64 encoded string. Decoded version is: <code>http://www.elsmap.com/banner.jpg</code></td>
</tr>
<tr>
<td>ASCII</td>
<td>3418</td>
<td>33A5</td>
<td>aHR0cDovL3d3dy5lbHNtYXAuY29tL2V4YW0vcnVubWUuYmF0</td>
<td>Base64 encoded string. Decoded version is: <code>http://www.elsmap.com/exam/runme.bat</code>, a potential suspicious script file.</td>
</tr>
<tr>
<td>ASCII</td>
<td>3450</td>
<td>33DD</td>
<td>VGhlcmUgaXMgbm90aGluZyBoZXJlIExPTA0KR28gY2hlY2sgc29tZXRoaW5nIGVsc2UgOyk=</td>
<td>Base64 encoded string. Decoded version is: <code>There is nothing here LOL&lt;br/&gt;Go check something else ;)</code> - Thanks for this easter egg!</td>
</tr>
<tr>
<td>ASCII</td>
<td>34A0</td>
<td>342D</td>
<td>aHR0cDovL3d3dy5lbHNtYXAuY29tL3N0YXJ0LmpwZw==</td>
<td>Base64 encoded string. The decoded version is: <code>http://www.elsmap.com/start.jpg</code></td>
</tr>
<tr>
<td>ASCII</td>
<td>34D0</td>
<td>345D</td>
<td>aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzEuanBn</td>
<td>Base64 encoded string. The decoded version is: <code>http://www.elsmap.com/pic1.jpg</code></td>
</tr>
<tr>
<td>ASCII</td>
<td>3500</td>
<td>348D</td>
<td>aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzIuanBn</td>
<td>Base64 encoded string. The decoded version is: <code>http://www.elsmap.com/pic2.jpg</code></td>
</tr>
<tr>
<td>ASCII</td>
<td>3530</td>
<td>34BD</td>
<td>aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzMuanBn</td>
<td>Base64 encoded string. The decoded version is: <code>http://www.elsmap.com/pic3.jpg</code></td>
</tr>
<tr>
<td>ASCII</td>
<td>3560</td>
<td>34ED</td>
<td>aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzQuanBn</td>
<td>Base64 encoded string. The decoded version is: <code>http://www.elsmap.com/pic4.jpg</code></td>
</tr>
<tr>
<td>ASCII</td>
<td>3590</td>
<td>351D</td>
<td>aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzUuanBn</td>
<td>Base64 encoded string. The decoded version is: <code>http://www.elsmap.com/pic5.jpg</code></td>
</tr>
<tr>
<td>ASCII</td>
<td>35C0</td>
<td>354D</td>
<td>aHR0cDovL3d3dy5lbHNtYXAuY29tL2Zvb3Rlci5qcGc=</td>
<td>Base64 encoded string. The decoded version is: <code>http://www.elsmap.com/footer.jpg</code></td>
</tr>
<tr>
<td>ASCII</td>
<td>35F0</td>
<td>357D</td>
<td>aHR0cDovL3d3dy5lbHNtYXAuY29tL2hlYWRlci5qcGc=</td>
<td>Base64 encoded string. The decoded version is: <code>http://www.elsmap.com/header.jpg</code></td>
</tr>
<tr>
<td>ASCII</td>
<td>3658</td>
<td>35E5</td>
<td>aHR0cDovL3d3dy5lbHNtYXAuY29tL2Jhbm5lci5qcGc=</td>
<td>Base64 encoded string. The decoded version is: <code>http://www.elsmap.com/banner.jpg</code></td>
</tr>
<tr>
<td>ASCII</td>
<td>3688</td>
<td>3615</td>
<td>QzpcV2luZG93c1xTeXN0ZW0zMlxjb25iYXNlLmRsbA==</td>
<td>Base64 encoded string. The decoded version is: <code>C:\Windows\System32\conbase.dll</code> - This is suspicious since it is similar to a legit Windows DLL called <code>combase.dll</code> in the same path.</td>
</tr>
<tr>
<td>ASCII</td>
<td>36C0</td>
<td>364D</td>
<td>/C loader.exe &amp;&amp; del /F loader.exe</td>
<td>A cmd command for running <code>loader.exe</code> and force delete it afterwards.</td>
</tr>
<tr>
<td>Unicode</td>
<td>2FD0</td>
<td>2F5D</td>
<td>WINDBG.EXE</td>
<td>A debugger name - possibly used for debugger detection</td>
</tr>
<tr>
<td>Unicode</td>
<td>2FE8</td>
<td>2F75</td>
<td>VsDebugConsole.EXE</td>
<td>A debugger name - possibly used for debugger detection</td>
</tr>
<tr>
<td>Unicode</td>
<td>3010</td>
<td>2F9D</td>
<td>devenv.exe</td>
<td>A debugger name - possibly used for debugger detection</td>
</tr>
<tr>
<td>Unicode</td>
<td>3040</td>
<td>2FCD</td>
<td>x96dbg.exe</td>
<td>A debugger name - possibly used for debugger detection</td>
</tr>
<tr>
<td>Unicode</td>
<td>3058</td>
<td>2FE5</td>
<td>x64dbg.exe</td>
<td>A debugger name - possibly used for debugger detection</td>
</tr>
<tr>
<td>Unicode</td>
<td>3070</td>
<td>2FFD</td>
<td>x32dbg.exe</td>
<td>A debugger name - possibly used for debugger detection</td>
</tr>
<tr>
<td>Unicode</td>
<td>3098</td>
<td>3025</td>
<td>Debugger Detected</td>
<td>Possible message when debugger detected</td>
</tr>
<tr>
<td>Unicode</td>
<td>30C0</td>
<td>304D</td>
<td>WIRESHARK.EXE</td>
<td>Network sniffer commonly used for malware analysis - possible a self-defense for detecting the sample itself being analyzed.</td>
</tr>
<tr>
<td>Unicode</td>
<td>30F8</td>
<td>3085</td>
<td>Abort!</td>
<td>Possible message when Wireshark is detected.</td>
</tr>
<tr>
<td>Unicode</td>
<td>3160</td>
<td>30ED</td>
<td>Good night!</td>
<td>Possible message when Wireshark / Debugger is detected.</td>
</tr>
<tr>
<td>Unicode</td>
<td>3178</td>
<td>3105</td>
<td>Sleep tight my sweety</td>
<td>Possible message when Wireshark / Debugger is detected.</td>
</tr>
<tr>
<td>Unicode</td>
<td>31A8</td>
<td>3135</td>
<td>\.\PhysicalDrive0</td>
<td>Possible sandbox detection by checking the drive size</td>
</tr>
<tr>
<td>Unicode</td>
<td>31D0</td>
<td>315D</td>
<td>C:\Windows\System32\VBox*.dll</td>
<td>Possible sandbox detection by checking if libraries related to VirtualBox are used.</td>
</tr>
<tr>
<td>Unicode</td>
<td>3210</td>
<td>319D</td>
<td>C:\Windows\System32\vm*.dll</td>
<td>Possible sandbox detection by checking if libraries related to VMWare are used.</td>
</tr>
<tr>
<td>Unicode</td>
<td>3248</td>
<td>31D5</td>
<td>Do it now?</td>
<td>Possible message when VM / Sandbox is detected.</td>
</tr>
<tr>
<td>Unicode</td>
<td>3260</td>
<td>3eD</td>
<td>SYSTEM\ControlSet001\Services\VBoxSF</td>
<td>Possible sandbox detection by checking if registry used by VirtualBox exists.</td>
</tr>
<tr>
<td>Unicode</td>
<td>32B0</td>
<td>323D</td>
<td>SYSTEM\ControlSet001\Services\VMTools</td>
<td>Possible sandbox detection by checking if registry used by VMWare exists.</td>
</tr>
<tr>
<td>Unicode</td>
<td>3300</td>
<td>328D</td>
<td>Reboot required</td>
<td>Possible message when VM / Sandbox is detected.</td>
</tr>
<tr>
<td>Unicode</td>
<td>3620</td>
<td>35AD</td>
<td>ABORT!</td>
<td>Possible message when VM / Sandbox is detected.</td>
</tr>
<tr>
<td>Unicode</td>
<td>3630</td>
<td>35BD</td>
<td>Sandbox Detected!</td>
<td>Possible message when VM / Sandbox is detected.</td>
</tr>
</tbody>
</table>
<br/>
<hr>
<h2 id="2---reverse-engineering">2 - Reverse Engineering</h2>
<p><strong>Question</strong></p>
<p>You are required to reverse engineer all the files that are related to the malware sample, whether they were given to you or downloaded by the malware.</p>
<p>You need to identify them and reverse engineer them to understand what they do. You are not required to reverse every single part of them, but at least their main functionality.</p>
<p>Explain all the APIs that are used, how they are used and make sure you reference them with their online documentation found at the MSDN.</p>
<br/>
<p><strong>Answer</strong></p>
<h3 id="finalexamexe">FinalExam.exe</h3>
<h4 id="preparation">Preparation</h4>
<p>First load the sample into <strong>CFF Explorer</strong> and navigate to <strong>Optional Header</strong>. Modify <strong>DllCharacteristics</strong> and disable the <code>DLL can move</code> flag:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/51445448ea8fe0bd9181932ef1d408c703db0fb6b8885a00c6afeda202740044.png" alt="picture 15"></p>
<br/>
<p>Then save as <code>FinalExam_ASLR_Disabled.exe</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3dffa376b43d89568fee3317f219000afe79f85006aa490fb539bd5088f2dc8f.png" alt="picture 16"></p>
<br/>
<p>Then load <code>FinalExam_ASLR_Disabled.exe</code> into <strong>IDA Pro (64-bit)</strong>.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/19bcccee619398c92cfb72e0b7922b7a85cd24909d7a65cad98b18152132d0f7.png" alt="picture 17"></p>
<br/>
<h4 id="urldownloadtofilea---1400015c0">URLDownloadToFileA - 1400015C0</h4>
<p><code>URLDownloadToFileA</code> is used to download bits from the Internet and saves them to a file.</p>
<br/>
<p>Navigate to <strong>Imports</strong> and look for <code>URLDownloadToFileA</code>. Double click on it and check the xref of this function:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/a2520f0dd90e2d4e70be2d53864dd6fcae0cbf66c2fb3dc03bcfb86c8eb43995.png" alt="picture 18"></p>
<ul>
<li>It is referenced at <code>1400015C0</code> and <code>140002080</code></li>
</ul>
<br/>
<p>First check <code>1400015C0</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/79de1c98cb175aaf6aa2cbed97b0a11b878abf776c2ec2a67c9b7914f4cfe5d.png" alt="picture 19"></p>
<p>With reference to MSDN document (<a href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85)">https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85)</a> we may analyze the parameters:</p>
<ul>
<li><code>pCaller</code>: A pointer to the controlling IUnknown interface of the calling ActiveX component, if the caller is an ActiveX component. If the calling application is not an ActiveX component, this value can be set to NULL.
<ul>
<li>This value is determined by <code>xor ecx,ecx</code> at <code>140001622</code>, resulting in <code>0</code></li>
<li>This means there is not an ActiveX component</li>
</ul>
</li>
<li><code>szURL</code>: A pointer to a string value that contains the URL to download.
<ul>
<li>This is determined by <code>[rsp+48h+lpszUrlName]</code> at <code>14000161D</code></li>
<li>Note <code>[rsp+48h+lpszUrlName]</code> is set up from <code>1400015D6-1400015E2</code>, it should contain the pointer to <code>aHttpWwwElsmapC</code> (<code>http://www.elsmap.com/banner.jpg</code>)</li>
</ul>
</li>
<li><code>szFileName</code>: A pointer to a string value containing the name or full path of the file to create for the download. If szFileName includes a path, the target directory must already exist.
<ul>
<li>This is determined by <code>r8, [rsp+48h+arg_8]</code> at <code>140001618</code></li>
<li>Determined by <code>rdx</code> at <code>1400015C0</code></li>
</ul>
</li>
<li><code>dwReserved</code>: Must be 0 as determined at <code>140001615</code></li>
<li><code>lpfnCB</code>: A pointer to the IBindStatusCallback interface of the caller. By using IBindStatusCallback::OnProgress, a caller can receive download status. This parameter can be set to NULL if status is not required.
<ul>
<li>Determined by the instruction <code>mov [rsp+48h+var_28],0</code> at <code>140001610C</code></li>
<li>The parameter is set to <code>0</code>, meaning that status is not required</li>
</ul>
</li>
</ul>
<br/>
<p>Short conclusion for <code>sub_1400015C0</code>:</p>
<ul>
<li>This function call is to download the file <code>http://www.elsmap.com/banner.jpg</code>.</li>
</ul>
<br/>
<h4 id="urldownloadtofilea---140002080">URLDownloadToFileA - 140002080</h4>
<p>Then check another subroutine at <code>140002080</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/ea9d5d29e1cdae02a0b643aa6dfbebe390bb2f1874e892091478d61c81a1d39f.png" alt="picture 20"></p>
<ul>
<li>This is a loop which calls <code>DeleteUrlCacheEntry</code> and <code>URLDownloadToFileA</code> several times as shown on the screenshot</li>
</ul>
<br/>
<p>At the beginning of the sub-routine, we can see the stack initialization with the base64-encoded URLs found in the static analysis:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c185ba37340c676ef6a0bbf667e9bced7f346ba214df0fea4b0daf79ac77a632.png" alt="picture 21"></p>
<br/>
<p>Then we can see the number of Loops at <code>140002145</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/fda1c34b59bae7d453966eebd2f0fbf30090301f7924d0555167379aea8db7f.png" alt="picture 22"></p>
<ul>
<li>The loop counter <code>[rsp+11C8h+var_1198]</code> is compared with the static number <code>9</code>, which mean the loop has 9 iteration used with initial number 0 and <code>jge</code> (jump if greater than or equal) condition</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/05adda2fe88e6978587b87af5ea9d0b8ba4f2f53ed4fe0c66b12812ed9353799.png" alt="picture 23"></p>
<ul>
<li>Then in this section, it self-loop until <code>[rax+rcx]</code> equals 0</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/51cc2cb99c36a2c793c536d6ff81608ce96afd65e43073c71c062c6e038567ce.png" alt="picture 24"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/b2a0951d71a1dbc4c8fef59ac135637cafaf3955acbceb59fa9a09ed548f05b1.png" alt="picture 25"></p>
<p>Then we can see a function call related <code>GetTempPathA</code> (MSDN Doc: <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-gettemppatha">https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-gettemppatha</a>).</p>
<ul>
<li>Purpose: Retrieves the path of the directory designated for temporary files.</li>
<li>Return: If the function succeeds, the return value is the length, in TCHARs, of the string copied to lpBuffer, not including the terminating null character. If the function fails, the return value is zero.</li>
<li>Parameters:
<ul>
<li><code>nBufferLength</code>: The size of the string buffer identified by lpBuffer, in TCHARs.
<ul>
<li>Determined by <code>r8d</code> at <code>14000218B</code>, which is <code>0x100</code></li>
</ul>
</li>
<li><code>lpBuffer</code>: A pointer to a string buffer that receives the null-terminated string specifying the temporary file path.
<ul>
<li>This is determined by <code>rdx</code>, which is assigned as <code>[rsp+11C8+FileName]</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p>After calling the subroutine with <code>GetTempPathA</code>, we can see if calls the subroutine <code>140001320</code>, which contains <code>CryptStringToBinaryA</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/b0ebd8567ac8e5ba5934aa3677099a34b3e3995acd9f11ab9db397af493dc5c0.png" alt="picture 26"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3a26f640fe1c009f7d82a7ce02b52fe5fc9199c88e029e7e6f8f472e833e66ee.png" alt="picture 27"></p>
<ul>
<li>We will come back to this function call in <code>140001320</code> separate.</li>
</ul>
<br/>
<p>After calling <code>140001320</code>, it calls <code>remove</code> and <code>DeleteUrlCacheEntry</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/9d5ce2ee058f6af3c0a004ac2f5bd34c18f3dead09758ac3b9425236bf94b3c.png" alt="picture 28"></p>
<ul>
<li>
<p>Remove:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/remove-wremove?view=msvc-160">https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/remove-wremove?view=msvc-160</a></li>
<li>Purpose: Delete a file.</li>
<li>In this case, it removes <code>[rsp+11C8h+FileName]</code></li>
</ul>
</li>
<li>
<p>DeleteUrlCacheEntry:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-deleteurlcacheentry">https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-deleteurlcacheentry</a></li>
<li>Purpose: Removes the file associated with the source name from the cache, if the file exists.</li>
<li>In this case, it removes the cache related to <code>[rsp+11C8h+szUrlName]</code></li>
</ul>
</li>
<li>
<p>These function calls remove the files and caches downloaded on the disk, which evades detection</p>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c7bc928e97ba4034a0672fcab1f69356124d5db28a49fc985da15e60e07f751.png" alt="picture 29"></p>
<ul>
<li>Then finally before the loop body ends, it calls <code>URLDownloadToFileA</code> to download another file from the C2 server.
<ul>
<li>URL determined by <code>[rsp+11C8h+szUrlName]</code></li>
<li>Filename determined by <code>[rsp+11C8h+FileName]</code></li>
</ul>
</li>
<li>This loop will finally looping through all the base64-encoded URL on the stack.</li>
</ul>
<br/>
<h4 id="cryptstringtobinarya---140001320">CryptStringToBinaryA - 140001320</h4>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/04f8567f0947c64e79670da3ddea1472508685135cf6cb6472f3de0dd746a938.png" alt="picture 30"></p>
<p>The comment for the initialization is with reference to the parameters passed by <code>140002145</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/9fa456eb541caf3564008f52591d60ea47c8bb8b180ff5f1a590a9616ed18c9d.png" alt="picture 31"></p>
<ul>
<li>Usage: Converts a formatted string into an array of bytes.</li>
<li>Return:
<ul>
<li>If the function succeeds, the return value is nonzero (TRUE).</li>
<li>If the function fails, the return value is zero (FALSE).</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>pszString</code>: A pointer to a string that contains the formatted string to be converted.
<ul>
<li>Determined by <code>rcx</code> at <code>14000132E</code>, which is <code>[rsp+rax*8+11C8h+FileName]</code> passed by the previously analyzed subroutine <code>140002145</code></li>
<li>This is the Base64-encoded string defined on the stack previously</li>
</ul>
</li>
<li><code>cchString</code>: The number of characters of the formatted string to be converted, not including the terminating NULL character. If this parameter is zero, <code>pszString</code> is considered to be a null-terminated string.
<ul>
<li>Determined by <code>edx</code> at <code>14000132A</code>, which is <code>[rsp+11C8h+var_1184]</code>, which is <code>0</code> as determined at <code>140002182</code></li>
<li><code>cchString = 0</code> means the formatted string is null-terminated</li>
</ul>
</li>
<li><code>dwFlags</code>: Indicates the format of the string to be converted.
<ul>
<li>Set to be <code>1</code> at <code>14000136F</code></li>
<li>This indicates <code>CRYPT_STRING_BASE64</code> - base64 strings without header</li>
</ul>
</li>
<li><code>pbBinary</code>: A pointer to a buffer that receives the returned sequence of bytes.
<ul>
<li>Determined by <code>r8</code> at <code>140001325</code></li>
<li><code>[rsp+11C8h+szUrlName]</code> is passed to this.</li>
<li>This is how <code>URLDownloadToFileA</code> in subroutine <code>140002080</code> requests different URL each time</li>
</ul>
</li>
<li><code>pcbBinary</code>: A pointer to a DWORD variable that, on entry, contains the size, in bytes, of the pbBinary buffer.
<ul>
<li>This is eventually determined by <code>r9d</code> at <code>140001320</code>, which is passed by subroutine <code>140002080</code> as <code>0x1000</code></li>
<li>The size of the buffer will be 4096 (0x1000) bytes</li>
</ul>
</li>
<li><code>pdwSkip</code>: A pointer to a DWORD value that receives the number of characters skipped to reach the beginning of the -----BEGIN ...----- header. If no header is present, then the DWORD is set to zero. This parameter is optional and can be NULL if it is not needed.
<ul>
<li>This is set to <code>0</code> at <code>140001357</code></li>
</ul>
</li>
<li><code>pdwFlags</code>: A pointer to a DWORD value that receives the flags actually used in the conversion. This parameter is optional and can be NULL if it is not needed.
<ul>
<li>This is set to <code>0</code> at <code>14000134E</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>In short, the subroutine <code>140001320</code> is responsible for converting the base64-encoded URL and return to the subroutine <code>140002080</code> for retrieving files from the supicious server.</p>
<br/>
<p>Next check another API call <code>RegSetValueExA</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3ba98fea149d7867c90ffe42c399068af8431b96e11d12124b6b625124141f7f.png" alt="picture 33"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/215ad2698d13493f234e98e35dea017ed0367fa69c54eeba4d9aa2aeebbbfc7.png" alt="picture 34"></p>
<ul>
<li><code>RegSetValueExA</code> is referenced at <code>140001B80</code> and <code>140001C70</code></li>
</ul>
<h4 id="regopenkeyexa-regsetvalueexa-regclosekey---140001b80">RegOpenKeyExA, RegSetValueExA, RegCloseKey - 140001B80</h4>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/608ec9017c20e38defb59358ec83fa06eba6777104d329d5508793eddc7c2f1.png" alt="picture 36"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c6b16ed96c97075f071aa8128d2f0e9a5269dd5db3bf6cdd748860dccbd96de0.png" alt="picture 37"></p>
<ul>
<li>MSDN Doc: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa">https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa</a></li>
<li>Usage: Opens the specified registry key.</li>
<li>Return Value:
<ul>
<li>If the function succeeds, the return value is ERROR_SUCCESS.</li>
<li>If the function fails, the return value is a nonzero error code defined in Winerror.h.</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>hKey</code>: A handle to an open registry key, or it can be one of the following predefined keys: HKEY_CLASSES_ROOT HKEY_CURRENT_CONFIG HKEY_CURRENT_USER HKEY_LOCAL_MACHINE HKEY_USERS
<ul>
<li>In this case, by checking the symbolic constant of <code>0xFFFFFFFF80000002h</code>, it is <code>HKEY_LOCAL_MACHINE</code>, as shown in the above screenshot.</li>
</ul>
</li>
<li><code>lpSubKey</code>: The name of the registry subkey to be opened.
<ul>
<li>Determined at <code>140001BB0</code>, which is the constant string <code>SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code></li>
</ul>
</li>
<li><code>ulOptions</code>: Specifies the option to apply when opening the key.
<ul>
<li>Determined at <code>140001BAD</code> - self XOR-ing resulting in <code>0</code></li>
<li>No option set</li>
</ul>
</li>
<li><code>samDesired</code>: A mask that specifies the desired access rights to the key to be opened.
<ul>
<li>It is set to be <code>2</code> at <code>140001BA7</code>
<ul>
<li>With reference to <a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-key-security-and-access-rights">https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-key-security-and-access-rights</a>, <code>2</code> means <code>KEY_SET_VALUE</code>  - Required to create, delete, or set a registry value.</li>
</ul>
</li>
</ul>
</li>
<li><code>phkResult</code>: A pointer to a variable that receives a handle to the opened key.
<ul>
<li>This is set to be <code>rax</code> at <code>140001BA2</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>In short, this function call opens the Registry Key <code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>, which is a key that can be used for persistence.</p>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/436cda2540077eb071bfdc64b0127a143997b5ca901621c34c61345d719f482d.png" alt="picture 35"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/af8e9c27f01039485ee9d9d64f5780c2a92b50f94e8a68ba2614faa8fe2635f.png" alt="picture 38"></p>
<p><code>RegSetValueExA</code>:</p>
<ul>
<li>MSDN doc: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa">https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa</a></li>
<li>Purpose:
<ul>
<li>Sets the data and type of a specified value under a registry key.</li>
</ul>
</li>
<li>Return Value:
<ul>
<li>If the function succeeds, the return value is ERROR_SUCCESS.</li>
<li>If the function fails, the return value is a nonzero error code defined in Winerror.h.</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>hKey</code>:  A handle to an open registry key.
<ul>
<li>This is set as <code>[rsp+68h+hKey]</code> at <code>140001C1F</code>. This is determined when calling <code>RegOpenKeyExA</code>, which should be <code>HKEY_LOCAL_MACHINE</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/a00808aa4bd97953dccd47e120f343896b1657e788a19ad3093d243ad396e974.png" alt="picture 39"></p>
<ul>
<li><code>lpValueName</code>: The name of the value to be set.
<ul>
<li>This is determined by <code>[rsp+68h+lpValueName]</code>, which is referenced at <code>140001B85</code>. This has to be determined by the parameter value in <code>rcx</code> of the callee
<ul>
<li>To determine, click on the current subroutine name <code>sub_140001B80</code> and check the reference, as shown in the above screenshot - It is called by <code>140001D60</code></li>
<li><code>rcx</code> is set to be <code>WizLoader</code> at <code>14001DC8</code></li>
</ul>
</li>
<li>Therefore, this is set to be <code>WizLoader</code></li>
</ul>
</li>
<li><code>Reserved</code>: No meaning in context</li>
<li><code>dwType</code>: The type of data pointed to by the lpData parameter.
<ul>
<li>Set to be <code>1</code> at <code>140001C11</code></li>
<li>According to <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wprn/742b6ee-0323-42b1-b94c-65b3e21b086d">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wprn/742b6ee-0323-42b1-b94c-65b3e21b086d</a>, it is of type <code>REG_SZ</code> - a string.</li>
</ul>
</li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/19b4f37bbbc16a199876843490c637761dac5821553f3bd81a61360a2b722c81.png" alt="picture 40"></p>
<ul>
<li><code>lpData</code>: The data to be stored.
<ul>
<li>This is determined by <code>[rsp+68h+lpData]</code> at <code>140001C07</code>, which has a reference at the beginning of the current subroutine at <code>140001B80</code> - which need to determine the parameter passed in <code>rdx</code> of the callee
<ul>
<li>Similar to <code>lpValueName</code>, check the value set in <code>rdx</code> at the moment the current subroutine is called.</li>
<li>On the screenshot, <code>rdx</code> is determined by the return value of the function call <code>140001320</code>, which is used to decode base64 string as analyzed previously</li>
<li>At <code>140001D87</code>, we can find the base64-encoded string <code>Yzpcd2luZG93c1xzdmNob3N0LmV4ZQ==</code>, which is passed to <code>140001320</code> at <code>140001DB9</code>. Decoding this string, it should be <code>c:\windows\svchost.exe</code></li>
</ul>
</li>
<li>Therefore, the data to be stored is <code>c:\windows\svchost.exe</code></li>
</ul>
</li>
<li><code>cbData</code>: The size of the information pointed to by the lpData parameter, in bytes.
<ul>
<li>It is determined by <code>[rsp+68h+var_30]</code></li>
</ul>
</li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/777da8d825a7fc27f4eaea96f82655069aab9b71136e41fd2a908b84393ab35.png" alt="picture 44"></p>
<ul>
<li>Then the opened reg key is closed by calling <code>RegCloseKey</code>.</li>
</ul>
<br/>
<p>In short, the <code>RegSetValueExA</code> call adds a value for the key <code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\WizLoader</code> of the value <code>c:\windows\svchost.exe</code>, meaning that when any user logins the system, <code>c:\windows\svchost.exe</code> will be run.</p>
<br/>
<h4 id="regopenkeyexa-regsetvalueexa-regclosekey---140001c70">RegOpenKeyExA, RegSetValueExA, RegCloseKey - 140001C70</h4>
<p>The API usage is basically the same excepted for the following:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c11b4e044178a9148c8f4d0c2e516a2f0619ef7c5e66ecb25999737950993f55.png" alt="picture 41"></p>
<ul>
<li><code>RegOpenKeyExA</code>
<ul>
<li>The key to be opened is <code>SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor</code></li>
</ul>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/4bec13fb2130efee584b76897bfc5e1c9ea350970d4af60d6b291ff6f97ae194.png" alt="picture 43"></p>
<ul>
<li><code>RegSetValueExA</code>
<ul>
<li>The value name is <code>Driver</code></li>
<li>The data set is <code>C:\Windows\System32\conbase.dll</code></li>
</ul>
</li>
</ul>
<br/>
<p>In short, this functions calls in the subroutine <code>140001C70</code> set the registry key <code>HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor\Driver</code> with value <code>C:\Windows\System32\conbase.dll</code> for persistence, by injecting the DLL <code>C:\Windows\System32\conbase.dll</code> in the spooler.exe process.</p>
<br/>
<h4 id="internetcheckconnectiona-in-sub_140001ae0">InternetCheckConnectionA in sub_140001AE0</h4>
<p>In the subroutine <code>sub_140001AE0</code>, the API <code>InternetCheckConnectionA</code> is used:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3f42fed2795e756f140245b35c751be26faa0293f13de624bef4b945341870a0.png" alt="picture 45"></p>
<ul>
<li>MSDN doc: <a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetcheckconnectiona">https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetcheckconnectiona</a></li>
<li>Usage: Allows an application to check if a connection to the Internet can be established.</li>
<li>Return: Returns <code>TRUE</code> if a connection is made successfully, or <code>FALSE</code> otherwise.</li>
<li>Parameters:
<ul>
<li><code>lpszUrl</code>: Pointer to a null-terminated string that specifies the URL to use to check the connection.
<ul>
<li>Determined by <code>lea rcx, [rsp+0D8h+szUrl]</code> at <code>140001B3B</code>. <code>[rsp+0D8h+szUrl]</code> is defined by the callee on the stack but in this case it looks to be NULL</li>
<li>Then according to the MSDN, If lpszUrl is NULL and there is an entry in the internal server database for the nearest server, the host value is extracted from the entry and used to ping that server.</li>
<li>This will be <code>http://update.microsoft.com</code> as defined at <code>140001B1F</code></li>
</ul>
</li>
<li><code>dwFlags</code>: Options.
<ul>
<li>This is set to be <code>1</code> at <code>140001B36</code> -  the host value is extracted from it and used to ping that specific host.</li>
</ul>
</li>
<li><code>dwReserved</code>: Reserved and should be 0.</li>
</ul>
</li>
</ul>
<p>In short, this function call is used to check the internet connectivity. If unsuccessful, it jumps to <code>140001B51</code> (which sets <code>[rsp+0D8h+var_B8]</code> to be <code>0</code> and <code>140001B56</code> otherwise. <code>eax</code> will be returned as <code>0</code> for this subroutine call if internet conenction is unsuccessful.</p>
<br/>
<h4 id="messageboxw-in-main-function">MessageBoxW in main function</h4>
<p><code>MessageBoxW</code> is used in multiple locations:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/65f42c080c23311a3b7fe87d434ef0d25b01f6537ec233407081c314ae56d60.png" alt="picture 46"></p>
<ul>
<li>main</li>
<li>140001AA0</li>
<li>140001740</li>
</ul>
<br/>
<p>Since the usage of this API is quite simple, take one example at the location <code>main+6C</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/30e273c7a26f342ae3898f027b98122ef09cf9f477697bb253f476e988999b2.png" alt="picture 47"></p>
<ul>
<li>MSDN: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messageboxw">https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messageboxw</a></li>
<li>Usage: Displays a modal dialog box that contains a system icon, a set of buttons, and a brief application-specific message, such as status or error information.</li>
<li>Return:
<ul>
<li>If a message box has a Cancel button, the function returns the IDCANCEL value if either the ESC key is pressed or the Cancel button is selected. If the message box has no Cancel button, pressing ESC will no effect - unless an MB_OK button is present. If an MB_OK button is displayed and the user presses ESC, the return value will be IDOK.</li>
<li>If the function fails, the return value is zero.</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>hWnd</code>: A handle to the owner window of the message box to be created. If this parameter is NULL, the message box has no owner window.
<ul>
<li>Determined by <code>xor ecx,ecx</code> at <code>14000229A</code>, which is zero</li>
<li>No owner window</li>
</ul>
</li>
<li><code>lpText</code>: The message to be displayed.
<ul>
<li>Determined by <code>aSandboxDetecte</code>, a constant with the value <code>Sandbox Detected!</code></li>
</ul>
</li>
<li><code>lpCaption</code>: The dialog box title.
<ul>
<li>Determined by <code>aAbort_0</code> at <code>14000228C</code>, which is a constant value <code>ABORT!</code></li>
</ul>
</li>
<li><code>uType</code>: The contents and behavior of the dialog box.
<ul>
<li>Set to be <code>0x10</code> at <code>140002286</code>. This means <code>MB_ICONSTOP</code> - A stop-sign icon appears in the message box.</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/6edb00838ec4c49ab8ca26796340aec82bf5403e672625559cfc6c3c6df9abb2.png" alt="picture 48"></p>
<p>In short, this function call is used to display the warning message <code>Sandbox Detected!</code> upon detecting being in sandbox environment.</p>
<p>After displaying the warning message, the process will terminate.</p>
<br/>
<h4 id="messageboxw-in-140001aa0">MessageBoxW in 140001AA0</h4>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/12101253e7a0a3558853a411146f12639450bf45b31aa9b992c3132b2c6730f8.png" alt="picture 53"></p>
<ul>
<li><code>hWnd</code> is set to <code>0</code> at <code>140001AB8</code></li>
<li><code>lpText</code> is set to the string <code>Do it now?</code></li>
<li><code>lpCaption</code> is set to the string <code>Reboot required</code></li>
<li><code>uType</code> is set to <code>3</code>, which means <code>MB_YESNOCANCEL</code> - The message box contains three push buttons: Yes, No, and Cancel.</li>
<li>After the function call, it compare the return value with <code>6</code> at <code>140001AC4</code>
<ul>
<li><code>6</code> = <code>IDYES</code> = The Yes button was selected.</li>
<li>If so, <code>eax</code> will be set to <code>0</code> at <code>140001ACB</code></li>
</ul>
</li>
</ul>
<br/>
<h4 id="messageboxw-in-140001740">MessageBoxW in 140001740</h4>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/d58e4dc68e9350853d14ddc78c1fb2b33eec2224e94d9ecd38301250b68cebac.png" alt="picture 54"></p>
<ul>
<li><code>hWnd</code> is set to <code>0</code> at <code>140001773</code></li>
<li><code>lpText</code> is set to the string <code>Debugger Detected</code></li>
<li><code>lpCaption</code> is set to <code>Abort!</code></li>
<li><code>uType</code> is set to <code>0x10</code>. This means <code>MB_ICONSTOP</code> - A stop-sign icon appears in the message box.</li>
</ul>
<p>After the call the program exit with code 9.</p>
<br/>
<h4 id="shellexecutea-in-main-function">ShellExecuteA in main function</h4>
<p><code>ShellExecuteA</code> is used in the main function:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/ef8b1ae95b8d16395fe0412f154812be9d803919fc17602c82b299a0f400fcd1.png" alt="picture 50"></p>
<p>Inspect the usage:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/4f96cc88351454f4ee4963d4ea5d53a1646421baf6b66fbcd427bf663ee0264b.png" alt="picture 51"></p>
<ul>
<li>MSDN: <a href="https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecutea">https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecutea</a></li>
<li>Usage: Performs an operation on a specified file.</li>
<li>Return:
<ul>
<li>If the function succeeds, it returns a value greater than 32.</li>
<li>If the function fails, it returns an error value that indicates the cause of the failure.</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>hwnd</code>: A handle to the parent window used for displaying a UI or error messages. This value can be NULL if the operation is not associated with a window.
<ul>
<li>Set as <code>0</code> at <code>1400023E4</code> by self XORing</li>
</ul>
</li>
<li><code>lpOperation</code>: A pointer to a null-terminated string, referred to in this case as a verb, that specifies the action to be performed.
<ul>
<li>Set as <code>open</code> at <code>1400023DD</code></li>
<li>Opens the item specified by the lpFile parameter. The item can be a file or folder.</li>
</ul>
</li>
<li><code>lpFile</code>: A pointer to a null-terminated string that specifies the file or object on which to execute the specified verb. To specify a Shell namespace object, pass the fully qualified parse name. Note that not all verbs are supported on all objects.
<ul>
<li>Set as <code>cmd.exe</code> at <code>1400023D6</code></li>
<li>Execute <code>cmd.exe</code></li>
</ul>
</li>
<li><code>lpParameters</code>: If lpFile specifies an executable file, this parameter is a pointer to a null-terminated string that specifies the parameters to be passed to the application.
<ul>
<li>Set as <code>/C loader.exe &amp;&amp; del /F loader.exe</code></li>
</ul>
</li>
<li><code>lpDirectory</code>: A pointer to a null-terminated string that specifies the default (working) directory for the action. If this value is NULL, the current working directory is used.
<ul>
<li>Set as <code>0</code> - Current directory will be used</li>
</ul>
</li>
<li><code>nShowCmd</code>: The flags that specify how an application is to be displayed when it is opened.
<ul>
<li>Set as <code>0</code> at <code>1400023BE</code>.</li>
<li>According to <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-showwindow">https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-showwindow</a>, this value means &quot;Hides the window and activates another window.&quot;</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p>In short, <code>ShellExecuteA</code> executes <code>cmd.exe /C loader.exe &amp;&amp; del /F loader.exe</code> and hide the running window. This execute the file <code>loader.exe</code> and then delete it afterwards.</p>
<br/>
<h4 id="anti-x-functions">Anti-X functions</h4>
<p>Analyzing the subroutines involved in the main function, several Anti-X functions are found. The sub-routines are renamed so as to visualize the intentions of them.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/fe6b649c48a3cfad989b6258cf522dc6572177c941686b404b8aa84ab27c82f1.png" alt="picture 55"></p>
<ul>
<li><code>14000225D</code>: Calling anti-debugger subroutine 140001740</li>
<li><code>140002262</code>: Calling sandbox detection subroutine 1400017D0</li>
</ul>
<br/>
<h4 id="debugger-detection-at-subroutine-140001740">Debugger Detection at subroutine 140001740</h4>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/12d067cd84ebb49059bfb6a6051b8d6f373bb05368cd36c46c837b7e59fd937.png" alt="picture 56"></p>
<p>The logic of detecting debugger is to check the flag <code>BeingDebugged</code> (<code>gs:60h</code>).</p>
<p>If the flag is active, the result at <code>14000175B</code> will be non-zero, which means debugger presents, and it will pop up the alert box and exit process.</p>
<br/>
<h4 id="sandbox-detection-at-subroutine-1400017d0">Sandbox detection at subroutine 1400017D0</h4>
<p>First it starts by using <code>GetSystemInfo</code> to get an object of system information:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c14dc194e24407870f3e2df819e6765f1060f6f95be042a90f94fafd4b140622.png" alt="picture 57"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsysteminfo">https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsysteminfo</a></li>
<li>Usage: Retrieves information about the current system.</li>
<li>It compares the number of processors with a hardcoded number <code>4</code>
<ul>
<li>If the number of processor is less than 4, it regards the environment as sandbox, which essentially set <code>eax</code> to <code>1</code> and return</li>
<li>Otherwise, it continues to other checkings</li>
</ul>
</li>
</ul>
<br/>
<p>Then it uses <code>GlobalMemoryStatusEx</code> to get the memory information.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/71c534a563df57a755f45130f5e0b12e206300cca2da040f320b6e4f5f80739.png" alt="picture 58"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-globalmemorystatusex">https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-globalmemorystatusex</a></li>
<li>Usage Retrieves information about the system's current usage of both physical and virtual memory.</li>
<li>It compares the total physical memory with the hardcoded number <code>8192</code>
<ul>
<li>If the system has less than <code>8192</code> memory, it regards the environment as sandbox, which set <code>eax</code> to <code>1</code> and return</li>
<li>Otherwise, it continues to other checkings</li>
</ul>
</li>
</ul>
<br/>
<p>Then it utilizes <code>CreateFileW</code> and <code>DeviceIoControl</code> to check the storage information.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/408f05639bceca131903de9d58d98f41a8439e342c2cbd21f67995b9f8ba112f.png" alt="picture 59"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilew">https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilew</a>
<ul>
<li><code>CreateFileW</code> is used to read the main disk drive and get the device handle</li>
</ul>
</li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">https://docs.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol</a>
<ul>
<li><code>DeviceIoControl</code> is used to seend a control code directly to a specified device driver
<ul>
<li>The control code <code>0x70000</code> at <code>1400018C1</code> retrieves information about the physical disk's geometry</li>
<li>The codes follow will convert the result to number of GB</li>
</ul>
</li>
</ul>
</li>
<li>It then compares <code>100</code> with the disk size
<ul>
<li>If the system has less than <code>100</code> GB, it regards the environment as sandbox, which set <code>eax</code> to <code>1</code> and return</li>
<li>Otherwise, it sets <code>eax</code> to <code>0</code> at <code>140001933</code> and return</li>
</ul>
</li>
</ul>
<br/>
<p>In the main function, we can see after the sandbox detection subroutine, if <code>eax</code> is <code>1</code>, it jumps to <code>140002286</code>, which pops up an alert box and exits process.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/484d8c091b3a54aea92dad250aafc66897d4421b8201d1044f15ca3959cd33d6.png" alt="picture 60"></p>
<p>If not detected, it proceeds another checking.</p>
<br/>
<h4 id="vm-detection-at-subroutine-140001950">VM Detection at subroutine 140001950</h4>
<p>It uses <code>FindFirstFileW</code> to look for the patterns:</p>
<ul>
<li><code>C:\\Windows\\System32\\VBox*.dll</code>
<ul>
<li>DLL files related to VirtualBox</li>
</ul>
</li>
<li><code>C:\\Windows\\System32\\vm*.dll</code>
<ul>
<li>DLL files related to VMWare</li>
</ul>
</li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/372c885da8427a19cb15f186ef40fb60c51725296022c8814fd078619d4f480a.png" alt="picture 61"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-findfirstfilew">https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-findfirstfilew</a></li>
<li>Return value:
<ul>
<li>If the function succeeds, the return value is a search handle used in a subsequent call to FindNextFile or FindClose</li>
<li>If the function fails or fails to locate files from the search string in the lpFileName parameter, the return value is INVALID_HANDLE_VALUE (0FFFFFFFFFFFFFFFFh)</li>
</ul>
</li>
<li>At <code>14000197B</code>, we can see it compares the return value of <code>FindFirstFileW</code> with <code>0FFFFFFFFFFFFFFFFh</code>
<ul>
<li>If not found, it jumps to <code>14000198B</code> to look for VMWare related libraries</li>
<li>Otherwise it sets <code>eax</code> to <code>1</code> and return</li>
</ul>
</li>
<li>Similarlarly at <code>1400019A1</code>, if no DLL file related to VMWare is found, it jumps to <code>1400019AA</code> to do another check
<ul>
<li>Otherwise it sets <code>eax</code> to <code>1</code> and return</li>
</ul>
</li>
</ul>
<br/>
<p>Then it proceeds to use <code>RegOpenKeyExW</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3edb48a65056450f8031159fb95f923b785ca214110be5abddf75e291fc6c2db.png" alt="picture 62"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexw">https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexw</a></li>
<li>Return value:
<ul>
<li>If the function succeeds, the return value is ERROR_SUCCESS.</li>
<li>If the function fails, the return value is a nonzero error code</li>
</ul>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/f315c4490b6d0cc51068631f6a8f4ff7ecf2af1d6ebb00ba1cc70368531c8a23.png" alt="picture 63"></p>
<p>In the <code>RegOpenKeyExW</code> call at <code>1400019CB</code>, it tries to open <code>HKLM\\SYSTEM\\ControlSet001\\Services\\VBoxSF</code> and test the return value at <code>1400019D1</code></p>
<ul>
<li>If <code>eax</code> is non-zero, the registry key related to VirtualBox is not found and it jumps to <code>1400019DC</code> to proceed to check the VMWare registry key
<ul>
<li>Otherwise it sets <code>eax</code> to <code>1</code> and return</li>
</ul>
</li>
</ul>
<p>Similarly it checks the registry key <code>HKLM\\SYSTEM\\ControlSet001\\Services\\VMTools</code> at <code>1400019FD</code> by trying to open it.</p>
<ul>
<li>If <code>eax</code> is non-zero, which means it fails to open the RegKey, it jumps to <code>140001A0E</code>, the <code>xor eax,eax</code> instruction, and finally return <code>eax=0</code>
<ul>
<li>Otherwise, the <code>eax</code> is set to <code>1</code> and return.</li>
</ul>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/d49c69ddf4d7ed76c1113e651684f7decc2c25c4ef47d94984e7f05357545.png" alt="picture 64"></p>
<ul>
<li>If returned <code>eax=1</code>, which means VM detected, it jumps to the location of exiting the process.</li>
<li>Otherwise, it proceed to another checking in the subroutine <code>140002274</code></li>
</ul>
<br/>
<h4 id="sandbox-detection-by-number-of-processes">Sandbox detection by Number of Processes</h4>
<p>At <code>140002274</code> it calls a subroutine at <code>140001A30</code>, which contains a function call <code>K32EnumProcesses</code>.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/75ea7049e8935ea686f59e9c197e09a32d1b54253921cc6881cb92fb9d7fc7c8.png" alt="picture 65"></p>
<ul>
<li>MSDN: <a href="https://docs.microsoft.com/en-us/windows/win32/api/psapi/nf-psapi-enumprocesses">https://docs.microsoft.com/en-us/windows/win32/api/psapi/nf-psapi-enumprocesses</a></li>
<li>Usage: Retrieves the process identifier for each process object in the system.</li>
<li>Parameters:
<ul>
<li><code>lpidProcess</code>: A pointer to an array that receives the list of process identifiers.
<ul>
<li>Set as <code>[rsp+1048h+idProcess]</code></li>
</ul>
</li>
<li><code>cb</code>: The size of the <code>pProcessIds</code> array, in bytes.
<ul>
<li>Set as <code>1000h</code></li>
</ul>
</li>
<li><code>lpcbNeeded</code>: The number of bytes returned in the <code>pProcessIds</code> array.
<ul>
<li>Set as <code>[rsp+1048h+cbNeeded]</code></li>
</ul>
</li>
</ul>
</li>
<li>Return value:
<ul>
<li>If the function succeeds, the return value is non-zero</li>
<li>If the function fails; the return value is <code>0</code></li>
</ul>
</li>
<li>At <code>140001A87</code>, it compares the return value with <code>100</code>
<ul>
<li>If the return value is below <code>100</code>, it regards the environment as sandbox, which set <code>eax</code> to 1 and return</li>
<li>Otherwise it return <code>eax=0</code></li>
</ul>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/e66a835559aac45968b24313c0130c7c64b380e63f346c8b498ce766f65f608.png" alt="picture 67"></p>
<ul>
<li>If <code>eax</code> returned is not zero, it jumps to <code>140002286</code> and exits the process.</li>
<li>Otherwise it proceeds to another check.</li>
</ul>
<br/>
<h4 id="debugger-detection-by-using-tickcount">Debugger detection by using TickCount</h4>
<p>At <code>14000227D</code>, the main function calls the sub-routine <code>140001790</code>, which contains a API call to <code>GetTickCount64</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/2a52ebcd3f89a8bdbebfeda166a3e1ba7898472af78136e31a87c4086b169758.png" alt="picture 68"></p>
<ul>
<li>MSDN: <a href="https://docs.microsoft.com/zh-tw/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount64">https://docs.microsoft.com/zh-tw/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount64</a></li>
<li>Usage: Retrieves the number of milliseconds that have elapsed since the system was started.</li>
<li>Return: The number of milliseconds.</li>
<li>At <code>1400017A9</code>, it compares the return value with <code>86400</code> (ms)
<ul>
<li>If the system uptime is lower than 86400 ms, it regards the current environment as Sandbox and will set <code>eax=1</code> and return</li>
<li>Otherwise <code>eax</code> will be set to <code>0</code> at <code>1400017BB</code> and return</li>
</ul>
</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/a9f1610a4b5077157d713723afe650ab627383d3769fef12640b7c6da8a04379.png" alt="picture 69"></p>
<ul>
<li>If <code>eax</code> is <code>0</code>, it means sandbox is not detected and it jumps to <code>1400022AD</code>
<ul>
<li>Otherwise, it proceeds to <code>140002286</code> and will exit the process.</li>
</ul>
</li>
</ul>
<br/>
<h3 id="bannerjpg">banner.jpg</h3>
<p>Checking the URLs found, it is identified that <code>banner.jpg</code> is actually a Windows PE file (DLL):</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/42e437cb644e9413307ead33bf2c40ebe5ff25e70a33945ebad30da2599e351.png" alt="picture 70"></p>
<br/>
<h3 id="loaderexe">loader.exe</h3>
<p>In the string analysis, we identify <code>loader.exe</code> in the sample. On IDA Pro, navigate to <code>View &gt; Open subviews &gt; Strings</code> and then find <code>loader.exe</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c760405a8813ac0312aef55079ed86c4c30c72c5ff60b988bc5d862a84c3cb7d.png" alt="picture 100"></p>
<ul>
<li>Double click it and check its cross reference:</li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/91b1b7be6dd50c8f4a7e545723f805667517c9ec49e1a6c442e02c203aa5109c.png" alt="picture 143"></p>
<ul>
<li>The subroutine <code>1400014C0</code> has a reference</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/8a7676837b8c80cb17d9d7aed6a26f28df0666782852f8c43616d9a326073df.png" alt="picture 144"></p>
<ul>
<li>MSDN: <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea">https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea</a></li>
<li>Usage: Creates or opens a file or I/O device.</li>
<li>Return:
<ul>
<li>If the function succeeds, the return value is an open handle to the specified file, device, named pipe, or mail slot.</li>
<li>If the function fails, the return value is INVALID_HANDLE_VALUE.</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>lpFileName</code>: The name of the file or device to be created or opened.
<ul>
<li>Set to be <code>loader.exe</code> at <code>140001506</code></li>
</ul>
</li>
<li><code>dwDesiredAccess</code>: The requested access to the file or device, which can be summarized as read, write, both or neither zero).
<ul>
<li>Set to be <code>0xc0000000</code> at <code>140001501</code>, which represents <code>GENERIC_READ | GENERIC_WRITE</code></li>
</ul>
</li>
<li><code>dwShareMode</code>: The requested sharing mode of the file or device, which can be read, write, both, delete, all of these, or none.
<ul>
<li>Set to be <code>3</code> at <code>1400014FB</code>, which should be the combination of <code>FILE_SHARE_READ</code> and <code>FILE_SHARE_WRITE</code></li>
</ul>
</li>
<li><code>lpSecurityAttributes</code>: A pointer to a SECURITY_ATTRIBUTES structure that contains two separate but related data members: an optional security descriptor, and a Boolean value that determines whether the returned handle can be inherited by child processes.
<ul>
<li>Set to be <code>0</code> at <code>1400014F8</code></li>
<li>The handle returned by CreateFile cannot be inherited by any child processes the application may create and the file or device associated with the returned handle gets a default security descriptor.</li>
</ul>
</li>
<li><code>dwCreationDisposition</code>: An action to take on a file or device that exists or does not exist.
<ul>
<li>Set to be <code>2</code> at <code>1400014F0</code> - this means &quot;Creates a new file, always.&quot;</li>
</ul>
</li>
<li><code>dwFlagsAndAttributes</code>: The file or device attributes and flags, FILE_ATTRIBUTE_NORMAL being the most common default value for files.
<ul>
<li>Set to be <code>0x80</code> at <code>1400014E8</code> - FILE_ATTRIBUTE_NORMAL, The file does not have other attributes set.</li>
</ul>
</li>
<li><code>hTemplateFile</code>: A valid handle to a template file with the GENERIC_READ access right. The template file supplies file attributes and extended attributes for the file that is being created.
<ul>
<li>Set to <code>0</code> at <code>1400014DF</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p>In short this create a file named <code>loader.exe</code>.</p>
<br/>
<p>Then this subroutine uses <code>WriteFile</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/bf599af62f51bba14d39b95b5f38cd53d2b3be1d8d3e6f6c572c03976356ce83.png" alt="picture 145"></p>
<ul>
<li>MSDN: <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile">https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile</a></li>
<li>Usage: Writes data to the specified file or input/output (I/O) device.</li>
<li>Parameters:
<ul>
<li><code>hFile</code>: A handle to the file or I/O device (for example, a file, file stream, physical disk, volume, console buffer, tape drive, socket, communications resource, mailslot, or pipe).
<ul>
<li>Set to <code>[rsp+4078h+hFile]</code>, which is the handle returned by the <code>CreateFileA</code> call. Should be pointing to <code>loader.exe</code></li>
</ul>
</li>
<li><code>lpBuffer</code>: A pointer to the buffer containing the data to be written to the file or device.
<ul>
<li>Set to <code>[rsp+4078h+Buffer]</code></li>
</ul>
</li>
<li><code>nNumberOfBytesToWrite</code>: The number of bytes to be written to the file or device.</li>
<li><code>lpNumberOfBytesWritten</code>: A pointer to the variable that receives the number of bytes written when using a synchronous hFile parameter.</li>
<li><code>lpOverlapped</code>: A pointer to an OVERLAPPED structure is required if the hFile parameter was opened with FILE_FLAG_OVERLAPPED, otherwise this parameter can be NULL.</li>
</ul>
</li>
</ul>
<p>At <code>14000154A - 140001551</code>, it uses the base64-encoded string as a parameter to call the base64-decoding subroutine. Then at <code>140001556</code>, the return value is moved to <code>[rsp+4078h+nNumberOfBytesToWrite]</code>.</p>
<br/>
<p>In short, the base64-encoded content at <code>14000BB00</code> is decoded and used to write to <code>loader.exe</code>. This is the subroutine for unpacking the encoded executable stored in the string.</p>
<br/>
<h3 id="phexe">ph.exe</h3>
<p>Similar to <code>loader.exe</code>, <code>ph.exe</code> is created in the subroutine <code>0x1400013C0</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c137284d90b64a6f3c80988b12eb19f979c595feb2dde8e4f360f9ce9abfc449.png" alt="picture 146"></p>
<p>Again, this subroutine decode the strings at <code>140007050</code> and write to the file <code>ph.exe</code>.</p>
<br/>
<hr>
<h2 id="1a---static-analysis-of-bannerjpg">1a - Static analysis of banner.jpg</h2>
<h3 id="summary-1">Summary</h3>
<table>
<thead>
<tr>
<th>Question</th>
<th>Answer</th>
<th>Reference section</th>
</tr>
</thead>
<tbody>
<tr>
<td>1. What are the hashes of the malware sample?</td>
<td>MD5: 989D3C5FA70A8466C6D4A5953C704B00<br/>SHA1: A75FC173781A4A9BE3B8FF79EBCDED543AD98BF4<br/>SHA256: FF1FE3B4D5D374BF69A2ACE60F21BA80440B8E23902FAB8D994D1F4E34A042C3</td>
<td>1a-1</td>
</tr>
<tr>
<td>2. What is the file type?</td>
<td>Windows PE (DLL)</td>
<td>1a-1</td>
</tr>
<tr>
<td>3. What is the compilation time stamp?</td>
<td>Fri Jun 19 06:55:54 2020</td>
<td>1a-1</td>
</tr>
<tr>
<td>4. What are the file characteristics (e.g. EXE, DLL, 32-bit, 64-bit, etc.)?</td>
<td>DLL, 64-bit</td>
<td>1a-1</td>
</tr>
<tr>
<td>5. What is the Image Base and the Entry Point address?</td>
<td>EntryPoint: 0x1534<br/>ImageBase: 0x180000000</td>
<td>1a-2</td>
</tr>
<tr>
<td>6. Provide details about each section found in terms of their names, sizes, permissions, entropy, and what each is used for.</td>
<td>See details in the reference 1a-3</td>
<td>1a-3</td>
</tr>
<tr>
<td>7. What are the libraries (DLLs) referenced by this sample and which functions do you think are suspicious?</td>
<td>See details in the reference 1a-4</td>
<td>1a-4</td>
</tr>
<tr>
<td>8. What are the MITRE techniques being used?</td>
<td>T1124, T1106, T1082</td>
<td>1a-5</td>
</tr>
<tr>
<td>9. Is this sample packed or not and what proof do you have?</td>
<td>Not packed based on the section names and entropy</td>
<td>1a-3</td>
</tr>
<tr>
<td>10.  What interesting findings can you extract from the resources section?</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>11. What interesting strings (ASCII and Unicode) did you find and could they be used later as an IOC? Provide a brief explanation for each string found.</td>
<td>See the details in 1a-7</td>
<td>1a-7</td>
</tr>
<tr>
<td>12. Are there any crypto functions being used by the sample and what are they?</td>
<td>N/A</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<br/>
<h3 id="1a-1---basic-information">1a-1 - Basic Information</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/4ed435b9630fcb3038f39b129044f03299f6c5c96a64ed42ea781b9cd3992a1f.png" alt="picture 71"></p>
<ol>
<li>The hashes of banner.jpg:</li>
</ol>
<ul>
<li>md5,989D3C5FA70A8466C6D4A5953C704B00</li>
<li>sha1,A75FC173781A4A9BE3B8FF79EBCDED543AD98BF4</li>
<li>sha256,FF1FE3B4D5D374BF69A2ACE60F21BA80440B8E23902FAB8D994D1F4E34A042C3</li>
</ul>
<br/>
<ol start="2">
<li>File type:</li>
</ol>
<ul>
<li>Windows PE (DLL) - Based on the first bytes <code>MZ</code></li>
</ul>
<br/>
<ol start="3">
<li>Compilation timestamp</li>
</ol>
<ul>
<li>Fri Jun 19 06:55:54 2020</li>
</ul>
<br/>
<ol start="4">
<li>File characteristics:</li>
</ol>
<ul>
<li>Type: DLL (based on the file-type field)</li>
<li>Architect: 64-bit (AMD64)</li>
<li>Subsystem: Console</li>
</ul>
<br/>
<h3 id="1a-2---optional-header">1a-2 - Optional Header</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/e75c277c659217900d77fe6be6a5e4c91824b3319c0e65aba04bb0758bc2679d.png" alt="picture 72"></p>
<ol start="5">
<li>Image Base &amp; Entrypoint</li>
</ol>
<ul>
<li>EntryPoint: <code>0x1534</code></li>
<li>Image Base: <code>0x180000000</code></li>
<li>Note <code>ASLR</code> is enabled and have better disable it before doing further analysis.</li>
</ul>
<br/>
<h3 id="1a-3---sections">1a-3 - Sections</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c4f159c1dc7f964c3f66215c452c4ab96283978d982e0e17e013560ed10dd2f.png" alt="picture 73"></p>
<ul>
<li>
<ol start="6">
<li>Section information</li>
</ol>
<ul>
<li><strong>Section Name:</strong> .text
<ul>
<li>Usage: Executable code</li>
<li>Raw Size: 4608 bytes</li>
<li>Virtual Size: 4116 bytes</li>
<li>Permission: Executable</li>
<li>Entropy: 5.687</li>
</ul>
</li>
<li><strong>Section Name:</strong> .rdata
<ul>
<li>Usage: Read-only initialized data</li>
<li>Raw Size: 3072 bytes</li>
<li>Virtual Size: 2966 bytes</li>
<li>Permission: N/A</li>
<li>Entropy: 4.06</li>
</ul>
</li>
<li><strong>Section name:</strong> .data
<ul>
<li>Usage: Initialized data</li>
<li>Raw Size: 512 bytes</li>
<li>Virtual Size: 2160 bytes</li>
<li>Permission: Writable</li>
<li>Entropy: 0.45</li>
</ul>
</li>
<li><strong>Section Name:</strong> .pdata
<ul>
<li>Usage: Exception information</li>
<li>Raw Size: 512 bytes</li>
<li>Virtual Size: 456 bytes</li>
<li>Permission: N/A</li>
<li>Entropy: 3.418</li>
</ul>
</li>
<li><strong>Section Name:</strong> .rsrc
<ul>
<li>Usage: Resource directory</li>
<li>Raw Size: 512 bytes</li>
<li>Virtual Size: 480 bytes</li>
<li>Permission: N/A</li>
<li>Entropy: 4.705</li>
</ul>
</li>
<li><strong>Section Name:</strong> .reloc
<ul>
<li>Usage: Image relocations</li>
<li>Raw Size: 512 bytes</li>
<li>Virtual Size: 24 bytes</li>
<li>Permission: N/A</li>
<li>Entropy: 0.293</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p>Check the <strong>libraries</strong> section:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/1381941393e2775265d7dbc03a19973f2a4b9b11cb4d2645b19d26155b620be9.png" alt="picture 74"></p>
<ul>
<li>
<p><strong>Library:</strong> ws2_32.dll</p>
<ul>
<li>Usage: Handle windows sockets communication</li>
<li>Suspicious?
<ul>
<li>Yes - This can be used as shell</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Library:</strong> kernel32.dll</p>
<ul>
<li>Usage: Contain core functionlity, like access and manipulation of memory, files, and hardware</li>
<li>Suspicious?
<ul>
<li>No - This is a very common DLL for any Windows executable</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<h3 id="1a-4---functions">1a-4 - Functions</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/16cc15b84840a2e74c41f1411ab7c46d0f8be604eb9278bdf0821dfa7c244668.png" alt="picture 75"></p>
<p>The functions imported from <code>ws2_32.dll</code> are all relatd to command and control:</p>
<ul>
<li><strong>ws2_32.dll</strong>
<ul>
<li>Function: WSAConnect
<ul>
<li>Usage:  The WSAConnect function establishes a connection to another socket application, exchanges connect data, and specifies required quality of service based on the specified FLOWSPEC structure.</li>
<li>Suspicious: Yes - can be used in C&amp;C</li>
<li>Reference: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsaconnect">https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsaconnect</a></li>
</ul>
</li>
<li>Function: WSASocketA
<ul>
<li>Usage: The WSASocket function creates a socket that is bound to a specific transport-service provider.</li>
<li>Suspicious: Yes - can be used in C&amp;C</li>
<li>Reference: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsasocketa">https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsasocketa</a></li>
</ul>
</li>
<li>Function: CreateProcessA
<ul>
<li>Usage: Creates a new process and its primary thread.</li>
<li>Suspicious: Yes - can be used to spawn new processes</li>
<li>Reference: <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<h3 id="1a-5---attck-analysis">1a-5 - ATT&amp;CK Analysis</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/eedae3aa89cbcbe8765675e6af685cd21f36b655cf44c5044945565159fa0f.png" alt="picture 76"></p>
<ul>
<li><strong>Discovery - T1124 - System Time Discovery</strong>
<ul>
<li>Library: kernel32.dll</li>
<li>Function: GetSystemTimeAsFileTime</li>
<li>Description:
<ul>
<li>An adversary may gather the system time and/or time zone from a local or remote system.</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://attack.mitre.org/techniques/T1124/">https://attack.mitre.org/techniques/T1124/</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<ul>
<li><strong>Execution - T1106 - Native API</strong>
<ul>
<li>Library: kernel32.dll</li>
<li>Function: CreateProcessA</li>
<li>Description:
<ul>
<li>Adversaries may directly interact with the native OS application programming interface (API) to execute behaviors. Native APIs provide a controlled means of calling low-level OS services within the kernel, such as those involving hardware/devices, memory, and processes.</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://attack.mitre.org/techniques/T1106/">https://attack.mitre.org/techniques/T1106/</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<ul>
<li><strong>Discovery - T1082 - System Information Discovery</strong>
<ul>
<li>Library: kernel32.dll</li>
<li>Function: IsDebuggerPresent</li>
<li>Description:
<ul>
<li>An adversary may attempt to get detailed information about the operating system and hardware, including version, patches, hotfixes, service packs, and architecture.</li>
</ul>
</li>
<li>Reference:
<ul>
<li><a href="https://attack.mitre.org/techniques/T1082/">https://attack.mitre.org/techniques/T1082/</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<h3 id="1a-6---resources">1a-6 - Resources</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/de29a0543b6a3cbf1dfbed81099defe66047784b098fcf3ca728f7af2ea795fd.png" alt="picture 77"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/2cbf123b549c6f4726495ee069eb2c955faa062c5c0ad35123c1af33f2c74d6d.png" alt="picture 78"></p>
<ul>
<li>The manifest shows the execution level is <code>As invoker</code></li>
</ul>
<br/>
<h3 id="1a-7---strings-analysis">1a-7 - Strings analysis</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/2cd190c28a64875193a87460f043702b9f41d1907fc6a459112a4634e44d08d2.png" alt="picture 79"></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>File position</th>
<th>Memory</th>
<th>Text</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ASCII</td>
<td>17A0</td>
<td>172D</td>
<td>192.168.210.132</td>
<td>An unknown IP</td>
</tr>
<tr>
<td>ASCII</td>
<td>17B0</td>
<td>173D</td>
<td>cmd.exe</td>
<td>Potentially used as reverse shell</td>
</tr>
<tr>
<td>ASCII</td>
<td>1D4C</td>
<td>1CD9</td>
<td>MaliciousDLL.dll</td>
<td>Unknown DLL</td>
</tr>
</tbody>
</table>
<br/>
<hr>
<h2 id="2a---reverse-engineering---bannerjpg--conbasedll">2a - Reverse Engineering - banner.jpg / conbase.dll</h2>
<p>Load <code>banner.jpg</code> into IDA Pro and check the cross-reference of the API <code>WSAConnect</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/1139a063aede120339decb055d0f6bfc272d07d3fcfa72db9623f9247289e08b.png" alt="picture 80"></p>
<p>The subroutine called <code>bokbok</code> has reference to <code>WSAConnect</code>.</p>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/f94410dc701b273996c7dbe02cea3c69ee70882cb5c05c85748241ac918357.png" alt="picture 81"></p>
<h3 id="wsastartup-wsasocketa-htons-inet_addr-wsaconnect-and-createprocessa-in-routine-180001000">WSAStartup, WSASocketA, htons, inet_addr, WSAConnect and CreateProcessA in routine 180001000</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/702ee1a38cda177b516f2d12bc633d690f9542351463e512c817dc3e6244be23.png" alt="picture 82"></p>
<ul>
<li>MSDN: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-wsastartup">https://docs.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-wsastartup</a></li>
<li>Usage: The WSAStartup function initiates use of the Winsock DLL by a process.</li>
<li>Return:
<ul>
<li>If successful, the WSAStartup function returns zero.</li>
<li>Otherwise, it returns one of the error codes.</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>wVersionRequested</code>: TBD
<ul>
<li>Set to be <code>0x202h</code> (514) - Version 2.2</li>
</ul>
</li>
<li><code>lpWSAData</code>: A pointer to the WSADATA data structure that is to receive details of the Windows Sockets implementation.
<ul>
<li>Set to be <code>stru_180004650</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p>Then inspect the function call <code>WSASocketA</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/e5802b4986258fdeb3f549cbd7385c53308511b8e0e0ae430bc9f8a3142d0f6b.png" alt="picture 83"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsasocketa">https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsasocketa</a></li>
<li>Usage: The WSASocket function creates a socket that is bound to a specific transport-service provider.</li>
<li>Return:
<ul>
<li>If no error occurs, WSASocket returns a descriptor referencing the new socket.</li>
<li>Otherwise, a value of INVALID_SOCKET is returned, and a specific error code</li>
</ul>
</li>
<li>Parameters
<ul>
<li><code>af</code>: The address family specification. Possible values for the address family are defined in the Winsock2.h header file.
<ul>
<li>Set to <code>2</code> at <code>18000104A</code>, which means IPv4</li>
</ul>
</li>
<li><code>type</code>: The type specification for the new socket.
<ul>
<li>Set to <code>1</code> at <code>180001045</code>, which means <code>SOCK_STREAM</code> (TCP)</li>
</ul>
</li>
<li><code>protocol</code>: The protocol to be used.
<ul>
<li>Set to <code>6</code> at <code>18000103F</code>, which is <code>IPPROTO_TCP</code> - TCP</li>
</ul>
</li>
<li><code>lpProtocolInfo</code>: A pointer to a WSAPROTOCOL_INFO structure that defines the characteristics of the socket to be created.
<ul>
<li>Set to <code>0</code> by <code>xor r9d,r9d</code> at <code>18000103C</code></li>
</ul>
</li>
<li><code>g</code>: An existing socket group ID or an appropriate action to take when creating a new socket and a new socket group.
<ul>
<li>Set to <code>0</code> at <code>180001034</code> - No group operation is performed.</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p>Then inspect the function call <code>htons</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/301645f779923e01be225ae6548be94dfe73e37d267d6e7ed7560fff49dac760.png" alt="picture 84"></p>
<ul>
<li><a href="https://docs.microsoft.com/zh-hk/windows/win32/api/winsock/nf-winsock-htons">https://docs.microsoft.com/zh-hk/windows/win32/api/winsock/nf-winsock-htons</a></li>
<li>Usage: The htons function converts a u_short from host to TCP/IP network byte order (which is big-endian).</li>
<li>Return: The htons function returns the value in TCP/IP network byte order.</li>
<li>Parameter:
<ul>
<li><code>hostshort</code>: A 16-bit number in host byte order.
<ul>
<li>Set to be <code>1BBh</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p>Then inspect the function call <code>inet_addr</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/685b0910b1dd3e5a42f360e4705d124bb085a3a6ef312470bc2745ba1b202e52.png" alt="picture 85"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-inet_addr">https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-inet_addr</a></li>
<li>Usage: The inet_addr function converts a string containing an IPv4 dotted-decimal address into a proper address for the IN_ADDR structure.</li>
<li>Return value: If no error occurs, the inet_addr function returns an unsigned long value containing a suitable binary representation of the Internet address given.</li>
<li>Parameter:
<ul>
<li><code>cp</code>: Pointer to a IPv4 standard dotted decimal notation
<ul>
<li>Set to be <code>192.168.210.132</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p>Then it calls <code>WSAConnect</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/245d58bd1fa9c523ebfc795a2db4bb55f2546964188630d4ae733cf61aa170d1.png" alt="picture 86"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsaconnect">https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsaconnect</a></li>
<li>Usage: The WSAConnect function establishes a connection to another socket application, exchanges connect data, and specifies required quality of service based on the specified FLOWSPEC structure.</li>
<li>Return:
<ul>
<li>If no error occurs, WSAConnect returns zero.</li>
<li>Otherwise, it returns SOCKET_ERROR</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>s</code>: A descriptor identifying an unconnected socket.
<ul>
<li>Set to be <code>cs:s</code>, which is the return value of <code>WSASocketA</code></li>
</ul>
</li>
<li><code>name</code>: A pointer to a sockaddr structure that specifies the address to which to connect.
<ul>
<li>Set by the structure defined by the function calls returns of <code>WSASokcetA</code>, <code>htons</code> and <code>inet_addr</code></li>
</ul>
</li>
<li><code>namelen</code>: The length, in bytes, of the sockaddr structure pointed to by the name parameter.
<ul>
<li>Set to 10h (16)</li>
</ul>
</li>
<li><code>lpCallerData</code>: A pointer to the user data that is to be transferred to the other socket during connection establishment.
<ul>
<li>Set to be 0 at <code>1800010A7</code> by self xoring</li>
</ul>
</li>
<li><code>lpCalleeData</code>: A pointer to the user data that is to be transferred back from the other socket during connection establishment.
<ul>
<li>Set to te 0</li>
</ul>
</li>
<li><code>lpSQOS</code>: A pointer to the FLOWSPEC structures for socket s, one for each direction.
<ul>
<li>Set to be 0 at <code>18000108C</code></li>
</ul>
</li>
<li><code>lpGQOS</code>: Reserved for future use with socket groups. Should be 0.</li>
</ul>
</li>
</ul>
<p>This makes connection to the destination <code>192.168.210.132</code></p>
<br/>
<p>Finally it uses <code>CreateProcessA</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/52b66e92ef38a99b12258c49024c4300fd2999dbf64d23ce72391f622973109d.png" alt="picture 87"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa</a></li>
<li>Usage: Creates a new process and its primary thread. The new process runs in the security context of the calling process.</li>
<li>Return value:
<ul>
<li>If the function succeeds, the return value is nonzero.</li>
<li>If the function fails, the return value is zero.</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>lpApplicationName</code>: The name of the module to be executed.
<ul>
<li>Set to be <code>0</code> at <code>180001177</code> by self xor-ing</li>
</ul>
</li>
<li><code>lpCommandLine</code>: The command line to be executed.
<ul>
<li>Set to be <code>[rsp+168h+CommandLine]</code>, which is defined at <code>180001115</code> referencing <code>cs:qword_1800031B0</code>
<ul>
<li><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/994e6bb101adc14e1a2a3b16f65a56129961d63b85aadd414e7335f675724522.png" alt="picture 88"></li>
<li>We can convert this HEX to ASCII</li>
<li><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/399bd6a74e6d3908160f152cb840c5c5733ec53dee42632fa951871038dba23f.png" alt="picture 89"></li>
<li>This is in little endian format so the command is <code>cmd.exe</code></li>
</ul>
</li>
</ul>
</li>
<li><code>lpProcessAttributes</code>: A pointer to a SECURITY_ATTRIBUTES structure that determines whether the returned handle to the new process object can be inherited by child processes.
<ul>
<li>Set to <code>0</code> at <code>18000116F</code> by self xor-ing</li>
<li>Default security descriptor</li>
</ul>
</li>
<li><code>lpThreadAttributes</code>: A pointer to a SECURITY_ATTRIBUTES structure that determines whether the returned handle to the new thread object can be inherited by child processes.
<ul>
<li>Set to <code>0</code> at <code>18000116C</code> by self-xoring</li>
<li>Default security descriptor</li>
</ul>
</li>
<li><code>bInheritHandles</code>: If this parameter is TRUE, each inheritable handle in the calling process is inherited by the new process. If the parameter is FALSE, the handles are not inherited.
<ul>
<li>Set as <code>1</code> (<code>TRUE</code>) at <code>180001164</code>, which means each inheritable handle in the calling process is inherited by the new process</li>
</ul>
</li>
<li><code>dwCreationFlags</code>: The flags that control the priority class and the creation of the process.
<ul>
<li>Set to <code>0</code> at <code>18000115C</code></li>
<li>The priority class defaults to NORMAL_PRIORITY_CLASS</li>
</ul>
</li>
<li><code>lpEnvironment</code>: A pointer to the environment block for the new process.
<ul>
<li>Set to <code>0</code> at <code>180001153</code></li>
<li>The new process uses the environment of the calling process.</li>
</ul>
</li>
<li><code>lpCurrentDirectory</code>: The full path to the current directory for the process.
<ul>
<li>Set to <code>0</code> at <code>18000114A</code></li>
<li>The new process will have the same current drive and directory as the calling process.</li>
</ul>
</li>
<li><code>lpStartupInfo</code>: A pointer to a STARTUPINFO or STARTUPINFOEX structure.
<ul>
<li>Provided by the structure construction from <code>1800010C4</code> to <code>18000110E</code></li>
</ul>
</li>
<li><code>lpProcessInformation</code>: A pointer to a PROCESS_INFORMATION structure that receives identification information about the new process.</li>
</ul>
</li>
</ul>
<br/>
<p>In short, the subroutine <code>180001000</code> makes a connection to <code>192.168.210.132</code> and launch <code>cmd.exe</code>. This is a typical reverse shell.</p>
<br/>
<hr>
<h2 id="3---running-the-malware">3 - Running the malware</h2>
<p><strong>Question</strong></p>
<p>You are required to dynamically analyze the malware sample(s) and provide thorough details to what it does. Use the questions below to guide you through your analysis.</p>
<ol>
<li>Explain what happens upon execution (effect) and why?</li>
<li>If the malware is applying any anti-x (debugging, vm, reversing, etc.), how will you bypass those methods? Provide a step by step detailed.</li>
<li>What are the processes involved in this malware sample?</li>
<li>Provide activity details of the processes involved.</li>
<li>What are the files accessed, downloaded, and used? Where are the locations of these files on disk (PATH)?</li>
<li>What Registry keys and values were added, removed, updated?</li>
<li>What obfuscation was applied and how did you deobfuscate?</li>
<li>Does this malware perform any type of injection? Explain in detail how injection is performed.</li>
<li>Does the malware drop or download any files? If it does, what are they used for and how?</li>
</ol>
<br/>
<p><strong>Answer</strong></p>
<h3 id="summmary-table">Summmary table</h3>
<table>
<thead>
<tr>
<th>No.</th>
<th>Question</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Explain what happens upon execution (effect) and why?</td>
<td>A message box &quot;ABORT!&quot; shows and says &quot;Sandbox Detected&quot;!</td>
</tr>
<tr>
<td>2</td>
<td>If the malware is applying any anti-x (debugging, vm, reversing, etc.), how will you bypass those methods? Provide a step by step detailed.</td>
<td>See below</td>
</tr>
<tr>
<td>3</td>
<td>What are the processes involved in this malware sample?</td>
<td>cmd.exe, loader.exe, ping.exe</td>
</tr>
<tr>
<td>4</td>
<td>Provide activity details of the processes involved.</td>
<td>See the details explanations in the following</td>
</tr>
<tr>
<td>5</td>
<td>What are the files accessed, downloaded, and used? Where are the locations of these files on disk (PATH)?</td>
<td>See the details in the following</td>
</tr>
<tr>
<td>6</td>
<td>What Registry keys and values were added, removed, updated?</td>
<td>PortMonitor, CurrentVersion\Run</td>
</tr>
<tr>
<td>7</td>
<td>What obfuscation was applied and how did you deobfuscate?</td>
<td><code>.dll</code> to <code>.jpg</code> in <code>banner.jpg</code>. Discovered by checking the first bytes</td>
</tr>
<tr>
<td>8</td>
<td>Does this malware perform any type of injection? Explain in detail how injection is performed.</td>
<td>?</td>
</tr>
<tr>
<td>9</td>
<td>Does the malware drop or download any files? If it does, what are they used for and how?</td>
<td>See below</td>
</tr>
</tbody>
</table>
<h3 id="first-time-running-the-malware">First time running the malware</h3>
<p>Given the anti-reversing capabilities of the sample as analyzed above, it is expected to pop up a warning of sandbox detected and terminate upon running.</p>
<p>Beforing running the malware, launch <strong>Wireshark</strong>, <strong>Process Hacker</strong> and <strong>Process Monitor</strong> for tracking the host activities.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/84436c9a602f10182b59bb6ee8dec6fd0900b4bb49e77cf759b866799b91171.png" alt="picture 90"></p>
<br/>
<p>Start capturing on <strong>Wireshark</strong> and <strong>Process Monitor</strong> and then run the sample as admin.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/90d21819bd50ad0756dbbaab50e0e797579135c6bac93e9ce2bc494a2cab4414.png" alt="picture 91"></p>
<ul>
<li>As expected, a message box tilted <code>ABORT!</code> with message <code>Sandbox Detected!</code> appears</li>
<li>This is due to the anti-vm / anti-debugging capabilities of the malware</li>
</ul>
<br/>
<h3 id="bypassing-the-self-defensive-mechanism">Bypassing the self-defensive mechanism</h3>
<h4 id="debugger-detection-at-subroutine-140001740-1">Debugger Detection at subroutine 140001740</h4>
<p>Load the sample into <strong>x64dbg</strong>.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/b7722962df157898bedf009786a3cfcc0c4751020e4e9de13270da26b92503fb.png" alt="picture 92"></p>
<br/>
<p>First bypass the Debugger Detection at subroutine <code>140001740</code>. Use <code>Ctrl+G</code> and enter the location <code>140001740</code> to navigate to the related potion:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/05974a982e859b4804f07f68ecf36c775673d5818bd59677f57e4ade706fe777.png" alt="picture 93"></p>
<ul>
<li>The process will exit if the jump at <code>14000175D</code> is not taken</li>
<li>To bypass, patch it by modifying the instruction <code>je</code> to <code>jmp</code> so it always take the jump:</li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/d396265e59a880d178fcfd9d9309740e522846a6e4fc1c769b67d69be8ebf64a.png" alt="picture 94"></p>
<br/>
<h4 id="detection-at-subroutine-1400017d0-140001950-140002274-14000227d">Detection at subroutine 1400017D0, 140001950, 140002274, 14000227D</h4>
<p>Use <code>Ctrl+G</code> and enter the location <code>140002269</code> to navigate to the potion calling the detection subroutines:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/05f2a0bbe5109449c149e03c6abbe133745f968f82edd25df3269a515e8ff015.png" alt="picture 95"></p>
<ul>
<li>The common thing for the first 3 detection subroutine calls is that if detected, it jumps to <code>140002286</code>.</li>
<li>To patch, change all the related <code>jne</code> instructions to <code>NOP</code>:</li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/50f1828bb47f67ac555a3d9dd25ea24bd2ff75303017202c6439edeb830c5215.png" alt="picture 96"></p>
<br/>
<p>Finally if we pass the checking, the jump should be taken at <code>140002284</code>. We can patch it by changing <code>je</code> to <code>jmp</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/76b67e5fe7f675f6c4bd7547724c17f838ff7dfa9be54354da9d4e6ee4f9d37.png" alt="picture 97"></p>
<br/>
<p>Then click <code>File &gt; Patch file ...</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/2f5a419bca9b3e5816b20dcfa9be4b6e30cddda4041f61c7af4c23bfd52bb43e.png" alt="picture 98"></p>
<ul>
<li>Patch File</li>
<li>Save as <code>FinalExam_patched.exe</code></li>
</ul>
<br/>
<h3 id="running-the-patched-executable">Running the patched executable</h3>
<p>Start capturing on <strong>Wireshark</strong> and <strong>Process Monitor</strong> and then run the patched sample as admin.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/48c77d1153a43e88ea962de5352a80edf0d2d2fdd58b65e64db696591b00ef03.png" alt="picture 99"></p>
<ul>
<li>This time, instead of popping up the alert box, it shows <code>Reboot required</code> and ask <code>Do it now?</code></li>
<li>Click the <code>No</code> button</li>
</ul>
<br/>
<p>Stop Wireshark capture and on Process Monitor, save the session as CSV.</p>
<br/>
<h3 id="processes-involved-by-the-sample">Processes involved by the sample</h3>
<p>Inspect the Process Tree on <strong>Process Monitor</strong>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/dfef85e9f8fc480dc6d17f4867a034e72b80e16875b7d7f712817759f9b1129d.png" alt="picture 147"></p>
<p>As shown, the processes involved are:</p>
<ul>
<li>conhost.exe</li>
<li>cmd.exe
<ul>
<li>conhost.exe</li>
<li>loader.exe</li>
</ul>
</li>
<li>cmd.exe
<ul>
<li>conhost.exe</li>
<li>ping.exe</li>
</ul>
</li>
</ul>
<p>Note <code>conhost.exe</code> is not meaningful to the analysis and is ignored in the following.</p>
<br/>
<h4 id="first-cmdexe">First cmd.exe</h4>
<p>The first instance of <code>cmd.exe</code> has the following CommandLine:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/e8fb11101950a09535fcd68a69daad6b7f2e89f8977b64373c00898b5cfac637.png" alt="picture 148"></p>
<ul>
<li><code>C:\Windows\System32\cmd.exe&quot; /C loader.exe &amp;&amp; del /F loader.exe</code></li>
<li>It is invoked to run the executable <code>loader.exe</code>, and force remove <code>loader.exe</code> afterwards
<ul>
<li>This also explains why <code>loader.exe</code> disappears in the current working directory of the sample</li>
</ul>
</li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/f67eb22b80c3d96442fd626fea451a5eca8ede7458919349928640a3ed3c33f7.png" alt="picture 149"></p>
<br/>
<h4 id="loaderexe-1">Loader.exe</h4>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/a94cafa1271a9b99984e8601ce000177331362a434963c96a1a82e88934ed634.png" alt="picture 150"></p>
<p><code>Loader.exe</code> is run but there is no child process. It has been be analyzed further to understand its functions and capability.</p>
<br/>
<h4 id="second-cmdexe">Second cmd.exe</h4>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/9eb7153f4edcf8a05a98ee608e4052493d474e96d31dd80885ed1143ce1f3f55.png" alt="picture 151"></p>
<ul>
<li><code>cmd.exe /C ping 1.1.1.1 -n 1 -w 3000 &gt; Nul &amp; Del /f /q &quot;C:\Users\AdminELS\Downloads\Samples\Final_Exam\FinalExam_patched.exe&quot;</code></li>
<li><code>cmd.exe</code> is used to execute a <code>ping</code> command to <code>1.1.1.1</code> with the switch <code>-n 1</code> (one packet) and <code>-w 3000</code> (exit after 3000 seconds), where to output will be redirected to NULL; also the sample will be deleted forcefully and quietly</li>
</ul>
<br/>
<h4 id="pingexe">ping.exe</h4>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3a5b7ea831f757afac493e59ae170381c7de18f602c8ef20ef456f0f3004423a.png" alt="picture 152"></p>
<ul>
<li><code>ping.exe</code> is execute to send ICMP packet to <code>1.1.1.1</code></li>
</ul>
<br/>
<h3 id="file-accessed-downloaded-or-used-and-their-path">File accessed, downloaded, or used, and their PATH</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/dee73ed2ccf108f54172458897cbba32e8cd4bbb209bdf71b3590fe2dd25b416.png" alt="picture 154"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/0a0c75aff0d1385264e11de19ad55da0373c6efbf9933ab3e93be054f580af5d.png" alt="picture 155"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/0919c89088f2c74cf3690ef1f5c9fb960f67fad5cc51c3ff8c1f12cf1b1322dd.png" alt="picture 156"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/cfb06addb7f033145918743fbbae9f42998321c038faf3c5d2dab5cf1b11de6e.png" alt="picture 157"></p>
<table>
<thead>
<tr>
<th>File</th>
<th>Full Path</th>
<th>Action</th>
<th>MD5 Hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>loader.exe</td>
<td>C:\Users\AdminELS\Downloads\Samples\Final_Exam\loader.exe</td>
<td>Create &amp; Delete</td>
<td>-</td>
</tr>
<tr>
<td>ph.exe</td>
<td>C:\Users\AdminELS\Downloads\Samples\Final_Exam\ph.exe</td>
<td>Create</td>
<td>D2DCC98A3CF29BE377291DAC3EE5DF1C</td>
</tr>
<tr>
<td>banner.jpg</td>
<td>C:\Users\AdminELS\AppData\Local\Temp\banner.jpg</td>
<td>Download</td>
<td>989D3C5FA70A8466C6D4A5953C704B00</td>
</tr>
<tr>
<td>start.jpg</td>
<td>C:\Users\AdminELS\AppData\Local\Temp\start.jpg</td>
<td>Download</td>
<td>5606DF43FEEFC42FBD12CF06F60676B9</td>
</tr>
<tr>
<td>footer.jpg</td>
<td>C:\Users\AdminELS\AppData\Local\Temp\footer.jpg</td>
<td>Download</td>
<td>3eD3FEF9A570BF9436565113D19AA71</td>
</tr>
<tr>
<td>pic1.jpg</td>
<td>C:\Users\AdminELS\AppData\Local\Temp\pic1.jpg</td>
<td>Download</td>
<td>369BC1DB5F92AA730B871A2BECBBEDA2</td>
</tr>
<tr>
<td>pic2.jpg</td>
<td>C:\Users\AdminELS\AppData\Local\Temp\pic2.jpg</td>
<td>Download</td>
<td>D08AB13F3C57753EF26730E8E62AA817</td>
</tr>
<tr>
<td>pic3.jpg</td>
<td>C:\Users\AdminELS\AppData\Local\Temp\pic3.jpg</td>
<td>Download</td>
<td>E40E65D6F8A6C9626E181D9273B3E5E4</td>
</tr>
<tr>
<td>pic4.jpg</td>
<td>C:\Users\AdminELS\AppData\Local\Temp\pic4.jpg</td>
<td>Download</td>
<td>955E9C5204009BD6FDAE913F7584FA6B</td>
</tr>
<tr>
<td>pic5.jpg</td>
<td>C:\Users\AdminELS\AppData\Local\Temp\pic5.jpg</td>
<td>Download</td>
<td>64FB3D450B85EFF54FADB1217852CCD3</td>
</tr>
<tr>
<td>s3f0.[0-4]</td>
<td>C:\Users\AdminELS\AppData\Local\Temp\s3f0.[0-4]</td>
<td>Create</td>
<td>53A5D03DF598AEDEB9C48B8DC66E8D81</td>
</tr>
<tr>
<td>s454.[0-4]</td>
<td>C:\Users\AdminELS\AppData\Local\Temp\s454.[0-4]</td>
<td>Create</td>
<td>53A5D03DF598AEDEB9C48B8DC66E8D81</td>
</tr>
<tr>
<td>runme.bat</td>
<td>C:\Users\AdminELS\AppData\Local\Temp\runme.bat</td>
<td>Download</td>
<td>C9063EF391A6BB5693525BDA6C54DA8C</td>
</tr>
</tbody>
</table>
<br/>
<h3 id="registry-activities">Registry Activities</h3>
<p>There are 2 notable registry activities.</p>
<h4 id="portmonitor">PortMonitor</h4>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/014fbfdf5d29e74308249b448e9ba80f410e4aca53bd7fa5ff4c55f3cdca5b38.png" alt="picture 158"></p>
<ul>
<li><code>HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor\Driver</code> is set with value <code>C:\Windows\System32\conbase.dll</code></li>
</ul>
<br/>
<h4 id="run-key">Run Key</h4>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/ab3ea2f0ec53746eda542d3966ba20681810383c05ec46a767b0e29780310572.png" alt="picture 159"></p>
<ul>
<li><code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\WizLoader</code> is set with the value <code>C:\Windows\svchost.exe</code></li>
</ul>
<br/>
<h3 id="obfuscation">Obfuscation</h3>
<p>The downloaded file <code>banner.jpg</code> is identified as a Windows PE (DLL). It is discovered by inspecting the first bytes of the file on <strong>PeStudio</strong>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3a2edfeba3b4970598f4fed6e1b6a79330f8bf6e7fd32e57e80ec31a77e107ad.png" alt="picture 160"></p>
<br/>
<p>We can also inspect the HTTP stream in Wireshark capture:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/e9cf33a2f5a085877a09c9e089d109c50a4692eb7214c2b0d0660dea068018.png" alt="picture 161"></p>
<ul>
<li>The <code>MZ</code> first bytes reveals it is not a <code>JPG</code> but a Windows PE</li>
</ul>
<br/>
<h3 id="bannerjpg--conbasedll">banner.jpg / conbase.dll</h3>
<p>The malware downloads <code>banner.jpg</code> from <code>www.elsmap.com/banner.jpg</code> and saves to <code>C:\Windows\System32\conbase.dll</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/8b8c4ad5d926ecfaafbecb0faf49669bdebdfbc32fa61d0e47d4b42173eda692.png" alt="picture 162"></p>
<br/>
<p>This downloaded file (function: reverse shell callback) is for setting up the persistece at the reg key <code>HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor\Driver</code>.</p>
<br/>
<h3 id="extracting-loaderexe">Extracting Loader.exe</h3>
<p>Since <code>loader.exe</code> is removed automatically when running the malware, we have to use debugger to control the program flow. Load the patched version of the sample into <strong>x64dbg</strong> and set a breakpoint after the sample use <code>WriteFile</code> to write the binary content into <code>loader.exe</code>. Let's set a breakpoint at <code>140001597</code> after the sample close the handle. Also add a breakpoint at <code>14000157D</code> after the sample calling <code>WriteFile</code>.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/d7670f703df4f769b56ac2254b4a5f4657cc5fe094c0750b1b8cd32049fc2b9a.png" alt="picture 163"></p>
<br/>
<p>Then run the sample in <strong>x64dbg</strong>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/05745e557d71b0fc55f54ab7d41c3899f704dac65e1202f56e6a61af50187007.png" alt="picture 165"></p>
<br/>
<p>Inspecting the directory of the sample, now we can see the executable <code>loader.exe</code> being written:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/04b5f9e7bac3360be61cd6b8ad6bc77f6567e63afe599f6aa6ee701c59b9683c.png" alt="picture 166"></p>
<ul>
<li>Save a copy of this.</li>
</ul>
<br/>
<hr>
<h2 id="1b---static-analysis-of-loaderexe">1b - Static analysis of loader.exe</h2>
<p>Load <code>loader.exe</code> into <strong>PeStudio</strong>.</p>
<h3 id="summary-2">Summary</h3>
<table>
<thead>
<tr>
<th>Question</th>
<th>Answer</th>
<th>Reference section</th>
</tr>
</thead>
<tbody>
<tr>
<td>1. What are the hashes of the malware sample?</td>
<td>MD5: CF48AF5B5779877C3BD9F15A443BE1B1<br/>SHA1: FCF84B82E4A8EADC5BED83F6C8B0F02290171578<br/>SHA256: 1B9404FE5B9FABA42A2A1260B8AB0B03559096E01C0E05902ADE10FFF29320D7<br/>IMPHASH: F9AADDE1BC0183E1A505586E305A4EAD<br/></td>
<td>1b-1</td>
</tr>
<tr>
<td>2. What is the file type?</td>
<td>Windows PE</td>
<td>1b-1</td>
</tr>
<tr>
<td>3. What is the compilation time stamp?</td>
<td>Tue Jun 23 01:51;34 2020</td>
<td>1b-1</td>
</tr>
<tr>
<td>4. What are the file characteristics (e.g. EXE, DLL, 32-bit, 64-bit, etc.)?</td>
<td>EXE, 64-bit</td>
<td>1b-1</td>
</tr>
<tr>
<td>5. What is the Image Base and the Entry Point address?</td>
<td>Image Base: 0x140000000<br/>Entry Point: 0x00008090<br/></td>
<td>1b-2</td>
</tr>
<tr>
<td>6. Provide details about each section found in terms of their names, sizes, permissions, entropy, and what each is used for.</td>
<td>See the reference 1b-3</td>
<td>1b-3</td>
</tr>
<tr>
<td>7. What are the libraries (DLLs) referenced by this sample and which functions do you think are suspicious?</td>
<td>See details i nthe reference 1b-4</td>
<td>1b-4</td>
</tr>
<tr>
<td>8. What are the MITRE techniques being used?</td>
<td>T1106</td>
<td>1b-5</td>
</tr>
<tr>
<td>9. Is this sample packed or not and what proof do you have?</td>
<td>Yes - the uncommon section names and high entropy of section A</td>
<td>1b-3</td>
</tr>
<tr>
<td>10. What interesting findings can you extract from the resources section?</td>
<td>Admin privilege is not required</td>
<td>1b-6</td>
</tr>
<tr>
<td>11. What interesting strings (ASCII and Unicode) did you find and could they be used later as an IOC? Provide a brief explanation for each string found.</td>
<td><code>explorer.</code></td>
<td>1b-7</td>
</tr>
<tr>
<td>12. Are there any crypto functions being used by the sample and what are they?</td>
<td>No</td>
<td>1b-4</td>
</tr>
</tbody>
</table>
<br/>
<h3 id="1b-1-general-information">1b-1 General Information</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/2d17b7c78a103b99f271c9cecc0da7157dde09e8cf57123006b4fd6e5f0b3931.png" alt="picture 167"></p>
<ul>
<li>hashes:
<ul>
<li>md5,CF48AF5B5779877C3BD9F15A443BE1B1</li>
<li>sha1,FCF84B82E4A8EADC5BED83F6C8B0F02290171578</li>
<li>sha256,1B9404FE5B9FABA42A2A1260B8AB0B03559096E01C0E05902ADE10FFF29320D7</li>
<li>imphash,F9AADDE1BC0183E1A505586E305A4EAD</li>
</ul>
</li>
<li>File type: Windows PE (based on the first bytes <code>MZ</code>) - Executable</li>
<li>Archi: 64-bit (AMD64)</li>
<li>Complied time: Tue Jun 23 01:51;34 2020</li>
</ul>
<br/>
<h3 id="1b-2-optional-header">1b-2 Optional Header</h3>
<p>Check the optional header:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/b62aae63216c70a6e57a28738ff820f14c9eb29d659730566f8fa2d7d342d19a.png" alt="picture 168"></p>
<ul>
<li>EntryPoint: <code>0x00008090</code></li>
<li>ImageBase: <code>0x140000000</code></li>
<li>Subsystem: Console</li>
</ul>
<br/>
<h3 id="1b-3-sections">1b-3 Sections</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c4a4884337e6c81afd1c0c161d75b2366b979a61a164b93aa879ed4dec41404b.png" alt="picture 169"></p>
<ul>
<li>Sections information
<ul>
<li><strong>Section Name:</strong> A
<ul>
<li>Usage: unknown (uncommon section - being 0 bytes might means this section serve for unpacked content)</li>
<li>Raw Size: 0 bytes</li>
<li>Virtual Size: 24576 bytes</li>
<li>Permission: Writable, Executable</li>
<li>Entropy: 0 (null)</li>
</ul>
</li>
<li><strong>Section Name:</strong> B
<ul>
<li>Usage: unknown (uncommon section)</li>
<li>Raw Size: 5120 bytes</li>
<li>Virtual Size: 8192 bytes</li>
<li>Permission: Writable, Executable</li>
<li>Entropy: 7.543 (High entropy - <strong>possibly packed</strong>)</li>
</ul>
</li>
<li><strong>Section Name:</strong> .rsrc
<ul>
<li>Usage: Resource directory</li>
<li>Raw Size: 1536 bytes</li>
<li>Virtual Size: 4096 bytes</li>
<li>Permission: Writable</li>
<li>Entropy: 3.922</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p>Check the <strong>libraries</strong> section:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/f81112c3f90953bcd55a056e53c80e6bf22c21b7dbc7aa5d5ccaba5c3aeb608c.png" alt="picture 170"></p>
<ul>
<li>Only kernel32.dll</li>
</ul>
<br/>
<h3 id="1b-4-functions">1b-4 Functions</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/520640e09cf7c73a33e3c7f7479f894eb55045e726ed451d9a9a9b2a5226d7fb.png" alt="picture 171"></p>
<ul>
<li>kernel32.dll
<ul>
<li>Function: VirtualProtect
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect</a></li>
<li>Usage: Changes the protection on a region of committed pages in the virtual address space of the calling process.</li>
<li>Suspisious?
<ul>
<li>Yes - likely used for unpacking / code injection</li>
</ul>
</li>
</ul>
</li>
<li>Function: LoadLibraryA
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya">https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya</a></li>
<li>Usage: Loads the specified module into the address space of the calling process. The specified module may cause other modules to be loaded.</li>
<li>Suspicious?
<ul>
<li>Yes - likely used for unpacking / code injection</li>
</ul>
</li>
</ul>
</li>
<li>Function: GetProcAddress
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress">https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress</a></li>
<li>Usage: Retrieves the address of an exported function or variable from the specified dynamic-link library (DLL).</li>
<li>Suspicious?
<ul>
<li>Yes and likely used for unpacking / code injection</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<h3 id="1b-5-attck-analysis">1b-5 ATT&amp;CK Analysis</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/fc2496c26a9e96954e9e14f715ba08cf15100c969fe169c10c373393ebf66f47.png" alt="picture 172"></p>
<ul>
<li><strong>Execution - T1106 - Native API</strong>
<ul>
<li>Library: kernel32.dll</li>
<li>Function: LoadLibraryA</li>
<li>Description: Adversaries may directly interact with the native OS application programming interface (API) to execute behaviors.</li>
<li>Reference: <a href="https://attack.mitre.org/techniques/T1106/">https://attack.mitre.org/techniques/T1106/</a></li>
</ul>
</li>
</ul>
<br/>
<h3 id="1b-6-resources">1b-6 Resources</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/58b57ce83ee750c68312491582d7fc4ad4646761a4e5d379594ede87230ef59a.png" alt="picture 173"></p>
<ul>
<li>Only has the manifest.</li>
</ul>
<br/>
<p>Also check the manifest:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/0f2fe38cc8a9c05250cd05c9a5143bd39de1fc92c22af520a2e2804703ee9f5d.png" alt="picture 174"></p>
<ul>
<li>Admin privilege is not required</li>
</ul>
<br/>
<h3 id="1b-7-strings">1b-7 Strings</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/cce021132adbe611cb785ac32cb7b6476e7aeaa557fc34e9420c308d78d9c617.png" alt="picture 175"></p>
<ul>
<li><code>explorer.</code> at <code>0xE4F</code></li>
</ul>
<hr>
<h2 id="2b---reverse-engineering---loaderexe">2b - Reverse Engineering - loader.exe</h2>
<p>See <strong>4 - Unpacking</strong> instead.</p>
<br/>
<hr>
<h2 id="1c---static-analysis-of-phexe">1c - Static analysis of ph.exe</h2>
<h3 id="summary-3">Summary</h3>
<table>
<thead>
<tr>
<th>Question</th>
<th>Answer</th>
<th>Reference section</th>
</tr>
</thead>
<tbody>
<tr>
<td>1. What are the hashes of the malware sample?</td>
<td>MD5: D2DCC98A3CF29BE377291DAC3EE5DF1C<br/>SHA1: 71C99BD947C9E69AE92CC2C850B904F35F01DACF<br/>SHA256: 2C1C44345CDEB6E8F701CECF2A4016AC8F14B6CE237318B195093248D0B5363C<br/></td>
<td>1c-1</td>
</tr>
<tr>
<td>2. What is the file type?</td>
<td>Windows PE</td>
<td>1c-1</td>
</tr>
<tr>
<td>3. What is the compilation time stamp?</td>
<td>Sun Jun 14 07:03:36 2020</td>
<td>1c-1</td>
</tr>
<tr>
<td>4. What are the file characteristics (e.g. EXE, DLL, 32-bit, 64-bit, etc.)?</td>
<td>EXE, 64-bit</td>
<td>1c-1</td>
</tr>
<tr>
<td>5. What is the Image Base and the Entry Point address?</td>
<td>Image Base: 0x140000000<br/>Entry Point: 0x1980<br/></td>
<td>1c-2</td>
</tr>
<tr>
<td>6. Provide details about each section found in terms of their names, sizes, permissions, entropy, and what each is used for.</td>
<td>See the reference 1c-3</td>
<td>1c-3</td>
</tr>
<tr>
<td>7. What are the libraries (DLLs) referenced by this sample and which functions do you think are suspicious?</td>
<td>See details i nthe reference 1c-4</td>
<td>1c-4</td>
</tr>
<tr>
<td>8. What are the MITRE techniques being used?</td>
<td>T1124, T1106, T1082, T1055</td>
<td>1c-5</td>
</tr>
<tr>
<td>9. Is this sample packed or not and what proof do you have?</td>
<td>Unlikely based on the section names and entropy</td>
<td>1c-3</td>
</tr>
<tr>
<td>10. What interesting findings can you extract from the resources section?</td>
<td>Admin privilege is not required</td>
<td>1c-6</td>
</tr>
<tr>
<td>11. What interesting strings (ASCII and Unicode) did you find and could they be used later as an IOC? Provide a brief explanation for each string found.</td>
<td><code>explorer.</code></td>
<td>1c-7</td>
</tr>
<tr>
<td>12. Are there any crypto functions being used by the sample and what are they?</td>
<td>No</td>
<td>1c-4</td>
</tr>
</tbody>
</table>
<br/>
<p>Load <code>ph.exe</code> into <strong>PeStudio</strong>.</p>
<br/>
<h3 id="1c-1-general-information">1c-1 General Information</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/4527fc953b92198caa3be2c45941badf1cde921337b32765f9c9e241523f40e6.png" alt="picture 204"></p>
<ul>
<li>Hashes:
<ul>
<li>md5,D2DCC98A3CF29BE377291DAC3EE5DF1C</li>
<li>sha1,71C99BD947C9E69AE92CC2C850B904F35F01DACF</li>
<li>sha256,2C1C44345CDEB6E8F701CECF2A4016AC8F14B6CE237318B195093248D0B5363C</li>
<li>imphash: 687EDAFEB6600648422964431D20AFBD</li>
</ul>
</li>
<li>File type: Windows PE (determined by the first bytes <code>MZ</code>) - executable (EXE)</li>
<li>Architecture: 64-bit</li>
<li>Complied time: Sun Jun 14 07:03:36 2020</li>
</ul>
<br/>
<h3 id="1c-2-optional-header">1c-2 Optional Header</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/65eb434a70d601142483c3ce9fce58525b4af2e503ef86b039604b407b701c5f.png" alt="picture 205"></p>
<ul>
<li>EntryPoint: <code>0x1980</code></li>
<li>ImageBase: <code>0x140000000</code></li>
<li>Subsystem: Console</li>
</ul>
<br/>
<h3 id="1c-3-sections">1c-3 Sections</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/9923e8f92089acbaf9298597b8a1930794beac7c7995bff55d18b9278e31bdb.png" alt="picture 206"></p>
<ul>
<li>Section information
<ul>
<li><strong>Section Name:</strong> .text
<ul>
<li>Usage: Executable code</li>
<li>Raw Size: 5632 bytes</li>
<li>Virtual Size: 5560 bytes</li>
<li>Permission: Executable</li>
<li>Entropy: 6.066</li>
</ul>
</li>
<li><strong>Section Name:</strong> .rdata
<ul>
<li>Usage: Read-only initialized data</li>
<li>Raw Size: 5632 bytes</li>
<li>Virtual Size: 5156 bytes</li>
<li>Permission: /</li>
<li>Entropy: 3.77</li>
</ul>
</li>
<li><strong>Section Name:</strong> .data
<ul>
<li>Usage: Initialized data</li>
<li>Raw Size: 512 bytes</li>
<li>Virtual Size: 1760 bytes</li>
<li>Permission: Writable</li>
<li>Entropy: 2.01</li>
</ul>
</li>
<li><strong>Section Name:</strong> .pdata
<ul>
<li>Usage: Exception information</li>
<li>Raw Size: 512 bytes</li>
<li>Virtual Size: 456 bytes</li>
<li>Permission: /</li>
<li>Entropy: 3.473</li>
</ul>
</li>
<li><strong>Section Name:</strong> .rsrc
<ul>
<li>Usage: Resource directory</li>
<li>Raw Size: 512 bytes</li>
<li>Virtual Size: 480 bytes</li>
<li>Permission: /</li>
<li>Entropy: 4.702</li>
</ul>
</li>
<li><strong>Section Name:</strong> .reloc
<ul>
<li>Usage: Image relocations</li>
<li>Raw Size: 512 bytes</li>
<li>Virtual Size: 68 bytes</li>
<li>Permission: /</li>
<li>Entropy: 0.916</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<h3 id="1c-4-functions">1c-4 Functions</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/cb260d648050cc23aece328fb39898722890764d92ad1d42e4f8dd39bb05c144.png" alt="picture 207"></p>
<ul>
<li>Only <code>kernel32.dll</code> is imported</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/82a3e23e2c5cefc1928ff6a22b7aeb711c9043e99432af1f13cee9997a7aa118.png" alt="picture 208"></p>
<ul>
<li><code>kernel32.dll</code>
<ul>
<li>Function: ReadProcessMemory:
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-readprocessmemory">https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-readprocessmemory</a></li>
<li>Usage: This function reads memory in a specified process. The entire area to be read must be accessible, or the operation fails.</li>
</ul>
</li>
<li>Function: WriteProcessMemory
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory">https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory</a></li>
<li>Usage: Writes data to an area of memory in a specified process.</li>
</ul>
</li>
<li>Function: VirtualProtectEx
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotectex">https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotectex</a></li>
<li>Usage: Changes the protection on a region of committed pages in the virtual address space of a specified process.</li>
</ul>
</li>
<li>Function: CreateProcessA
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa</a></li>
<li>Usage: Creates a new process and its primary thread. The new process runs in the security context of the calling process.</li>
</ul>
</li>
<li>Function: GetThreadContext
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreadcontext">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreadcontext</a></li>
<li>Usage: Retrieves the context of the specified thread.</li>
</ul>
</li>
<li>Function: SetThreadContext
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadcontext">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadcontext</a></li>
<li>Isage: A 64-bit application can set the context of a WOW64 thread using the Wow64SetThreadContext function.</li>
</ul>
</li>
<li>Function: GetCurrentThreadId
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentthreadid">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentthreadid</a></li>
<li>Retrieves the thread identifier of the calling thread.</li>
</ul>
</li>
<li>Function: GetCurrentProcessId
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocessid">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocessid</a></li>
<li>Retrieves the process identifier of the calling process.</li>
</ul>
</li>
<li>Function: CreateFileA
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea">https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea</a></li>
<li>Creates or opens a file or I/O device.</li>
</ul>
</li>
<li>Function: ReadFile
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile">https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile</a></li>
<li>Usage: Reads data from the specified file or input/output (I/O) device. Reads occur at the position specified by the file pointer if supported by the device.</li>
</ul>
</li>
<li>Function: ResumeThread
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-resumethread">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-resumethread</a></li>
<li>Usage: Decrements a thread's suspend count. When the suspend count is decremented to zero, the execution of the thread is resumed.</li>
</ul>
</li>
<li>Function: GetCurrentProcess
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocess">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocess</a></li>
<li>Usage: Retrieves a pseudo handle for the current process.</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<h3 id="1c-5-attck-analysis">1c-5 ATT&amp;CK Analysis</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/8213ab79c3193a9d5c2434f20f6bd143699613980744c96dad434aa6ac91895a.png" alt="picture 209"></p>
<ul>
<li><strong>Discovery - T1124 - System Time Discovery</strong>
<ul>
<li>Library: kernel32.dll</li>
<li>Function: GetSYstemTimeAsFileTime</li>
<li>Description: An adversary may gather the system time and/or time zone from a local or remote system.</li>
<li>Reference: <a href="https://attack.mitre.org/techniques/T1124/">https://attack.mitre.org/techniques/T1124/</a></li>
</ul>
</li>
<li><strong>Execution - T1106 - Native API</strong>
<ul>
<li>Library: kernel32.dll</li>
<li>Function: CreateProcessA</li>
<li>Description: Adversaries may directly interact with the native OS application programming interface (API) to execute behaviors.</li>
<li>Reference: <a href="https://attack.mitre.org/techniques/T1106/">https://attack.mitre.org/techniques/T1106/</a></li>
</ul>
</li>
<li><strong>Defense Evasion / Privilege Escalation - T1055 - Process Injection</strong>
<ul>
<li>Library: kernel32.dll</li>
<li>Function: WriteProcessMemory</li>
<li>Description: Adversaries may inject code into processes in order to evade process-based defenses as well as possibly elevate privileges. Process injection is a method of executing arbitrary code in the address space of a separate live process. Running code in the context of another process may allow access to the process's memory, system/network resources, and possibly elevated privileges. Execution via process injection may also evade detection from security products since the execution is masked under a legitimate process.</li>
<li>Reference: <a href="https://attack.mitre.org/techniques/T1055">https://attack.mitre.org/techniques/T1055</a></li>
</ul>
</li>
</ul>
<br/>
<h3 id="1c-6-resources">1c-6 Resources</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/d769811ad7f45c143ac78abc22ee013598d175bb0a5d426cf9069eccb44c37df.png" alt="picture 210"></p>
<ul>
<li>The resource only contains the manifest</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c9b8f309b8ec05c4056884262ce65954558087770d5a467c66637db828a12749.png" alt="picture 211"></p>
<ul>
<li>It doesn't require admin privilege</li>
</ul>
<br/>
<h3 id="1c-7-strings">1c-7 Strings</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3a9434e90906ae5c11951bbc0fda71468584eae3bd8a1a560a0aff976199e3e7.png" alt="picture 212"></p>
<ul>
<li><code>searchWOW64.exe</code> - ASCII - at <code>0x1D60</code></li>
<li><code>timeztsrv.exe</code> - ASCII - at <code>0x1D70</code></li>
</ul>
<br/>
<hr>
<h2 id="2c---reverse-engineering---phexe">2c - Reverse Engineering - ph.exe</h2>
<p>Before reverse engineering the sample, disable the ASLR flag using CFF Explorer:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/5cb98b20e2a1197c20d5a4929a5737428767ed556b7dce72d7aeacfaa7eafbb.png" alt="picture 214"></p>
<br/>
<p>Load <code>ph.exe</code> into <strong>IDA Pro</strong>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/a9d920a5ec62106b4f133e391c051963787cfc0162a2a4c74679e6ef59c63b35.png" alt="picture 215"></p>
<br/>
<h3 id="readfile-in-the-main-function">ReadFile in the main function</h3>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/9cdf47e1f38be41be0b7767358c36f4f7ee42da625e38a2d7a54cf03dd228ad.png" alt="picture 216"></p>
<ul>
<li><code>ReadFile</code> has a cross reference in <code>main</code> function</li>
</ul>
<br/>
<p>Inspect the <code>ReadFile</code> API call:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/9dd721fe6455a51b4f690c4d522a6bde6e2b7f153a810d6cdda15b1d91bfdb29.png" alt="picture 217"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile">https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile</a></li>
<li>Usage: Reads data from the specified file or input/output (I/O) device.</li>
<li>Return:
<ul>
<li>If the function succeeds, the return value is nonzero (TRUE).</li>
<li>If the function fails, or is completing asynchronously, the return value is zero (FALSE).</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>hFile</code>: A handle to the device (for example, a file, file stream, physical disk, volume, console buffer, tape drive, socket, communications resource, mailslot, or pipe).
<ul>
<li>Set to <code>rsi</code>, which is determined by the return value of the API call <code>CreateFileA</code> at <code>1400010BD</code></li>
<li><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/691df900e267a0bd06f52d9635c9d8306e666f982537f367d1a99603290760dd.png" alt="picture 218"></li>
<li>Potentially to be a handle of <code>timeztsrv.exe</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This function call read content of <code>timeztsrv.exe</code>.</p>
<br/>
<h3 id="createfilea-in-the-main-function">CreateFileA in the main function</h3>
<p>Scroll up and check the function call of <code>CreateFileA</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/b7a691ba18ae837f6b04f0adcea1b572beb31aecdda184d99dbace58bd68cbf.png" alt="picture 219"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea">https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea</a></li>
<li>Usage: Creates or opens a file or I/O device. The most commonly used I/O devices are as follows: file, file stream, directory, physical disk, volume, console buffer, tape drive, communications resource, mailslot, and pipe.</li>
<li>Return:
<ul>
<li>If the function succeeds, the return value is an open handle to the specified file, device, named pipe, or mail slot.</li>
<li>If the function fails, the return value is INVALID_HANDLE_VALUE.</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>lpFileName</code>: The name of the file or device to be created or opened.
<ul>
<li>It is <code>timeztsrv.exe</code> set at <code>1400010A0</code></li>
</ul>
</li>
<li><code>dwCreationDisposition</code>: An action to take on a file or device that exists or does not exist.
<ul>
<li>Set to <code>3</code> at <code>1400010AA</code> - <code>OPEN_EXISTING</code> - Opens a file or device, only if it exists. If the specified file or device does not exist, the function fails and the last-error code is set to ERROR_FILE_NOT_FOUND</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This function call opens <code>timeztsrv.exe</code> if it exists.</p>
<br/>
<h3 id="createprocessa-in-the-main-function">CreateProcessA in the main function</h3>
<p>Check the call of <code>CreateProcessA</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/5710295af6fdda4dfc722074d2ba315d3301aa2b74cc2fe23d883c3b68db5383.png" alt="picture 220"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa</a></li>
<li>Usage: Creates a new process and its primary thread. The new process runs in the security context of the calling process.</li>
<li>Return:
<ul>
<li>If the function succeeds, the return value is nonzero.</li>
<li>If the function fails, the return value is zero.</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>lpApplicationName</code>: The name of the module to be executed.
<ul>
<li>Set to <code>0</code> at <code>140001081</code></li>
<li>The module name must be the first white spacedelimited token in the <code>lpCommandLine</code> string.</li>
</ul>
</li>
<li><code>lpCommandLine</code>:  The command line to be executed.
<ul>
<li>Set to <code>searchWOW64.exe</code> at <code>14000104D</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p>The <code>CreateProcessA</code> function call runs <code>searchWOW64.exe</code>, which is not a well-known executable.</p>
<p>Checking the PreFetch, it has not actually executed:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/1d62a816b236900be83cfdb376904cc1924579d0573c5cd72655e6ad6686b3e1.png" alt="picture 221"></p>
<br/>
<p>Also, <code>ph.exe</code> has not been executed as well:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/10a63436287275bf52eb983b2c9263eb72ae513ad898ec0ff6526e11b95652e.png" alt="picture 222"></p>
<br/>
<h2 id="3c---dynamic-analysis---pdexe">3c - Dynamic Analysis - pd.exe</h2>
<p>Beforing running, run <strong>Wireshark</strong> and <strong>Process Monitor</strong> to capture the traffic and process details.</p>
<br/>
<p>Run <code>ph.exe</code> as admin then.</p>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/d372206c82219bd8923c8e1bc9348ab3ce86ea0aaba02ca1d319b91692fdaf46.png" alt="picture 224"></p>
<p>As expected, the attempts of running <code>searchWOW64.exe</code> and <code>timeztsrv.exe</code> fails since they are not present:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/bc5528d975355fc6d83208e3d853819a51606fa3b07d0475437ff3f09402530e.png" alt="picture 223"></p>
<br/>
<hr>
<h2 id="4---unpacking">4 - Unpacking</h2>
<p><strong>Question</strong></p>
<p>If there is a packed file, you need to unpack it and then provide full analysis of what it does and how it works. Dont forget to add details such as but not limited to the File entropy, names of the sections, size of the sections.</p>
<br/>
<p><strong>Answer</strong></p>
<p><code>loader.exe</code> is found to be packed in the static analysis. Recap the static analyze:</p>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c4a4884337e6c81afd1c0c161d75b2366b979a61a164b93aa879ed4dec41404b.png" alt="picture 169"></p>
<ul>
<li>Sections information
<ul>
<li><strong>Section Name:</strong> A
<ul>
<li>Usage: unknown (uncommon section - being 0 bytes might means this section serve for unpacked content)</li>
<li>Raw Size: 0 bytes</li>
<li>Virtual Size: 24576 bytes</li>
<li>Permission: Writable, Executable</li>
<li>Entropy: 0 (null)</li>
</ul>
</li>
<li><strong>Section Name:</strong> B
<ul>
<li>Usage: unknown (uncommon section)</li>
<li>Raw Size: 5120 bytes</li>
<li>Virtual Size: 8192 bytes</li>
<li>Permission: Writable, Executable</li>
<li>Entropy: 7.543 (High entropy - <strong>possibly packed</strong>)</li>
</ul>
</li>
<li><strong>Section Name:</strong> .rsrc
<ul>
<li>Usage: Resource directory</li>
<li>Raw Size: 1536 bytes</li>
<li>Virtual Size: 4096 bytes</li>
<li>Permission: Writable</li>
<li>Entropy: 3.922</li>
</ul>
</li>
</ul>
</li>
</ul>
<br/>
<p>Use <strong>Detect It Easy</strong> to try to look for common packer:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/e2977b22ddd9ef33ab071d6baa02f329d96dc16dd6530c8843c44aa927f32d6c.png" alt="picture 177"></p>
<ul>
<li>Possibly packed by <strong>UPX</strong></li>
</ul>
<br/>
<h3 id="unpacking-loaderexe">Unpacking loader.exe</h3>
<p>Before unpacking, first disable ASLR using CFF Explorer:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/da083e42f089aab89db45df86ba6720e497c34573503ed79a196e9afbaa0c321.png" alt="picture 180"></p>
<br/>
<p>Load <code>loader.exe</code> into <strong>x64dbg</strong> for manual extraction.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/309a8bbe2daf3b43b64c382d4464806d3276d1833a45ea6dce15b0a53eb7edea.png" alt="picture 178"></p>
<br/>
<p>Get to the entrypoint and scroll down, there is an area containing many opcode <code>00 00</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/fd5866fd79f50a8e6b4b05e2ab9c1bc61981db8b6ff0a4eaa8c95f3e1b2239a4.png" alt="picture 181"></p>
<ul>
<li><code>1400082D0</code> should notate the end of the unpacking process</li>
<li>Set a breakpoint at this instruction</li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3463b6a41960f3099c630b0e6eeea85dfe22040cb36fa4ddfedcb5e22c8a423d.png" alt="picture 182"></p>
<br/>
<p>Before running, let's take a look into the string reference currently:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3ca15cf7215e069da557bf417c62b3305a0fd79783b14a31b2618f1a8a054512.png" alt="picture 183"></p>
<br/>
<p>Run it and it should hit the breakpoint we set. Then step over it once:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/741b3f8548628e9369cdc3fed57574c11263040350127f490a2a2dbcf47882d6.png" alt="picture 184"></p>
<br/>
<p>Now check the strings references:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/a579f389c730d75d03ec7b2e46d41692cdf27cd28d9297a1a007a1da427d8cc6.png" alt="picture 185"></p>
<ul>
<li>Now we see more strings reference in this region</li>
</ul>
<br/>
<p>Check the intermodular call as well:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/ccd9c04a089be60648dce6cb3c3ed5dac4804616a3ab3af1c9e7993181f0bc0.png" alt="picture 186"></p>
<ul>
<li>As shown, there are more API calls compared to when doing in static analysis</li>
<li>Now <code>loader.exe</code> should be unpacked</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/d16ca5ef9379b665f91c08ff789ce4c257faf5dcaba0403bda9ab67f52ec9131.png" alt="picture 187"></p>
<ul>
<li><code>140001434</code> is likely the OEP</li>
</ul>
<br/>
<p>Use <strong>x64dbg</strong> <strong>OllyDumpEx</strong> to dump the process:</p>
<ul>
<li><a href="https://low-priority.appspot.com/ollydumpex/">https://low-priority.appspot.com/ollydumpex/</a></li>
<li>Click <code>GetRIP</code> as <code>OEP</code></li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/9d3c6b2ab6fdbd2cc60c242015fbbb1d0e479cb5689803f1db7c88a5d0817daa.png" alt="picture 189"></p>
<br/>
<p>Also, double-click the section <code>&quot;A&quot;</code> and <code>&quot;B&quot;</code> and enable the flag <code>MEM_WRITE</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/377804a8cf1f019e4fb16f98a1071af9a90b9a82f73309344abcf99902f278f.png" alt="picture 190"></p>
<br/>
<p>Then dump the process and save as <code>loader-dumped.exe</code>.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/7c7111f8ff9c2d6f1663469202c7337dede883ba58c4b4db54dfd9b169b21958.png" alt="picture 191"></p>
<br/>
<p>Also we have to rebuild the IAT. Use the <code>Scylla</code> plugin on <code>x64dbg</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/60c9fe79afd14e5f3e646722e0ee830ff7e03c8653d85fd31b9ec4798005e9f2.png" alt="picture 192"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/38a726aa6d9619190f8b00f249391b397d72c8924c6da01c92e21c89a667a651.png" alt="picture 193"></p>
<ul>
<li>The fixed dump is named <code>loader-dumped_SCY.exe</code></li>
</ul>
<br/>
<p>Load <code>loader-dumped_SCY.exe</code> in <strong>PeStudio</strong> and inspect the libraries and imports:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/9713f8c6f840414a602134b34ed47c7bf19b1d25c2dace11ce5dae0d1b617c7c.png" alt="picture 194"></p>
<ul>
<li>Sample libraries</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/d1c6a583c10f61bf4df53f9fa499a6e7c95b3ef86f569c54bf2def994f41afb9.png" alt="picture 195"></p>
<ul>
<li>More imported functions compared with before</li>
<li>There are some notable functions related to Code Injection
<ul>
<li><code>CreateToolhelp32Snapshot</code>: Get a listing of running processes</li>
<li><code>Process32First</code> and <code>Process32Next</code>: Iterate through the processes in the list</li>
<li><code>OpenProcess</code>: Open a handle to the target processes</li>
<li><code>VirtualAllocEx</code>: Allocate memory space in the targeted process</li>
<li><code>WriteProcessMemory</code>: Write specified contents (code / data)</li>
<li><code>CreateRemoteThread</code>: Run code in a new thread of the process</li>
</ul>
</li>
<li>Based on this observation, we may have the hypothesis of <code>loader.exe</code> being able to perform code injection</li>
</ul>
<br/>
<p>Inspect the strings as well:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/0c4a602e39788e1195c112c00cd9146d2c796e05aa15ec3c264ee4a012ca550.png" alt="picture 196"></p>
<ul>
<li>Many more strings than before</li>
</ul>
<br/>
<h3 id="disassemble-unpacked-loaderexe">Disassemble unpacked loader.exe</h3>
<p>Load <code>loader-dumped_SCY.exe</code> into <strong>IDA Pro</strong>.</p>
<br/>
<h4 id="createremotethread-in-the-main-function">CreateRemoteThread in the main function</h4>
<p>Check the cross-reference of this function call:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/f67730536dd77d8ded4df227e09da3b5c3690035b329242e2e71f051422db57b.png" alt="picture 197"></p>
<ul>
<li>It is referenced in the <code>main</code> function</li>
</ul>
<br/>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/794165f19dacf92810e1a0b24762643a5b65cfd95b2d1e3745d89d27f0594ca.png" alt="picture 198"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread</a></li>
<li>Usage: Creates a thread that runs in the virtual address space of another process.</li>
<li>Parameters:
<ul>
<li><code>hProcess</code>: A handle to the process in which the thread is to be created.
<ul>
<li>Set to <code>[rsp+1C8h+hProcess]</code> - this is set up at <code>1400010D6</code> by the return value of the fucntion call <code>OpenProcess</code></li>
</ul>
</li>
<li><code>lpStartAddress</code>: A pointer to the application-defined function of type LPTHREAD_START_ROUTINE to be executed by the thread and represents the starting address of the thread in the remote process.
<ul>
<li>Set to <code>[rsp+1C8h+lpStartAddress]</code>, which is set up by the return value of <code>GetProcAddress</code> at <code>14000112A</code></li>
<li></li>
</ul>
</li>
</ul>
</li>
<li>In short, the thread will execute code at address <code>lpStartAddress</code> within the process where <code>hProcess</code> handle is pointing.</li>
</ul>
<br/>
<h4 id="openprocess-in-the-main-function">OpenProcess in the main function</h4>
<p>Next inspect the <code>OpenProcess</code> function call to see what is set for the <code>hProcess</code> in <code>CreateRemoteThread</code>.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/1ddfd9c3da072f45f8baef55e9687e09e1d4abb1568e32ef4b1f16bddc8486b.png" alt="picture 200"></p>
<p>As shown, before calling <code>OpenProcess</code>, there is a <code>stricmp</code> function call.</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/stricmp-wcsicmp-mbsicmp-stricmp-l-wcsicmp-l-mbsicmp-l?view=msvc-160">https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/stricmp-wcsicmp-mbsicmp-stricmp-l-wcsicmp-l-mbsicmp-l?view=msvc-160</a></li>
<li><code>stricmp</code> performs a case-insensitive comparison of strings.</li>
<li>Return value will be <code>0</code> if matched</li>
<li>Based on <code>14000108C - 140001093</code>, it compares the return value of the <code>Process32Next</code> function call and the static string <code>explorer.exe</code></li>
<li>In other words, the <code>stricmp</code> call is used to locate the process named <code>explorer.exe</code></li>
<li>If the return value of <code>stricmp</code> is <code>0</code>, meaning that the process checking is <code>explorer.exe</code>, the jump at <code>1400010A3</code> will NOT be taken and instructions starting from <code>1400010A9</code> will be executed and then reach <code>OpenProcess</code></li>
</ul>
<br/>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess</a></li>
<li>Usage: Opens an existing local process object.</li>
<li>Return:
<ul>
<li>If the function succeeds, the return value is an open handle to the specified process.</li>
<li>If the function fails, the return value is NULL.</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>dwProcessId</code>: The identifier of the local process to be opened.
<ul>
<li>Set to be <code>[rsp+1C8h+pe.th32ProcessId]</code></li>
<li>This is can regarded as the ProcessId of <code>explorer.exe</code> in this context</li>
</ul>
</li>
</ul>
</li>
<li>In short, this function call open the process named <code>explorer.exe</code></li>
</ul>
<br/>
<h4 id="virtualalloxex-in-the-main-function">VirtualAlloxEx in the main function</h4>
<p>After calling <code>OpenProcess</code> it call <code>VirtualAllocEx</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/875926b42fc79ac5e931c10a05b782e1c17bdad61d7eae0c2726f2c78bd48b6.png" alt="picture 201"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex">https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex</a></li>
<li>Usage: Reserves, commits, or changes the state of a region of memory within the virtual address space of a specified process. The function initializes the memory it allocates to zero.</li>
<li>Return:
<ul>
<li>If the function succeeds, the return value is the base address of the allocated region of pages.</li>
<li>If the function fails, the return value is NULL.</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>hProcess</code>: The handle to a process.
<ul>
<li>This is set to be the returned handle of the <code>OpenProcess</code> API call at <code>1400010BB</code></li>
<li>Handle for <code>explorer.exe</code></li>
</ul>
</li>
<li><code>lpAddress</code>: The pointer that specifies a desired starting address for the region of pages that you want to allocate.
<ul>
<li>Set to <code>0</code> - the function determines where to allocate the region</li>
</ul>
</li>
<li><code>dwSize</code>: The size of the region of memory to allocate, in bytes.
<ul>
<li>Set to <code>0x18</code> (24 bytes) at <code>1400010CE</code></li>
</ul>
</li>
<li><code>flAllocationType</code>: The type of memory allocation.
<ul>
<li>Set to <code>0x1000</code> - <code>MEM_COMMIT</code> - Allocates memory charges (from the overall size of memory and the paging files on disk) for the specified reserved memory pages. The function also guarantees that when the caller later initially accesses the memory, the contents will be zero. Actual physical pages are not allocated unless/until the virtual addresses are actually accessed.</li>
</ul>
</li>
<li><code>flProtect</code>: The memory protection for the region of pages to be allocated.
<ul>
<li>Set to <code>4</code>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants">https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants</a></li>
<li>PAGE_READWRITE - Enables read-only or read/write access to the committed region of pages.</li>
<li>This matches the characteristic of code injection</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>This function call allocate memory space in the process <code>explorer.exe</code></li>
</ul>
<br/>
<h4 id="writeprocessmemory-in-the-main-function">WriteProcessMemory in the main function</h4>
<p>After calling <code>VirtualAllocEx</code> it call <code>WriteProcessMemory</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/410eee33cad3c59b5d6a76322cad0922db6094ee2440da25e38ad8f2070be450.png" alt="picture 202"></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory">https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory</a></li>
<li>Usage: Writes data to an area of memory in a specified process</li>
<li>Return:
<ul>
<li>If the function succeeds, the return value is nonzero.</li>
<li>If the function fails, the return value is 0 (zero).</li>
</ul>
</li>
<li>Parameters:
<ul>
<li><code>hProcess</code>: A handle to the process memory to be modified.
<ul>
<li>This is set to be the returned handle of the <code>OpenProcess</code> API call at <code>1400010BB</code></li>
<li>Handle for <code>explorer.exe</code></li>
</ul>
</li>
<li><code>lpBaseAddress</code>: A pointer to the base address in the specified process to which data is written.
<ul>
<li>This is set to <code>[rsp+1C8h+lpBaseAddress]</code></li>
<li>This is determined by the return value of the function call <code>VirtualAllocEx</code> at <code>1400010E1</code></li>
</ul>
</li>
<li><code>lpBuffer</code>: A pointer to the buffer that contains data to be written in the address space of the specified process.
<ul>
<li>This is set to <code>[rsp+1C8h+Buffer]</code>, which refererence to <code>140001024 - 14000103E</code></li>
<li>The buffer contains the string <code>conbase.dll</code></li>
</ul>
</li>
<li><code>nSize</code>: The nubmer of bytes to be written to the specified process
<ul>
<li>Set to <code>18h</code> (24 bytes)</li>
</ul>
</li>
</ul>
</li>
<li>In short, the <code>WriteProcessMemory</code> call write <code>conbase.dll</code> in the memory space in the <code>explorer.exe</code> process</li>
</ul>
<br/>
<h4 id="getmodulehandlea-and-getprocaddress-in-the-main-function">GetModuleHandleA and GetProcAddress in the main function</h4>
<p>After the <code>WriteProcessMemory</code> call we can see the <code>GetModuleHandleA</code> and <code>GetProcAddress</code> call:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/18cc7013101075e1bb7f4c89947baff4a08424baa3d47bade3067201a472f5ac.png" alt="picture 203"></p>
<ul>
<li>
<p><code>GetModuleHandleA</code></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea">https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea</a></li>
<li>Usage: Retrieves a module handle for the specified module</li>
<li>Return:
<ul>
<li>If the function succeeds, the return value is a handle to the specified module.</li>
<li>If the function fails, the return value is NULL.</li>
</ul>
</li>
<li>Parameter:
<ul>
<li><code>lpModuleName</code>: The name of the loaded module (either a .dll or .exe file).
<ul>
<li>Set to be <code>Kernel32</code></li>
</ul>
</li>
</ul>
</li>
<li>In short, this function call get a pointer to <code>kernel32.dll</code></li>
</ul>
</li>
<li>
<p><code>GetProcAddress</code></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress">https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress</a></li>
<li>Usage: Retrieves the address of an exported function or variable from the specified dynamic-link library (DLL).</li>
<li>Return:
<ul>
<li>If the function succeeds, the return value is the address of the exported function or variable.</li>
<li>If the function fails, the return value is NULL.</li>
</ul>
</li>
<li>Parameter:
<ul>
<li><code>hModule</code>: A handle to the DLL module that contains the function or variable.
<ul>
<li>Set to <code>LoadLibraryW</code></li>
</ul>
</li>
<li><code>lpProcName</code>: The function or variable name, or the function's ordinal value. If this parameter is an ordinal value, it must be in the low-order word; the high-order word must be zero.
<ul>
<li>Set to <code>rax</code> - the return value of <code>GetModuleHandleA</code> - which is the handle of <code>kernel32.dll</code></li>
</ul>
</li>
</ul>
</li>
<li>In short, this function call locate the address of the LoadLibrary function within the <code>kernell32.dll</code> file</li>
</ul>
</li>
</ul>
<br/>
<h4 id="short-summary-of-loaderexe">Short summary of loader.exe</h4>
<p>At this point, judging from the above analysis, the <code>CreateRemoteThread</code> directs the <code>LoadLibrary</code> call inside the new thread in <code>explorer.exe</code>, and loads the malicious DLL <code>conbase.dll</code>.</p>
<br/>
<p>Per the analysis previously, <code>conbase.dll</code> is actually the obfuscated file located in <code>http://www.elsmap.com/banner.jpg</code>, which is downloaded and stored in <code>SYSTEM32</code>. This is how this malicious DLL gets injected to <code>explorer.exe</code>.</p>
<br/>
<hr>
<h2 id="5---network-activity">5 - Network Activity</h2>
<p><strong>Question</strong></p>
<p>What network activity did this malware sample generate, use the bullet points below to help you with what you need to document on your final report.</p>
<ol>
<li>Domains and IP addresses that the malware communicated with</li>
<li>Protocols used</li>
<li>Files accessed or downloaded, their type and what are their contents</li>
</ol>
<br/>
<p><strong>Answer</strong></p>
<p>Check the <strong>Wireshark</strong> capture and inspect the <strong>Protocol Hierarchy Statistics</strong>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/93f6b206b24080068971b2a0428dec9ea5807e734e004892b40e507cc59cbcff.png" alt="picture 108"></p>
<ul>
<li>There are HTTP traffics as expected</li>
</ul>
<br/>
<h3 id="http">HTTP</h3>
<p>Check the http traffic by using the filter <code>not tcp.port == 3389 and http</code>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/a46f4ae9807465994328d315276782e822df64ab156340e4e5db56f794ca8f8f.png" alt="picture 109"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/959cca748b0442e5a96c8bc02a9d24aed163d018051211bc667d417dd4afc2f.png" alt="picture 110"></p>
<ul>
<li>Domain: <a href="http://www.elsmap.com">www.elsmap.com</a></li>
<li>IP Address: 192.168.210.1</li>
<li>Protocol: HTTP</li>
<li>File downloaded:
<ul>
<li>banner.jpg</li>
<li>start.jpg</li>
<li>pic1.jpg</li>
<li>pic2.jpg</li>
<li>pic3.jpg</li>
<li>pic4.jpg</li>
<li>pic5.jpg</li>
<li>footer.jpg</li>
<li>/exam/runme.bat</li>
</ul>
</li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/cbc1b80e53e204302f00ed6e66fd6e90ee59af2075559c136264f998094e08cc.png" alt="picture 111"></p>
<ul>
<li>This shows <code>banner.jpg</code> is actually a PE file</li>
</ul>
<br/>
<h4 id="bannerjpg-1">banner.jpg</h4>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Type</th>
<th>MD5</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>banner.jpg</td>
<td>Windows PE (DLL)</td>
<td>989D3C5FA70A8466C6D4A5953C704B00</td>
<td>/</td>
</tr>
</tbody>
</table>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/a817265523c8646bba0ebb6611aaea49a93262acbe63f042f005ce84b7caf7ba.png" alt="picture 112"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/4895608337a894ab2d6bc129f88452fdcccb213f98361dcbbcf6487ba6b459ec.png" alt="picture 117"></p>
<br/>
<h4 id="startjpg">start.jpg</h4>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Type</th>
<th>MD5</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>start.jpg</td>
<td>JPEG</td>
<td>5606DF43FEEFC42FBD12CF06F60676B9</td>
<td>/</td>
</tr>
</tbody>
</table>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c987dd39f4cf48b6a64e1f8b29420bfdbcd1c0a432ebd2e6aa891a44d0d2cf8.png" alt="picture 113"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/6d0b62eb445383d8136e81f6b1a04b5cfe0269021f1a41674dca428e3400bfbd.png" alt="picture 114"></p>
<ul>
<li><code>FF D8</code> = JPEG</li>
</ul>
<p>Content:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3ad652d9c56ff5cc507676dcf3ce6b6d38298a93fafe4062ee4f0a3590acac2c.png" alt="picture 115"></p>
<br/>
<h4 id="pic1jpg">pic1.jpg</h4>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Type</th>
<th>MD5</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>pic1.jpg</td>
<td>JPEG</td>
<td>369BC1DB5F92AA730B871A2BECBBEDA2</td>
<td>/</td>
</tr>
</tbody>
</table>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c008838bc7964164645f78572cbe489753e4edb3e376226f9787305ea45a417.png" alt="picture 119"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/ab3eb524dde809159eeee4ea92b50316bbf08b3965327fb4b9f1010cbd4a1f67.png" alt="picture 118"></p>
<ul>
<li><code>FF D8</code> = JPEG</li>
</ul>
<p>Content:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/0c68cd1db8b438664bcc867ac18153bbce9f5d2c93d32e6333748f42a7bfbcfb.png" alt="picture 120"></p>
<br/>
<h4 id="pic2jpg">pic2.jpg</h4>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Type</th>
<th>MD5</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>pic2.jpg</td>
<td>JPEG</td>
<td>D08AB13F3C57753EF26730E8E62AA817</td>
<td>/</td>
</tr>
</tbody>
</table>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/7883507aae5e8f36258ef8706829cebbd10486f96f40484ed764bcdbb2124f2.png" alt="picture 122"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/23a5a5e9208ae2107c2c4f69a2947cadbc11ba78c023092233a912cc20159288.png" alt="picture 123"></p>
<ul>
<li><code>FF D8</code> = JPEG</li>
</ul>
<p>Content:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/8bc6559ce90ef117c7d4210d6bed29ac90ac03a53124b961f0bff5da2490e2.png" alt="picture 121"></p>
<br/>
<h4 id="pic3jpg">pic3.jpg</h4>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Type</th>
<th>MD5</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>pic3.jpg</td>
<td>JPEG</td>
<td>E40E65D6F8A6C9626E181D9273B3E5E4</td>
<td>/</td>
</tr>
</tbody>
</table>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c37cdf173d7f56f64cbb99d87d24ac197c1ad8f34fa736eab03aae8424c42210.png" alt="picture 129"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3d79f5459ef228ff35e0d3ecfecc3f8a4c28e12be279b8e2d5b645377260b1.png" alt="picture 124"></p>
<ul>
<li><code>FF D8</code> = JPEG</li>
</ul>
<p>Content:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/0a2870425348d125b10c05b586c1546976eba324975ef5635cbd246e8ac7a37d.png" alt="picture 130"></p>
<br/>
<h4 id="pic4jpg">pic4.jpg</h4>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Type</th>
<th>MD5</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>pic4.jpg</td>
<td>JPEG</td>
<td>955E9C5204009BD6FDAE913F7584FA6B</td>
<td>/</td>
</tr>
</tbody>
</table>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/459d39e4cce323638a16c651855a5aa6dd4173e588eebff482a0a3ff5e3b5957.png" alt="picture 134"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3916854a895579c35aeea422d6eb6973eb6cad363b31d2d99f40c57f98f26286.png" alt="picture 125"></p>
<ul>
<li><code>FF D8</code> = JPEG</li>
</ul>
<p>Content:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3e838cd8f9a11566fa3511fe8d693bd98b23f9cba86f4546a8624be35b79d733.png" alt="picture 131"></p>
<br/>
<h4 id="pic5jpg">pic5.jpg</h4>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Type</th>
<th>MD5</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>pic5.jpg</td>
<td>JPEG</td>
<td>64FB3D450B85EFF54FADB1217852CCD3</td>
<td>/</td>
</tr>
</tbody>
</table>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/6d29877d93ed99d6ecbe8304a5042d76f13c45ace2d50e8a9bc639983ae4822c.png" alt="picture 135"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/3387e99262fee405896813d2f6442832bbff477ae8a903c1c4610a726359ec94.png" alt="picture 126"></p>
<ul>
<li><code>FF D8</code> = JPEG</li>
</ul>
<p>Content:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/645acbb9331227e224785fe6c4fe076925c5128dd1cffdb8d0861138ddcbd473.png" alt="picture 132"></p>
<br/>
<h4 id="footerjpg">footer.jpg</h4>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Type</th>
<th>MD5</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>footer.jpg</td>
<td>JPEG</td>
<td>3eD3FEF9A570BF9436565113D19AA71</td>
<td>/</td>
</tr>
</tbody>
</table>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/bc0e821ad8ab54fdd8585371a95784acfa24727d105cf832ed2f7c26cc4530c8.png" alt="picture 136"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/509df9bc750c9bb78a47ec3b73f16c83616fa319699b1f953705ce28ad607175.png" alt="picture 127"></p>
<ul>
<li><code>FF D8</code> = JPEG</li>
</ul>
<p>Content:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/642c53425d97eabf086603f0b1d0acd6855cb93bac161004b8e0190ff2ba5eb9.png" alt="picture 133"></p>
<br/>
<h4 id="runmebat">runme.bat</h4>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Type</th>
<th>MD5</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>runme.bat</td>
<td>Windows Batch script</td>
<td>C9063EF391A6BB5693525BDA6C54DA8C</td>
<td>/</td>
</tr>
</tbody>
</table>
<p>Content:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/8d4c20f67299985887fb53183eb12e0b4b46457a5eea0e0c83789a325a34734.png" alt="picture 128"></p>
<ul>
<li>This is a destructive batch script which targeted to delete <code>*.exe</code>, <code>*.dll</code>, <code>*.jpg</code> and <code>*.png</code> on the system</li>
</ul>
<br/>
<h3 id="icmp">ICMP</h3>
<p>Also ICMP traffic is also observed:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/987f2dff48dc36671f89e1006bbe726ad98e14b9bcf342335860f094a80cd6f.png" alt="picture 153"></p>
<ul>
<li>Destination: 1.1.1.1</li>
<li>This is expected result triggered by the ping command analyzed previously</li>
</ul>
<br/>
<hr>
<h2 id="6---persistence">6 - Persistence</h2>
<p><strong>Question</strong></p>
<p>You need to provide thorough details and explanations on how this malware is achieving persistence on the victims system. You should list all the persistence techniques in use (e.g. running as a service, registry keys, autorun folders, etc).</p>
<br/>
<p><strong>Answer</strong></p>
<h3 id="method-1---using-persistence-run-key">Method 1 - Using Persistence Run key</h3>
<p>As per the disassembly, the sample has a function of adding a persistence key <code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\WizLoader</code> and set the value to be <code>C:\Windows\svchost.exe</code>. Here is the screenshot of the action captured in dynamic analysis on <strong>Process Monitor</strong>:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/0a013a06cce82515e2ce3bf80c763d556935d23722ba9153ec6c4f453a84bc.png" alt="picture 137"></p>
<ul>
<li>ATT&amp;CK:
<ul>
<li>ID: T1547.001</li>
<li>Technique: Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder</li>
<li>Tactics: Persistence</li>
</ul>
</li>
</ul>
<br/>
<p>With this registry key added, <code>C:\Windows\svchost.exe</code> will be run at the time a user logon.</p>
<p>Note that the legit <code>svchost.exe</code> resides in <code>C:\Windows\System32\</code>.</p>
<ul>
<li>ATT&amp;CK:
<ul>
<li>ID: T1036.005</li>
<li>Technique: Masquerading: Match Legitimate Name or Location</li>
<li>Tactics: Defense Evasion</li>
</ul>
</li>
</ul>
<br/>
<p>Checking the path and also the entries in <strong>Process Monitor</strong>, <code>C:\Windows\svchost.exe</code> has never been created.</p>
<br/>
<h3 id="method-2---inject-dll-into-spoolsvexe-port-monitors">Method 2 - Inject DLL into spoolsv.exe (Port Monitors)</h3>
<p>As per the disassembly, the sample adds a registry key <code>HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor</code>.</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/773830cedc706d11a88f4e38890e4d67921be6d4b553a8b18bd18771da824e76.png" alt="picture 138"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/a1d941ba7b13020fb022d7f7bc70699b26b8990c8f54470bfbdb1fe37698c7bf.png" alt="picture 139"></p>
<br/>
<p>By adding this registry key, the supplied DLL <code>C:\Windows\System32\conbase.dll</code> is loaded at system startup, and it is loaded by th spooler server <code>spoolsv.exe</code> at boot time. This run as SYSTEM level permission.</p>
<br/>
<ul>
<li>ATT&amp;CK:
<ul>
<li>ID: T1547.010</li>
<li>Technique: Boot or Logon Autostart Execution: Port Monitors</li>
<li>Tactics: Persistence, Privilege Escalation</li>
</ul>
</li>
</ul>
<br/>
<p>Similar to <code>svchost.exe</code>, there is a legit Windows DLL called <code>combase.dll</code>.</p>
<ul>
<li>ATT&amp;CK:
<ul>
<li>ID: T1036.005</li>
<li>Technique: Masquerading: Match Legitimate Name or Location</li>
<li>Tactics: Defense Evasion</li>
</ul>
</li>
</ul>
<br/>
<p><code>C:\Windows\System32\conbase.dll</code> can be found:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/9f8dc1d34345a783ea7b0577434a9c94b438e6692c6727fa2bb6aa2c5ca47ed.png" alt="picture 140"></p>
<ul>
<li>MD5: 989D3C5FA70A8466C6D4A5953C704B00</li>
<li>Note that this is exactly the same as the file downloaded from <code>http://www.elsmap.com/banner.jpg</code></li>
</ul>
<br/>
<p>To check it capability, first add a secondary address on the ethernet interface:</p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/9d75e159186b478cbed1011c6cc61c963c13fbb8ce32ada6fb145d0816b04099.png" alt="picture 141"></p>
<br/>
<p>Launch a netcat listener locally:</p>
<ul>
<li><code>nc -nlvp 443</code></li>
</ul>
<p>Then use <code>rundll32.exe</code> to load the DLL:</p>
<ul>
<li><code>C:\Windows\System32\rundll32.exe C:\Windows\System32\conbase.dll,0</code></li>
</ul>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/b9cadd79b4f27a5d156ded74193e6d45a3cf6b57498542e7db915434383ce9cf.png" alt="picture 142"></p>
<ul>
<li>A reverse shell calls back to the netcat listener, which matches our analysis in disassembly</li>
</ul>
<br/>
<hr>
<h2 id="7---dropped-and-downloaded-files">7 - Dropped and Downloaded Files</h2>
<p><strong>Question</strong></p>
<p>What are the hash values of all the files that are related to this malware? You should list all files in a table showing their type, from where they were downloaded, where they were saved on disk, their hash value, and a description about what they are used for.</p>
<br/>
<p><strong>Answer</strong></p>
<table>
<thead>
<tr>
<th>#</th>
<th>Name</th>
<th>Type</th>
<th>Hash (MD5)</th>
<th>URL</th>
<th>Location on Disk</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>loader.exe</td>
<td>EXE</td>
<td>CF48AF5B5779877C3BD9F15A443BE1B1</td>
<td>/</td>
<td>Created by the sample</td>
<td>C:\Users\AdminELS\Downloads\Samples\Final_Exam\loader.exe</td>
</tr>
<tr>
<td>2</td>
<td>ph.exe</td>
<td>EXE</td>
<td>D2DCC98A3CF29BE377291DAC3EE5DF1C</td>
<td>Created by the sample</td>
<td>C:\Users\AdminELS\Downloads\Samples\Final_Exam\ph.exe</td>
<td>Executable created by the sample</td>
</tr>
<tr>
<td>3</td>
<td>banner.jpg</td>
<td>EXE</td>
<td>989D3C5FA70A8466C6D4A5953C704B00</td>
<td><a href="http://www.elsmap.com/banner.jpg">http://www.elsmap.com/banner.jpg</a></td>
<td>C:\Users\AdminELS\AppData\Local\Temp\banner.jpg</td>
<td><code>conbase.dll</code>, a reverse shell pretending to be an image file</td>
</tr>
<tr>
<td>4</td>
<td>start.jpg</td>
<td>JPG</td>
<td>5606DF43FEEFC42FBD12CF06F60676B9</td>
<td><a href="http://www.elsmap.com/start.jpg">http://www.elsmap.com/start.jpg</a></td>
<td>Image</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>footer.jpg</td>
<td>JPG</td>
<td>3eD3FEF9A570BF9436565113D19AA71</td>
<td><a href="http://www.elsmap.com/footer.jpg">http://www.elsmap.com/footer.jpg</a>  C:\Users\AdminELS\AppData\Local\Temp\footer.jpg</td>
<td>Image</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>pic1.jpg</td>
<td>JPG</td>
<td>369BC1DB5F92AA730B871A2BECBBEDA2</td>
<td><a href="http://www.elsmap.com/pic1.jpg">http://www.elsmap.com/pic1.jpg</a>  C:\Users\AdminELS\AppData\Local\Temp\pic1.jpg</td>
<td>Image</td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>pic2.jpg</td>
<td>JPG</td>
<td>D08AB13F3C57753EF26730E8E62AA817</td>
<td><a href="http://www.elsmap.com/pic2.jpg">http://www.elsmap.com/pic2.jpg</a>  C:\Users\AdminELS\AppData\Local\Temp\pic1.jpg</td>
<td>Image</td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>pic3.jpg</td>
<td>JPG</td>
<td>E40E65D6F8A6C9626E181D9273B3E5E4</td>
<td><a href="http://www.elsmap.com/pic3.jpg">http://www.elsmap.com/pic3.jpg</a>  C:\Users\AdminELS\AppData\Local\Temp\pic1.jpg</td>
<td>Image</td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>pic4.jpg</td>
<td>JPG</td>
<td>955E9C5204009BD6FDAE913F7584FA6B</td>
<td><a href="http://www.elsmap.com/pic4.jpg">http://www.elsmap.com/pic4.jpg</a>  C:\Users\AdminELS\AppData\Local\Temp\pic1.jpg</td>
<td>Image</td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>pic5.jpg</td>
<td>JPG</td>
<td>369BC1DB5F92AA730B871A2BECBBEDA2</td>
<td><a href="http://www.elsmap.com/pic5.jpg">http://www.elsmap.com/pic5.jpg</a>  C:\Users\AdminELS\AppData\Local\Temp\pic1.jpg</td>
<td>Image</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>runme.bat</td>
<td>BAT</td>
<td>C9063EF391A6BB5693525BDA6C54DA8C</td>
<td><a href="http://www.elsmap.com/runme.bat">http://www.elsmap.com/runme.bat</a>  C:\Users\AdminELS\AppData\Local\Temp\runme.bat</td>
<td>A batch script containing instruction of wiping *.exe, *.dll, *.jpg and *.png</td>
<td></td>
</tr>
</tbody>
</table>
<br/>
<hr>
<h2 id="8---iocs">8 - IOCs</h2>
<p><strong>Question</strong></p>
<p>What are the IOCs that you could use to write a YARA rule in order to detect this sample on other systems? The rule should be able to identify that sample based on PE header, File Hash, Functions used, Strings, etc. Be very specific about what you use, otherwise it will lead to many false positives.</p>
<br/>
<p><strong>Answer</strong></p>
<p>The following YARA rule can be used:</p>
<pre><code><code><div>import &quot;pe&quot;
import &quot;hash&quot;

rule DetectFinalExamEXE
{
    meta:
        description = &quot;Detect FinalExam.exe&quot;
        author = &quot;Brian Yau&quot;
        date = &quot;10 Aug 2021&quot;
    strings:
        $mz = {4d 5a}
        $s1 = &quot;ph.exe&quot; nocase ascii wide
        $s2 = &quot;loader&quot; nocase ascii wide
        $s3 = &quot;http://www.elsmap.com/banner.jpg&quot; nocase ascii wide
        $s4 = &quot;cmd.exe /C ping 1.1.1.1 -n 1 -w 3000 &gt; Nul &amp; Del /f /q \&quot;%s\&quot;&quot; nocase ascii wide
        $s5 = &quot;http://update.microsoft.com&quot; nocase ascii wide
        $s6 = &quot;WizLoader&quot; nocase ascii wide
        $s7 = &quot;SYSTEM\\CurrentControlSet\\Control\\Print\\Monitors\\PortMonitor&quot; nocase ascii wide
        $s8 = &quot;Yzpcd2luZG93c1xzdmNob3N0LmV4ZQ==&quot; nocase ascii wide
        $s9 = &quot;/C loader.exe &amp;&amp; del /F loader.exe&quot; nocase ascii wide
        $s10 = &quot;Debugger Detected&quot; nocase ascii wide
        $s11 = &quot;Abort!&quot; nocase ascii wide
        $s12 = &quot;Sandbox Detected!&quot; nocase ascii wide
    condition:
        (
            $mz at 0 and
            all of ($s*) and
            (
                pe.imports(&quot;wininet.dll&quot;, &quot;DeleteUrlCacheEntry&quot;) and
                pe.imports(&quot;wininet.dll&quot;, &quot;InternetCheckConnectionA&quot;) and
                pe.imports(&quot;crypt32.dll&quot;, &quot;CryptStringToBinaryA&quot;) and
                pe.imports(&quot;urlmon.dll&quot;, &quot;URLDownloadToFileA&quot;) and
                pe.imports(&quot;user32.dll&quot;, &quot;MessageBoxW&quot;) and
                pe.imports(&quot;advapi32.dll&quot;, &quot;RegOpenKeyExA&quot;) and
                pe.imports(&quot;advapi32.dll&quot;, &quot;RegOpenKeyExW&quot;) and
                pe.imports(&quot;advapi32.dll&quot;, &quot;RegSetValueExA&quot;) and
                pe.imports(&quot;advapi32.dll&quot;, &quot;RegCloseKey&quot;) and
                pe.imports(&quot;shell32.dll&quot;, &quot;ShellExecuteA&quot;)
            )
        ) or
        (
            hash.md5(0,filesize) == &quot;28783d3a3d0fc76385a471d782141c04&quot; or hash.sha1(0,filesize) == &quot;d98e17f3a7a28454e96031792d3cbad3b1b64e2&quot; or hash.sha256(0,filesize) == &quot;a4c1473add35a0409fc49c12c344decf8ff71b1029f77de2d20c9794ce387ab9&quot;
        )
}
</div></code></code></pre>
<br/>
<p>Use the rule against the FinalExam folder to test:</p>
<pre><code><code><div>yara64.exe rule.yar -s -r C:\Users\AdminELS\Downloads\Samples\Final_Exam
</div></code></code></pre>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/754f06b67950fa22054b59c05d68c3ea77ae0bd7cb31236b3c8d5e8e0fa16e7.png" alt="picture 225"></p>
<ul>
<li>As shown, the rule successfully detect the sample.</li>
</ul>
<br/>
<hr>
<h2 id="9---visualization">9 - Visualization</h2>
<p><strong>Question</strong></p>
<p>Provide a visualization for the whole execution life cycle (or execution flow) of the sample. You do not have to use ProcDOT, you can draw it using any tool you prefer.</p>
<br/>
<p><strong>Answer</strong></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/4232da7375001cf53bd43f3ad5a44ea69afd825a0a23c36591f4574325af0030.png" alt="picture 101"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/b819a84186efa8f03bfce8e3462f5388d93201c6fcc02f54df5d65eef2c3696.png" alt="picture 102"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/c75abe2477d9e4ac72d34101b63e0f73edc0f12feb94821de69c6b95cb1de20e.png" alt="picture 103"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/67e212ae785abcee509faaf576db7511cba718debbb24903151b0ae5e0b7f970.png" alt="picture 104"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/5918a0280c935c049373ddb1b326f507a484e893f01f22cb7a582f9bb77031ae.png" alt="picture 105"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/40e0df9f597300e58bb764cd659f1b7435ecb7c9f36efda97cb75ee847ab6f.png" alt="picture 107"></p>
<p><img src="file:////Users/brianyau/Documents/GitHub/MalwareAnalysis/images/096c5b06f2509967dc3f208da9ff38b481d378e8ccb815181c6978eee8ad779.png" alt="picture 106"></p>
<br/>
<hr>
<h2 id="10---summary--conclusion">10 - Summary &amp; Conclusion</h2>
<p><strong>Question</strong></p>
<p>This one is very simple, just write a summary of your analysis.</p>
<br/>
<p><strong>Answer</strong></p>
<p>The sample <code>FinalExam.exe</code> is capable of downloading additional file from <code>www.elsmap.com</code> - a packed executable obfuscated as a JPG file, which performs DLL injection into <code>explorer.exe</code> and make a reverse connection to the C2 IP address <code>192.168.210.132</code>.</p>
<br/>
<p>Based on the finding, the possible measures to be taken to prevent this malware from causing further damaging will be:</p>
<ul>
<li>Block the IP address <code>192.168.210.132</code> in the network</li>
<li>Block the domain <code>www.elsmap.com</code> in the network</li>
</ul>
<br/>
<hr>

    </body>
    </html>