# Lab 11 - Keylogger Dynamic Analysis

- [Lab 11 - Keylogger Dynamic Analysis](#lab-11---keylogger-dynamic-analysis)
  - [Scenario](#scenario)
  - [Tools](#tools)
  - [Task 1: Finding main handles and files](#task-1-finding-main-handles-and-files)
    - [Static Analysis](#static-analysis)
    - [Dynamic Analysis](#dynamic-analysis)
  - [Task 2: Analyzing process activity](#task-2-analyzing-process-activity)
  - [Task 3: Sample IOCs](#task-3-sample-iocs)

---

## Scenario

You’ve been called by a client to examine a weird sample that was found on one of their developer’s systems. The client thinks this sample could be hiding its true nature of activity.

<br/>

The goal of this lab is to understand how to analyze a user level keylogger and locate the files where keystrokes are being saved to.

<br/>

After completing this lab, you will be able to analyze user-level keyloggers using basic dynamic analysis techniques using tools such as Process Explorer, Process Monitor, and Wireshark.

<br/>

192.168.210.10 / AdminELS / Nu3pmkfyX

<br/>

---

## Tools

- Sysinternals Process Explorer (procexp.exe) 
- Sysinternals Process Monitor (procmon.exe)
- Wireshark

<br/>

---

## Task 1: Finding main handles and files

**Question**

Run the given sample and find all the main parts of it: handles and files used.

<br/>

**Answer**

### Static Analysis

Open the sample in **PEStudio**:

![picture 247](images/5bd555568e216180ec1f1dac81cceeab20ae930f836e80be454ab991fa2fd288.png)  

- MD5: `F02FB4A3AFC3696276696E317785484B`
- SHA1: `A364BD5754D8549C1B9EE07DF120640430265E99`
- SHA256: `67E61A356A91129037DB0C1D933998086CCC24A4025C97E5AB7541F72C411BD4`
- It is a PE (indicated by the first bytes `MZ` `0x4d5a`)
- 32-bit with GUI

<br/>

Check the strings:

![picture 248](images/bfa4dbd364cae66b257f4b1e29ad48d92b71732e1e6fb3abcb14d2b91680f59a.png)  

- Interesting strings:
  - `C:\Windows\System32\WOW64Log.txt`
  - `connection reset`
  - `identifier removed`
  - `operator co await`

- Hooking related:
  - `CallNextHookEx`

- Execution related:
  - CloseThreadpoolTimer
  - CreateThreadpoolTimer
  - CreateThreadpoolWait
  - CreateThreadpoolWork
  - GetCurrentProcessId
  - GetCurrentProcessorNumber
  - GetCurrentThreadId
  - GetEnvironmentStrings
  - GetWindowThreadProcessId
  - SetEnvironmentVariable
  - SwitchToThread
  - TerminateProcess
  - WaitForThreadpoolTimerCallbacks

- File related:
  - CreateSymbolicLink
  - FindClose
  - FindFirstFileEx
  - FindNextFile
  - GetFileInformationByHandleEx

- IO related:
  - GetKeyState
  - MapVirtualKeyEx
  - GetKeyboardLayout

- DLL related:
  - GetModuleFileName
  - GetModuleHandleEx

<br/>

Check the imports:

![picture 249](images/2dae998e673b8c129df52305ec493a4763d29492aa3f53310a4847b68c0b88b7.png)  

- IO related:
  - GetKeyState
  - MapVirtualKeyExA

- Hooking related:
  - CallNextHookEx
  - SetWindowsHookExA

- File related:
  - FindClose
  - FindFirstFileExW
  - FindNextFileW

- Execution related:
  - GetWindowThreadProcessId
  - TerminateProcess
  - SetEnvironmentVariableW
  - GetEnvironmentStringsW
  - SwitchToThread
  - GetCurrentProcessId
  - GetCurrentThreadId

<br/>

Check the libraries:

![picture 250](images/71199479510942c6a44a70503ce99f231d85d26fa9879105dcf2ce708d7233ee.png)  

- `user32.dll`
- `kernel32.dll`

<br/>

### Dynamic Analysis

Open, as admin, the following:

1. Process Monitor
2. Process Explorer
3. Wireshark

<br/>

Run the sample as admin:

```
lab_10.exe
```

![picture 251](images/b7907a9e4fa858e782dd2e7be70320a6a47b25b573fa393fb2e89edcfdb039fa.png)  

- Nothing is shown to the user

<br/>

Inspect in Process Explorer:

![picture 252](images/e594a340a77a35b7238774dc68baaa3aba119ad78dc577da01e5a2bd68047591.png)  

- An instance of `lab_10.exe` (PID: 2096) is running

<br/>

In Process Monitor, inspect the Process Handle:

1. `View > Show Lower Pane`
2. `View > Lower Pane View > Handles`

![picture 254](images/1c0e60a6ae900b83d2fcdbee6c240c32fab39feaf68a28872d7f40c3b18b1348.png)  

- It is communicating with `C:\Windows\SysWOW64\WOW64Log.txt`

![picture 255](images/be89ba929b4c657c612040da416e1fda1f607a835f56b97bd38d91461fd8a36d.png)  


<br/>

Also check the memory strings of `lab_10.exe` in **Process Explorer**:

![picture 257](images/8db092904d428d6834eb2c6648a6c65cc9a0f3b9a6de7d1d95e27304378f938a.png)  

- "Failed to install hook" is shown
- There are some keystrokes listed - likely they are the ones that the program cannot hook

<br/>

In the Static Analysis, it is suspected that this is a keylogger since it includes some I/O imports. 

Try to create a text file and see if the text is captured somewhere.

![picture 253](images/4a2773f2efe49d902b3a5ec201a006ff509f6fe611f0f81949f3b6e3d1475036.png)  


<br/>

---

## Task 2: Analyzing process activity

**Question**

This is a malicious sample that was collected, and you’re required to analyze it and provide as much information to what activity it is doing.

<br/>

**Answer**

In **Process Monitor**, filter `Operation is CreateFile` and `ProcessName is lab_10.exe`:

![picture 258](images/416115a847c49c0a09ef446895e170ccd29beec136a6d07ab9f7e1b6da5de74e.png)  

- The operation of creating `WOW64Log.txt` is shown

![picture 259](images/936688f0ad946908ce53c549375be675781be4a2c58d15dbffe777c4b07d279d.png)  

- Desired Access is `Generic Write, Read Attributes`
- OpenResult is `Created`

<br/>

Right click the entry and click `Jump To ...`, it brings you to the target path:

![picture 260](images/a214906ed17cab27b89615e9bccfb1b521ae8609122f126aa66fa356a4f10095.png)  

<br/>

Inspect the file:

![picture 261](images/2d8474e6e48dc152a94313c4cf3c2e8d7845bf5d1218709e1b55c2dc5ba20ed9.png)  

![picture 262](images/2d518dbffcbd477abc111b0b91ab6d8f215a38f8f74397845bedfa146d822f0a.png)  

- These are the character that we have typed

<br/>

Filter `Process Name is lab_10.exe`:

![picture 263](images/4a144fe3c4e1381deb3883de0c7d918e7f5bee6cfdbc8683f2693554426e710e.png)  

- See the pattern `QueryStandardinformationFile` > `WriteFile`
- Note the bytes written are different: `53`, `70`, `64`, `65` etc -> This indicates the length of different keystokes

![picture 264](images/fc11580b211c7e8d9fe7d3d511b7618b5563229d1b920b917fae58521d7f0310.png)  


<br/>

---

## Task 3: Sample IOCs

**Question**

What are the IOCs that could be created to find and identify this sample on other systems?

<br/>

**Answer**

We can write a YARA rule to capture this in memory:

```
import "hash"

rule DetectKeyloggerLab10
{
    meta:
      description = "Detect Keylogger lab_10.exe"
      author = "Brain You"
      date = "13 Jun 2021"
    strings:
      $str1 = "[BACKSPACE]" nocase ascii wide
      $str2 = "[TAB]" nocase ascii wide
      $str3 = "[SHIFT]" nocase ascii wide
      $str4 = "[CONTROL]" nocase ascii wide
      $str5 = "[ESCAPE]" nocase ascii wide
      $str6 = "[END]" nocase ascii wide
      $str7 = "[HOME]" nocase ascii wide
      $str8 = "[LEFT]" nocase ascii wide
      $str10 = "[RIGHT]" nocase ascii wide
      $str11 = "[DOWN]" nocase ascii wide
      $str12 = "[CAPSLOCK]" nocase ascii wide
      $str13 = "C:\Windows\System32\WOW64Log.txt" nocase ascii wide
      $str14 = "Failed to install hook!" nocase ascii wide
      $str15 = "GetKeyState" nocase ascii wide
      $str16 = "MapVirtualKeyEx" nocase ascii wide
      $str17 = "GetKeyboardLayout" nocase ascii wide
    condition:
      ( all of ($str*) ) or
      ( hash.md5(0, filesize) == "f02fb4a3afc3696276696e317785484b" )
}

```

<br/>

Use `yara64.exe` to inspect the process of `lab_10.exe`:

```
yara64.exe rule.yar -s 2096
```

![picture 265](images/0f53eae814f29063582d9c549234a20f0bfc7455e519da618a4c10ad6169bdbe.png)  

<br/>

Also check against file:

```
yara64.exe rule.yar -s -r C:\Users\AdminELS\Desktop\Lab_11_Samples\
```

![picture 266](images/b66782b4874908942e8b14b964e6e4a1f2a36f96038a52594028cb68a04a63f9.png)  

<br/>

---