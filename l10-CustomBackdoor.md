# Lab 10 - Custom Backdoor Dynamic Analysis

- [Lab 10 - Custom Backdoor Dynamic Analysis](#lab-10---custom-backdoor-dynamic-analysis)
  - [Scenario](#scenario)
  - [Tools](#tools)
  - [Task 1: Finding general information and handles](#task-1-finding-general-information-and-handles)
    - [Static Analysis](#static-analysis)
    - [Dynamic Analysis](#dynamic-analysis)
  - [Task 2: Analyzing process activity](#task-2-analyzing-process-activity)
  - [Task 3: Sample IOCs](#task-3-sample-iocs)

---

## Scenario

You have been called by a client to examine a weird sample that was found on one of their developerâ€™s systems. The client thinks this sample is hiding its true nature of activity.

<br/>

The goal of this lab is to understand how to analyze a backdoor using a reverse shell by performing dynamic analysis and to see if this is enough to identify key parts of the sample.

<br/>

After completing this lab, you will be able to analyze a sample with a backdoor using basic dynamic analysis techniques using tools such as Process Explorer, Process Hacker, Process Monitor, Netcat, and Wireshark.

<br/>

192.168.210.10 / AdminELS / Nu3pmkfyX

<br/>

----

## Tools

- Process Explorer / Process Hacker
- Process Monitor
- Netcat
- Wireshark

<br/>

---

## Task 1: Finding general information and handles

**Question**

Run the given sample and gather general information related to it.

<br/>

**Answer**

### Static Analysis

Load the sample in **PE Studio**:

![picture 223](images/35f461c2a3e6cd0a992d96857672488281a279251d8d34281b83be1ecb7ecdb8.png)  

- MD5: FCA6B0E7DB00A153B9828F3DB2F12A0C
- SHA1: DBB267A1192963239D2E35CD2976724C5F7EC983
- SHA256: 8999131E615D9CED52D8DE39BEA4F72687830A428254ABB9190D9538D87ED18F
- 32-bit executable (console)

<br/>

Check the **strings** tab:

![picture 224](images/3ea389747e1dd7b2cf6475f3fac3fb2938de7f52f897dafc7ae66e85b0280d7f.png)  

- Interesting strings:
  - `192.168.210.132`
  - `2cmd.exe`
  - `IsDebuggerPresent` - Potential debug functionality
  - `WSAConnect` / `WSASocket` - Network utilities
  - `GetCurrentProcessId` / `GetCurrentThreadId` / `GetCurrentProcess` - Potential DLL injection API

<br/>

Check the libraries import:

![picture 225](images/b3602990d3f9ae881bad3ea112576ad8defabad44e734cd2a92bc93e12f327e1.png)  

- `ws2_32.dll` - Handle network connections

<br/>

Check the imports:

![picture 226](images/597bae5a121ad0694473109a0096ccbcbe6a1fd4a094e19f89f801aa4b32e7cc.png)  

- Network functions from `ws2_32.dll` - `WSAStartup`, `inet_addr`, `WSASocketW`, `htons`, `WSAConnect`

Note:
The names `115`, `11` etc mean they are exported by Ordinal

<br/>

### Dynamic Analysis

First run the following as admin:

- Process Explorer
- Process Monitor
- Wireshark (monitor both Ethernet adapter and loopback)

<br/>

Use privileged `cmd.exe` to launch `lab_09.exe`:

```
cd C:\Users\AdminELS\Desktop\Lab_10_Samples
lab_09.exe
```

![picture 227](images/90f1861218e35f360c9d73242749de208037127e673c5a667e057f8af3ec9d00.png)  

- No obvious things shown to the user

<br/>

---

## Task 2: Analyzing process activity

**Question**

Analyze this malicious sample and find a way to create the environment that is needed by the sample in order to fully understanding with basic dynamic analysis methods only. Then, provide as much information to what this sample is and what activity it is doing.

<br/>

**Answer**

Filter out `Process Name is lab_09.exe` in Procmon. Then open **Process Tree** via `Tools > Process Tree`:

![picture 229](images/e1f0ec2b60f51ec331307a9c86253fd721f1e6089fbe4515aa4d88a00d573d88.png)  


- `lab_09.exe` spawns `cmd.exe` (PID: 124)

<br/>

In addition to `lab_09.exe`, also filter out `Process Name is cmd.exe`. Then use `Tools > Network Summary` to inspect the network traffic:

![picture 230](images/abf2bbe747eb9149188becaad5a24b18879b80f5fa32ff8cbcb7b0334d651198.png)  

- It tries connecting to `192.168.210.132:443`
- Note this IP is found in the executable strings

<br/>

Double-clicking the first entries will show all of the operations captured related to the traffic:

![picture 233](images/0cca8c9fcd788710ab351532a6ec3c9d5525cab0c449b1a27b31a464c5bdc1cd.png)  


<br/>

In **Wireshark**, try to check the network connection related to `192.168.210.132` using `ip.host == 192.168.210.132`:

![picture 231](images/b53000a162ac8252561d04c99da60d0a6bb94fddcfc356a4486311ed08aa045e.png)  

- No result

<br/>

Use `Edit > Find Packet` to find the string `192.168.210.132` to find the related traffic:

![picture 232](images/57c61a3a5be5a7f85769095d38b7a835e5e6a30627048f6e83396b642e4b8a23.png)  

- There are ARP traffic - the host is trying to find the available host with the IP address `192.168.210.132`; however there is no such host and there is no any ARP reply received

<br/>

To see the actions after a successful connection, let's try to give response to the request. The method is as follows:

1. Add a virtual IP address `192.168.210.132` in local network device
2. Use `netcat` to listen on `tcp/443`


![picture 234](images/82c2e492fcbdeba4ab61ad6d2dc289e1311984ccb1ae8b2b467508479adcb94c.png)  


```
nc.exe -nlvp 443
```

![picture 235](images/f24c1b668a75367d0abe0929a6b00620036298fe7c87a07afa83065b3e159158.png)  

<br/>

Then rerun the sample.

<br/>

First inspect the netcat listener, it receives the connection and launches a CMD prompt:

![picture 236](images/1733ab79da54c65c6903f5502eb7ce6e1c6796f333f8643e31a7069f14839dfd.png)  

- This is like a reverse shell!

Try to generate some events by running `ipconfig` in the spawned shell:

![picture 238](images/555b74cf34a190e906a054a917e74a114926c19056858e43d9b7e5be3eac5de6.png)  


<br/>

On **Procmon**, filter out `Process Name is cmd.exe` and `Process Name is lab_09.exe`. Then check the **Network Summary**:

![picture 239](images/a9ccd3c0edaad64f59b3e178d78ba5c8b91cb0103ca24ac3d8e4bb7c39392262.png)  

<br/>

Double-clicking the network entry:

![picture 240](images/9422659d662f1b0faa2ec09e6bccc8aa745337150471566b8f78cb07e99468bc.png)  

- Many network connections compared with before

<br/>

Check the **Process Tree** on **Procmon**:

![picture 241](images/e1def508e680b89cc0742250afe17fa9d298a09ac95aac940041ef443fb22b72.png)  

- It shows `lab_09.exe` (PID: 4212) spawns a `cmd.exe` (PID: 3032)
- `cmd.exe` (PID: 3032) spawns `ipconfig.exe` (PID: 6344), which is the process that we run in the spawned shell

<br/>

To confirm this, we can generate some random events with unique signature:

- Create a folder: `mkdir TESTING001`
- Echo a message: `echo "This is TESTING002`
- Create a file with message: `echo Backdoor > .\TESTING001\TESTING003.txt`

![picture 242](images/25917b2d2404d281eb1161f44481ced4b09327a57951bec85017ab3ae88324a1.png)  

<br/>

In Procmon, filter out `Path contains TESTING` (spawned cmd.exe).

![picture 243](images/1937d051b93bea751d9be563eda3261d499624c2f3aa6db367ecf1f0c715c6b9.png)  

- Note there are many operations handled by another process `SearchprotocolHost.exe` for createing folder and file

<br/>

Filter out `lab_09.exe` and `cmd.exe` only, we can see they spawned after the TCP connection:

![picture 244](images/dca4ad7bf5d3754829a6e131e3c64292bdbbca10dbdae793cd4b17588998ed9c.png)  


<br/>

We can also inspect the TCP stream in Wireshark:

- Filter `ip.host eq 192.168.210.132`
- Right click one of the entry and `Follow TCP Stream`

![picture 245](images/5a177e9a4744e0aa636e5339870e6102fabf9af260c36594c0bb166362efdf4e.png)  

- Note the payloads are in Cleartext

<br/>

---

## Task 3: Sample IOCs

**Question**

Determine the IOCs that could be created to find and identify this sample on other systems.

<br/>

**Answer**

We can create a YARA rule:

```
import "pe"
import "hash"

rule DetectLab09Backdoor 
{
    meta:
      description = "Detect lab_09.exe"
      author = "Brain You"
      date = "13 Jun 2021"
    strings:
      $str1 = "192.168.210.132" nocase ascii wide
      $str2 = "2cmd.exe" nocase ascii wide
      $str3 = "CreateProcessW" nocase ascii wide
      $str4 = "WSAConnect" nocase ascii wide
      $mz = {4d 5a}
    condition:
      ( ( all of ($str*) ) and ( $mz at 0 ) ) or 
      ( hash.md5(0, filesize) == "fca6b0e7db00a153b9828f3db2f12a0c" )
}
```

<br/>

Test it again the sample folder:

```
yara64.exe rule.yar -s -r C:\Users\AdminELS\Desktop\Lab_10_Samples\
```

![picture 246](images/5996c56ba455c15e498bb966d364c837d95730a78bde06e11592178ba08dee99.png)  


<br/>

---