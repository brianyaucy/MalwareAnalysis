# Lab 17 - Analyzing the WannaCry Ransomware

- [Lab 17 - Analyzing the WannaCry Ransomware](#lab-17---analyzing-the-wannacry-ransomware)
  - [Scenario](#scenario)
  - [Goals](#goals)
  - [Tools](#tools)
  - [Task 1: Initial Sample Assessment](#task-1-initial-sample-assessment)
  - [Task 2: RE with a Debugger](#task-2-re-with-a-debugger)
    - [http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com](#httpwwwiuqerfsodp9ifjaposdfjhgosurijfaewrwergweacom)
    - [Domain alive case - Location 408090](#domain-alive-case---location-408090)
  - [Task 3: Analyzing Suspicious Resources](#task-3-analyzing-suspicious-resources)
  - [Task 4: Running WannaCry](#task-4-running-wannacry)
    - [Execution - UserAssist Registry](#execution---userassist-registry)
    - [IE Security Zone](#ie-security-zone)
    - [Prefetch](#prefetch)
    - [Added Windows Service](#added-windows-service)
    - [Written file: C:\Windows\tasksche.exe](#written-file-cwindowstaskscheexe)
    - [New Process: tasksche.exe](#new-process-taskscheexe)
    - [Network Miner Pcap](#network-miner-pcap)
  - [Task 5: IOCs](#task-5-iocs)

---

## Scenario

You have been called by a client to examine a WannaCry Ransomware sample that was found on one of their systems and has encrypted all of their data.

<br/>

---

## Goals

The goal of this lab is to understand how to perform both Behavioral and Static Analysis techniques to analyze the famous WannaCry Ransomware.

<br/>

---

## Tools

- PeStudio
- Resource Hacker
- HxD Editor
- Process Hacker
- Procmon
- Fakenet-NG
- Wireshark

<br/>

---

## Task 1: Initial Sample Assessment

Do an initial assessment of the sample to understand what the basic information are we could gather from it. This is the basic static analysis phase.

<br/>

**Answer**

Load the sample into **PeStudio**.

<br/>

![picture 7](images/0e8b85a349d54b467a30503a39da3b10f270c4d5dc8086dfb5220db9f32bfd27.png)  

- Hashes:
  - md5,DB349B97C37D22F5EA1D1841E3C89EB4
  - sha1,E889544AFF85FFAF8B0D0DA705105DEE7C97FE26
  - sha256,24D004A104D4D54034DBCFFC2A4B19A11F39008A575AA614EA04703480B1022C

- 32-bit
- Windows PE
- Description:
  - `Microsoft® Disk Defragmenter`
- High entropy: `7.965`
  - Possible packed

<br/>

Check the version tab:

![picture 8](images/c770519c4cbac5c905784d88e7ff1b985dcf31b652908eddd9ab4b5005b60d7e.png)  

- Orginal name: `lhdfrgui.exe`

<br/>

Check the libraries:

![picture 9](images/be7bf669d1c4c72bd3a3a57f17b3b91f642848538dc2faa4d2733b65ee3c1ce9.png)  

- ws2_32.dll / iphlpapi.dll / wininet.dll
  - Internet connection

<br/>

Check the strings:

![picture 10](images/a619d9980ddfcd8dd903fc9ff6b9a759cb9a1e832bdf07e7229f3ab96ee70024.png)  

- `C:\%s\qeriuwjhrf`
- `http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com`
- `launcher.dll`
- `mssecsvc.exe`
- `tasksche.exe`
- `icacls . /grant Everyone:F /T /C /Q`
- `.?AVexception@@`

```
.der
.pfx
.key
.crt
.csr
.p12
.pem
.odt
.sxw
.stw
.3ds
.max
.3dm
.ods
.sxc
.stc
.dif
.slk
.wb2
.odp
.sxd
.std
.sxm
.sqlite3
.sqlitedb
.sql
.accdb
.mdb
.dbf
.odb
.frm
.myd
.myi
.mdf
.ldf
.cpp
.pas
.asm
.cmd
.bat
.vbs
.sch
.jsp
.php
.asp
.java
.jar
.class
.mp3
.wav
.swf
.fla
.wmv
.mpg
.vob
.mpeg
.asf
.avi
.mov
.mp4
.mkv
.flv
.wma
.mid
.m3u
.m4u
.svg
.psd
.tiff
.tif
.raw
.gif
.png
.bmp
.jpg
.jpeg
.iso
.backup
.zip
.rar
.tgz
.tar
.bak
.ARC
.vmdk
.vdi
.sldm
.sldx
.sti
.sxi
.hwp
.dwg
.pdf
.wk1
.wks
.rtf
.csv
.txt
.eml
.msg
.pst
.ppsx
.ppsm
.pps
.pot
.pptm
.pptx
.ppt
.xltm
.xltx
.xlc
.xlm
.xlt
.xlw
.xlsb
.xlsm
.xlsx
.xls
.dotm
.dot
.docm
.docx
.doc
```

- `lhdfrgui.exe`

<br/>

---

## Task 2: RE with a Debugger

Use a debugger to perform reverse engineering on the malware and understand the execution flow of the malware. This will help you with the next tasks when you need to run the sample.

<br/>

**Answer**

First load the sample into **x96dbg**.

To get to the program entrypoint, navigate to **Symbol**, and double click on `wannacry.exe`:

![picture 1](images/2290a11f2fa5539e58b123310b9c76f9ec39c52601b103615a944f1311da6f9c.png)  

<br/>

Then we can check the function calls by `wannacry.exe` by right-click on the CPU panel, `Disassembly Window > Search for > Current Module > Intermodular calls`:

![picture 2](images/7ba295a51c02b983171420c3d32fc47e7d8ef71cc8e0ec315fbe22eadda8e112.png)  

![picture 3](images/ee774b78fcd2c5053af57ea78d40efc512546cc932fa50368352d3d26293c621.png)  

- `GetTickCount` could be used to check if the running environment is virtualized / detect sandbox

<br/>

Also check string references:

![picture 4](images/b3ae2e6ab19abecbe4e63adca50b827b11ae005b7361e146740d88782a07f010.png)  

![picture 5](images/c3eec5e0df334bc92edbd6cff1c06888bbdea532b9ef5f694e0ade0e8a05ff12.png)  

- `IPC$` - Use of SMB protocol - likely finding network shares across the network
- `Microsoft Security Center (2.0) Service` - Look like a service name but it is not a commonly known one
- `%s -m security` - Look like a service command line
- `%d.%d.%d.%d` - Model for IPv4
- `mssecsvc2.0` - Look like a service name / executable name
- `C:\\%s\\qeriuwjhrf` - Hardcoded system path
- `tasksche.exe` - Look like an executable name - Schedule task alike naming
- `csvc.exe` - Uncommon executable name
- `"http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com"` - Look like a malicious domain

<br/>

Using this leads, we may try to get more information about the logic and capabilities of the sample.

<br/>

### http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com

Double click on the domain string, which brings you to the disassemble panel.

![picture 6](images/3ef94dcbfdbe59c798c2333434c9a56bec9508540be144b50d20b67a671e89a5.png)  

- At `40817B`, we can see the API call `InternetOpenA`
  - https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopena
- At `408194`, we can see the API call `InternetOpenUrlA`
  - https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopenurla
  - `esi` holds the value of the `lpszUrl`
  - Return value:
    - Returns a valid handle to the URL if the connection is successfully established, or 
    - NULL if the connection fails.
  - In short, this makes an Internet connection to the malicious domain 
    - If successful, a handle will be returned and saved to `eax`, which is then saved to `edi` at `40819A`

<br/>

![picture 7](images/cab57063742b3b36e910056d755c3cd8acc76b82bd580709b16e2d3a86609ccb.png)  


Then at `4081A3`, `test edi,edi` checks if the connection is successful:

- If unsuccessful, it matches the condition of the `jne` at `4081A5`. 
  - Then it jumps to `4081BC`
- If yes, it continues to the instruction at `4081A7` - `call esi`
  - `40819D` defines `esi`, which is the function call `InternetCloseHandle` for closing the Internet connection
  - Then it jumps to `408090`

<br/>

Right click the instruction `4081A5` and `Follow in Disassembler`:

![picture 8](images/284b5adb4e30707e42941b81fd1bc897e44146662d5323e8c9cf5b653b611c15.png)  

- The instructions after the jump basically does nothing else but close the Internet Handle

<br/>

### Domain alive case - Location 408090

If the domain is alive and the connection is successful, it runs the code starting at `408090`.

<br/>

![picture 9](images/6b2922a156aa62bfe4995b162dddb331131a1c15f6d61f5abbb9f270cc67e61b.png)  

At `4080DC`, it calls `OpenServiceA`.

- https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-openservicea
  - Opens an existing service.
  - Return value:
    - If the function succeeds, the return value is a handle to the service.
    - If the function fails, the return value is NULL. 
- `lpServiceName` is set to be `mssecsvc2.0`
- In short, this call tries to open the service named `mssecsvc2.0`

<br/>

![picture 10](images/b85ae2fb6171b341e5f300ca1556b6d69aba99ae9227347174dc249aced68aa6.png)  

- Then at `4080EA`, it checks if the call is successful by checking the register `esi`
  - If successful, jump to `4080FC` at `4080FC`
  - If not, call `407FA0`

<br/>

Further check `407FA0`, we can see several API calls:

![picture 11](images/7d46db129ddf031f28f6c2fb61d9fc31b0a8924c594c1a30f2a439e9b015b6ea.png)  

- `407FFA` calls `ChangeServiceConfig2A`
  - https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-changeserviceconfig2a
  - Changes the optional configuration parameters of a service.
- This part basically sets the action if the service does not exist

<br/>

Now check the successful condition, which jumps to `4080FC`:

![picture 12](images/d0eac825de005e57841fd3ca29a707f7066b0f546bb630eae038ac509fdb1726.png)  

- At `408126`, it calls `StartServiceCtrlDispatcherA`
  - https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-startservicectrldispatchera
  - Connects the main thread of a service process to the service control manager, which causes the thread to be the service control dispatcher thread for the calling process.

<br/>

---

## Task 3: Analyzing Suspicious Resources

The malware has a suspicious resource section. Use the skills you learned in previous labs in order to analyze this section (or file!).

<br/>

**Answer**

Checking the executable in **PeStudio**, it identifies an executable:

![picture 13](images/3c7a0413e04b988709528c4dee84e4d55029dfe448cd1ffde2f6d5d2e4ba079a.png)  

- Type: R (non-standard)
- MD5: 84C82835A5D21BBCF75A61706D8AB549
- First bytes: `MZ` (Windows PE›)

<br/>

Right click the entry and dump it:

![picture 14](images/11efc4d7c8bcaa99e03100be80222477aa165832ed0d18f7fa0c873ffd34306e.png)  

- Name it `WannaCry-Resource-Dump.dump`

<br/>

Load the dumped file into **PeStudio**:

![picture 15](images/12f7775f5ecb31200938c6bd025ed50e9530185deead429315b9dc2793c46d9c.png)  

- Hashes:
  - md5,84C82835A5D21BBCF75A61706D8AB549
  - sha1,5FF465AFAABCBF0150D1A3AB2C2E74F3A4426467
  - sha256,ED01EBFBC9EB5BBEA545AF4D01BF5F1071661840480439C6E5BABE8E080E41AA

- Entropy: 7.995 (Likely obfuscated / packed)

<br/>

Checking the **sections**, `.rsrc` has a high entropy of `8`:

![picture 16](images/3ca988f82efc3bd65684de10449311a1a7291547aa563210d4b6948640935a72.png)  

- Obfuscated / packed

<br/>

Navigate to the `resources` section, **PeStudio** identified an `XIA` resource, which is a `PKZIP` file:

![picture 17](images/6ee7841bb10d4c2f738c98ef5c134e88f3532b3d45bbc6a78592577971a92a84.png)  

<br/>

Again, right click this and dump it out:

![picture 18](images/55bc17327146be65b9e2e157bb3649ed1f17188f16d229fade16d0055fa18f43.png)  

- Save as a `.zip` file

<br/>

Then extract the `ZIP` file dumped:

![picture 19](images/aace94343683016ceec2f1de4a792c629639d6d42a5886d214335c806a592181.png)  

- However, extracting it requires a password

<br/>

Try to load `WannaCry-Resource-Dump.dmp` into `x32dbg` and further check.

![picture 20](images/296a34189f9463110bc35e7c3a2436c856af16434628b074d16633a3312f9a62.png)  

![picture 21](images/f52c079dc98ec41e81edf14e2c5bd5468f1ee16802f69389d290afb662fa0d4b.png)  

- Main function is at around `00620026`
- Click `Ctrl-G` in the CPU panel to get there
- 
![picture 22](images/d519529ee319b3763d9c397611c53ed799b05684664965e39484aad30bd6312b.png)  

<br/>

Then check the strings references:

![picture 23](images/2e4b93622ba36c04eb3d4500f31ba1a439356b22390c8c5fa1889385f01194b1.png)  

<br/>

![picture 24](images/df2d4d50e69d764a5abdd4ac96f29e2ec00186f7f337b4eaf554dabbfbbdd729.png)  

Interesting strings:

- rb
- wb
- c.wnry
- WanaCrypt0r
- Wd
- WANACRY!
- CreateFileW / WriteFile / ReadFile / MoveFileW / MoveFileExW / DeleteFileW / CloseHandle
  - API calls
- CryptAcquireContextA / CryptImportKey / CryptDestroyKey / CryptEncrypt / CryptDecrypt / CryptGenKey
  - Look like it leverages Windows native APIs to generate keys and encrypt files, and then destroy the key
- `cmd.exe /c \"%s\""`
  - Command executions
- `tasksche.exe`
  - Found in the previous step
- `WNcry@2ol7`
  - Password-alike string

<br/>

Double click on it:

![picture 25](images/6b92ccf548192d84596175f2ae5a381d603d059c414cccdf29fab903e6a03d2e.png)  

- It is used as a parameter to call `401DAB`
  - Examine this section:

![picture 26](images/240a678b3b938d461e896f18a487f1e5a75639155f916288a52d5c290aa67adc.png)  

- Numerous resource related API calls
- This could be suggesting that `WNcry@2ol7` is a password to the ZIP file hidding in the resource section

<br/>

Try to use this to decrypt the ZIP file:

![picture 28](images/d92334559b050d96176582eece3772cbc0ec19ea3739b7de8bb24ba2a38b34f0.png)  

- Successful:

![picture 29](images/6cc8c924b8e32f87da2ad3f05498a3b278aced66bc40f65c69e7d9033e1b7b49.png)  

<br/>

Inspect `r.wnry`:

![picture 30](images/d26c94db37e1e18af8294b9c481b1584095448cd8512e63edf09776e657b6984.png)  

- Ransomware notes found

<br/>

Inspect `msg/m_english.wnry`:

![picture 31](images/be62401d0e6086da801599a4cbc3c556cad1dc4b0b6aa0c6994abe157050c98d.png)  

- Look like a RTF file

<br/>

Open it on **Wordpad**:

![picture 32](images/de4b2c19bf0be70475c4933ad4ff3530f792fabeceae82b1f0e947875e5b45b8.png)  

- Another ransomware note found

<br/>

For other files, try to use **HxD** to identify the file type. First open `b.wnry`:

![picture 33](images/7af921a98fd9aed3456c850115e9e88554786b2e10bbf154517162f7b6eb59dd.png)  

- Magic bytes: `BM`
  - https://asecuritysite.com/forensics/magic
  - `BM` indicates a `BMP` file
  - Add `.bmp` at the end of `b.wnry`

![picture 34](images/06cffb58b4a7069ade32cdc00443525a02fccf07cde546d06fe03f94335fe5bf.png)  

<br/>

`c.wnry` contains TOR addresses:

![picture 35](images/a126e42a28be71ccfb3a2b01bb266aef6cb046545823beda329787091a716f34.png)  

- gx7ekbenv2riucmf.onion
- 57g7spgrzlojinas.onion
- xxlvbrloxvriy2c5.onion
- 76jdd2ir2embyv47.onion
- cwwnhwhlz52maqm7.onion

<br/>

`s.wnry` is yet another ZIP (PK) file:

![picture 36](images/b23f288e8c22a790c8e627c3fddfd6e8d81a545b7bd4ec67363e08229265e1eb.png)  

![picture 37](images/1fc736a23ae4e4895126d0436019f65aa5538e2f459e545dc6c2a29467bdb7d8.png)  

- It contains a TOR executable

<br/>

`t.wnry` is a unknown file type with first bytes `WANACRY!`

![picture 38](images/b1149f5955dbe18092669b19258f0694c0e5a7449142c02fddb9f339d1aff5c9.png)  

<br/>

`u.wnry` is a Windows PE:

![picture 39](images/4213e516119cbb3b71d58ae0e3889dc1f986dd1536f05071ce1bea58f5009b5c.png)  

Inspect it in **PeStudio**:

![picture 40](images/ecbcf5c356573a073a36fbfd40d167dee47e2166cc79e057eab6e2937ff5ba8c.png)  

- Hashes:
  - md5,7BF2B57F2A205768755C07F238FB32CC
  - sha1,45356A9DD616ED7161A3B9192E2F318D0AB5AD10
  - sha256,B9C5D4339809E0AD9A00D4D3DD26FDF44A32819A54ABF846BB9B560D81391C25
- `LODCTR.exe`
- Description: `Load PerfMon Counters`
- GUI application

Inspect the strings:

![picture 41](images/9bd1a798ccd23d9fe8c32b9b53593bf466d25487f13e295023d7a58cc3a7723e.png)  

- `/c vssadmin delete shadows /all /quiet & wmic shadowcopy delete & bcdedit /set {default} bootstatuspolicy ignoreallfailures & bcdedit /set {default} recoveryenabled no & wbadmin delete catalog -quiet`
  - Remove shadowcopy from the host

![picture 42](images/395e55818f322d88a1358ed8fa02bbd3019455cef39dd8e30d4b926f481d845c.png)  

- Ransomware encrypted filenames

![picture 43](images/5d3eb2eea61f55cd74450019be93203487dd850f096bca74925d9c7fbd32e32c.png)  

- Look like having the capability of checking TOR network connectivity

<br/>

---

## Task 4: Running WannaCry

Prepare your environment and run the malware. Make sure to collect enough information to give you an idea of what happened and how it happened. For example, the malware will encrypt files, and you need to explain how that happened.

<br/>

**Answer**

First create a number of files on the Desktop:

![picture 44](images/196a82cc1786fdd8c9fa44662ddb27d88a84d5435d27c114237908bb52175e7c.png)  

<br/>

Then run **Process Hacker**:

![picture 45](images/f19580e7373e01fce1ca7c6313d8f8f63344b06c67c74e3ce2b5805823cc853d.png)  

<br/>

Run **Procmon** with the following filter:

- Operation: Process Creation
- Operation: RegSetValue
- Operation: WriteFile
- Operation: Process Exit

![picture 46](images/420cf8c8d4b5c8f2b5d4efd79d446692eede21bd87235505bd5996ff48a8deaf.png)  

<br/>

Run **Network Miner** for monitoring resources downloaded:

![picture 47](images/3ad240b1fe5020c2d7c61deada024945e4275bc97255c2c21b80c7670d7de552.png)  

<br/>

Then run WannaCry.exe with admin privilge:

![picture 48](images/03113460e34ab3ec2022a90a5659ee622e4d06b4445aab95f7e36e2f945f7850.png)  

![picture 49](images/ea17f339c69f88335169913973471625ceeafa3d59030a37ac77189e9a4e14b8.png)  

![picture 50](images/a9c9c86ee829895cfb73f6888b422505a8168d6fcc9e1827976761dc0a3e37cb.png)  

![picture 53](images/2e229294e9235fa5ba75f10457a15c4046770cadc509e59ac632361e9e5ed52e.png)  

- The txt files now have the extension `WNCRY`

![picture 54](images/b7f0d52de8bfd079463e96294a6eee28bb93ca88bef25b26b4a45cf82bb7073b.png)  

- Encrypted file

<br/>

### Execution - UserAssist Registry

On Windows, every GUI-based programs launched from the desktop are tracked in the following registry:

- https://www.andreafortuna.org/2018/05/23/forensic-artifacts-evidences-of-program-execution-on-windows-systems/
- `HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{GUID}\Count`
- The values are **ROT-13** encoded

<br/>

Looking for `RegSetValue` activities related to UserAssist, we can find the following:

![picture 55](images/dca1dd14633728b47be768bcf9293ac697a06720d7a837467edc277874cb61d6.png)  

- The path is `HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{CEBFF5CD-ACE2-4F4F-9178-9926F41749EA}\Count\P:\Hfref\NqzvaRYF\Qrfxgbc\JnaanPel.rkr`
  - ROT-13: https://rot13.com/

![picture 56](images/e838429163e6d51f066f817bd9db703aa7b54b49707b7c460c8117eac8005767.png)  

<br/>

### IE Security Zone

After the launch of `WannaCry.exe`, there are some IE `ZoneMap` registry value set:

![picture 57](images/a0ac737bfdcdb5348661e07ca64400b2ad6e0d1ac0f2440ed879925ca198616a.png)  

- https://docs.microsoft.com/en-us/troubleshoot/browsers/ie-security-zones-registry-entries

<br/>

`Right click > Jump To ...`:

![picture 58](images/3cad54d943fa81c61b61f695112c4cbd1e002db61467ad67fc866e058437a439.png)  

https://getadmx.com/HKLM/Software/Policies/Microsoft/Windows/CurrentVersion/Internet%20Settings/ZoneMap

- AutoDetect = 0 (Disabled)
  - Turn on automatic detection of the intranet
- IntranetName = 1 
  - Intranet Sites: Include all local (intranet) sites not listed in other zones
- ProxyBypass = 1
  - Intranet Sites: Include all sites that bypass the proxy server
- UNCAsintranet = 1
  - Intranet Sites: Include all network paths (UNCs)

<br/>

### Prefetch

A prefetch file has been written, which shows the successful execution of `WannaCry.exe`:

![picture 59](images/a204d94391c76cb461bfe0ac9e8ea7905efd937d5988ec7a9447a429a3d053cf.png)  

<br/>

### Added Windows Service

![picture 60](images/6c18ee132e6c80aebbd3890a2491eda6e6d3da0420748c02e495f825453e7e59.png)  

- We can see `services.exe` adding registry value for the path `HKLM\System\CurrentControlSet\Services\mssecsvc2.0\...`

<br/>

Right click and jump to the registry:

![picture 61](images/1d488dcd9a8853c28f2726fbf363c61eac8f55eedb49d6e6e0189c59a6b7227e.png)  

- We can see the service settings
- Displayname: `Microsoft Security Center (2.0) Service`
- ImagePath: `C:\Users\AdminELS\Desktop\WannaCry.exe -m security`
- Type: 0x10
  - A Win32 program that can be started by the Service Controller and that obeys the service control protocol. This type of Win32 service runs in a process by itself.
- WOW64: 0x14c

<br/>

### Written file: C:\Windows\tasksche.exe

![picture 62](images/0334b507a99168636af9863ed88a6dcbc7d0923c728dc9c00a9311ba27808f68.png)  

- We can see the file `tasksche.exe` is written in `C:\Windows\`
- Then the `WannaCry.exe` process exits

<br/>

### New Process: tasksche.exe

![picture 63](images/bb80af21aac6cdc3fb85e2f4d0d6da9ec638e3ef0e540cc2ac309389d7ce8e5e.png)  

- It writes a file `C:\ProgramData\yyqdyhfxxmyx066\tasksche.exe`
  - Jump to the directory to inspect:

![picture 64](images/32c214168eac78a1c4b6fbf0b3a8be1b92ba05e0fd35fc36877b96f19f16ad89.png)  

```
PS C:\ProgramData\yyqdyhfxxmyx066> Get-FileHash -Algorithm MD5 t*

Algorithm       Hash                                            Path
---------       ----                                            ----
MD5             5DCAAC857E695A65F5C3EF1441A73A8F                C:\ProgramData\yyqdyhfxxmyx066\t.wnry
MD5             4FEF5E34143E646DBF9907C4374276F5                C:\ProgramData\yyqdyhfxxmyx066\taskdl.exe
MD5             84C82835A5D21BBCF75A61706D8AB549                C:\ProgramData\yyqdyhfxxmyx066\tasksche.exe
MD5             8495400F199AC77853C53B5A3F278F3E                C:\ProgramData\yyqdyhfxxmyx066\taskse.exe
```

<br/>

Note it also creates a new service `HKLM\System\CurrentControlSet\Services\yyqdyhfxxmyx066\`:

![picture 65](images/9e3150137f3f19ed94025bea79de06fa878de9a0e1fff3e9578c2b92582cb2ec.png)  

- ImagePath: `cmd.exe /c "C:\ProgramData\yyqdyhfxxmyx066\tasksche.exe"`


<br/>

Then we can see the service invokes `cmd.exe` and the command line in the `ImagePath` of the newly added service:

![picture 66](images/dd71adb7f75dc9ab1ed13e352f6625fad5160ef3218861101a16d17c67adacb8.png)  

- It runs `C:\ProgramData\yyqdyhfxxmyx066\tasksche.exe`
  - Add a registry  `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\WanaCrypt0r\wd` with value `C:\ProgramData\yyqdyhfxxmyx066`
  - Write file `C:\ProgramData\yyqdyhfxxmyx066\b.wnry`

<br/>

Also it writes different language notes:

![picture 67](images/b57928c64fd9a87afee81082795dc58b368b47ba355f0b6f8270104b0d7ad312.png)  

<br/>

![picture 68](images/c085cd550c0f1a61a6c542c4d78b141f775ed0b653264b1f756f65649aac7d1e.png)  

![picture 69](images/8270fdda051d5aaca792cde64baaa508cf2b5e1e5395ff8c719b503d15b322a6.png)  

![picture 70](images/939a4654ea89d27a87aff153d771ce94f4a48755b6fc7402a54c6d07eb708dd3.png)  

![picture 71](images/b08e5fcb814c4ae7415c1cb2663ff845756d3f1b164e8bad9f515e69392e979a.png)  

- It writes `s.wnry`, `t.wnry`, `u.wnry`, `c.wnry`
- It writes `taskdl.exe`, `taskse.exe` in `C:\ProgramData\yyqdyhfxxmyx066`
- It launch the process `attrib.exe`, `conhost.exe`, `icacls.exe`
  - `attrib.exe` changes file attribute (e.g. hidden)
  - `icacls.exe` grants access to everyone
  - These properties applied to the directory `C:\ProgramData\yyqdyhfxxmyx066`

<br/>

It also creates `000000000.pky`, `000000000.eky`, `000000000.res`

- Purpose: Unknown
  - Possible encryption key

<br/>

![picture 72](images/24cb42ae775d2d29ec008c29760f3a30992119dbf45b10b2baa6a98703b5d62c.png)  

- Then `tasksche.exe` creates `taskdl.exe` and run it (quickly exits)

<br/>

![picture 73](images/64d60e279de707f3af3e4395892a49881129932c563e507799dc8cee80320c43.png)  

![picture 74](images/35c942342e2de2ccc2f8a11b44282adf60649f305666ac5112b8cd3a5a00ef65.png)  


- It writes `@WanaDecryptor@.exe` and `112441627817491.bat`
  - The `.bat` file is run

<br/>

Then the files created previously on desktop are encrypted:

![picture 75](images/101202cce052d6cd1dab554f2b743bb8ad90785b317f8f268b0d512a6a6d1530.png)  

<br/>

Then `cmd.exe` is run to invoke the VBScript using `cscript //nologo`:

![picture 76](images/a5f8b9fd727b7ac83f4e387e2101e92cb45ec6a3ba4ceae3f55f65fa3eb0d394.png)  

<br/>

Persistence key is added:

![picture 77](images/fef005c8d70ccf4625b94eb003ccb0e05f477a99c2bc4d735afe2baef36be23a.png)  

![picture 78](images/77a637d70d6917534f80b2df3f47214cc58735605b85e67de26bb9b7bd9a6c62.png)  

- Key: `yyqdyhfxxmyx066`
- Value: `"C:\ProgramData\yyqdyhfxxmyx066\tasksche.exe"`

<br/>

Shadow copy remove:

![picture 79](images/952210c9c56f67c23b4863f6a403c2c769507e353801b714ef47ffe5b063f11a.png)  

- This is invoked by `@WanaDecryptor@`

![picture 80](images/45ef11672d8d40ead4b4ed747434727d642c654a1dca5b7e483d664c4f055516.png)  

- `cmd.exe /c vssadmin delete shadows /all /quiet & wmic shadowcopy delete & bcdedit /set {default} bootstatuspolicy ignoreallfailures & bcdedit /set {default} recoveryenabled no & wbadmin delete catalog -quiet`

<br/>

### Network Miner Pcap

In **NetworkMiner**, it shows capturing some SMB traffic:

![picture 81](images/73c8301363fcfb0dba76a83ad0495a8b110de5115e6c280438aa02740b55b0cf.png)  

<br/>

Check the PCAP using **Wireshark**:

![picture 82](images/8defcc770c97a4b7bc64032b2befbed3e5af1418db42b87a0a4adb6b7608b90e.png)  


<br/>


---

## Task 5: IOCs

Determine the IOCs that could be created to find and identify this sample on other systems
or on the network.

<br/>

**Answer**

