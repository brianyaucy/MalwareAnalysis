# eCMAP Exam

- [eCMAP Exam](#ecmap-exam)
  - [Configuration](#configuration)
  - [1 - Initial Assessments - Final Exam.exe](#1---initial-assessments---final-examexe)
    - [Summary](#summary)
    - [1-1 - Hashes](#1-1---hashes)
    - [1-2 - Optional Header](#1-2---optional-header)
    - [1-3 - Sections](#1-3---sections)
    - [1-4 - Functions](#1-4---functions)
    - [1-5 - ATT&CK Analysis](#1-5---attck-analysis)
    - [1-6 - Resources](#1-6---resources)
    - [1-7 - Strings analysis](#1-7---strings-analysis)
  - [2 - Reverse Engineering](#2---reverse-engineering)
    - [FinalExam.exe](#finalexamexe)
      - [Preparation](#preparation)
      - [URLDownloadToFileA - 1400015C0](#urldownloadtofilea---1400015c0)
      - [URLDownloadToFileA - 140002080](#urldownloadtofilea---140002080)
      - [CryptStringToBinaryA - 140001320](#cryptstringtobinarya---140001320)
      - [RegOpenKeyExA, RegSetValueExA, RegCloseKey - 140001B80](#regopenkeyexa-regsetvalueexa-regclosekey---140001b80)
      - [RegOpenKeyExA, RegSetValueExA, RegCloseKey - 140001C70](#regopenkeyexa-regsetvalueexa-regclosekey---140001c70)
      - [InternetCheckConnectionA in sub_140001AE0](#internetcheckconnectiona-in-sub_140001ae0)
      - [MessageBoxW in main function](#messageboxw-in-main-function)
      - [MessageBoxW in 140001AA0](#messageboxw-in-140001aa0)
      - [MessageBoxW in 140001740](#messageboxw-in-140001740)
      - [ShellExecuteA in main function](#shellexecutea-in-main-function)
      - [Anti-X functions](#anti-x-functions)
      - [Debugger Detection at subroutine 140001740](#debugger-detection-at-subroutine-140001740)
      - [Sandbox detection at subroutine 1400017D0](#sandbox-detection-at-subroutine-1400017d0)
      - [VM Detection at subroutine 140001950](#vm-detection-at-subroutine-140001950)
      - [Sandbox detection by Number of Processes](#sandbox-detection-by-number-of-processes)
      - [Debugger detection by using TickCount](#debugger-detection-by-using-tickcount)
    - [banner.jpg](#bannerjpg)
    - [loader.exe](#loaderexe)
    - [ph.exe](#phexe)
  - [1a - Static analysis of banner.jpg](#1a---static-analysis-of-bannerjpg)
    - [Summary](#summary-1)
    - [1a-1 - Basic Information](#1a-1---basic-information)
    - [1a-2 - Optional Header](#1a-2---optional-header)
    - [1a-3 - Sections](#1a-3---sections)
    - [1a-4 - Functions](#1a-4---functions)
    - [1a-5 - ATT&CK Analysis](#1a-5---attck-analysis)
    - [1a-6 - Resources](#1a-6---resources)
    - [1a-7 - Strings analysis](#1a-7---strings-analysis)
  - [2a - Reverse Engineering - banner.jpg / conbase.dll](#2a---reverse-engineering---bannerjpg--conbasedll)
    - [WSAStartup, WSASocketA, htons, inet_addr, WSAConnect and CreateProcessA in routine 180001000](#wsastartup-wsasocketa-htons-inet_addr-wsaconnect-and-createprocessa-in-routine-180001000)
  - [3 - Running the malware](#3---running-the-malware)
    - [Summmary table](#summmary-table)
    - [First time running the malware](#first-time-running-the-malware)
    - [Bypassing the self-defensive mechanism](#bypassing-the-self-defensive-mechanism)
      - [Debugger Detection at subroutine 140001740](#debugger-detection-at-subroutine-140001740-1)
      - [Detection at subroutine 1400017D0, 140001950, 140002274, 14000227D](#detection-at-subroutine-1400017d0-140001950-140002274-14000227d)
    - [Running the patched executable](#running-the-patched-executable)
    - [Processes involved by the sample](#processes-involved-by-the-sample)
      - [First cmd.exe](#first-cmdexe)
      - [Loader.exe](#loaderexe-1)
      - [Second cmd.exe](#second-cmdexe)
      - [ping.exe](#pingexe)
    - [File accessed, downloaded, or used, and their PATH](#file-accessed-downloaded-or-used-and-their-path)
    - [Registry Activities](#registry-activities)
      - [PortMonitor](#portmonitor)
      - [Run Key](#run-key)
    - [Obfuscation](#obfuscation)
    - [banner.jpg / conbase.dll](#bannerjpg--conbasedll)
  - [4 - Unpacking](#4---unpacking)
  - [5 - Network Activity](#5---network-activity)
    - [HTTP](#http)
      - [banner.jpg](#bannerjpg-1)
      - [start.jpg](#startjpg)
      - [pic1.jpg](#pic1jpg)
      - [pic2.jpg](#pic2jpg)
      - [pic3.jpg](#pic3jpg)
      - [pic4.jpg](#pic4jpg)
      - [pic5.jpg](#pic5jpg)
      - [footer.jpg](#footerjpg)
      - [runme.bat](#runmebat)
    - [ICMP](#icmp)
  - [6 - Persistence](#6---persistence)
    - [Method 1 - Using Persistence Run key](#method-1---using-persistence-run-key)
    - [Method 2 - Inject DLL into spoolsv.exe (Port Monitors)](#method-2---inject-dll-into-spoolsvexe-port-monitors)
  - [7 - Dropped and Downloaded Files](#7---dropped-and-downloaded-files)
  - [8 - IOCs](#8---iocs)
  - [9 - Visualization](#9---visualization)
  - [10 - Summary & Conclusion](#10---summary--conclusion)
  - [References](#references)

---

## Configuration

192.168.210.10 
AdminELS / Nu3pmkfyX

<br/>

Sample:
- `C:\Users\AdminELS\Downloads\Samples\Final_Exam`


<br/>

---

## 1 - Initial Assessments - Final Exam.exe

**Questions**

Please provide background information about the malware sample given and any other malicious file(s) that gets downloaded. Use the questions below to help you when providing details about the file being analyzed.

1. What are the hashes of the malware sample?
2. What is the file type?
3. What is the compilation time stamp?
4. What are the file characteristics (e.g. EXE, DLL, 32-bit, 64-bit, etc.)?
5. What is the Image Base and the Entry Point address?
6. Provide details about each section found in terms of their names, sizes, permissions, entropy, and what each is used for.
7. What are the libraries (DLLs) referenced by this sample and which functions do you think are suspicious?
8. What are the MITRE techniques being used?
9. Is this sample packed or not and what proof do you have?
10. What interesting findings can you extract from the resources section?
11. What interesting strings (ASCII and Unicode) did you find and could they be used later as an IOC? Provide a brief explanation for each string found.
12. Are there any crypto functions being used by the sample and what are they?

<br/>

**Answer**

### Summary

| Question | Answer | Reference section |
| --- | --- | --- |
| 1. What are the hashes of the malware sample? | MD5: 28783D3A3D0FC76385A471D782141C04<br/>SHA1: D98E17F3A7A28454E96031792D3CBAD3B1B641E2<br/>SHA256: A4C1473ADD35A0409FC49C12C344DECF8FF71B1029F77DE2D20C9794CE387AB9<br/>IMPHASH: B60C0B539449AFE6F81105D67CA5D7EC | 1-1 |
| 2. What is the file type? | Windows PE | 1-1 |
| 3. What is the compilation time stamp? | Thu Jun 25 06:30:41 2020 | 1-1 |
| 4. What are the file characteristics (e.g. EXE, DLL, 32-bit, 64-bit, etc.)? | EXE, 64-bit | 1-1 |
| 5. What is the Image Base and the Entry Point address? | EntryPoint: 0x2ADC<br/>ImageBase: 0x140000000 | 1-2 |
| 6. Provide details about each section found in terms of their names, sizes, permissions, entropy, and what each is used for. | See details in the reference 1-3 | 1-3 |
| 7. What are the libraries (DLLs) referenced by this sample and which functions do you think are suspicious? | See details in the reference 1-4 | 1-4 |
| 8. What are the MITRE techniques being used? | T1497, T1124, T1112, T1106, T1082 | 1-5 |
| 9. Is this sample packed or not and what proof do you have? | Not packed based on the section names and entropy | 1-3 |
| 10.  What interesting findings can you extract from the resources section? | It requires administrator privilege to run | 1-6 |
| 11. What interesting strings (ASCII and Unicode) did you find and could they be used later as an IOC? Provide a brief explanation for each string found.| See the details in 1-7 | 1-7 |
| 12. Are there any crypto functions being used by the sample and what are they? | Yes - CryptStringToBinaryA (from crypt32.dll) | 1-4 |

<br/>

### 1-1 - Hashes

Use **PeStudio** to open the sample to inspect it statically.

<br/>

![picture 1](images/15c9b0635b354b68513490fa358f6aca313f9bd0db6226896d704d0ca17c2b84.png)  

Based on this screenshot of summary page on **PeStudio** we can get the following information:

- **1. File hashes:**
  - MD5: 28783D3A3D0FC76385A471D782141C04
  - SHA1: D98E17F3A7A28454E96031792D3CBAD3B1B641E2
  - SHA256: A4C1473ADD35A0409FC49C12C344DECF8FF71B1029F77DE2D20C9794CE387AB9
  - IMPHASH: B60C0B539449AFE6F81105D67CA5D7EC
- **2. File type:**
  - Windows PE (Based on the first-bytes being `MZ` (`0x4D5A`))
- **3. Compilation timestamp:** 
  - Thu Jun 25 06:30:41 2020
- **4. File characteristics:**
  - Type: EXE (Based on the **file-type** field)
  - Architect: 64-bit (AMD64)
  - Subsystem: Console

<br/>

### 1-2 - Optional Header

Check the **optional header**:

![picture 2](images/edeb48faa3284e5d1852e69f98497e38c5a2689e41a4e611abc5b497a2454bcd.png)  

- **5. Image Base & Entrypoint:**
  - EntryPoint: 0x2ADC
  - ImageBase: 0x140000000
- Also note that **ASLR** is enabled for this executable - we may have to turn it off later so we can analyze it on disassembler more easily.

<br/>

### 1-3 - Sections

Check the **sections**:

![picture 3](images/e7cefa801b791c52d8102a305b9c1739a2b89150c52932d95fdcedbff5aef192.png)  

- **6. Sections information**
  - **Section Name:** .text
    - Usage: Executable code
    - Raw Size: 9216 bytes
    - Virtual Size: 9180 bytes
    - Permissions: Executable
    - Entropy: 5.802 <br/>
  - **Section Name:** .rdata
    - Usage: Read-only initialized data
    - Raw Size: 8704 bytes
    - Virtual Size: 8488 bytes
    - Permissions: N/A
    - Entropy: 4.497
  - **Section Name:** .data
    - Usage: Initialized data
    - Raw Size: 29696 bytes
    - Virtual Size: 31176 bytes
    - Permissions: Writable
    - Entropy: 4.717
  - **Section Name:** .pdata
    - Usage: Exception information
    - Raw Size: 1024 bytes
    - Virtual Size: 732 bytes
    - Permissions: N/A
    - Entropy: 3.037
  - **Section Name:** .rsrc
    - Usage: Resource directory
    - Raw Size: 47616 bytes
    - Virtual Size: 47228 bytes
    - Permissions: N/A
    - Entropy: 4.031
  - **Section Name:** .reloc
    - Usage: Image relocations
    - Raw Size: 512 bytes
    - Virtual Size: 48 bytes
    - Permissions: N/A
    - Entropy: 0.647

Based on the Entropy score and section names, this sample is unlikely packed.

<br/>

Check the **libraries** section:

![picture 4](images/04be4d9672f3ba17bf87fdf437005b4f3ec39d19df4fab6e59b5ecc74860013b.png)  

- **Library:** wininet.dll
  - Usage: This DLL contains higher-level networking functions that implement protocols such as FTP, HTTP and NTP.
  - Suspicious?
    - Yes - It can be used to establish internet connections.
- **Library:** urlmon.dll
  - Usage: Perform internet communications
  - Suspicious?
    - Yes - It can be used to establish internet connections.
- **Library:** crypt32.dll
  - Usage: Handle cryptographic messaging functions
  - Suspicious?
    - Yes - This is commonly seen in malware for encrypted data, or even in ransomware
- **Library:** kernel32.dll
  - Usage: Contain core functionlity, like access and manipulation of memory, files, and hardware
  - Suspicious?
    - No - This is a very common DLL for any Windows executable
- **Library:** user32.dll
  - Usage: Contain all the user-interface components, such as buttons, scroll bars, and components for controlling and responding to user actions
  - Suspicious?
    - Could be - The subsystem is Console while having UI components, which is not consistent
- **Library:** advapi32.dll
  - Usage: Provide access to advanced core Windows components such as the Service Manager and Registry
  - Suspicious?
    - Could be - Commonly used for addign registry keys for persistence
- **Library:** shell32.dll
  - Usage: Contain Windows Shell API functions, which are used when opening webpages and files.
  - Suspicious?
    - No
- Other libraries are added by Windows Visual C++, which can be likely ignored

<br/>

### 1-4 - Functions

Check the **imports** section to see the functions referenced by each library:

![picture 5](images/2202e6698041d6cc8e41ceee4ee64e87ee1048adcf2581bc8e7960c2659e9a6f.png)  

- **wininet.dll**
  - **Function:** DeleteUrlCacheEntry
    - Usage: Removes the file associated with the source name from the cache, if the file exists.
    - Suspicious?
      - Not obvious
    - Reference:
      - https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-deleteurlcacheentry
  - **Function:** InternetCheckConnectionA
    - Usage: Allows an application to check if a connection to the Internet can be established.
    - Suspicious?
      - Yes - Can be used by the malware to check internet connectivity
    - Reference:
      - https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetcheckconnectiona

<br/>

![picture 9](images/398ff4b695631641ea7a325cb712f13bfa96ab42a9b89b43d5146b52a8f94a92.png)  

- **crypt32.dll**
  - **Function:** CryptStringToBinaryA
    - Usage: The CryptStringToBinary function converts a formatted string into an array of bytes.
    - Suspicious?
      - Yes - Could be used to decrypt componenets in the suspicious executable and execute it somehow.
    - Reference:
      - https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptstringtobinarya

<br/>

![picture 7](images/4c283ed2a66e5ce48911b238335a8486150fd7c5ba7943ac0582be97eb69b735.png)  

- **urlmon.dll**
  - **Function:** URLDownloadToFileA
    - Usage: Downloads bits from the Internet and saves them to a file.
    - Suspicious?
      - Yes - Can be used by the malware to download additional files from the internet
    - Reference:
      - https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85)

<br/>


![picture 6](images/53d7c050715f5c3e01673896ff4d713e88a6777d1bee432a66c90b381aa22db8.png)  


- **user32.dll**
  - **Function:** MessageBoxW
    - Usage: Displays a modal dialog box that contains a system icon, a set of buttons, and a brief application-specific message, such as status or error information.
    - Suspicious: Yes - commonly used by malware to mislead the user
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messageboxw

<br/>

![picture 10](images/c9339c22490e41670455d4ce93c779a278c72542848f9c23e1660a454c0284c3.png)  

- **advapi32.dll**
  - **Function:** RegOpenKeyExA / RegOpenKeyExW
    - Usage: Opens the specified registry key.
    - Suspicious: Yes - Could be used for persistence
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa
  - **Function:** RegSetValueExA
    - Usage: Sets the data and type of a specified value under a registry key.
    - Suspicious: Yes - Could be used for persistence
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa
  - **Function:** RegCloseKey
    - Usage: Closes a handle to the specified registry key.
    - Suspicious: Yes - Could be used for persistence
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regclosekey

<br/>

![picture 49](images/ae21c5d0741dca0ef6743e243d50bf73e155156315c09551a1ebbe00c7438c60.png)  

- **shell32.dll**
  - **Function:** ShellExecuteA
    - Usage: Performs an operation on a specified file.
    - Suspicious: Yes - Can be used to execute malicious commands
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecutea

<br/>

### 1-5 - ATT&CK Analysis

![picture 11](images/18bc05820be8b909419f11e7e3ddd197d3ec7741ae69ce2a1e6470733ee432c4.png)  

- Also there are MITRE ATT&CK techniques with reference to the imports:
  - **Defense Evasion - T1497.003 - Virtulization/Sandbox Evasion: Time Based Evasion**
    - Library: kernel32.dll
    - Function: Sleep
    - Description:
      - Adversaries may employ various time-based evasions, such as delaying malware functionality upon initial execution using programmatic sleep commands or native system scheduling functionality (ex: Scheduled Task/Job). Delays may also be based on waiting for specific victim conditions to be met (ex: system time, events, etc.)
    - Reference:
      - https://attack.mitre.org/techniques/T1497/003/
  - **Discovery - T1124 - System Time Discovery**
    - Description:
      - Library: kernel32.dll
      - Function: GetSystemTimeAsFileTime
      - Description:
        - An adversary may gather the system time and/or time zone from a local or remote system. 
      - Reference:
        - https://attack.mitre.org/techniques/T1124/
  - **Defense Evasion - T1112 - Modify Registry**
    - Description:
      - Library: advapi32.dll
      - Function: RegSetValueExA
      - Description:
        - Adversaries may interact with the Windows Registry to hide configuration information within Registry keys, remove information as part of cleaning up, or as part of other techniques to aid in persistence and execution.
      - Reference:
        - https://attack.mitre.org/techniques/T1112/
  - **Execution - T1106 - Native API**
    - Description:
      - Library: kernel32.dll
      - Function: CreateProcessA
      - Description:
        - Functionality provided by native APIs are often also exposed to user-mode applications via interfaces and libraries. For example, functions such as the Windows API `CreateProcess()` or GNU `fork()` will allow programs and scripts to start other processes.
      - Reference:
        - https://attack.mitre.org/techniques/T1106/
  - **Execution - T1106 - Native API**
    - Description:
      - Library: shell32.dll
      - Function: ShellExecuteA
      - Description:
        - Functionality provided by native APIs are often also exposed to user-mode applications via interfaces and libraries. For example, functions such as the Windows API `CreateProcess()` or GNU `fork()` will allow programs and scripts to start other processes.
      - Reference:
        - https://attack.mitre.org/techniques/T1106/
  - **Discovery - T1082 - System Information Discovery**
    - Description:
      - Library: kernel32.dll
      - Function: IsDebuggerPresent
      - Description:
        - An adversary may attempt to get detailed information about the operating system and hardware, including version, patches, hotfixes, service packs, and architecture. IsDebuggerPresent is commonly seen in self-defense malware to detect if it is being debugged.
      - Reference:
        - https://attack.mitre.org/techniques/T1082/

<br/>

### 1-6 - Resources

Check the resources section:

![picture 12](images/19f859216e6becdb983d9144d6656105da875dd95824af137723cdc89612e38e.png)  

- Most of them are icons

<br/>

Check the manifest as well:

![picture 13](images/250cc19b3ad88b1faaa1a08a7be052d0b26f60fc3652b4b7408b2b6b2fb9ace4.png)  

- The sample requires running as administrator.

<br/>

### 1-7 - Strings analysis

Use **BinText** to look for interesting strings:

![picture 14](images/694eb36b5210cf48737f52bc3741b97f0f27d634b8dfcbfb41f318ab143ae74f.png)  


| Type | File position | Memory position | Text | Description |
| --- | --- | --- | --- | --- |
| ASCII | 2F50 | 2EDD | ph.exe | Unknown executable name |
| ASCII | 2F58 | 2EE5 | loader.exe | Unknown executable name |
| ASCII | 2F68 | 2EF5 | http://www.elsmap.com/banner.jpg | URL of a JPG file from an unknown site |
| ASCII | 2F90 | 2F1D | cmd.exe /C ping 1.1.1.1 -n 1 -w 3000 > Nul & Del /f /q "%s" | A cmd command for execute a one-time ping to 1.1.1.1 (possibly check internet connection) and delete a file quitely. |
| ASCII | 3320 | 32AD | http://update.microsoft.com | URL of Microsoft Update - possibly used for internet connectivity |
| ASCII | 3340 | 32CD | SOFTWARE\Microsoft\Windows\CurrentVersion\Run | A persistence run key by running a process automatically when a user login. |
| ASCII | 3370 | 32FD | SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor | A persistence run key by injecting a DLL into the spoolsv.exe process.<br/>Ref: https://pentestlab.blog/2019/10/28/persistence-port-monitors/ | 
| ASCII | 33B0 | 333D | Yzpcd2luZG93c1xzdmNob3N0LmV4ZQ== | Base64 encoded string. Decoded version is `c:\windows\svchost.exe` |
| ASCII | 33D8 | 3365 | WizLoader | Uncommon string |
| ASCII | 33E8 | 3375 | aHR0cDovL3d3dy5lbHNtYXAuY29tL2Jhbm5lci5qcGc= | Base64 encoded string. Decoded version is: `http://www.elsmap.com/banner.jpg` |
| ASCII | 3418 | 33A5 | aHR0cDovL3d3dy5lbHNtYXAuY29tL2V4YW0vcnVubWUuYmF0 | Base64 encoded string. Decoded version is: `http://www.elsmap.com/exam/runme.bat`, a potential suspicious script file. |
| ASCII | 3450 | 33DD | VGhlcmUgaXMgbm90aGluZyBoZXJlIExPTA0KR28gY2hlY2sgc29tZXRoaW5nIGVsc2UgOyk= | Base64 encoded string. Decoded version is: `There is nothing here LOL<br/>Go check something else ;)` - Thanks for this easter egg! |
| ASCII | 34A0 | 342D | aHR0cDovL3d3dy5lbHNtYXAuY29tL3N0YXJ0LmpwZw== | Base64 encoded string. The decoded version is: `http://www.elsmap.com/start.jpg` |
| ASCII | 34D0 | 345D | aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzEuanBn | Base64 encoded string. The decoded version is: `http://www.elsmap.com/pic1.jpg` |
| ASCII | 3500 | 348D | aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzIuanBn | Base64 encoded string. The decoded version is: `http://www.elsmap.com/pic2.jpg` |
| ASCII | 3530 | 34BD | aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzMuanBn | Base64 encoded string. The decoded version is: `http://www.elsmap.com/pic3.jpg` |
| ASCII | 3560 | 34ED | aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzQuanBn | Base64 encoded string. The decoded version is: `http://www.elsmap.com/pic4.jpg` |
| ASCII | 3590 | 351D | aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzUuanBn | Base64 encoded string. The decoded version is: `http://www.elsmap.com/pic5.jpg` |
| ASCII | 35C0 | 354D | aHR0cDovL3d3dy5lbHNtYXAuY29tL2Zvb3Rlci5qcGc= | Base64 encoded string. The decoded version is: `http://www.elsmap.com/footer.jpg` |
| ASCII | 35F0 | 357D | aHR0cDovL3d3dy5lbHNtYXAuY29tL2hlYWRlci5qcGc= | Base64 encoded string. The decoded version is: `http://www.elsmap.com/header.jpg` |
| ASCII | 3658 | 35E5 | aHR0cDovL3d3dy5lbHNtYXAuY29tL2Jhbm5lci5qcGc= | Base64 encoded string. The decoded version is: `http://www.elsmap.com/banner.jpg` |
| ASCII | 3688 | 3615 | QzpcV2luZG93c1xTeXN0ZW0zMlxjb25iYXNlLmRsbA== | Base64 encoded string. The decoded version is: `C:\Windows\System32\conbase.dll` - This is suspicious since it is similar to a legit Windows DLL called `combase.dll` in the same path. |
| ASCII | 36C0 | 364D | /C loader.exe && del /F loader.exe | A cmd command for running `loader.exe` and force delete it afterwards. |
| Unicode | 2FD0 | 2F5D | WINDBG.EXE | A debugger name - possibly used for debugger detection |
| Unicode | 2FE8 | 2F75 | VsDebugConsole.EXE | A debugger name - possibly used for debugger detection |
| Unicode | 3010 | 2F9D | devenv.exe | A debugger name - possibly used for debugger detection |
| Unicode | 3040 | 2FCD | x96dbg.exe | A debugger name - possibly used for debugger detection |
| Unicode | 3058 | 2FE5 | x64dbg.exe | A debugger name - possibly used for debugger detection |
| Unicode | 3070 | 2FFD | x32dbg.exe | A debugger name - possibly used for debugger detection |
| Unicode | 3098 | 3025 | Debugger Detected | Possible message when debugger detected |
| Unicode | 30C0 | 304D | WIRESHARK.EXE | Network sniffer commonly used for malware analysis - possible a self-defense for detecting the sample itself being analyzed. |
| Unicode | 30F8 | 3085 | Abort! | Possible message when Wireshark is detected. |
| Unicode | 3160 | 30ED | Good night! | Possible message when Wireshark / Debugger is detected. |
| Unicode | 3178 | 3105 | Sleep tight my sweety | Possible message when Wireshark / Debugger is detected. |
| Unicode | 31A8 | 3135 | \\.\PhysicalDrive0 | Possible sandbox detection by checking the drive size |
| Unicode | 31D0 | 315D | C:\Windows\System32\VBox*.dll | Possible sandbox detection by checking if libraries related to VirtualBox are used. |
| Unicode | 3210 | 319D | C:\Windows\System32\vm*.dll | Possible sandbox detection by checking if libraries related to VMWare are used. |
| Unicode | 3248 | 31D5 | Do it now? | Possible message when VM / Sandbox is detected. |
| Unicode | 3260 | 31ED | SYSTEM\ControlSet001\Services\VBoxSF | Possible sandbox detection by checking if registry used by VirtualBox exists. |
| Unicode | 32B0 | 323D | SYSTEM\ControlSet001\Services\VMTools | Possible sandbox detection by checking if registry used by VMWare exists. |
| Unicode | 3300 | 328D | Reboot required | Possible message when VM / Sandbox is detected. |
| Unicode | 3620 | 35AD | ABORT! | Possible message when VM / Sandbox is detected. |
| Unicode | 3630 | 35BD | Sandbox Detected! | Possible message when VM / Sandbox is detected. |

<br/>

---


## 2 - Reverse Engineering

**Question**

You are required to reverse engineer all the files that are related to the malware sample, whether they were given to you or downloaded by the malware. 

You need to identify them and reverse engineer them to understand what they do. You are not required to reverse every single part of them, but at least their main functionality. 

Explain all the APIs that are used, how they are used and make sure you reference them with their online documentation found at the MSDN.

<br/>

**Answer**

### FinalExam.exe

#### Preparation

First load the sample into **CFF Explorer** and navigate to **Optional Header**. Modify **DllCharacteristics** and disable the `DLL can move` flag:

![picture 15](images/51445448ea8fe0bd9181932ef1d408c703db0fb6b8885a00c6afeda202740044.png)  

<br/>

Then save as `FinalExam_ASLR_Disabled.exe`:

![picture 16](images/3dffa376b43d89568fee3317f219000afe79f85006aa490fb539bd5088f2dc8f.png)  

<br/>

Then load `FinalExam_ASLR_Disabled.exe` into **IDA Pro (64-bit)**.

![picture 17](images/19bcccee619398c92cfb72e0b7922b7a85cd24909d7a65cad98b18152132d0f7.png)  

<br/>

#### URLDownloadToFileA - 1400015C0

`URLDownloadToFileA` is used to download bits from the Internet and saves them to a file.
 
<br/>

Navigate to **Imports** and look for `URLDownloadToFileA`. Double click on it and check the xref of this function:

![picture 18](images/a2520f0dd90e2d4e70be2d53864dd6fcae0cbf66c2fb3dc03bcfb86c8eb43995.png)  

- It is referenced at `1400015C0` and `140002080`

<br/>

First check `1400015C0`:

![picture 19](images/79de1c98cb175aaf6aa2cbed97b0a11b878abf776c2ec2a67c9b7914f4cf1e5d.png)  

With reference to MSDN document (https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85) we may analyze the parameters:

- `pCaller`: A pointer to the controlling IUnknown interface of the calling ActiveX component, if the caller is an ActiveX component. If the calling application is not an ActiveX component, this value can be set to NULL.
  - This value is determined by `xor ecx,ecx` at `140001622`, resulting in `0`
  - This means there is not an ActiveX component
- `szURL`: A pointer to a string value that contains the URL to download.
  - This is determined by `[rsp+48h+lpszUrlName]` at `14000161D`
  - Note `[rsp+48h+lpszUrlName]` is set up from `1400015D6-1400015E2`, it should contain the pointer to `aHttpWwwElsmapC` (`http://www.elsmap.com/banner.jpg`)
- `szFileName`: A pointer to a string value containing the name or full path of the file to create for the download. If szFileName includes a path, the target directory must already exist.
  - This is determined by `r8, [rsp+48h+arg_8]` at `140001618`
  - Determined by `rdx` at `1400015C0`
- `dwReserved`: Must be 0 as determined at `140001615`
- `lpfnCB`: A pointer to the IBindStatusCallback interface of the caller. By using IBindStatusCallback::OnProgress, a caller can receive download status. This parameter can be set to NULL if status is not required.
  - Determined by the instruction `mov [rsp+48h+var_28],0` at `140001610C`
  - The parameter is set to `0`, meaning that status is not required

<br/>

Short conclusion for `sub_1400015C0`:

- This function call is to download the file `http://www.elsmap.com/banner.jpg`.

<br/>

#### URLDownloadToFileA - 140002080

Then check another subroutine at `140002080`:

![picture 20](images/ea9d5d29e1cdae02a0b643aa6dfbebe390bb2f1874e892091478d61c81a1d39f.png)  

- This is a loop which calls `DeleteUrlCacheEntry` and `URLDownloadToFileA` several times as shown on the screenshot

<br/>

At the beginning of the sub-routine, we can see the stack initialization with the base64-encoded URLs found in the static analysis:

![picture 21](images/c185ba37340c676ef6a0bbf667e9bced7f346ba214df0fea4b0daf79ac77a632.png)  

<br/>

Then we can see the number of Loops at `140002145`:

![picture 22](images/fda1c34b59bae7d4539661eebd2f0fbf30090301f7924d0555167379aea8db7f.png)  

- The loop counter `[rsp+11C8h+var_1198]` is compared with the static number `9`, which mean the loop has 9 iteration used with initial number 0 and `jge` (jump if greater than or equal) condition

<br/>

![picture 23](images/05adda2fe88e6978587b87af5ea9d0b8ba4f2f53ed4fe0c66b12812ed9353799.png)  

- Then in this section, it self-loop until `[rax+rcx]` equals 0

<br/>

![picture 24](images/51cc2cb99c36a2c793c536d6ff81608ce96afd65e43073c71c062c6e038567ce.png)  

![picture 25](images/b2a0951d71a1dbc4c8fef59ac135637cafaf3955acbceb59fa9a09ed548f05b1.png)  

Then we can see a function call related `GetTempPathA` (MSDN Doc: https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-gettemppatha).

- Purpose: Retrieves the path of the directory designated for temporary files.
- Return: If the function succeeds, the return value is the length, in TCHARs, of the string copied to lpBuffer, not including the terminating null character. If the function fails, the return value is zero.
- Parameters:
  - `nBufferLength`: The size of the string buffer identified by lpBuffer, in TCHARs.
    - Determined by `r8d` at `14000218B`, which is `0x100`
  - `lpBuffer`: A pointer to a string buffer that receives the null-terminated string specifying the temporary file path.
    - This is determined by `rdx`, which is assigned as `[rsp+11C8+FileName]`

<br/>

After calling the subroutine with `GetTempPathA`, we can see if calls the subroutine `140001320`, which contains `CryptStringToBinaryA`:

![picture 26](images/b0ebd8567ac8e5ba5934aa3677099a34b3e3995acd9f11ab9db397af493dc5c0.png)  

![picture 27](images/3a26f640fe1c009f7d82a7ce02b52fe5fc9199c88e029e7e6f8f472e833e66ee.png)  

- We will come back to this function call in `140001320` separate.

<br/>

After calling `140001320`, it calls `remove` and `DeleteUrlCacheEntry`:

![picture 28](images/9d5ce21ee058f6af3c0a004ac2f5bd34c18f3dead09758ac3b9425236bf94b3c.png)  

- Remove:
  - https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/remove-wremove?view=msvc-160
  - Purpose: Delete a file.
  - In this case, it removes `[rsp+11C8h+FileName]`
- DeleteUrlCacheEntry:
  - https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-deleteurlcacheentry
  - Purpose: Removes the file associated with the source name from the cache, if the file exists.
  - In this case, it removes the cache related to `[rsp+11C8h+szUrlName]`

- These function calls remove the files and caches downloaded on the disk, which evades detection

<br/>

![picture 29](images/c7bc928e97ba4034a0672fcab1f69356124d5db28a49fc985da151e60e07f751.png)  

- Then finally before the loop body ends, it calls `URLDownloadToFileA` to download another file from the C2 server. 
  - URL determined by `[rsp+11C8h+szUrlName]`
  - Filename determined by `[rsp+11C8h+FileName]`
- This loop will finally looping through all the base64-encoded URL on the stack.

<br/>

#### CryptStringToBinaryA - 140001320

![picture 30](images/04f8567f0947c64e79670da3ddea1472508685135cf6cb6472f3de0dd746a938.png)  

The comment for the initialization is with reference to the parameters passed by `140002145`:

![picture 31](images/9fa456eb541caf3564008f52591d60ea47c8bb8b180ff5f1a590a9616ed18c9d.png)  


- Usage: Converts a formatted string into an array of bytes.
- Return: 
  - If the function succeeds, the return value is nonzero (TRUE).
  - If the function fails, the return value is zero (FALSE).
- Parameters:
  - `pszString`: A pointer to a string that contains the formatted string to be converted.
    - Determined by `rcx` at `14000132E`, which is `[rsp+rax*8+11C8h+FileName]` passed by the previously analyzed subroutine `140002145`
    - This is the Base64-encoded string defined on the stack previously
  - `cchString`: The number of characters of the formatted string to be converted, not including the terminating NULL character. If this parameter is zero, `pszString` is considered to be a null-terminated string.
    - Determined by `edx` at `14000132A`, which is `[rsp+11C8h+var_1184]`, which is `0` as determined at `140002182`
    - `cchString = 0` means the formatted string is null-terminated
  - `dwFlags`: Indicates the format of the string to be converted.
    - Set to be `1` at `14000136F`
    - This indicates `CRYPT_STRING_BASE64` - base64 strings without header
  - `pbBinary`: A pointer to a buffer that receives the returned sequence of bytes.
    - Determined by `r8` at `140001325`
    - `[rsp+11C8h+szUrlName]` is passed to this. 
    - This is how `URLDownloadToFileA` in subroutine `140002080` requests different URL each time
  - `pcbBinary`: A pointer to a DWORD variable that, on entry, contains the size, in bytes, of the pbBinary buffer. 
    - This is eventually determined by `r9d` at `140001320`, which is passed by subroutine `140002080` as `0x1000`
    - The size of the buffer will be 4096 (0x1000) bytes
  - `pdwSkip`: A pointer to a DWORD value that receives the number of characters skipped to reach the beginning of the -----BEGIN ...----- header. If no header is present, then the DWORD is set to zero. This parameter is optional and can be NULL if it is not needed.
    - This is set to `0` at `140001357`
  - `pdwFlags`: A pointer to a DWORD value that receives the flags actually used in the conversion. This parameter is optional and can be NULL if it is not needed.
    - This is set to `0` at `14000134E`

In short, the subroutine `140001320` is responsible for converting the base64-encoded URL and return to the subroutine `140002080` for retrieving files from the supicious server.


<br/>

Next check another API call `RegSetValueExA`:

![picture 33](images/3ba98fea149d7867c90ffe42c399068af8431b96e11d12124b6b625124141f7f.png)  

![picture 34](images/215ad2698d13493f234e98e35dea017ed0367fa69c541eeba4d9aa2aeebbbfc7.png)  

- `RegSetValueExA` is referenced at `140001B80` and `140001C70`

#### RegOpenKeyExA, RegSetValueExA, RegCloseKey - 140001B80

![picture 36](images/608ec9017c20e38defb59358ec83fa06eba6777104d329d55087931eddc7c2f1.png)  

![picture 37](images/c6b16ed96c97075f071aa8128d2f0e9a5269dd5db3bf6cdd748860dccbd96de0.png)  


- MSDN Doc: https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa
- Usage: Opens the specified registry key. 
- Return Value: 
  - If the function succeeds, the return value is ERROR_SUCCESS.
  - If the function fails, the return value is a nonzero error code defined in Winerror.h.
- Parameters:
  - `hKey`: A handle to an open registry key, or it can be one of the following predefined keys: HKEY_CLASSES_ROOT HKEY_CURRENT_CONFIG HKEY_CURRENT_USER HKEY_LOCAL_MACHINE HKEY_USERS
    - In this case, by checking the symbolic constant of `0xFFFFFFFF80000002h`, it is `HKEY_LOCAL_MACHINE`, as shown in the above screenshot.
  - `lpSubKey`: The name of the registry subkey to be opened.
    - Determined at `140001BB0`, which is the constant string `SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
  - `ulOptions`: Specifies the option to apply when opening the key.
    - Determined at `140001BAD` - self XOR-ing resulting in `0`
    - No option set
  - `samDesired`: A mask that specifies the desired access rights to the key to be opened.
    - It is set to be `2` at `140001BA7`
      - With reference to https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-key-security-and-access-rights, `2` means `KEY_SET_VALUE`  - Required to create, delete, or set a registry value.
  - `phkResult`: A pointer to a variable that receives a handle to the opened key. 
    - This is set to be `rax` at `140001BA2`

In short, this function call opens the Registry Key `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`, which is a key that can be used for persistence.

<br/>

![picture 35](images/436cda2540077eb071bfdc64b0127a143997b5ca901621c34c61345d719f482d.png)  

![picture 38](images/af8e9c27f01039485ee9d9d64f5780c2a92b50f94e8a68ba2614faa8f1e2635f.png)  


`RegSetValueExA`:

- MSDN doc: https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa
- Purpose:
  - Sets the data and type of a specified value under a registry key.
- Return Value:
  - If the function succeeds, the return value is ERROR_SUCCESS.
  - If the function fails, the return value is a nonzero error code defined in Winerror.h.
- Parameters:
  - `hKey`:  A handle to an open registry key.
    - This is set as `[rsp+68h+hKey]` at `140001C1F`. This is determined when calling `RegOpenKeyExA`, which should be `HKEY_LOCAL_MACHINE`
  
![picture 39](images/a00808aa4bd97953dccd47e120f343896b1657e788a19ad3093d243ad396e974.png)  

  - `lpValueName`: The name of the value to be set.
    - This is determined by `[rsp+68h+lpValueName]`, which is referenced at `140001B85`. This has to be determined by the parameter value in `rcx` of the callee
      - To determine, click on the current subroutine name `sub_140001B80` and check the reference, as shown in the above screenshot - It is called by `140001D60`
      - `rcx` is set to be `WizLoader` at `14001DC8`
    - Therefore, this is set to be `WizLoader`
  - `Reserved`: No meaning in context
  - `dwType`: The type of data pointed to by the lpData parameter.
    - Set to be `1` at `140001C11`
    - According to https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wprn/742b6e1e-0323-42b1-b94c-65b3e21b086d, it is of type `REG_SZ` - a string.

![picture 40](images/19b4f37bbbc16a199876843490c637761dac5821553f3bd81a61360a2b722c81.png)  

  - `lpData`: The data to be stored.
    - This is determined by `[rsp+68h+lpData]` at `140001C07`, which has a reference at the beginning of the current subroutine at `140001B80` - which need to determine the parameter passed in `rdx` of the callee
      - Similar to `lpValueName`, check the value set in `rdx` at the moment the current subroutine is called.
      - On the screenshot, `rdx` is determined by the return value of the function call `140001320`, which is used to decode base64 string as analyzed previously
      - At `140001D87`, we can find the base64-encoded string `Yzpcd2luZG93c1xzdmNob3N0LmV4ZQ==`, which is passed to `140001320` at `140001DB9`. Decoding this string, it should be `c:\windows\svchost.exe`
    - Therefore, the data to be stored is `c:\windows\svchost.exe`
  - `cbData`: The size of the information pointed to by the lpData parameter, in bytes.
    - It is determined by `[rsp+68h+var_30]`

![picture 44](images/777da8d825a7fc27f4ea1ea96f82655069aab9b71136e41fd2a908b84393ab35.png)  

- Then the opened reg key is closed by calling `RegCloseKey`.

<br/>

In short, the `RegSetValueExA` call adds a value for the key `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\WizLoader` of the value `c:\windows\svchost.exe`, meaning that when any user logins the system, `c:\windows\svchost.exe` will be run.

<br/>

#### RegOpenKeyExA, RegSetValueExA, RegCloseKey - 140001C70

The API usage is basically the same excepted for the following:

![picture 41](images/c11b4e044178a9148c8f4d0c2e516a2f0619ef7c5e66ecb25999737950993f55.png)  

- `RegOpenKeyExA`
  - The key to be opened is `SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor`

<br/>

![picture 43](images/4bec13fb2130efee584b76897bfc5e1c9ea350970d4af60d6b291ff6f97ae194.png)  


- `RegSetValueExA`
  - The value name is `Driver`
  - The data set is `C:\Windows\System32\conbase.dll`

<br/>

In short, this functions calls in the subroutine `140001C70` set the registry key `HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor\Driver` with value `C:\Windows\System32\conbase.dll` for persistence, by injecting the DLL `C:\Windows\System32\conbase.dll` in the spooler.exe process.

<br/>

#### InternetCheckConnectionA in sub_140001AE0

In the subroutine `sub_140001AE0`, the API `InternetCheckConnectionA` is used:

![picture 45](images/3f42fed2795e756f140245b35c751be26faa0293f13de624bef4b945341870a0.png)  

- MSDN doc: https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetcheckconnectiona
- Usage: Allows an application to check if a connection to the Internet can be established.
- Return: Returns `TRUE` if a connection is made successfully, or `FALSE` otherwise. 
- Parameters:
  - `lpszUrl`: Pointer to a null-terminated string that specifies the URL to use to check the connection.
    - Determined by `lea rcx, [rsp+0D8h+szUrl]` at `140001B3B`. `[rsp+0D8h+szUrl]` is defined by the callee on the stack but in this case it looks to be NULL
    - Then according to the MSDN, If lpszUrl is NULL and there is an entry in the internal server database for the nearest server, the host value is extracted from the entry and used to ping that server.
    - This will be `http://update.microsoft.com` as defined at `140001B1F`
  - `dwFlags`: Options.
    - This is set to be `1` at `140001B36` -  the host value is extracted from it and used to ping that specific host.
  - `dwReserved`: Reserved and should be 0.

In short, this function call is used to check the internet connectivity. If unsuccessful, it jumps to `140001B51` (which sets `[rsp+0D8h+var_B8]` to be `0` and `140001B56` otherwise. `eax` will be returned as `0` for this subroutine call if internet conenction is unsuccessful.

<br/>


#### MessageBoxW in main function

`MessageBoxW` is used in multiple locations:

![picture 46](images/65f42c080c23311a3b7fe87d434ef0d25b01f6537ec233407081c314a1e56d60.png)  

- main
- 140001AA0
- 140001740

<br/>

Since the usage of this API is quite simple, take one example at the location `main+6C`:

![picture 47](images/301e273c7a26f342ae3898f027b98122ef09cf9f477697bb253f476e988999b2.png)  

- MSDN: https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messageboxw
- Usage: Displays a modal dialog box that contains a system icon, a set of buttons, and a brief application-specific message, such as status or error information.
- Return: 
  - If a message box has a Cancel button, the function returns the IDCANCEL value if either the ESC key is pressed or the Cancel button is selected. If the message box has no Cancel button, pressing ESC will no effect - unless an MB_OK button is present. If an MB_OK button is displayed and the user presses ESC, the return value will be IDOK.
  - If the function fails, the return value is zero. 
- Parameters:
  - `hWnd`: A handle to the owner window of the message box to be created. If this parameter is NULL, the message box has no owner window.
    - Determined by `xor ecx,ecx` at `14000229A`, which is zero 
    - No owner window
  - `lpText`: The message to be displayed.
    - Determined by `aSandboxDetecte`, a constant with the value `Sandbox Detected!`
  - `lpCaption`: The dialog box title. 
    - Determined by `aAbort_0` at `14000228C`, which is a constant value `ABORT!`
  - `uType`: The contents and behavior of the dialog box.
    - Set to be `0x10` at `140002286`. This means `MB_ICONSTOP` - A stop-sign icon appears in the message box.

<br/>

![picture 48](images/6edb00838ec4c49ab8ca26796340aec82bf5403e672625559cfc6c3c6df9abb2.png)  


In short, this function call is used to display the warning message `Sandbox Detected!` upon detecting being in sandbox environment.

After displaying the warning message, the process will terminate.

<br/>

#### MessageBoxW in 140001AA0

![picture 53](images/12101253e7a0a3558853a411146f12639450bf45b31aa9b992c3132b2c6730f8.png)  

- `hWnd` is set to `0` at `140001AB8`
- `lpText` is set to the string `Do it now?`
- `lpCaption` is set to the string `Reboot required`
- `uType` is set to `3`, which means `MB_YESNOCANCEL` - The message box contains three push buttons: Yes, No, and Cancel.
- After the function call, it compare the return value with `6` at `140001AC4`
  - `6` = `IDYES` = The Yes button was selected.
  - If so, `eax` will be set to `0` at `140001ACB`

<br/>

#### MessageBoxW in 140001740

![picture 54](images/d58e4dc68e9350853d14ddc78c1fb2b33eec2224e94d9ecd38301250b68cebac.png)  

- `hWnd` is set to `0` at `140001773`
- `lpText` is set to the string `Debugger Detected`
- `lpCaption` is set to `Abort!`
- `uType` is set to `0x10`. This means `MB_ICONSTOP` - A stop-sign icon appears in the message box.

After the call the program exit with code 9.

<br/>

#### ShellExecuteA in main function

`ShellExecuteA` is used in the main function:

![picture 50](images/ef8b1ae95b8d16395fe0412f154812be9d803919fc17602c82b299a0f400fcd1.png)  

Inspect the usage:

![picture 51](images/4f96cc88351454f4ee4963d4ea5d53a1646421baf6b66fbcd427bf663ee0264b.png)  

- MSDN: https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecutea
- Usage: Performs an operation on a specified file.
- Return:
  - If the function succeeds, it returns a value greater than 32. 
  - If the function fails, it returns an error value that indicates the cause of the failure. 
- Parameters:
  - `hwnd`: A handle to the parent window used for displaying a UI or error messages. This value can be NULL if the operation is not associated with a window.
    - Set as `0` at `1400023E4` by self XORing
  - `lpOperation`: A pointer to a null-terminated string, referred to in this case as a verb, that specifies the action to be performed.
    - Set as `open` at `1400023DD`
    - Opens the item specified by the lpFile parameter. The item can be a file or folder.
  - `lpFile`: A pointer to a null-terminated string that specifies the file or object on which to execute the specified verb. To specify a Shell namespace object, pass the fully qualified parse name. Note that not all verbs are supported on all objects. 
    - Set as `cmd.exe` at `1400023D6`
    - Execute `cmd.exe`
  - `lpParameters`: If lpFile specifies an executable file, this parameter is a pointer to a null-terminated string that specifies the parameters to be passed to the application. 
    - Set as `/C loader.exe && del /F loader.exe`
  - `lpDirectory`: A pointer to a null-terminated string that specifies the default (working) directory for the action. If this value is NULL, the current working directory is used.
    - Set as `0` - Current directory will be used
  - `nShowCmd`: The flags that specify how an application is to be displayed when it is opened.
    - Set as `0` at `1400023BE`.
    - According to https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-showwindow, this value means "Hides the window and activates another window."

<br/>

In short, `ShellExecuteA` executes `cmd.exe /C loader.exe && del /F loader.exe` and hide the running window. This execute the file `loader.exe` and then delete it afterwards.

<br/>

#### Anti-X functions

Analyzing the subroutines involved in the main function, several Anti-X functions are found. The sub-routines are renamed so as to visualize the intentions of them.

![picture 55](images/fe6b649c48a3cfad989b6258cf522dc6572177c941686b404b8aa84ab27c82f1.png)  

- `14000225D`: Calling anti-debugger subroutine 140001740
- `140002262`: Calling sandbox detection subroutine 1400017D0

<br/>

#### Debugger Detection at subroutine 140001740

![picture 56](images/12d067cd841ebb49059bfb6a6051b8d6f373bb05368cd36c46c837b7e59fd937.png)  

The logic of detecting debugger is to check the flag `BeingDebugged` (`gs:60h`). 

If the flag is active, the result at `14000175B` will be non-zero, which means debugger presents, and it will pop up the alert box and exit process.

<br/>

#### Sandbox detection at subroutine 1400017D0

First it starts by using `GetSystemInfo` to get an object of system information:

![picture 57](images/c14dc194e24407870f3e2df819e6765f1060f6f95be042a90f94fafd4b140622.png)  

- https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsysteminfo
- Usage: Retrieves information about the current system.
- It compares the number of processors with a hardcoded number `4`
  - If the number of processor is less than 4, it regards the environment as sandbox, which essentially set `eax` to `1` and return
  - Otherwise, it continues to other checkings

<br/>

Then it uses `GlobalMemoryStatusEx` to get the memory information.

![picture 58](images/71c534a563df57a755f45130f5e0b121e206300cca2da040f320b6e4f5f80739.png)  


- https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-globalmemorystatusex
- Usage Retrieves information about the system's current usage of both physical and virtual memory.
- It compares the total physical memory with the hardcoded number `8192`
  - If the system has less than `8192` memory, it regards the environment as sandbox, which set `eax` to `1` and return
  - Otherwise, it continues to other checkings

<br/>

Then it utilizes `CreateFileW` and `DeviceIoControl` to check the storage information.

![picture 59](images/408f05639bceca131903de9d58d98f41a8439e342c2cbd21f67995b9f8ba112f.png)  

- https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilew
  - `CreateFileW` is used to read the main disk drive and get the device handle
- https://docs.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol
  - `DeviceIoControl` is used to seend a control code directly to a specified device driver
    - The control code `0x70000` at `1400018C1` retrieves information about the physical disk's geometry
    - The codes follow will convert the result to number of GB
- It then compares `100` with the disk size
  - If the system has less than `100` GB, it regards the environment as sandbox, which set `eax` to `1` and return
  - Otherwise, it sets `eax` to `0` at `140001933` and return

<br/>

In the main function, we can see after the sandbox detection subroutine, if `eax` is `1`, it jumps to `140002286`, which pops up an alert box and exits process.

![picture 60](images/484d8c091b3a54aea92dad250aafc66897d4421b8201d1044f15ca3959cd33d6.png)  

If not detected, it proceeds another checking.

<br/>

#### VM Detection at subroutine 140001950

It uses `FindFirstFileW` to look for the patterns:

- `C:\\Windows\\System32\\VBox*.dll`
  - DLL files related to VirtualBox
- `C:\\Windows\\System32\\vm*.dll`
  - DLL files related to VMWare

![picture 61](images/372c885da8427a19cb15f186ef40fb60c51725296022c8814fd078619d4f480a.png)  

- https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-findfirstfilew
- Return value:
  - If the function succeeds, the return value is a search handle used in a subsequent call to FindNextFile or FindClose
  - If the function fails or fails to locate files from the search string in the lpFileName parameter, the return value is INVALID_HANDLE_VALUE (0FFFFFFFFFFFFFFFFh)
- At `14000197B`, we can see it compares the return value of `FindFirstFileW` with `0FFFFFFFFFFFFFFFFh`
  - If not found, it jumps to `14000198B` to look for VMWare related libraries
  - Otherwise it sets `eax` to `1` and return
- Similarlarly at `1400019A1`, if no DLL file related to VMWare is found, it jumps to `1400019AA` to do another check
  - Otherwise it sets `eax` to `1` and return

<br/>

Then it proceeds to use `RegOpenKeyExW`:

![picture 62](images/3edb48a65056450f8031159fb95f923b785ca214110be5abddf75e291fc6c2db.png)  

- https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexw
- Return value:
  - If the function succeeds, the return value is ERROR_SUCCESS.
  - If the function fails, the return value is a nonzero error code

<br/>

![picture 63](images/f315c4490b6d0cc51068631f6a8f4ff7ecf2af1d6ebb00ba1cc70368531c8a23.png)  

In the `RegOpenKeyExW` call at `1400019CB`, it tries to open `HKLM\\SYSTEM\\ControlSet001\\Services\\VBoxSF` and test the return value at `1400019D1`
- If `eax` is non-zero, the registry key related to VirtualBox is not found and it jumps to `1400019DC` to proceed to check the VMWare registry key
  - Otherwise it sets `eax` to `1` and return

Similarly it checks the registry key `HKLM\\SYSTEM\\ControlSet001\\Services\\VMTools` at `1400019FD` by trying to open it.
- If `eax` is non-zero, which means it fails to open the RegKey, it jumps to `140001A0E`, the `xor eax,eax` instruction, and finally return `eax=0`
  - Otherwise, the `eax` is set to `1` and return.

<br/>

![picture 64](images/d49c69ddf4d71ed76c11131e651684f7d1ecc2c25c4ef47d94984e7f05357545.png)  

- If returned `eax=1`, which means VM detected, it jumps to the location of exiting the process.
- Otherwise, it proceed to another checking in the subroutine `140002274`

<br/>

#### Sandbox detection by Number of Processes

At `140002274` it calls a subroutine at `140001A30`, which contains a function call `K32EnumProcesses`.

![picture 65](images/75ea7049e8935ea686f59e9c197e09a32d1b54253921cc6881cb92fb9d7fc7c8.png)  

- MSDN: https://docs.microsoft.com/en-us/windows/win32/api/psapi/nf-psapi-enumprocesses
- Usage: Retrieves the process identifier for each process object in the system.
- Parameters:
  - `lpidProcess`: A pointer to an array that receives the list of process identifiers.
    - Set as `[rsp+1048h+idProcess]`
  - `cb`: The size of the `pProcessIds` array, in bytes.
    - Set as `1000h`
  - `lpcbNeeded`: The number of bytes returned in the `pProcessIds` array.
    - Set as `[rsp+1048h+cbNeeded]`
- Return value:
  - If the function succeeds, the return value is non-zero
  - If the function fails; the return value is `0`
- At `140001A87`, it compares the return value with `100`
  - If the return value is below `100`, it regards the environment as sandbox, which set `eax` to 1 and return
  - Otherwise it return `eax=0`

<br/>

![picture 67](images/e66a835559aac45968b24313c0130c7c64b3801e63f346c8b498ce766f65f608.png)  

- If `eax` returned is not zero, it jumps to `140002286` and exits the process.
- Otherwise it proceeds to another check.

<br/>

#### Debugger detection by using TickCount

At `14000227D`, the main function calls the sub-routine `140001790`, which contains a API call to `GetTickCount64`:

![picture 68](images/2a52ebcd3f89a8bdbebfeda166a3e1ba7898472af78136e31a87c4086b169758.png)  

- MSDN: https://docs.microsoft.com/zh-tw/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount64
- Usage: Retrieves the number of milliseconds that have elapsed since the system was started.
- Return: The number of milliseconds.
- At `1400017A9`, it compares the return value with `86400` (ms)
  - If the system uptime is lower than 86400 ms, it regards the current environment as Sandbox and will set `eax=1` and return
  - Otherwise `eax` will be set to `0` at `1400017BB` and return

<br/>

![picture 69](images/a9f1610a4b5077157d713723afe650ab627383d3769fef12640b7c6da8a04379.png)  

- If `eax` is `0`, it means sandbox is not detected and it jumps to `1400022AD`
  - Otherwise, it proceeds to `140002286` and will exit the process.

<br/>

### banner.jpg

Checking the URLs found, it is identified that `banner.jpg` is actually a Windows PE file (DLL):

![picture 70](images/42e437cb644e9413307ead33bf2c40ebe5ff25e70a339451ebad30da2599e351.png)  

<br/>

### loader.exe

In the string analysis, we identify `loader.exe` in the sample. On IDA Pro, navigate to `View > Open subviews > Strings` and then find `loader.exe`:

![picture 100](images/c760405a8813ac0312aef55079ed86c4c30c72c5ff60b988bc5d862a84c3cb7d.png)  

- Double click it and check its cross reference:

![picture 143](images/91b1b7be6dd50c8f4a7e545723f805667517c9ec49e1a6c442e02c203aa5109c.png)  

- The subroutine `1400014C0` has a reference

<br/>

![picture 144](images/8a7676837b8c80cb17d9d7a1ed6a26f28df0666782852f8c43616d9a326073df.png)  

- MSDN: https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea
- Usage: Creates or opens a file or I/O device. 
- Return:
  - If the function succeeds, the return value is an open handle to the specified file, device, named pipe, or mail slot.
  - If the function fails, the return value is INVALID_HANDLE_VALUE. 
- Parameters:
  - `lpFileName`: The name of the file or device to be created or opened.
    - Set to be `loader.exe` at `140001506`
  - `dwDesiredAccess`: The requested access to the file or device, which can be summarized as read, write, both or neither zero).
    - Set to be `0xc0000000` at `140001501`, which represents `GENERIC_READ | GENERIC_WRITE`
  - `dwShareMode`: The requested sharing mode of the file or device, which can be read, write, both, delete, all of these, or none.
    - Set to be `3` at `1400014FB`, which should be the combination of `FILE_SHARE_READ` and `FILE_SHARE_WRITE`
  - `lpSecurityAttributes`: A pointer to a SECURITY_ATTRIBUTES structure that contains two separate but related data members: an optional security descriptor, and a Boolean value that determines whether the returned handle can be inherited by child processes.
    - Set to be `0` at `1400014F8`
    - The handle returned by CreateFile cannot be inherited by any child processes the application may create and the file or device associated with the returned handle gets a default security descriptor.
  - `dwCreationDisposition`: An action to take on a file or device that exists or does not exist.
    - Set to be `2` at `1400014F0` - this means "Creates a new file, always."
  - `dwFlagsAndAttributes`: The file or device attributes and flags, FILE_ATTRIBUTE_NORMAL being the most common default value for files.
    - Set to be `0x80` at `1400014E8` - FILE_ATTRIBUTE_NORMAL, The file does not have other attributes set. 
  - `hTemplateFile`: A valid handle to a template file with the GENERIC_READ access right. The template file supplies file attributes and extended attributes for the file that is being created.
    - Set to `0` at `1400014DF`

<br/>

In short this create a file named `loader.exe`.

<br/>

Then this subroutine uses `WriteFile`:

![picture 145](images/bf599af62f51bba14d39b95b5f38cd53d2b3be1d8d3e6f6c572c03976356ce83.png)  

- MSDN: https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile
- Usage: Writes data to the specified file or input/output (I/O) device.
- Parameters:
  - `hFile`: A handle to the file or I/O device (for example, a file, file stream, physical disk, volume, console buffer, tape drive, socket, communications resource, mailslot, or pipe).
    - Set to `[rsp+4078h+hFile]`, which is the handle returned by the `CreateFileA` call. Should be pointing to `loader.exe`
  - `lpBuffer`: A pointer to the buffer containing the data to be written to the file or device.
    - Set to `[rsp+4078h+Buffer]`
  - `nNumberOfBytesToWrite`: The number of bytes to be written to the file or device.
  - `lpNumberOfBytesWritten`: A pointer to the variable that receives the number of bytes written when using a synchronous hFile parameter.
  - `lpOverlapped`: A pointer to an OVERLAPPED structure is required if the hFile parameter was opened with FILE_FLAG_OVERLAPPED, otherwise this parameter can be NULL.

At `14000154A - 140001551`, it uses the base64-encoded string as a parameter to call the base64-decoding subroutine. Then at `140001556`, the return value is moved to `[rsp+4078h+nNumberOfBytesToWrite]`.

<br/>

In short, the base64-encoded content at `14000BB00` is decoded and used to write to `loader.exe`. This is the subroutine for unpacking the encoded executable stored in the string.

<br/>

### ph.exe

Similar to `loader.exe`, `ph.exe` is created in the subroutine `0x1400013C0`:

![picture 146](images/c137284d90b64a6f3c80988b12eb19f979c595feb2dde8e4f360f9ce9abfc449.png)  

Again, this subroutine decode the strings at `140007050` and write to the file `ph.exe`.

<br/>

---

## 1a - Static analysis of banner.jpg

### Summary

| Question | Answer | Reference section |
| --- | --- | --- |
| 1. What are the hashes of the malware sample? | MD5: 989D3C5FA70A8466C6D4A5953C704B00<br/>SHA1: A75FC173781A4A9BE3B8FF79EBCDED543AD98BF4<br/>SHA256: FF1FE3B4D5D374BF69A2ACE60F21BA80440B8E23902FAB8D994D1F4E34A042C3 | 1a-1 |
| 2. What is the file type? | Windows PE (DLL) | 1a-1 |
| 3. What is the compilation time stamp? | Fri Jun 19 06:55:54 2020 | 1a-1 |
| 4. What are the file characteristics (e.g. EXE, DLL, 32-bit, 64-bit, etc.)? | DLL, 64-bit | 1a-1 |
| 5. What is the Image Base and the Entry Point address? | EntryPoint: 0x1534<br/>ImageBase: 0x180000000 | 1a-2 |
| 6. Provide details about each section found in terms of their names, sizes, permissions, entropy, and what each is used for. | See details in the reference 1a-3 | 1a-3 |
| 7. What are the libraries (DLLs) referenced by this sample and which functions do you think are suspicious? | See details in the reference 1a-4 | 1a-4 |
| 8. What are the MITRE techniques being used? | T1124, T1106, T1082 | 1a-5 |
| 9. Is this sample packed or not and what proof do you have? | Not packed based on the section names and entropy | 1a-3 |
| 10.  What interesting findings can you extract from the resources section? | N/A | N/A |
| 11. What interesting strings (ASCII and Unicode) did you find and could they be used later as an IOC? Provide a brief explanation for each string found.| See the details in 1a-7 | 1a-7 |
| 12. Are there any crypto functions being used by the sample and what are they? | N/A | N/A |

<br/>

### 1a-1 - Basic Information

![picture 71](images/4ed435b9630fcb3038f39b129044f03299f6c5c96a64ed42ea781b9cd3992a1f.png)  


1. The hashes of banner.jpg:

- md5,989D3C5FA70A8466C6D4A5953C704B00
- sha1,A75FC173781A4A9BE3B8FF79EBCDED543AD98BF4
- sha256,FF1FE3B4D5D374BF69A2ACE60F21BA80440B8E23902FAB8D994D1F4E34A042C3

<br/>

2. File type:

- Windows PE (DLL) - Based on the first bytes `MZ`

<br/>

3. Compilation timestamp

- Fri Jun 19 06:55:54 2020

<br/>

4. File characteristics:
   
- Type: DLL (based on the file-type field)
- Architect: 64-bit (AMD64)
- Subsystem: Console

<br/>

### 1a-2 - Optional Header

![picture 72](images/e75c277c659217900d77fe6be6a5e4c91824b3319c0e65aba04bb0758bc2679d.png)  

5. Image Base & Entrypoint

- EntryPoint: `0x1534`
- Image Base: `0x180000000`
- Note `ASLR` is enabled and have better disable it before doing further analysis.

<br/>

### 1a-3 - Sections

![picture 73](images/c4f159c1dc7f964c3f66215c452c4ab96283978d982e0e17e0135601ed10dd2f.png)  

- 6. Section information
  - **Section Name:** .text
    - Usage: Executable code
    - Raw Size: 4608 bytes
    - Virtual Size: 4116 bytes
    - Permission: Executable
    - Entropy: 5.687
  - **Section Name:** .rdata
    - Usage: Read-only initialized data
    - Raw Size: 3072 bytes
    - Virtual Size: 2966 bytes
    - Permission: N/A
    - Entropy: 4.06
  - **Section name:** .data
    - Usage: Initialized data
    - Raw Size: 512 bytes
    - Virtual Size: 2160 bytes
    - Permission: Writable
    - Entropy: 0.45
  - **Section Name:** .pdata
    - Usage: Exception information
    - Raw Size: 512 bytes
    - Virtual Size: 456 bytes
    - Permission: N/A
    - Entropy: 3.418
  - **Section Name:** .rsrc
    - Usage: Resource directory
    - Raw Size: 512 bytes
    - Virtual Size: 480 bytes
    - Permission: N/A
    - Entropy: 4.705
  - **Section Name:** .reloc
    - Usage: Image relocations
    - Raw Size: 512 bytes
    - Virtual Size: 24 bytes
    - Permission: N/A
    - Entropy: 0.293

<br/>

Check the **libraries** section:

![picture 74](images/1381941393e2775265d7dbc03a19973f2a4b9b11cb4d2645b19d26155b620be9.png)  

- **Library:** ws2_32.dll
  - Usage: Handle windows sockets communication
  - Suspicious?
    - Yes - This can be used as shell

- **Library:** kernel32.dll
  - Usage: Contain core functionlity, like access and manipulation of memory, files, and hardware
  - Suspicious?
    - No - This is a very common DLL for any Windows executable

<br/>

### 1a-4 - Functions

![picture 75](images/16cc15b84840a2e74c41f1411ab7c46d0f8be604eb9278bdf0821dfa7c244668.png)  

The functions imported from `ws2_32.dll` are all relatd to command and control:

- **ws2_32.dll**
  - Function: WSAConnect
    - Usage:  The WSAConnect function establishes a connection to another socket application, exchanges connect data, and specifies required quality of service based on the specified FLOWSPEC structure.
    - Suspicious: Yes - can be used in C&C
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsaconnect
  - Function: WSASocketA
    - Usage: The WSASocket function creates a socket that is bound to a specific transport-service provider.
    - Suspicious: Yes - can be used in C&C
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsasocketa
  - Function: CreateProcessA
    - Usage: Creates a new process and its primary thread. 
    - Suspicious: Yes - can be used to spawn new processes
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa

<br/>

### 1a-5 - ATT&CK Analysis

![picture 76](images/1e1edae3aa89cbcbe8765675e6af685cd21f36b655cf44c5044945565159fa0f.png)  

- **Discovery - T1124 - System Time Discovery**
  - Library: kernel32.dll
  - Function: GetSystemTimeAsFileTime
  - Description:
    - An adversary may gather the system time and/or time zone from a local or remote system. 
  - Reference:
    - https://attack.mitre.org/techniques/T1124/

<br/>

- **Execution - T1106 - Native API**
  - Library: kernel32.dll
  - Function: CreateProcessA
  - Description:
    - Adversaries may directly interact with the native OS application programming interface (API) to execute behaviors. Native APIs provide a controlled means of calling low-level OS services within the kernel, such as those involving hardware/devices, memory, and processes.
  - Reference:
    - https://attack.mitre.org/techniques/T1106/

<br/>

- **Discovery - T1082 - System Information Discovery**
  - Library: kernel32.dll
  - Function: IsDebuggerPresent
  - Description:
    - An adversary may attempt to get detailed information about the operating system and hardware, including version, patches, hotfixes, service packs, and architecture.
  - Reference:
    - https://attack.mitre.org/techniques/T1082/

<br/>

### 1a-6 - Resources

![picture 77](images/de29a0543b6a3cbf1dfbed81099defe66047784b098fcf3ca728f7af2ea795fd.png)  

![picture 78](images/2cbf123b549c6f4726495ee069eb2c955faa062c5c0ad35123c1af33f2c74d6d.png)  

- The manifest shows the execution level is `As invoker`

<br/>

### 1a-7 - Strings analysis

![picture 79](images/2cd190c28a64875193a87460f043702b9f41d1907fc6a459112a4634e44d08d2.png)  

| Type | File position | Memory | Text | Description | 
| --- | --- | --- | --- | --- |
| ASCII | 17A0 | 172D | 192.168.210.132 | An unknown IP |
| ASCII | 17B0 | 173D | cmd.exe | Potentially used as reverse shell |
| ASCII | 1D4C | 1CD9 | MaliciousDLL.dll | Unknown DLL |


<br/>

---

## 2a - Reverse Engineering - banner.jpg / conbase.dll


Load `banner.jpg` into IDA Pro and check the cross-reference of the API `WSAConnect`:

![picture 80](images/1139a063aede120339decb055d0f6bfc272d07d3fcfa72db9623f9247289e08b.png)  

The subroutine called `bokbok` has reference to `WSAConnect`.

<br/>

![picture 81](images/f94410dc701b273996c7dbe02cea3c691e1e70882cb5c05c85748241ac918357.png)  

### WSAStartup, WSASocketA, htons, inet_addr, WSAConnect and CreateProcessA in routine 180001000

![picture 82](images/702ee1a38cda177b516f2d12bc633d690f9542351463e512c817dc3e6244be23.png)  

- MSDN: https://docs.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-wsastartup
- Usage: The WSAStartup function initiates use of the Winsock DLL by a process.
- Return:
  - If successful, the WSAStartup function returns zero. 
  - Otherwise, it returns one of the error codes.
- Parameters:
  - `wVersionRequested`: TBD
    - Set to be `0x202h` (514) - Version 2.2
  - `lpWSAData`: A pointer to the WSADATA data structure that is to receive details of the Windows Sockets implementation.
    - Set to be `stru_180004650`

<br/>

Then inspect the function call `WSASocketA`:

![picture 83](images/e5802b4986258fdeb3f549cbd7385c53308511b8e0e0ae430bc9f8a3142d0f6b.png)  

- https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsasocketa
- Usage: The WSASocket function creates a socket that is bound to a specific transport-service provider.
- Return:
  - If no error occurs, WSASocket returns a descriptor referencing the new socket. 
  - Otherwise, a value of INVALID_SOCKET is returned, and a specific error code 
- Parameters
  - `af`: The address family specification. Possible values for the address family are defined in the Winsock2.h header file.
    - Set to `2` at `18000104A`, which means IPv4
  - `type`: The type specification for the new socket.
    - Set to `1` at `180001045`, which means `SOCK_STREAM` (TCP)
  - `protocol`: The protocol to be used.
    - Set to `6` at `18000103F`, which is `IPPROTO_TCP` - TCP
  - `lpProtocolInfo`: A pointer to a WSAPROTOCOL_INFO structure that defines the characteristics of the socket to be created. 
    - Set to `0` by `xor r9d,r9d` at `18000103C`
  - `g`: An existing socket group ID or an appropriate action to take when creating a new socket and a new socket group.
    - Set to `0` at `180001034` - No group operation is performed.

<br/>

Then inspect the function call `htons`:

![picture 84](images/301645f779923e01be225ae6548be94dfe73e37d267d6e7ed7560fff49dac760.png)  

- https://docs.microsoft.com/zh-hk/windows/win32/api/winsock/nf-winsock-htons
- Usage: The htons function converts a u_short from host to TCP/IP network byte order (which is big-endian).
- Return: The htons function returns the value in TCP/IP network byte order.
- Parameter:
  - `hostshort`: A 16-bit number in host byte order.
    - Set to be `1BBh`

<br/>

Then inspect the function call `inet_addr`:

![picture 85](images/685b0910b1dd3e5a42f360e4705d124bb085a3a6ef312470bc2745ba1b202e52.png)  

- https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-inet_addr
- Usage: The inet_addr function converts a string containing an IPv4 dotted-decimal address into a proper address for the IN_ADDR structure.
- Return value: If no error occurs, the inet_addr function returns an unsigned long value containing a suitable binary representation of the Internet address given.
- Parameter:
  - `cp`: Pointer to a IPv4 standard dotted decimal notation
    - Set to be `192.168.210.132`

<br/>

Then it calls `WSAConnect`:

![picture 86](images/245d58bd1fa9c523ebfc795a2db4bb55f2546964188630d4ae733cf61aa170d1.png)  

- https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsaconnect
- Usage: The WSAConnect function establishes a connection to another socket application, exchanges connect data, and specifies required quality of service based on the specified FLOWSPEC structure.
- Return: 
  - If no error occurs, WSAConnect returns zero. 
  - Otherwise, it returns SOCKET_ERROR
- Parameters:
  - `s`: A descriptor identifying an unconnected socket.
    - Set to be `cs:s`, which is the return value of `WSASocketA`
  - `name`: A pointer to a sockaddr structure that specifies the address to which to connect.
    - Set by the structure defined by the function calls returns of `WSASokcetA`, `htons` and `inet_addr`
  - `namelen`: The length, in bytes, of the sockaddr structure pointed to by the name parameter.
    - Set to 10h (16)
  - `lpCallerData`: A pointer to the user data that is to be transferred to the other socket during connection establishment.
    - Set to be 0 at `1800010A7` by self xoring
  - `lpCalleeData`: A pointer to the user data that is to be transferred back from the other socket during connection establishment.
    - Set to te 0
  - `lpSQOS`: A pointer to the FLOWSPEC structures for socket s, one for each direction.
    - Set to be 0 at `18000108C`
  - `lpGQOS`: Reserved for future use with socket groups. Should be 0.

This makes connection to the destination `192.168.210.132`

<br/>

Finally it uses `CreateProcessA`:

![picture 87](images/52b66e92ef38a99b12258c49024c4300fd2999dbf64d23ce72391f622973109d.png)  

- https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa
- Usage: Creates a new process and its primary thread. The new process runs in the security context of the calling process.
- Return value: 
  - If the function succeeds, the return value is nonzero.
  - If the function fails, the return value is zero. 
- Parameters:
  - `lpApplicationName`: The name of the module to be executed.
    - Set to be `0` at `180001177` by self xor-ing
  - `lpCommandLine`: The command line to be executed.
    - Set to be `[rsp+168h+CommandLine]`, which is defined at `180001115` referencing `cs:qword_1800031B0`
      - ![picture 88](images/994e6bb101adc14e1a2a3b16f65a56129961d63b85aadd414e7335f675724522.png)
      - We can convert this HEX to ASCII
      - ![picture 89](images/399bd6a74e6d3908160f152cb840c5c5733ec53dee42632fa951871038dba23f.png)
      - This is in little endian format so the command is `cmd.exe`
  - `lpProcessAttributes`: A pointer to a SECURITY_ATTRIBUTES structure that determines whether the returned handle to the new process object can be inherited by child processes.
    - Set to `0` at `18000116F` by self xor-ing
    - Default security descriptor
  - `lpThreadAttributes`: A pointer to a SECURITY_ATTRIBUTES structure that determines whether the returned handle to the new thread object can be inherited by child processes. 
    - Set to `0` at `18000116C` by self-xoring
    - Default security descriptor
  - `bInheritHandles`: If this parameter is TRUE, each inheritable handle in the calling process is inherited by the new process. If the parameter is FALSE, the handles are not inherited. 
    - Set as `1` (`TRUE`) at `180001164`, which means each inheritable handle in the calling process is inherited by the new process
  - `dwCreationFlags`: The flags that control the priority class and the creation of the process.
    - Set to `0` at `18000115C`
    - The priority class defaults to NORMAL_PRIORITY_CLASS
  - `lpEnvironment`: A pointer to the environment block for the new process.
    - Set to `0` at `180001153`
    - The new process uses the environment of the calling process.
  - `lpCurrentDirectory`: The full path to the current directory for the process.
    - Set to `0` at `18000114A`
    - The new process will have the same current drive and directory as the calling process.
  - `lpStartupInfo`: A pointer to a STARTUPINFO or STARTUPINFOEX structure.
    - Provided by the structure construction from `1800010C4` to `18000110E`
  - `lpProcessInformation`: A pointer to a PROCESS_INFORMATION structure that receives identification information about the new process.

<br/>

In short, the subroutine `180001000` makes a connection to `192.168.210.132` and launch `cmd.exe`. This is a typical reverse shell.


<br/>

---

## 3 - Running the malware

**Question**

You are required to dynamically analyze the malware sample(s) and provide thorough details to what it does. Use the questions below to guide you through your analysis.

1. Explain what happens upon execution (effect) and why?
2. If the malware is applying any anti-x (debugging, vm, reversing, etc.), how will you bypass those methods? Provide a step by step detailed.
3. What are the processes involved in this malware sample?
4. Provide activity details of the processes involved.
5. What are the files accessed, downloaded, and used? Where are the locations of these files on disk (PATH)?
6. What Registry keys and values were added, removed, updated?
7. What obfuscation was applied and how did you deobfuscate?
8. Does this malware perform any type of injection? Explain in detail how injection is performed.
9. Does the malware drop or download any files? If it does, what are they used for and how?

<br/>

**Answer**

### Summmary table

| No. | Question | Explanation |
| --- | --- | --- |
| 1 | Explain what happens upon execution (effect) and why? | A message box "ABORT!" shows and says "Sandbox Detected"! |
| 2 | If the malware is applying any anti-x (debugging, vm, reversing, etc.), how will you bypass those methods? Provide a step by step detailed. | See below |
| 3 | What are the processes involved in this malware sample? | cmd.exe, loader.exe, ping.exe |
| 4 | Provide activity details of the processes involved. | See the details explanations in the following |
| 5 | What are the files accessed, downloaded, and used? Where are the locations of these files on disk (PATH)? | See the details in the following |


### First time running the malware

Given the anti-reversing capabilities of the sample as analyzed above, it is expected to pop up a warning of sandbox detected and terminate upon running.

Beforing running the malware, launch **Wireshark**, **Process Hacker** and **Process Monitor** for tracking the host activities. 

![picture 90](images/84436c9a602f10182b59bb6ee8dec6fd0900b4bb491e77cf759b866799b91171.png)  

<br/>

Start capturing on **Wireshark** and **Process Monitor** and then run the sample as admin.

![picture 91](images/90d21819bd50ad0756dbbaab50e0e797579135c6bac93e9ce2bc494a2cab4414.png)  

- As expected, a message box tilted `ABORT!` with message `Sandbox Detected!` appears
- This is due to the anti-vm / anti-debugging capabilities of the malware

<br/>

### Bypassing the self-defensive mechanism

#### Debugger Detection at subroutine 140001740

Load the sample into **x64dbg**.

![picture 92](images/b7722962df157898bedf009786a3cfcc0c4751020e4e9de13270da26b92503fb.png)  

<br/>

First bypass the Debugger Detection at subroutine `140001740`. Use `Ctrl+G` and enter the location `140001740` to navigate to the related potion:

![picture 93](images/05974a982e859b4804f07f68ecf36c775673d5818bd59677f57e4ade706fe777.png)  

- The process will exit if the jump at `14000175D` is not taken
- To bypass, patch it by modifying the instruction `je` to `jmp` so it always take the jump:

![picture 94](images/d396265e59a880d178fcfd9d9309740e522846a6e4fc1c769b67d69be8ebf64a.png)  


<br/>

#### Detection at subroutine 1400017D0, 140001950, 140002274, 14000227D

Use `Ctrl+G` and enter the location `140002269` to navigate to the potion calling the detection subroutines:

![picture 95](images/05f2a0bbe5109449c149e03c6abbe133745f968f82edd25df3269a515e8ff015.png)  

- The common thing for the first 3 detection subroutine calls is that if detected, it jumps to `140002286`.
- To patch, change all the related `jne` instructions to `NOP`:

![picture 96](images/50f1828bb47f67ac555a3d9dd25ea24bd2ff75303017202c6439edeb830c5215.png)  

<br/>

Finally if we pass the checking, the jump should be taken at `140002284`. We can patch it by changing `je` to `jmp`:

![picture 97](images/76b67e5fe7f675f6c4bd7547724c17f838ff7dfa9be54354da9d4e61ee4f9d37.png)  

<br/>

Then click `File > Patch file ...`:

![picture 98](images/2f5a419bca9b3e5816b20dcfa9be4b6e30cddda4041f61c7af4c23bfd52bb43e.png)  

- Patch File
- Save as `FinalExam_patched.exe`

<br/>

### Running the patched executable

Start capturing on **Wireshark** and **Process Monitor** and then run the patched sample as admin.

![picture 99](images/48c77d1153a43e88ea962de5352a80edf0d2d2fdd58b65e64db696591b00ef03.png)  

- This time, instead of popping up the alert box, it shows `Reboot required` and ask `Do it now?`
- Click the `No` button

<br/>

Stop Wireshark capture and on Process Monitor, save the session as CSV.

<br/>

### Processes involved by the sample

Inspect the Process Tree on **Process Monitor**:

![picture 147](images/dfef85e9f8fc480dc6d17f4867a034e72b80e16875b7d7f712817759f9b1129d.png)  

As shown, the processes involved are:

- conhost.exe
- cmd.exe
  - conhost.exe
  - loader.exe
- cmd.exe
  - conhost.exe
  - ping.exe

Note `conhost.exe` is not meaningful to the analysis and is ignored in the following.

<br/>

#### First cmd.exe

The first instance of `cmd.exe` has the following CommandLine:

![picture 148](images/e8fb11101950a09535fcd68a69daad6b7f2e89f8977b64373c00898b5cfac637.png)  

- `C:\Windows\System32\cmd.exe" /C loader.exe && del /F loader.exe`
- It is invoked to run the executable `loader.exe`, and force remove `loader.exe` afterwards
  - This also explains why `loader.exe` disappears in the current working directory of the sample

![picture 149](images/f67eb22b80c3d96442fd626fea451a5eca8ede7458919349928640a3ed3c33f7.png)  

<br/>

#### Loader.exe

![picture 150](images/a94cafa1271a9b99984e8601ce000177331362a434963c96a1a82e88934ed634.png)  

`Loader.exe` is run but there is no child process. It has been be analyzed further to understand its functions and capability.

<br/>

#### Second cmd.exe

![picture 151](images/9eb7153f4edcf8a05a98ee608e4052493d474e96d31dd80885ed1143ce1f3f55.png)  

- `cmd.exe /C ping 1.1.1.1 -n 1 -w 3000 > Nul & Del /f /q "C:\Users\AdminELS\Downloads\Samples\Final_Exam\FinalExam_patched.exe"`
- `cmd.exe` is used to execute a `ping` command to `1.1.1.1` with the switch `-n 1` (one packet) and `-w 3000` (exit after 3000 seconds), where to output will be redirected to NULL; also the sample will be deleted forcefully and quietly

<br/>

#### ping.exe

![picture 152](images/3a5b7ea831f757afac493e59ae170381c7de18f602c8ef20ef456f0f3004423a.png)  

- `ping.exe` is execute to send ICMP packet to `1.1.1.1`

<br/>

### File accessed, downloaded, or used, and their PATH

![picture 154](images/dee73ed2ccf108f54172458897cbba32e8cd4bbb209bdf71b3590fe2dd25b416.png)  

![picture 155](images/0a0c75aff0d1385264e11de19ad55da0373c6efbf9933ab3e93be054f580af5d.png)  

![picture 156](images/0919c89088f2c74cf3690ef1f5c9fb960f67fad5cc51c3ff8c1f12cf1b1322dd.png)  

![picture 157](images/cfb06addb7f033145918743fbbae9f42998321c038faf3c5d2dab5cf1b11de6e.png)  


| File | Full Path | Action | MD5 Hash |
| --- | --- | --- | --- |
| loader.exe | C:\Users\AdminELS\Downloads\Samples\Final_Exam\loader.exe | Create & Delete | - |
| ph.exe | C:\Users\AdminELS\Downloads\Samples\Final_Exam\ph.exe | Create | D2DCC98A3CF29BE377291DAC3EE5DF1C |
| banner.jpg | C:\Users\AdminELS\AppData\Local\Temp\banner.jpg | Download | 989D3C5FA70A8466C6D4A5953C704B00 |
| start.jpg | C:\Users\AdminELS\AppData\Local\Temp\start.jpg | Download | 5606DF43FEEFC42FBD12CF06F60676B9 |
| footer.jpg | C:\Users\AdminELS\AppData\Local\Temp\footer.jpg | Download | 31ED3FEF9A570BF9436565113D19AA71 |
| pic1.jpg | C:\Users\AdminELS\AppData\Local\Temp\pic1.jpg | Download | 369BC1DB5F92AA730B871A2BECBBEDA2 | 
| pic2.jpg | C:\Users\AdminELS\AppData\Local\Temp\pic2.jpg | Download | D08AB13F3C57753EF26730E8E62AA817 |
| pic3.jpg | C:\Users\AdminELS\AppData\Local\Temp\pic3.jpg | Download | E40E65D6F8A6C9626E181D9273B3E5E4 |
| pic4.jpg | C:\Users\AdminELS\AppData\Local\Temp\pic4.jpg | Download | 955E9C5204009BD6FDAE913F7584FA6B |
| pic5.jpg | C:\Users\AdminELS\AppData\Local\Temp\pic5.jpg | Download | 64FB3D450B85EFF54FADB1217852CCD3 |
| s3f0.[0-4] | C:\Users\AdminELS\AppData\Local\Temp\s3f0.[0-4] | Create | 53A5D03DF598AEDEB9C48B8DC66E8D81 |
| s454.[0-4] | C:\Users\AdminELS\AppData\Local\Temp\s454.[0-4] | Create | 53A5D03DF598AEDEB9C48B8DC66E8D81 |
| runme.bat | C:\Users\AdminELS\AppData\Local\Temp\runme.bat | Download | C9063EF391A6BB5693525BDA6C54DA8C |

<br/>

### Registry Activities

There are 2 notable registry activities.

#### PortMonitor

![picture 158](images/014fbfdf5d29e74308249b448e9ba80f410e4aca53bd7fa5ff4c55f3cdca5b38.png)  

- `HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor\Driver` is set with value `C:\Windows\System32\conbase.dll`

<br/>

#### Run Key

![picture 159](images/ab3ea2f0ec53746eda542d3966ba20681810383c05ec46a767b0e29780310572.png)  

- `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\WizLoader` is set with the value `C:\Windows\svchost.exe`

<br/>

### Obfuscation

The downloaded file `banner.jpg` is identified as a Windows PE (DLL). It is discovered by inspecting the first bytes of the file on **PeStudio**:

![picture 160](images/3a2edfeba3b4970598f4fed6e1b6a79330f8bf6e7fd32e57e80ec31a77e107ad.png)  

<br/>

We can also inspect the HTTP stream in Wireshark capture:

![picture 161](images/e9cf33a2f5a085877a09c91e089d109c50a46921eb7214c2b0d0660dea068018.png)  

- The `MZ` first bytes reveals it is not a `JPG` but a Windows PE

<br/>

### banner.jpg / conbase.dll

The malware downloads `banner.jpg` from `www.elsmap.com/banner.jpg` and saves to `C:\Windows\System32\conbase.dll`:

![picture 162](images/8b8c4ad5d926ecfaafbecb0faf49669bdebdfbc32fa61d0e47d4b42173eda692.png)  

<br/>

This downloaded file (function: reverse shell callback) is for setting up the persistece at the reg key `HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor\Driver`.

<br/>


---

## 4 - Unpacking

**Question**

If there is a packed file, you need to unpack it and then provide full analysis of what it does and how it works. Don’t forget to add details such as but not limited to the File entropy, names of the sections, size of the sections.

<br/>

**Answer**


<br/>

---

## 5 - Network Activity

**Question**

What network activity did this malware sample generate, use the bullet points below to help you with what you need to document on your final report.

1. Domains and IP addresses that the malware communicated with
2. Protocols used
3. Files accessed or downloaded, their type and what are their contents

<br/>

**Answer**

Check the **Wireshark** capture and inspect the **Protocol Hierarchy Statistics**:

![picture 108](images/93f6b206b24080068971b2a0428dec9ea5807e734e004892b40e507cc59cbcff.png)  

- There are HTTP traffics as expected

<br/>

### HTTP

Check the http traffic by using the filter `not tcp.port == 3389 and http`:

![picture 109](images/a46f4ae9807465994328d315276782e822df64ab156340e4e5db56f794ca8f8f.png)  

![picture 110](images/959cca748b04421e5a96c8bc02a9d24aed163d018051211bc667d417dd4afc2f.png)  

- Domain: www.elsmap.com
- IP Address: 192.168.210.1
- Protocol: HTTP
- File downloaded:
  - banner.jpg
  - start.jpg
  - pic1.jpg
  - pic2.jpg
  - pic3.jpg
  - pic4.jpg
  - pic5.jpg
  - footer.jpg
  - /exam/runme.bat

![picture 111](images/cbc1b80e53e204302f00ed6e66fd6e90ee59af2075559c136264f998094e08cc.png)  

- This shows `banner.jpg` is actually a PE file

<br/>

#### banner.jpg

| Filename | Type | MD5 | Content |
| --- | --- | --- | --- |
| banner.jpg | Windows PE (DLL) | 989D3C5FA70A8466C6D4A5953C704B00 | / |

![picture 112](images/a817265523c8646bba0ebb6611aaea49a93262acbe63f042f005ce84b7caf7ba.png)  

![picture 117](images/4895608337a894ab2d6bc129f88452fdcccb213f98361dcbbcf6487ba6b459ec.png)  

<br/>

#### start.jpg

| Filename | Type | MD5 | Content |
| --- | --- | --- | --- |
| start.jpg | JPEG | 5606DF43FEEFC42FBD12CF06F60676B9 | / |

![picture 113](images/c987dd39f4cf48b6a64e1f8b29420bfdbcd1c0a432ebd21e6aa891a44d0d2cf8.png)  

![picture 114](images/6d0b62eb445383d8136e81f6b1a04b5cfe0269021f1a41674dca428e3400bfbd.png)  

- `FF D8` = JPEG

Content: 

![picture 115](images/3ad652d9c56ff5cc507676dcf3ce6b6d38298a93fafe4062ee4f0a3590acac2c.png)  

<br/>

#### pic1.jpg

| Filename | Type | MD5 | Content |
| --- | --- | --- | --- |
| pic1.jpg | JPEG | 369BC1DB5F92AA730B871A2BECBBEDA2 | / |

![picture 119](images/c008838bc7964164645f78572cbe489753e41edb3e376226f9787305ea45a417.png)  


![picture 118](images/ab3eb524dde809159eeee4ea92b50316bbf08b3965327fb4b9f1010cbd4a1f67.png)  

- `FF D8` = JPEG

Content:

![picture 120](images/0c68cd1db8b438664bcc867ac18153bbce9f5d2c93d32e6333748f42a7bfbcfb.png)  

<br/>

#### pic2.jpg

| Filename | Type | MD5 | Content |
| --- | --- | --- | --- |
| pic2.jpg | JPEG | D08AB13F3C57753EF26730E8E62AA817 | / |

![picture 122](images/7883507aae5e8f36258ef8706829cebbd10486f96f404841ed764bcdbb2124f2.png)  

![picture 123](images/23a5a5e9208ae2107c2c4f69a2947cadbc11ba78c023092233a912cc20159288.png)  

- `FF D8` = JPEG

Content:

![picture 121](images/8bc6559c1e901ef117c7d4210d6bed29ac90ac03a53124b961f0bff5da2490e2.png)  

<br/>

#### pic3.jpg

| Filename | Type | MD5 | Content |
| --- | --- | --- | --- |
| pic3.jpg | JPEG | E40E65D6F8A6C9626E181D9273B3E5E4 | / |

![picture 129](images/c37cdf173d7f56f64cbb99d87d24ac197c1ad8f34fa736eab03aae8424c42210.png)  

![picture 124](images/3d79f5459ef228ff35e0d3ecfecc3f8a4c28e12b1e279b81e2d5b645377260b1.png)  

- `FF D8` = JPEG

Content:

![picture 130](images/0a2870425348d125b10c05b586c1546976eba324975ef5635cbd246e8ac7a37d.png)  


<br/>

#### pic4.jpg

| Filename | Type | MD5 | Content |
| --- | --- | --- | --- |
| pic4.jpg | JPEG | 955E9C5204009BD6FDAE913F7584FA6B | / |

![picture 134](images/459d39e4cce323638a16c651855a5aa6dd4173e588eebff482a0a3ff5e3b5957.png)  


![picture 125](images/3916854a895579c35aeea422d6eb6973eb6cad363b31d2d99f40c57f98f26286.png)  

- `FF D8` = JPEG

Content:

![picture 131](images/3e838cd8f9a11566fa3511fe8d693bd98b23f9cba86f4546a8624be35b79d733.png)  


<br/>

#### pic5.jpg

| Filename | Type | MD5 | Content |
| --- | --- | --- | --- |
| pic5.jpg | JPEG | 64FB3D450B85EFF54FADB1217852CCD3 | / |

![picture 135](images/6d29877d93ed99d6ecbe8304a5042d76f13c45ace2d50e8a9bc639983ae4822c.png)  

![picture 126](images/3387e99262fee405896813d2f6442832bbff477ae8a903c1c4610a726359ec94.png)  

- `FF D8` = JPEG

Content:

![picture 132](images/645acbb9331227e224785fe6c4fe076925c5128dd1cffdb8d0861138ddcbd473.png)  


<br/>

#### footer.jpg

| Filename | Type | MD5 | Content |
| --- | --- | --- | --- |
| footer.jpg | JPEG | 31ED3FEF9A570BF9436565113D19AA71 | / |

![picture 136](images/bc0e821ad8ab54fdd8585371a95784acfa24727d105cf832ed2f7c26cc4530c8.png)  

![picture 127](images/509df9bc750c9bb78a47ec3b73f16c83616fa319699b1f953705ce28ad607175.png)  

- `FF D8` = JPEG

Content:

![picture 133](images/642c53425d97eabf086603f0b1d0acd6855cb93bac161004b8e0190ff2ba5eb9.png)  


<br/>

#### runme.bat

| Filename | Type | MD5 | Content |
| --- | --- | --- | --- |
| runme.bat | Windows Batch script | C9063EF391A6BB5693525BDA6C54DA8C | / |

Content:

![picture 128](images/8d4c20f67299985887fb53183eb12e0b4b46457a5e1ea0e0c83789a325a34734.png)  

- This is a destructive batch script which targeted to delete `*.exe`, `*.dll`, `*.jpg` and `*.png` on the system

<br/>

### ICMP

Also ICMP traffic is also observed:

![picture 153](images/987f2dff48dc36671f891e1006bbe726ad98e14b9bcf342335860f094a80cd6f.png)  

- Destination: 1.1.1.1
- This is expected result triggered by the ping command analyzed previously

<br/>


---

## 6 - Persistence

**Question**

You need to provide thorough details and explanations on how this malware is achieving persistence on the victim’s system. You should list all the persistence techniques in use (e.g. running as a service, registry keys, autorun folders, etc).

<br/>

**Answer**

### Method 1 - Using Persistence Run key

As per the disassembly, the sample has a function of adding a persistence key `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\WizLoader` and set the value to be `C:\Windows\svchost.exe`. Here is the screenshot of the action captured in dynamic analysis on **Process Monitor**:

![picture 137](images/0a013a06cc1e82515e2ce3bf80c763d556935d23722ba91531ec6c4f453a84bc.png)  

- ATT&CK: 
  - ID: T1547.001
  - Technique: Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder
  - Tactics: Persistence

<br/>

With this registry key added, `C:\Windows\svchost.exe` will be run at the time a user logon.

Note that the legit `svchost.exe` resides in `C:\Windows\System32\`.

- ATT&CK:
  - ID: T1036.005
  - Technique: Masquerading: Match Legitimate Name or Location
  - Tactics: Defense Evasion

<br/>

Checking the path and also the entries in **Process Monitor**, `C:\Windows\svchost.exe` has never been created.

<br/>

### Method 2 - Inject DLL into spoolsv.exe (Port Monitors)

As per the disassembly, the sample adds a registry key `HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor`.

![picture 138](images/773830cedc706d11a88f4e38890e4d67921be6d4b553a8b18bd18771da824e76.png)  

![picture 139](images/a1d941ba7b13020fb022d7f7bc70699b26b8990c8f54470bfbdb1fe37698c7bf.png)  

<br/>

By adding this registry key, the supplied DLL `C:\Windows\System32\conbase.dll` is loaded at system startup, and it is loaded by th spooler server `spoolsv.exe` at boot time. This run as SYSTEM level permission.

<br/>

- ATT&CK:
  - ID: T1547.010
  - Technique: Boot or Logon Autostart Execution: Port Monitors
  - Tactics: Persistence, Privilege Escalation

<br/>

Similar to `svchost.exe`, there is a legit Windows DLL called `combase.dll`.

- ATT&CK:
  - ID: T1036.005
  - Technique: Masquerading: Match Legitimate Name or Location
  - Tactics: Defense Evasion

<br/>

`C:\Windows\System32\conbase.dll` can be found:

![picture 140](images/9f8dc1d34345a7831ea7b0577434a9c94b438e6692c6727fa2bb6aa2c5ca47ed.png)  

- MD5: 989D3C5FA70A8466C6D4A5953C704B00
- Note that this is exactly the same as the file downloaded from `http://www.elsmap.com/banner.jpg`

<br/>

To check it capability, first add a secondary address on the ethernet interface:

![picture 141](images/9d75e159186b478cbed1011c6cc61c963c13fbb8ce32ada6fb145d0816b04099.png)  

<br/>

Launch a netcat listener locally:

- `nc -nlvp 443`

Then use `rundll32.exe` to load the DLL:

- `C:\Windows\System32\rundll32.exe C:\Windows\System32\conbase.dll,0`

![picture 142](images/b9cadd79b4f27a5d156ded74193e6d45a3cf6b57498542e7db915434383ce9cf.png)  

- A reverse shell calls back to the netcat listener, which matches our analysis in disassembly

<br/>

---

## 7 - Dropped and Downloaded Files

**Question**

What are the hash values of all the files that are related to this malware? You
should list all files in a table showing their type, from where they were
downloaded, where they were saved on disk, their hash value, and a description
about what they are used for.

<br/>

**Answer**

| # | Name | Type | Hash (MD5) | URL | Location on Disk | Description |
| --- | --- | --- | --- | --- | --- | --- |
| 1 | 



<br/>

---

## 8 - IOCs

**Question**

What are the IOCs that you could use to write a YARA rule in order to detect this sample on other systems? The rule should be able to identify that sample based on PE header, File Hash, Functions used, Strings, etc. Be very specific about what you use, otherwise it will lead to many false positives.

<br/>

**Answer**





<br/>

---

## 9 - Visualization

**Question**

Provide a visualization for the whole execution life cycle (or execution flow) of the sample. You do not have to use ProcDOT, you can draw it using any tool you prefer.

<br/>

**Answer**

![picture 101](images/4232da7375001cf53bd43f3ad5a44ea69afd825a0a23c36591f4574325af0030.png)  

![picture 102](images/b819a84186efa8f03bfce8e3462f5388d93201c6fcc02f54df5d651eef2c3696.png)  

![picture 103](images/c75abe2477d9e4ac72d34101b63e0f73edc0f12feb94821de69c6b95cb1de20e.png)  

![picture 104](images/67e212ae785abcee509faaf576db7511cba718debbb24903151b0ae5e0b7f970.png)  

![picture 105](images/5918a0280c935c049373ddb1b326f507a484e893f01f22cb7a582f9bb77031ae.png)  

![picture 107](images/40e0df9f5973001e58bb764cd659f1b74351ecb7c9f36efda97cb75ee847ab6f.png)  

![picture 106](images/096c5b06f2509967dc3f208da9ff38b481d378e8ccb815181c6978ee1e8ad779.png)  


<br/>

---

## 10 - Summary & Conclusion

**Question**

This one is very simple, just write a summary of your analysis.

<br/>

**Answer**



<br/>

---

## References

1. PE Format - https://docs.microsoft.com/en-us/windows/win32/debug/pe-format
