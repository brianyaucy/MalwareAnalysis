# eCMAP Exam

- [eCMAP Exam](#ecmap-exam)
  - [Configuration](#configuration)
  - [1 - Initial Assessments](#1---initial-assessments)
    - [Summary](#summary)
    - [1-1 - Hashes](#1-1---hashes)
    - [1-2 - Optional Header](#1-2---optional-header)
    - [1-3 - Sections](#1-3---sections)
    - [1-4 - Functions](#1-4---functions)
    - [1-5 - ATT&CK Analysis](#1-5---attck-analysis)
    - [1-6 - Resources](#1-6---resources)
    - [1-7 - Strings analysis](#1-7---strings-analysis)
  - [2 - Reverse Engineering](#2---reverse-engineering)
    - [FinalExam.exe](#finalexamexe)
      - [Preparation](#preparation)
      - [urlmon - URLDownloadToFileA - 1400015C0](#urlmon---urldownloadtofilea---1400015c0)
      - [urlmon - URLDownloadToFileA - 140002080](#urlmon---urldownloadtofilea---140002080)
      - [crypt32.dll - CryptStringToBinaryA - 140001320](#crypt32dll---cryptstringtobinarya---140001320)
      - [advapi32.dll - RegSetValueExA](#advapi32dll---regsetvalueexa)
  - [3 - Running the malware](#3---running-the-malware)
  - [4 - Unpacking](#4---unpacking)
  - [5 - Network Activity](#5---network-activity)
  - [6 - Persistence](#6---persistence)
  - [7 - Dropped and Downloaded Files](#7---dropped-and-downloaded-files)
  - [8 - IOCs](#8---iocs)
  - [9 - Visualization](#9---visualization)
  - [10 - Summary & Conclusion](#10---summary--conclusion)
  - [References](#references)

---

## Configuration

192.168.210.10 
AdminELS / Nu3pmkfyX

<br/>

Sample:
- `C:\Users\AdminELS\Downloads\Samples\Final_Exam`


<br/>

---

## 1 - Initial Assessments

**Questions**

Please provide background information about the malware sample given and any other malicious file(s) that gets downloaded. Use the questions below to help you when providing details about the file being analyzed.

1. What are the hashes of the malware sample?
2. What is the file type?
3. What is the compilation time stamp?
4. What are the file characteristics (e.g. EXE, DLL, 32-bit, 64-bit, etc.)?
5. What is the Image Base and the Entry Point address?
6. Provide details about each section found in terms of their names, sizes, permissions, entropy, and what each is used for.
7. What are the libraries (DLLs) referenced by this sample and which functions do you think are suspicious?
8. What are the MITRE techniques being used?
9. Is this sample packed or not and what proof do you have?
10. What interesting findings can you extract from the resources section?
11. What interesting strings (ASCII and Unicode) did you find and could they be used later as an IOC? Provide a brief explanation for each string found.
12. Are there any crypto functions being used by the sample and what are they?

<br/>

**Answer**

### Summary

| Question | Answer | Reference section |
| --- | --- | --- |
| 1. What are the hashes of the malware sample? | MD5: 28783D3A3D0FC76385A471D782141C04<br/>SHA1: D98E17F3A7A28454E96031792D3CBAD3B1B641E2<br/>SHA256: A4C1473ADD35A0409FC49C12C344DECF8FF71B1029F77DE2D20C9794CE387AB9<br/>IMPHASH: B60C0B539449AFE6F81105D67CA5D7EC | 1-1 |
| 2. What is the file type? | Windows PE | 1-1 |
| 3. What is the compilation time stamp? | Thu Jun 25 06:30:41 2020 | 1-1 |
| 4. What are the file characteristics (e.g. EXE, DLL, 32-bit, 64-bit, etc.)? | EXE, 64-bit | 1-1 |
| 5. What is the Image Base and the Entry Point address? | EntryPoint: 0x2ADC<br/>ImageBase: 0x140000000 | 1-2 |
| 6. Provide details about each section found in terms of their names, sizes, permissions, entropy, and what each is used for. | See details in the reference 1-3 | 1-3 |
| 7. What are the libraries (DLLs) referenced by this sample and which functions do you think are suspicious? | See details in the reference 1-4 | 1-4 |
| 8. What are the MITRE techniques being used? | T1497, T1124, T1112, T1106, T1082 | 1-5 |
| 9. Is this sample packed or not and what proof do you have? | Not packed based on the section names and entropy | 1-3 |
| 10.  What interesting findings can you extract from the resources section? | It requires administrator privilege to run | 1-6 |
| 11. What interesting strings (ASCII and Unicode) did you find and could they be used later as an IOC? Provide a brief explanation for each string found.| See the details in 1-7 | 1-7 |
| 12. Are there any crypto functions being used by the sample and what are they? | Yes - CryptStringToBinaryA (from crypt32.dll) | 1-4 |

<br/>

### 1-1 - Hashes

Use **PeStudio** to open the sample to inspect it statically.

<br/>

![picture 1](images/15c9b0635b354b68513490fa358f6aca313f9bd0db6226896d704d0ca17c2b84.png)  

Based on this screenshot of summary page on **PeStudio** we can get the following information:

- **1. File hashes:**
  - MD5: 28783D3A3D0FC76385A471D782141C04
  - SHA1: D98E17F3A7A28454E96031792D3CBAD3B1B641E2
  - SHA256: A4C1473ADD35A0409FC49C12C344DECF8FF71B1029F77DE2D20C9794CE387AB9
  - IMPHASH: B60C0B539449AFE6F81105D67CA5D7EC
- **2. File type:**
  - Windows PE (Based on the first-bytes being `MZ` (`0x4D5A`))
- **3. Compilation timestamp:** 
  - Thu Jun 25 06:30:41 2020
- **4. File characteristics:**
  - Type: EXE (Based on the **file-type** field)
  - Architect: 64-bit (AMD64)
  - Subsystem: Console

<br/>

### 1-2 - Optional Header

Check the **optional header**:

![picture 2](images/edeb48faa3284e5d1852e69f98497e38c5a2689e41a4e611abc5b497a2454bcd.png)  

- **5. Image Base & Entrypoint:**
  - EntryPoint: 0x2ADC
  - ImageBase: 0x140000000
- Also note that **ASLR** is enabled for this executable - we may have to turn it off later so we can analyze it on disassembler more easily.

<br/>

### 1-3 - Sections

Check the **sections**:

![picture 3](images/e7cefa801b791c52d8102a305b9c1739a2b89150c52932d95fdcedbff5aef192.png)  

- **6. Sections information**
  - **Section Name:** .text
    - Usage: Executable code
    - Raw Size: 9216 bytes
    - Virtual Size: 9180 bytes
    - Permissions: Executable
    - Entropy: 5.802 <br/>
  - **Section Name:** .rdata
    - Usage: Read-only initialized data
    - Raw Size: 8704 bytes
    - Virtual Size: 8488 bytes
    - Permissions: N/A
    - Entropy: 4.497
  - **Section Name:** .data
    - Usage: Initialized data
    - Raw Size: 29696 bytes
    - Virtual Size: 31176 bytes
    - Permissions: Writable
    - Entropy: 4.717
  - **Section Name:** .pdata
    - Usage: Exception information
    - Raw Size: 1024 bytes
    - Virtual Size: 732 bytes
    - Permissions: N/A
    - Entropy: 3.037
  - **Section Name:** .rsrc
    - Usage: Resource directory
    - Raw Size: 47616 bytes
    - Virtual Size: 47228 bytes
    - Permissions: N/A
    - Entropy: 4.031
  - **Section Name:** .reloc
    - Usage: Image relocations
    - Raw Size: 512 bytes
    - Virtual Size: 48 bytes
    - Permissions: N/A
    - Entropy: 0.647

Based on the Entropy score and section names, this sample is unlikely packed.

<br/>

Check the **libraries** section:

![picture 4](images/04be4d9672f3ba17bf87fdf437005b4f3ec39d19df4fab6e59b5ecc74860013b.png)  

- **Library:** wininet.dll
  - Usage: This DLL contains higher-level networking functions that implement protocols such as FTP, HTTP and NTP.
  - Suspicious?
    - Yes - It can be used to establish internet connections.
- **Library:** urlmon.dll
  - Usage: Perform internet communications
  - Suspicious?
    - Yes - It can be used to establish internet connections.
- **Library:** crypt32.dll
  - Usage: Handle cryptographic messaging functions
  - Suspicious?
    - Yes - This is commonly seen in malware for encrypted data, or even in ransomware
- **Library:** kernel32.dll
  - Usage: Contain core functionlity, like access and manipulation of memory, files, and hardware
  - Suspicious?
    - No - This is a very common DLL for any Windows executable
- **Library:** user32.dll
  - Usage: Contain all the user-interface components, such as buttons, scroll bars, and components for controlling and responding to user actions
  - Suspicious?
    - Could be - The subsystem is Console while having UI components, which is not consistent
- **Library:** advapi32.dll
  - Usage: Provide access to advanced core Windows components such as the Service Manager and Registry
  - Suspicious?
    - Could be - Commonly used for addign registry keys for persistence
- **Library:** shell32.dll
  - Usage: Contain Windows Shell API functions, which are used when opening webpages and files.
  - Suspicious?
    - No
- Other libraries are added by Windows Visual C++, which can be likely ignored

<br/>

### 1-4 - Functions

Check the **imports** section to see the functions referenced by each library:

![picture 5](images/2202e6698041d6cc8e41ceee4ee64e87ee1048adcf2581bc8e7960c2659e9a6f.png)  

- **wininet.dll**
  - **Function:** DeleteUrlCacheEntry
    - Usage: Removes the file associated with the source name from the cache, if the file exists.
    - Suspicious?
      - Not obvious
    - Reference:
      - https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-deleteurlcacheentry
  - **Function:** InternetCheckConnectionA
    - Usage: Allows an application to check if a connection to the Internet can be established.
    - Suspicious?
      - Yes - Can be used by the malware to check internet connectivity
    - Reference:
      - https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetcheckconnectiona

<br/>

![picture 9](images/398ff4b695631641ea7a325cb712f13bfa96ab42a9b89b43d5146b52a8f94a92.png)  

- **crypt32.dll**
  - **Function:** CryptStringToBinaryA
    - Usage: The CryptStringToBinary function converts a formatted string into an array of bytes.
    - Suspicious?
      - Yes - Could be used to decrypt componenets in the suspicious executable and execute it somehow.
    - Reference:
      - https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptstringtobinarya

<br/>

![picture 7](images/4c283ed2a66e5ce48911b238335a8486150fd7c5ba7943ac0582be97eb69b735.png)  

- **urlmon.dll**
  - **Function:** URLDownloadToFileA
    - Usage: Downloads bits from the Internet and saves them to a file.
    - Suspicious?
      - Yes - Can be used by the malware to download additional files from the internet
    - Reference:
      - https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85)

<br/>


![picture 6](images/53d7c050715f5c3e01673896ff4d713e88a6777d1bee432a66c90b381aa22db8.png)  


- **user32.dll**
  - **Function:** MessageBoxW
    - Usage: Displays a modal dialog box that contains a system icon, a set of buttons, and a brief application-specific message, such as status or error information.
    - Suspicious: Yes - commonly used by malware to mislead the user
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messageboxw

<br/>

![picture 10](images/c9339c22490e41670455d4ce93c779a278c72542848f9c23e1660a454c0284c3.png)  

- **advapi32.dll**
  - **Function:** RegOpenKeyExA / RegOpenKeyExW
    - Usage: Opens the specified registry key.
    - Suspicious: Yes - Could be used for persistence
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa
  - **Function:** RegSetValueExA
    - Usage: Sets the data and type of a specified value under a registry key.
    - Suspicious: Yes - Could be used for persistence
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa
  - **Function:** RegCloseKey
    - Usage: Closes a handle to the specified registry key.
    - Suspicious: Yes - Could be used for persistence
    - Reference: https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regclosekey

<br/>

### 1-5 - ATT&CK Analysis

![picture 11](images/18bc05820be8b909419f11e7e3ddd197d3ec7741ae69ce2a1e6470733ee432c4.png)  

- Also there are MITRE ATT&CK techniques with reference to the imports:
  - **Defense Evasion - T1497.003 - Virtulization/Sandbox Evasion: Time Based Evasion**
    - Library: kernel32.dll
    - Function: Sleep
    - Description:
      - Adversaries may employ various time-based evasions, such as delaying malware functionality upon initial execution using programmatic sleep commands or native system scheduling functionality (ex: Scheduled Task/Job). Delays may also be based on waiting for specific victim conditions to be met (ex: system time, events, etc.)
    - Reference:
      - https://attack.mitre.org/techniques/T1497/003/
  - **Discovery - T1124 - System Time Discovery**
    - Description:
      - Library: kernel32.dll
      - Function: GetSystemTimeAsFileTime
      - Description:
        - An adversary may gather the system time and/or time zone from a local or remote system. 
      - Reference:
        - https://attack.mitre.org/techniques/T1124/
  - **Defense Evasion - T1112 - Modify Registry**
    - Description:
      - Library: advapi32.dll
      - Function: RegSetValueExA
      - Description:
        - Adversaries may interact with the Windows Registry to hide configuration information within Registry keys, remove information as part of cleaning up, or as part of other techniques to aid in persistence and execution.
      - Reference:
        - https://attack.mitre.org/techniques/T1112/
  - **Execution - T1106 - Native API**
    - Description:
      - Library: kernel32.dll
      - Function: CreateProcessA
      - Description:
        - Functionality provided by native APIs are often also exposed to user-mode applications via interfaces and libraries. For example, functions such as the Windows API `CreateProcess()` or GNU `fork()` will allow programs and scripts to start other processes.
      - Reference:
        - https://attack.mitre.org/techniques/T1106/
  - **Execution - T1106 - Native API**
    - Description:
      - Library: shell32.dll
      - Function: ShellExecuteA
      - Description:
        - Functionality provided by native APIs are often also exposed to user-mode applications via interfaces and libraries. For example, functions such as the Windows API `CreateProcess()` or GNU `fork()` will allow programs and scripts to start other processes.
      - Reference:
        - https://attack.mitre.org/techniques/T1106/
  - **Discovery - T1082 - System Information Discovery**
    - Description:
      - Library: kernel32.dll
      - Function: IsDebuggerPresent
      - Description:
        - An adversary may attempt to get detailed information about the operating system and hardware, including version, patches, hotfixes, service packs, and architecture. IsDebuggerPresent is commonly seen in self-defense malware to detect if it is being debugged.
      - Reference:
        - https://attack.mitre.org/techniques/T1082/

<br/>

### 1-6 - Resources

Check the resources section:

![picture 12](images/19f859216e6becdb983d9144d6656105da875dd95824af137723cdc89612e38e.png)  

- Most of them are icons

<br/>

Check the manifest as well:

![picture 13](images/250cc19b3ad88b1faaa1a08a7be052d0b26f60fc3652b4b7408b2b6b2fb9ace4.png)  

- The sample requires running as administrator.

<br/>

### 1-7 - Strings analysis

Use **BinText** to look for interesting strings:

![picture 14](images/694eb36b5210cf48737f52bc3741b97f0f27d634b8dfcbfb41f318ab143ae74f.png)  


| Type | File position | Memory position | Text | Description |
| --- | --- | --- | --- | --- |
| ASCII | 2F50 | 2EDD | ph.exe | Unknown executable name |
| ASCII | 2F58 | 2EE5 | loader.exe | Unknown executable name |
| ASCII | 2F68 | 2EF5 | http://www.elsmap.com/banner.jpg | URL of a JPG file from an unknown site |
| ASCII | 2F90 | 2F1D | cmd.exe /C ping 1.1.1.1 -n 1 -w 3000 > Nul & Del /f /q "%s" | A cmd command for execute a one-time ping to 1.1.1.1 (possibly check internet connection) and delete a file quitely. |
| ASCII | 3320 | 32AD | http://update.microsoft.com | URL of Microsoft Update - possibly used for internet connectivity |
| ASCII | 3340 | 32CD | SOFTWARE\Microsoft\Windows\CurrentVersion\Run | A persistence run key by running a process automatically when a user login. |
| ASCII | 3370 | 32FD | SYSTEM\CurrentControlSet\Control\Print\Monitors\PortMonitor | A persistence run key by injecting a DLL into the spoolsv.exe process.<br/>Ref: https://pentestlab.blog/2019/10/28/persistence-port-monitors/ | 
| ASCII | 33B0 | 333D | Yzpcd2luZG93c1xzdmNob3N0LmV4ZQ== | Base64 encoded string. Decoded version is `c:\windows\svchost.exe` |
| ASCII | 33D8 | 3365 | WizLoader | Uncommon string |
| ASCII | 33E8 | 3375 | aHR0cDovL3d3dy5lbHNtYXAuY29tL2Jhbm5lci5qcGc= | Base64 encoded string. Decoded version is: `http://www.elsmap.com/banner.jpg` |
| ASCII | 3418 | 33A5 | aHR0cDovL3d3dy5lbHNtYXAuY29tL2V4YW0vcnVubWUuYmF0 | Base64 encoded string. Decoded version is: `http://www.elsmap.com/exam/runme.bat`, a potential suspicious script file. |
| ASCII | 3450 | 33DD | VGhlcmUgaXMgbm90aGluZyBoZXJlIExPTA0KR28gY2hlY2sgc29tZXRoaW5nIGVsc2UgOyk= | Base64 encoded string. Decoded version is: `There is nothing here LOL<br/>Go check something else ;)` - Thanks for this easter egg! |
| ASCII | 34A0 | 342D | aHR0cDovL3d3dy5lbHNtYXAuY29tL3N0YXJ0LmpwZw== | Base64 encoded string. The decoded version is: `http://www.elsmap.com/start.jpg` |
| ASCII | 34D0 | 345D | aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzEuanBn | Base64 encoded string. The decoded version is: `http://www.elsmap.com/pic1.jpg` |
| ASCII | 3500 | 348D | aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzIuanBn | Base64 encoded string. The decoded version is: `http://www.elsmap.com/pic2.jpg` |
| ASCII | 3530 | 34BD | aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzMuanBn | Base64 encoded string. The decoded version is: `http://www.elsmap.com/pic3.jpg` |
| ASCII | 3560 | 34ED | aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzQuanBn | Base64 encoded string. The decoded version is: `http://www.elsmap.com/pic4.jpg` |
| ASCII | 3590 | 351D | aHR0cDovL3d3dy5lbHNtYXAuY29tL3BpYzUuanBn | Base64 encoded string. The decoded version is: `http://www.elsmap.com/pic5.jpg` |
| ASCII | 35C0 | 354D | aHR0cDovL3d3dy5lbHNtYXAuY29tL2Zvb3Rlci5qcGc= | Base64 encoded string. The decoded version is: `http://www.elsmap.com/footer.jpg` |
| ASCII | 35F0 | 357D | aHR0cDovL3d3dy5lbHNtYXAuY29tL2hlYWRlci5qcGc= | Base64 encoded string. The decoded version is: `http://www.elsmap.com/header.jpg` |
| ASCII | 3658 | 35E5 | aHR0cDovL3d3dy5lbHNtYXAuY29tL2Jhbm5lci5qcGc= | Base64 encoded string. The decoded version is: `http://www.elsmap.com/banner.jpg` |
| ASCII | 3688 | 3615 | QzpcV2luZG93c1xTeXN0ZW0zMlxjb25iYXNlLmRsbA== | Base64 encoded string. The decoded version is: `C:\Windows\System32\conbase.dll` - This is suspicious since it is similar to a legit Windows DLL called `combase.dll` in the same path. |
| ASCII | 36C0 | 364D | /C loader.exe && del /F loader.exe | A cmd command for running `loader.exe` and force delete it afterwards. |
| Unicode | 2FD0 | 2F5D | WINDBG.EXE | A debugger name - possibly used for debugger detection |
| Unicode | 2FE8 | 2F75 | VsDebugConsole.EXE | A debugger name - possibly used for debugger detection |
| Unicode | 3010 | 2F9D | devenv.exe | A debugger name - possibly used for debugger detection |
| Unicode | 3040 | 2FCD | x96dbg.exe | A debugger name - possibly used for debugger detection |
| Unicode | 3058 | 2FE5 | x64dbg.exe | A debugger name - possibly used for debugger detection |
| Unicode | 3070 | 2FFD | x32dbg.exe | A debugger name - possibly used for debugger detection |
| Unicode | 3098 | 3025 | Debugger Detected | Possible message when debugger detected |
| Unicode | 30C0 | 304D | WIRESHARK.EXE | Network sniffer commonly used for malware analysis - possible a self-defense for detecting the sample itself being analyzed. |
| Unicode | 30F8 | 3085 | Abort! | Possible message when Wireshark is detected. |
| Unicode | 3160 | 30ED | Good night! | Possible message when Wireshark / Debugger is detected. |
| Unicode | 3178 | 3105 | Sleep tight my sweety | Possible message when Wireshark / Debugger is detected. |
| Unicode | 31A8 | 3135 | \\.\PhysicalDrive0 | Possible sandbox detection by checking the drive size |
| Unicode | 31D0 | 315D | C:\Windows\System32\VBox*.dll | Possible sandbox detection by checking if libraries related to VirtualBox are used. |
| Unicode | 3210 | 319D | C:\Windows\System32\vm*.dll | Possible sandbox detection by checking if libraries related to VMWare are used. |
| Unicode | 3248 | 31D5 | Do it now? | Possible message when VM / Sandbox is detected. |
| Unicode | 3260 | 31ED | SYSTEM\ControlSet001\Services\VBoxSF | Possible sandbox detection by checking if registry used by VirtualBox exists. |
| Unicode | 32B0 | 323D | SYSTEM\ControlSet001\Services\VMTools | Possible sandbox detection by checking if registry used by VMWare exists. |
| Unicode | 3300 | 328D | Reboot required | Possible message when VM / Sandbox is detected. |
| Unicode | 3620 | 35AD | ABORT! | Possible message when VM / Sandbox is detected. |
| Unicode | 3630 | 35BD | Sandbox Detected! | Possible message when VM / Sandbox is detected. |

<br/>

---


## 2 - Reverse Engineering

**Question**

You are required to reverse engineer all the files that are related to the malware sample, whether they were given to you or downloaded by the malware. 

You need to identify them and reverse engineer them to understand what they do. You are not required to reverse every single part of them, but at least their main functionality. 

Explain all the APIs that are used, how they are used and make sure you reference them with their online documentation found at the MSDN.

<br/>

**Answer**

### FinalExam.exe

#### Preparation

First load the sample into **CFF Explorer** and navigate to **Optional Header**. Modify **DllCharacteristics** and disable the `DLL can move` flag:

![picture 15](images/51445448ea8fe0bd9181932ef1d408c703db0fb6b8885a00c6afeda202740044.png)  

<br/>

Then save as `FinalExam_ASLR_Disabled.exe`:

![picture 16](images/3dffa376b43d89568fee3317f219000afe79f85006aa490fb539bd5088f2dc8f.png)  

<br/>

Then load `FinalExam_ASLR_Disabled.exe` into **IDA Pro (64-bit)**.

![picture 17](images/19bcccee619398c92cfb72e0b7922b7a85cd24909d7a65cad98b18152132d0f7.png)  

<br/>

#### urlmon - URLDownloadToFileA - 1400015C0

`URLDownloadToFileA` is used to download bits from the Internet and saves them to a file.
 
<br/>

Navigate to **Imports** and look for `URLDownloadToFileA`. Double click on it and check the xref of this function:

![picture 18](images/a2520f0dd90e2d4e70be2d53864dd6fcae0cbf66c2fb3dc03bcfb86c8eb43995.png)  

- It is referenced at `1400015C0` and `140002080`

<br/>

First check `1400015C0`:

![picture 19](images/79de1c98cb175aaf6aa2cbed97b0a11b878abf776c2ec2a67c9b7914f4cf1e5d.png)  

With reference to MSDN document (https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85) we may analyze the parameters:

- `pCaller`: A pointer to the controlling IUnknown interface of the calling ActiveX component, if the caller is an ActiveX component. If the calling application is not an ActiveX component, this value can be set to NULL.
  - This value is determined by `xor ecx,ecx` at `140001622`, resulting in `0`
  - This means there is not an ActiveX component
- `szURL`: A pointer to a string value that contains the URL to download.
  - This is determined by `[rsp+48h+lpszUrlName]` at `14000161D`
  - Note `[rsp+48h+lpszUrlName]` is set up from `1400015D6-1400015E2`, it should contain the pointer to `aHttpWwwElsmapC` (`http://www.elsmap.com/banner.jpg`)
- `szFileName`: A pointer to a string value containing the name or full path of the file to create for the download. If szFileName includes a path, the target directory must already exist.
  - This is determined by `r8, [rsp+48h+arg_8]` at `140001618`
  - Determined by `rdx` at `1400015C0`
- `dwReserved`: Must be 0 as determined at `140001615`
- `lpfnCB`: A pointer to the IBindStatusCallback interface of the caller. By using IBindStatusCallback::OnProgress, a caller can receive download status. This parameter can be set to NULL if status is not required.
  - Determined by the instruction `mov [rsp+48h+var_28],0` at `140001610C`
  - The parameter is set to `0`, meaning that status is not required

<br/>

Short conclusion for `sub_1400015C0`:

- This function call is to download the file `http://www.elsmap.com/banner.jpg`.

<br/>

#### urlmon - URLDownloadToFileA - 140002080

Then check another subroutine at `140002080`:

![picture 20](images/ea9d5d29e1cdae02a0b643aa6dfbebe390bb2f1874e892091478d61c81a1d39f.png)  

- This is a loop which calls `DeleteUrlCacheEntry` and `URLDownloadToFileA` several times as shown on the screenshot

<br/>

At the beginning of the sub-routine, we can see the stack initialization with the base64-encoded URLs found in the static analysis:

![picture 21](images/c185ba37340c676ef6a0bbf667e9bced7f346ba214df0fea4b0daf79ac77a632.png)  

<br/>

Then we can see the number of Loops at `140002145`:

![picture 22](images/fda1c34b59bae7d4539661eebd2f0fbf30090301f7924d0555167379aea8db7f.png)  

- The loop counter `[rsp+11C8h+var_1198]` is compared with the static number `9`, which mean the loop has 9 iteration used with initial number 0 and `jge` (jump if greater than or equal) condition

<br/>

![picture 23](images/05adda2fe88e6978587b87af5ea9d0b8ba4f2f53ed4fe0c66b12812ed9353799.png)  

- Then in this section, it self-loop until `[rax+rcx]` equals 0

<br/>

![picture 24](images/51cc2cb99c36a2c793c536d6ff81608ce96afd65e43073c71c062c6e038567ce.png)  

![picture 25](images/b2a0951d71a1dbc4c8fef59ac135637cafaf3955acbceb59fa9a09ed548f05b1.png)  

Then we can see a function call related `GetTempPathA` (MSDN Doc: https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-gettemppatha).

- Purpose: Retrieves the path of the directory designated for temporary files.
- Return: If the function succeeds, the return value is the length, in TCHARs, of the string copied to lpBuffer, not including the terminating null character. If the function fails, the return value is zero.
- Parameters:
  - `nBufferLength`: The size of the string buffer identified by lpBuffer, in TCHARs.
    - Determined by `r8d` at `14000218B`, which is `0x100`
  - `lpBuffer`: A pointer to a string buffer that receives the null-terminated string specifying the temporary file path.
    - This is determined by `rdx`, which is assigned as `[rsp+11C8+FileName]`

<br/>

After calling the subroutine with `GetTempPathA`, we can see if calls the subroutine `140001320`, which contains `CryptStringToBinaryA`:

![picture 26](images/b0ebd8567ac8e5ba5934aa3677099a34b3e3995acd9f11ab9db397af493dc5c0.png)  

![picture 27](images/3a26f640fe1c009f7d82a7ce02b52fe5fc9199c88e029e7e6f8f472e833e66ee.png)  

- We will come back to this function call in `140001320` separate.

<br/>

After calling `140001320`, it calls `remove` and `DeleteUrlCacheEntry`:

![picture 28](images/9d5ce21ee058f6af3c0a004ac2f5bd34c18f3dead09758ac3b9425236bf94b3c.png)  

- Remove:
  - https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/remove-wremove?view=msvc-160
  - Purpose: Delete a file.
  - In this case, it removes `[rsp+11C8h+FileName]`
- DeleteUrlCacheEntry:
  - https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-deleteurlcacheentry
  - Purpose: Removes the file associated with the source name from the cache, if the file exists.
  - In this case, it removes the cache related to `[rsp+11C8h+szUrlName]`

- These function calls remove the files and caches downloaded on the disk, which evades detection

<br/>

![picture 29](images/c7bc928e97ba4034a0672fcab1f69356124d5db28a49fc985da151e60e07f751.png)  

- Then finally before the loop body ends, it calls `URLDownloadToFileA` to download another file from the C2 server. 
  - URL determined by `[rsp+11C8h+szUrlName]`
  - Filename determined by `[rsp+11C8h+FileName]`
- This loop will finally looping through all the base64-encoded URL on the stack.

<br/>

#### crypt32.dll - CryptStringToBinaryA - 140001320

![picture 30](images/04f8567f0947c64e79670da3ddea1472508685135cf6cb6472f3de0dd746a938.png)  

The comment for the initialization is with reference to the parameters passed by `140002145`:

![picture 31](images/9fa456eb541caf3564008f52591d60ea47c8bb8b180ff5f1a590a9616ed18c9d.png)  


- Usage: Converts a formatted string into an array of bytes.
- Return: 
  - If the function succeeds, the return value is nonzero (TRUE).
  - If the function fails, the return value is zero (FALSE).
- Parameters:
  - `pszString`: A pointer to a string that contains the formatted string to be converted.
    - Determined by `rcx` at `14000132E`, which is `[rsp+rax*8+11C8h+FileName]` passed by the previously analyzed subroutine `140002145`
    - This is the Base64-encoded string defined on the stack previously
  - `cchString`: The number of characters of the formatted string to be converted, not including the terminating NULL character. If this parameter is zero, `pszString` is considered to be a null-terminated string.
    - Determined by `edx` at `14000132A`, which is `[rsp+11C8h+var_1184]`, which is `0` as determined at `140002182`
    - `cchString = 0` means the formatted string is null-terminated
  - `dwFlags`: Indicates the format of the string to be converted.
    - Set to be `1` at `14000136F`
    - This indicates `CRYPT_STRING_BASE64` - base64 strings without header
  - `pbBinary`: A pointer to a buffer that receives the returned sequence of bytes.
    - Determined by `r8` at `140001325`
    - `[rsp+11C8h+szUrlName]` is passed to this. 
    - This is how `URLDownloadToFileA` in subroutine `140002080` requests different URL each time
  - `pcbBinary`: A pointer to a DWORD variable that, on entry, contains the size, in bytes, of the pbBinary buffer. 
    - This is eventually determined by `r9d` at `140001320`, which is passed by subroutine `140002080` as `0x1000`
    - The size of the buffer will be 4096 (0x1000) bytes
  - `pdwSkip`: A pointer to a DWORD value that receives the number of characters skipped to reach the beginning of the -----BEGIN ...----- header. If no header is present, then the DWORD is set to zero. This parameter is optional and can be NULL if it is not needed.
    - This is set to `0` at `140001357`
  - `pdwFlags`: A pointer to a DWORD value that receives the flags actually used in the conversion. This parameter is optional and can be NULL if it is not needed.
    - This is set to `0` at `14000134E`

In short, the subroutine `140001320` is responsible for converting the base64-encoded URL and return to the subroutine `140002080` for retrieving files from the supicious server.

<br/>

#### advapi32.dll - RegSetValueExA

Next check another API call `RegSetValueExA`:

![picture 33](images/3ba98fea149d7867c90ffe42c399068af8431b96e11d12124b6b625124141f7f.png)  

![picture 34](images/215ad2698d13493f234e98e35dea017ed0367fa69c541eeba4d9aa2aeebbbfc7.png)  

- `RegSetValueExA` is referenced at `140001B80` and `140001C70`

<br/>

**RegOpenKeyExA, RegSetValueExA, RegCloseKey - 140001B80**

![picture 36](images/608ec9017c20e38defb59358ec83fa06eba6777104d329d55087931eddc7c2f1.png)  

![picture 37](images/c6b16ed96c97075f071aa8128d2f0e9a5269dd5db3bf6cdd748860dccbd96de0.png)  


- MSDN Doc: https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa
- Usage: Opens the specified registry key. 
- Return Value: 
  - If the function succeeds, the return value is ERROR_SUCCESS.
  - If the function fails, the return value is a nonzero error code defined in Winerror.h.
- Parameters:
  - `hKey`: A handle to an open registry key, or it can be one of the following predefined keys: HKEY_CLASSES_ROOT HKEY_CURRENT_CONFIG HKEY_CURRENT_USER HKEY_LOCAL_MACHINE HKEY_USERS
    - In this case, by checking the symbolic constant of `0xFFFFFFFF80000002h`, it is `HKEY_LOCAL_MACHINE`, as shown in the above screenshot.
  - `lpSubKey`: The name of the registry subkey to be opened.
    - Determined at `140001BB0`, which is the constant string `SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
  - `ulOptions`: Specifies the option to apply when opening the key.
    - Determined at `140001BAD` - self XOR-ing resulting in `0`
    - No option set
  - `samDesired`: A mask that specifies the desired access rights to the key to be opened.
    - It is set to be `2` at `140001BA7`
      - With reference to https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-key-security-and-access-rights, `2` means `KEY_SET_VALUE`  - Required to create, delete, or set a registry value.
  - `phkResult`: A pointer to a variable that receives a handle to the opened key. 
    - This is set to be `rax` at `140001BA2`

In short, this function call opens the Registry Key `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`, which is a key that can be used for persistence.

<br/>

![picture 35](images/436cda2540077eb071bfdc64b0127a143997b5ca901621c34c61345d719f482d.png)  

![picture 38](images/af8e9c27f01039485ee9d9d64f5780c2a92b50f94e8a68ba2614faa8f1e2635f.png)  






`RegSetValueExA`:

- MSDN doc: https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa
- Purpose:
  - Sets the data and type of a specified value under a registry key.
- Return Value:
  - If the function succeeds, the return value is ERROR_SUCCESS.
  - If the function fails, the return value is a nonzero error code defined in Winerror.h.
- Parameters:
  - `hKey`:  A handle to an open registry key.
    - This is set as `[rsp+68h+hKey]` at `140001C1F`. This is determined when calling `RegOpenKeyExA`, which should be `HKEY_LOCAL_MACHINE`
  
![picture 39](images/a00808aa4bd97953dccd47e120f343896b1657e788a19ad3093d243ad396e974.png)  

  - `lpValueName`: The name of the value to be set.
    - This is determined by `[rsp+68h+lpValueName]`, which is referenced at `140001B85`. This has to be determined by the parameter value in `rcx` of the callee
      - To determine, click on the current subroutine name `sub_140001B80` and check the reference, as shown in the above screenshot - It is called by `140001D60`
      - `rcx` is set to be `WizLoader` at `14001DC8`
    - Therefore, this is set to be `WizLoader`
  - `Reserved`: No meaning in context
  - `dwType`: The type of data pointed to by the lpData parameter.
    - Set to be `1` at `140001C11`
    - According to https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wprn/742b6e1e-0323-42b1-b94c-65b3e21b086d, it is of type `REG_SZ` - a string.

![picture 40](images/19b4f37bbbc16a199876843490c637761dac5821553f3bd81a61360a2b722c81.png)  

  - `lpData`: The data to be stored.
    - This is determined by `[rsp+68h+lpData]` at `140001C07`, which has a reference at the beginning of the current subroutine at `140001B80` - which need to determine the parameter passed in `rdx` of the callee
      - Similar to `lpValueName`, check the value set in `rdx` at the moment the current subroutine is called.
      - On the screenshot, it 


<br/>

---

## 3 - Running the malware

**Question**

You are required to dynamically analyze the malware sample(s) and provide thorough details to what it does. Use the questions below to guide you through your analysis.

1. Explain what happens upon execution (effect) and why?
2. If the malware is applying any anti-x (debugging, vm, reversing, etc.), how will you bypass those methods? Provide a step by step detailed.
3. What are the processes involved in this malware sample?
4. Provide activity details of the processes involved.
5. What are the files accessed, downloaded, and used? Where are the locations of these files on disk (PATH)?
6. What Registry keys and values were added, removed, updated?
7. What obfuscation was applied and how did you deobfuscate?
8. Does this malware perform any type of injection? Explain in detail how injection is performed.
9. Does the malware drop or download any files? If it does, what are they used for and how?

<br/>

**Answer**


<br/>

---

## 4 - Unpacking

**Question**

If there is a packed file, you need to unpack it and then provide full analysis of what it does and how it works. Don’t forget to add details such as but not limited to the File entropy, names of the sections, size of the sections.

<br/>

**Answer**


<br/>

---

## 5 - Network Activity

**Question**

What network activity did this malware sample generate, use the bullet points below to help you with what you need to document on your final report.

1. Domains and IP addresses that the malware communicated with
2. Protocols used
3. Files accessed or downloaded, their type and what are their contents

<br/>

**Answer**




<br/>

---

## 6 - Persistence

**Question**

You need to provide thorough details and explanations on how this malware is achieving persistence on the victim’s system. You should list all the persistence techniques in use (e.g. running as a service, registry keys, autorun folders, etc).


<br/>

---

## 7 - Dropped and Downloaded Files

**Question**

What are the hash values of all the files that are related to this malware? You
should list all files in a table showing their type, from where they were
downloaded, where they were saved on disk, their hash value, and a description
about what they are used for.

<br/>

**Answer**

| # | Name | Type | Hash | URL | Location on Disk | Description |
| --- | --- | --- | --- | --- | --- | --- |




<br/>

---

## 8 - IOCs

**Question**

What are the IOCs that you could use to write a YARA rule in order to detect this sample on other systems? The rule should be able to identify that sample based on PE header, File Hash, Functions used, Strings, etc. Be very specific about what you use, otherwise it will lead to many false positives.

<br/>

**Answer**





<br/>

---

## 9 - Visualization

**Question**

Provide a visualization for the whole execution life cycle (or execution flow) of the sample. You do not have to use ProcDOT, you can draw it using any tool you prefer.

<br/>

**Answer**




<br/>

---

## 10 - Summary & Conclusion

**Question**

This one is very simple, just write a summary of your analysis.

<br/>

**Answer**



<br/>

---

## References

1. PE Format - https://docs.microsoft.com/en-us/windows/win32/debug/pe-format
