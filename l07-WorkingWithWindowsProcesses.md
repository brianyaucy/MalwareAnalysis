# Lab 07 - Working with Windows Processes

- [Lab 07 - Working with Windows Processes](#lab-07---working-with-windows-processes)
  - [Sceanrio](#sceanrio)
  - [Tools](#tools)
  - [Task 1: More about Windows Processes](#task-1-more-about-windows-processes)
  - [Task 2: Running Processes: Strings and Memory](#task-2-running-processes-strings-and-memory)
    - [Experiment 1](#experiment-1)
    - [Experiment 2](#experiment-2)
    - [Experiment 3](#experiment-3)
  - [Task 3: Processes and TCP/IP](#task-3-processes-and-tcpip)
  - [Task 4: Working with Windows Sessions](#task-4-working-with-windows-sessions)

---

## Sceanrio

You are required to do a couple of different experiments to understand how processes work and understand them better. The skills acquired in this lab will be later used when doing malware analysis and it could also be used if you are doing threat hunting too.

<br/>

The goals of this lab are to: 
- Further understand the different Process Explorer properties and settings, what they mean, and how to benefit from them.
- Understand more about threads and processes with network connections. 
- Searching for strings in program image files and memory. 
- Understand the different Windows sessions.

<br/>

By the end of the lab, you should have a better understanding of Windows processes, threads, how to find strings in the image file and in memory, processes with network connections, and the different Windows sessions and what each one is used for. You will also have the ability to spot a suspicious process that tries to use a common Windows process name.

<br/>

192.168.210.10 / AdminELS / Nu3pmkfyX

<br/>

---

## Tools

- Sysinternals Process Explorer (procexp.exe)
- Sysinternals PsExec
- Process Hacker
- Windows Netcat

<br/>

---

## Task 1: More about Windows Processes

**Question**

To continue our understanding about Windows Processes, use Process Explorer to answer the questions below. Some questions require you to do some research.

1. What do processes in pink represent?
2. Why are there two `csrss.exe`?
3. Which ports is your `explorer.exe` listening on? Is that normal, and why?
4. How many threads does your System Idle Process have and why?

<br/>

**Answer**

**[1] What do processes in pink represent?**

Launch `procexp64.exe` as admin. Navigate to `Options > Configure Colors ...`:

![picture 124](images/2eb0bf321caef96994d332a4d3a5da4cb28d73f71ecb1b166a0ff07d13327088.png)  

- Color in Pink represents `Services`

<br/>

**[2] Why are there two `csrss.exe`?**

![picture 125](images/ece63ed522a7fa8c76ae63336444715e446dc8a03fde77301db6ff4fc942bbd1.png)  

- The reason is that there will be one `csrss.exe` for the system, and then one for each user that is logged into the machine
- In the screenshot, it shows 3 `csrss.exe`, meaning that there are 2 users logged into the machine

To check whether the path is correct, we can double click `csrss.exe`:

![picture 126](images/806102f2d1fe77c4e9d08db47e9ca4f7c5823d42b585201c8604adbb3f453246.png)  

![picture 127](images/c68dab93d76438a60186265f0934cbb8f74cb069d451372ab428e08660e2e8c4.png)  

![picture 128](images/3363faa243338ca4cdd319b06d1a9a02c157e70dc63e4846c7acb1564306db79.png)  


- Image:
  - The `path` is `C:\Windows\System32\csrss.exe` - legit
  - The `parent` is non-existent - legit

<br/>

Naviagting to `Security` tab, we can understand which one is for the System and which one is for client by checking the **Session**:

![picture 129](images/9d06906246e877d13f3ea766b3c724bbd2a4e041783d242bdf35aadfdbe70340.png)  

- `Session 0` shows the SYSTEM instance
- User is `SYSTEM`
- SID is `S-1-5-18`

<br/>

![picture 130](images/6c9775906c72427aad392e6b863a1376fa083dd5aaa5cae0b37f414d28316a60.png)  

- `Session 1` shows the USER instance
- User is `SYSTEM`
- SID is `S-1-5-18`

<br/>

**[3] Which ports is your `explorer.exe` listening on? Is that normal, and why?**

Double click `Explorer.exe` and check the `TCP/IP` tab:

![picture 131](images/3c2e91b161465931dd2f2fba7cfc15e4cd3b0ab078470655ea21496929ea5d25.png)  

- Should be no listening port!

Also, the path of a legit `explorer.exe` should be:

- `\%SYSTEMROOT%\Explorer.exe`, which is defined in Registry `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell`

<br/>


---

## Task 2: Running Processes: Strings and Memory

**Question**

Determine how strings found while doing static analysis can help you with your analysis. What if the malware sample you are working on is obfuscated so the strings cannot be found during a basic search? This is one way of using the process’s memory to help us in our analysis.

Note: There are three experiments to help you understand this task.

<br/>

**Answer**

### Experiment 1

Extract `lab_07_samples.7z`.

Launch `procexp.exe` as Admin and run `Welcome.exe`:

![picture 132](images/2fa54cd5858559ade10c7550c36fccf73fc4f56d2754fecfe60013dd4d82d842.png)  

- Note the strings: `Welcome to:` and `eLearnSecurity MAP`
- Expected these to be seen in the **Strings** tab

<br/>

Go to the **Strings** tab and find the above strings in **Image**:

![picture 133](images/2c5ea845288268e0824c1e14bd0e517fbc903c51f1736be806e51ac75f713bc2.png)  

- Both strings are found

<br/>

Try to search in **Memory**:

![picture 134](images/6136185e858b21d1a4a40ab93e29b890c8224dc60c2f14766984a2efde6b1463.png)  

- Same result

<br/>

### Experiment 2

Launch `notepad.exe` and type `Hello this is lab 7 test`, and then save as `Lab7_Test.txt`.

<br/>

Check the `notepad.exe` process, and go to the **Strings** tab. Search for `Hello` in the Image:

![picture 135](images/71fe3c53385808669bfcb6833112bcd15e86ff9f9e93930d7405243c7b164ec0.png)  

- Not found! This is because it is not part of the `notepad.exe` image file

<br/>

Search for `Hello` in the Memory:

![picture 136](images/7f9ba6feb038959819003fb92ce89a6c1b14c97824ebeafc1d45a24a221a3f1e.png)  

- Still not found!

<br/>

Search for the filename `Lab7_Test.txt` in Memory:

![picture 137](images/c35b5782faf2b1a357792db1cf9735d4e9eefccbb64de2689cf7d859696dc5e1.png)  

- Still not found!

<br/>

Anyway, there is some information which is not part of the image file (EXE) or only available after running he program, then we can search the memory for that information.

Whatever is hidden in the executable itself is exposed in memory if we know where and how to search for it.

Keep in mind that not all strings are searched for this way, but this is just one way of doing things.

<br/>

### Experiment 3

Open `welcome2.exe` and inspecrt in ProcExp. Try to search `eLearn` in the String tab (Image):

![picture 138](images/42d80b0d2572b956f6031d705444399ada60c89f43b08a9c027eee4893b2da75.png)  

- Not found!

<br/>

Try again in memory:

![picture 139](images/c9f7aee12cd497e1043f26c38b6687b7d6a677924289e7f0f9b3eb7eb40e134f.png)  

<br/>

To understand why, check the Section Header of  `Welcome2.exe` in **CFF Explorer**:

![picture 140](images/6f000906a1b11ea5923ea3b6a112f51b0f3e47c6c13dffd86ef3d4516c38d91c.png)  

- As shown, this is a packed executable and that's why we cannot see the strings in the Image
- However, the strings are found in memory - we are able to find the strings and because the program was **unpacked in memory** and now the strings inside are shown in memory.

<br/>

---

## Task 3: Processes and TCP/IP

**Question**

Use `netcat` to run an experiment and determine how the netcat listener on port 9999 can be seen in a process monitoring tool such as process explorer.

Note: There is an experiment that will help you understand this task.

<br/>

**Answer**

Extract `nc111nt.zip` (password is `nc`) and launch `cmd.exe`:

![picture 141](images/c2e58579c3ae63468e2b480383d092cf08e662601e0febed814f971ed1c640d9.png)  

<br/>

Launch `nc.exe` and allow access:

```
nc -nlvp 9999
```

![picture 142](images/c16382c0f37a0016ba7392db1bd017c26db0667e1983d93766fe0dfe60323a75.png)  


<br/>

Check if `nc.exe` is listening on `tcp/9999`:

```
netstat -ant -p tcp
```

![picture 143](images/605ebb5821586d0bd5ccb10727b384f6d9495e8a5cba9d6ef164d29809f7d9fa.png)  

<br/>

Use **ProcExp** to check the **TCP/IP** tab of `nc.exe`:

![picture 144](images/ecd239c325bd2893a622473045b26b78e4af135fd96281c7c6aa5a1f1d3c5dbc.png)  

- Same process status we've seen in `netstat` output

<br/>

Launch another `nc.exe` and try to connect to this listener:

```
nc 192.168.210.10 9999
```

![picture 145](images/9c82e21e23ed9f9ef274181d89ae8aa35ac75678a62d0bcd4a8f56dec27f537f.png)  

- As shown, if a process connects to the listener, the state will be `ESTABLISHED` in the **TCP/IP** tab in the listener

<br/>

---

## Task 4: Working with Windows Sessions

**Questions**

In this task, we want to understand what Windows sessions are and how to interact with them.

Note: There is an experiment that will help you understand this task.

<br/>

**Answer**

Run `cmd.exe` as Admin, and then run `notepad.exe` in the command. Check the process details in **ProcExp** of `notepad.exe`:

![picture 146](images/d598c182dc15c6d94784e8488160d24f5e3b9a8049a49cd08946f75d6c028d97.png)  

![picture 147](images/d7c63bd516a5db7fc0ea3e98c20d5bf92f1c91a4019773502137a86045569cf4.png)  

- `notepad.exe` is running in session 1, which is an interactive session that our uyser can interact with

<br/>

Try to run `notepad.exe` using `psexec.exe`:

```
cd C:\Tools\SysinternalsSuite
PsExec.exe -s notepad.exe
```

Note:
`-s`: Run the remote process in the System account.

![picture 148](images/431de25be5c420485c8f0aba717ffc1bae466d4a0ca6c4677ad873d5b4afd673.png)  

- Though a process of `notepad.exe` is running (whose parent is `PSEXESVC.EXE`), it is not shown in the user-end.

<br/>

In `ProcExp`, check the security tab of the `notepad.exe` process:

![picture 149](images/8e3302e0e85d5420be83dfe6516691ee3f9b19ee2498b6161107858e94a48bb2.png)  

- The User is `SYSTEM`
- The SID is `S-1-5-18`
- The Session number is `0`
  - We can’t interact with processes running in session 0 directly
  - Processes in session 0 will not be visual to us, since they are running in another environment which is isolated

<br/>

Try to execute the following command using PsExec:

```
PsExec.exe -i -s notepad.exe
```

Note:
`-i`: Run the program so that it interacts with the desktop of the specified session on the remote system. If no session is specified the process runs in the console session. This flag is required when attempting to run console applications interactively (with redirected standard IO).

![picture 150](images/d049bbd6f64a414e7cfd6ab6f6952750560a4db11d2490b852856da42bd5a327.png)  

- Notepad.exe GUI is shown

![picture 151](images/04505d1a760c635fcc3db5c0b1963a16a07dc98d9710e0703ef07eb73b78177b.png)  

- It is in Session `1` but not `0`
- It is a child of `service.exe\PSEXESVC.exe` but not explorer.exe

<br/>

---