# 04 - Packed Malware Identification and Basic Analysis

- [04 - Packed Malware Identification and Basic Analysis](#04---packed-malware-identification-and-basic-analysis)
  - [Scenario](#scenario)
  - [Tools](#tools)
  - [Task 1: Packer Identification](#task-1-packer-identification)
    - [Using CFF Explorer](#using-cff-explorer)
    - [Using Exeinfo PE](#using-exeinfo-pe)
    - [Using PEStudio](#using-pestudio)
    - [Using Detect It Easy (DiE)](#using-detect-it-easy-die)
  - [Task 2: String Extractions - Part 1](#task-2-string-extractions---part-1)
    - [Using BinText](#using-bintext)
    - [Using PEStudio](#using-pestudio-1)
  - [Task 3: PE File Anaylsis - Part 1](#task-3-pe-file-anaylsis---part-1)
    - [PE Studio](#pe-studio)
  - [Task 4: Resource Analysis](#task-4-resource-analysis)
    - [Using Resource Hacker](#using-resource-hacker)
  - [Task 5: Unpacking](#task-5-unpacking)
    - [GUI - CFF Explorer](#gui---cff-explorer)
    - [CLI - UPX.exe](#cli---upxexe)
  - [Task 6: String Extractions - Part 2](#task-6-string-extractions---part-2)
    - [PEStudio](#pestudio)
  - [Task 7: PE Analysis - Part 2](#task-7-pe-analysis---part-2)
    - [PE Studio](#pe-studio-1)

---

## Scenario

You have been called by a client to examine a couple of samples that their IR team has collected from different locations within their network.

The samples for this lab are in `Lab_04.zip` (password = `infected`)

<br/>

**Goals**

The goals of this lab are to understand what a packed executable is, how some can be unpacked using basic techniques, and why sometimes you will need different analysis approaches for analyzing packed samples.

You will learn how to identify packed samples, unpack them, and continue your analysis. You will also learn when further analysis is required.

<br/>

192.168.210.10 / AdminELS / Nu3pmkfyX

<br/>



---

## Tools

| Tools | Usage |
| --- | --- |
| BinText | Inspect ASCII / Unicode strings in the binary |
| Strings | Inspect ASCII strings | 
| Bstrings | Inspect ASCII strings (Windows) |
| FLOSS | |
| PEiD | | 
| Detect it Easy (DiE) | | 
| Exeinfo PE | | 
| pestudio | |
| CFF Explorer | | 
| Resource Hacker | |
| UPX | |

<br/>

---

## Task 1: Packer Identification

**Question**

Identify whether or not the file is packed and, if so, what type of packer is being used.

<br/>

**Answer**

### Using CFF Explorer

First examine the file `Lab3_1.exe` and inspect its **Section Headers** using **CFF Explorer**:

![picture 90](images/8dcfc88c91296c598e83b39091df6e0fe1c7df6f683efb5fd9a441e226dfbf4f.png)  

- The sections naming is different from a typical PE 
- **UPX0** has a raw size of `0`, which is a hint of the usage of packing

Also check the **Characteristics** flags:

![picture 91](images/312e27e96226a0fb116dc0242e902d2a1b37a835aadd7f6914b3387876877371.png)  

- It is writable
- It contains uninitialized data, which are all flags that packers will use

<br/>

### Using Exeinfo PE

Open `Lab3_1.exe` in **ExeinfoPE.exe**:

![picture 92](images/9bc2b69917cbd9d59cc8d962fd230a455045612f3608deb5959eb821692e891b.png)  

- `UPX 0.89 - 3.xx -> Markus & Laszlo ver. [ 3.95 ] <- from file. ( sign like UPX packer ) `
- The PE is packed by **UPX packer**

<br/>

### Using PEStudio

Open `Lab3_1.exe` in **PEStudio**:

![picture 93](images/6ae29a6cf3340c689beba7630fffba7284b18b1a891cebc37a1a61d1e11884e2.png)  

- The signature shows `UPX -> www.upx.sourceforge.net`

![picture 94](images/f09a62b31584e011d15cfa39c418fde7105319bb46e12d66850922fe76ff21bf.png)  

<br/>

### Using Detect It Easy (DiE)

Open `Lab3_1.exe` in **DiE**:

![picture 96](images/0d441a54dba4a70b4684265516cba64becb453aa619967a6aedc42a6ee08eca3.png)  

- The executable is packed with **UPX (3.95)**

<br/>

Clicking the `S` in the section, it shows the signature:

![picture 97](images/3d9bb985758b3af4d58130f8ea81103061417b9634e6254e04dc642b822d5740.png)  

![picture 98](images/ee01376c605fee12a33f4b4f42a3e66bd0b6b3c6d8796875b9a489c93b09afe4.png)  

<br/>

Also check the Entropy:

![picture 99](images/1ebf423cb90d363963e010528e606706b1f60c058c4569d5972c3697798d24a9.png)  

![picture 100](images/90ae8763fad12942baa8f708977cb7624d78748b6b8c508de6c1e571731d95a0.png)  


| Section | Entropy | Verdict |
| --- | --- | --- |
| PE Header | 2.76 | Normal |
| Section0 | 0 | Suspicious |
| Section1 | 7.91527 | Indicator of scrambled / compressed / packed |
| Section2 | 5.57075 | Normal |

- The analysis of DiE shows the entropy to be `7.32639`, which is likely a packed PE

<br/>

---

## Task 2: String Extractions - Part 1

**Question**

Use the string extraction techniques you learned to extract as many strings as you can to help you understand the sampleâ€™s capabilities.

<br/>

**Answer**

### Using BinText

Scan the file using **BinText**:

![picture 101](images/ee567e4bcdce5013fa294b59f00aadd7ba5c14128c195fc0cf6f2038d13bf358.png)  

- Company Name: `OPTSoft`
- File Description: `Performs NTFS file system optimization`
- Internal Name: `fsopti.exe`
- Original Filename: `FSOptimizer.exe`
- Product Name: `File System Optimizer`
- Version: `1.0.0.1`

<br/>

### Using PEStudio

Open `lab3_1.exe` in PEStudio and inspect the **Strings** section:

![picture 102](images/79bf16adf9b54084f4f41a6494055ab91ba0a2a9ed256677a83955d37bd05f72.png)  

- `blacklist` means the stings are known to be used by malware
- `hint` means notable / suspicious

<br/>

Checking the **Verison** section:

![picture 103](images/09962017e904455372f2f55da117852b3048de13af2704bae76f943b4d22f70b.png)  

- The language `Russian` is highly suspicious since it does match the context of the company
- The filename `FSOptimizer.exe` is not a known software

![picture 106](images/e91fb514e3684af29f79cfdee50424ce1adc8892b2ecd399c54fc412e302f519.png)  

<br/>

Checking the **Imports** section:

![picture 104](images/49598a60a5802e480dc3bb522eb98ac95c8d8e689af9bba1003308c68f35291f.png)  

- `VirtualProtect` changes the protection on a region of committed pages in the virtual address space of the calling process; this change the memory region, for example, from RW(`rw-`) to RX(`r-x`) so the sample can execute code from that memory region
- `LoadLibraryA` loads the specified module into the address space of the calling process; since the PE is packed, it is likely that it uses this import to load a library that it needs to call some functions
- `GetProcAddress` retrieves the address of an exported function or variable from the specified DLL; after loading the library, this module help call functions required from within the library

<br/>

Checking the **Libraries** section:

![picture 105](images/735ccac46b38c5d1844e491ce170c9301bdce7c9727a82a7765711ae7621dfca.png)  

- wsock32.dll
- kernel32.dll
- user32.dll

<br/>

---

## Task 3: PE File Anaylsis - Part 1

**Question**

Use the PE file analysis skills you learned to do first attempt of analysis on the sample.

<br/>

**Answer**

### PE Studio

Open the sample `lab3_1.exe` in PEStudio and check the **indicators** section:

![picture 107](images/a5d8b78d2f346d713419817f910c709bf51d1bb23a46e28cff245d6e1a013210.png)  

- The highlighted indicators refer to UPX information
- There are 2 writable and executable sections - those are probably where the new libararies or other malicious will be loaded `written` and then executed

<br/>

Check the **sections**:

![picture 108](images/2fc69021e7c8431658772305c1e2627050bf896ae1f3398a9644d98f060ae7d4.png)  

- The `EntryPoint` is the **UPX1** section, which is probably to start the unpacking process

<br/>

Checking the **imports**:

![picture 109](images/cf177e989305d879eb454be05758b15c063ad261a3eedc374c96a32283315f70.png)  

- 6 functions are referenced, where 5 are referenced by name and 1 is referenced by ordinal number
- It shows 2 blacklist import modules - `115 (WSAStartup)` and `VirtualProtect`
- `115 (WSAStartup)` indicates the mapping by PEStudio and translated the ordinal number `115` to the referenced name `WSAStartup`

<br/>

---

## Task 4: Resource Analysis

**Question**

Check whether or not the resource section is packed and analyze it.

<br/>

**Answer**

### Using Resource Hacker

Load the executable into **Resource Hacker**:

![picture 110](images/256ef7d297d3f67a9fa729b7dce9047a3e878041d5a075dfb49d25538fc017d9.png)  

- `FSOPTI: 0` shows all the icons used by the program

<br/>

Check the **Version Info** section:

![picture 111](images/f5a27f69204472a6fbdaad69afacb3cbd90ce08ca03db83f1cc988909e23ac01.png)  

- Again this shows the metadata of the file, which is also seen in the String analysis
- The program name is not a well-known one, which is suspicious

<br/>

Check the **Manifest** section:

![picture 112](images/8540d25de242ff926224f5447447a672d4345621c24b7da11ec09071c486f9fe.png)  


- `<requestedExecutionLevel level='asInvoker' uiAccess='false' />`
- `asInvoker` = Not requiring Administrator privilege to execute

<br/>

---

## Task 5: Unpacking

**Question**

Try to unpack the given sample.

<br/>

**Answer**

### GUI - CFF Explorer

Load the sample `lab3_1.exe` into **CFF Explorer** and go to **UPX Utility**:

![picture 113](images/36ad5dbb118c27a3c493d66774113fbced6238253987fb19d4e374bc32b264e9.png)  

- Click `Unpack`

<br/>

![picture 114](images/5996437f48df05a0fd263e5321ab27fa44b6d2c2d96e20462369e6927f876b99.png)  

<br/>

Inspect the **Section Headers**:

![picture 115](images/cfa6eda3ec74392fe0e45948176a7e4dba918e0f243da577369ddf108c20b7b7.png)  

- As shown, the orginal sections of the PE are shown

<br/>

![picture 116](images/4c7836e21d021e57f66d0068b2da18f7707b37bd71e91b1c009653f2533f0508.png)  

- Save the unpacked PE as `Lab3_1_unpacked.exe`

![picture 117](images/9544b62c9f67ff77a4bf957a114f7f2725f00a4499a10c066e177ba5be8f78a5.png)  

<br/>

### CLI - UPX.exe

Download **upx.exe** from https://github.com/upx/upx/releases/tag/v3.96.

```
upx.exe --help
```

![picture 118](images/7f8ab41b8d83f6b586f928c5ee1576396f998843554cf0fbaa6ae5a9e2113de3.png)  

- To decompress, use the `-d` switch
- To write output, use the `-o` switch

```
upx.exe -d C:\Users\AdminELS\Desktop\Lab_04_Samples\Lab3_1.exe -o C:\Users\AdminELS\Desktop\Lab_04_Samples\Lab3_1_unpacked_upx.exe
```

![picture 119](images/9219070e4d9eafc943cf0865ea91ffdf386846867b7a8d177cddd15a95882046.png)  

<br/>

Load the unpacked sample into **CFF Explorer** and check the **sections header**:

![picture 120](images/e51bb4ef202492acc36802a71cfa27a947b90a8b8f71a0580c5f65815e202731.png)  

- As shown, the PE has been unpacked and the original sections are shown

<br/>

---

## Task 6: String Extractions - Part 2

**Question**

After you were able to unpack the sample, do a second attempt of string extraction and see if you got anything different this time.

<br/>

**Answer**

### PEStudio

Inspect the strings using **PEStudio**:

![picture 121](images/4a3d89f80df5fd7a9d76115fc845d55a463128dc6796b5db66de46d05e5e5d0a.png)  

- Some network related strings are found

<br/>

---

## Task 7: PE Analysis - Part 2

**Questions**

This is a second attempt of analyze the PE file after you were able to unpack the sample. See if you find anything different this time.

<br/>

**Answer**

### PE Studio

Again use **PE Studio** to check the indicators on the unpacked sample:

![picture 122](images/413772487ff07ddaa4ba746745cb4ea3234ccd0c40bd3a9ccc572871a52fdd6c.png)  

<br/>

Check the **Imported Libraries**:

![picture 123](images/337c10095bb2e6c6c075ec1b52d08eb83412c8f3502b2657d0435150a808655a.png)  

- Note the number of functions imported
- `wsock32.dll`: 11 functions (1 when packed)
- `kernel32.dll`: 84 (4 when packed)
- `user32.dll`: 1 (same with packed)

<br/>

Check the **imports** section:

![picture 124](images/e3da2ec0e90412214e44ce9c0229aac8377440950eb6e39a94911e1c438221bf.png)  

- Notable imports:

| name | group | flag |
| --- | --- | --- |
| closesocket | network | anonymous, blacklist |
| select | network | anonymous, blacklist |
| listen | network | anonymous, blacklist |
| bind | network | anonymous, blacklist |
| send | network | anonymous, blacklist |
| socket | network | anonymous, blacklist |
| recv | network | anonymous, blacklist |
| htons | network | anonymous, blacklist |
| WSACleanup | network | anonymous, blacklist |
| accept | network | blacklist |
| WSAStartup | network | blacklist |
| FindNextFileW | file | blacklist |
| FindFirstFileExW | file | blacklist |
| FindClose | file | blacklist |
| CreateProcessW | execution | T1106, blacklist |
| GetExitCodeProcess | execution | blacklist |
| SetEnvironmentVariableW | execution | blacklist |
| GetEnvironmentStringsW | execution | blacklist |
| SwitchToThread | execution | blacklist |
| TerminateProcess | execution | blacklist |
| GetCurrentProcessId | execution | blacklist |
| GetCurrentThreadId | execution | blacklist |
| RaiseException | exception-handling | blacklist |
| GetModuleFileNameW | exception-handling | blacklist |
| GetModuleHandleExW | exception-handling | blacklist |
| SetLastError | diagnostic | blacklist |
| GetConsoleWindow | console | blacklist |
| ReadConsoleW | console | blacklist |

<br/>

---

