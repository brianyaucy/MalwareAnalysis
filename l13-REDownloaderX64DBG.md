# Lab 13 - Debugging 64-bit Downloader using X64DBG

- [Lab 13 - Debugging 64-bit Downloader using X64DBG](#lab-13---debugging-64-bit-downloader-using-x64dbg)
  - [Scenario](#scenario)
  - [Tools](#tools)
  - [Task 1: General Sample Information](#task-1-general-sample-information)
  - [Task 2: Function calls and breakpoints](#task-2-function-calls-and-breakpoints)
  - [Task 3: Running the Downloader](#task-3-running-the-downloader)

---

## Scenario

You have been called by a client to examine a weird sample that was found on one of their developerâ€™s systems. The client thinks this sample could be hiding its true nature of activity.

<br/>

The goal of this lab is to understand how to both debug and reverse engineer a downloader which is widely used by different threat actors.

<br/>

After completing this lab, you will be able to use a disassembler, such as IDA Pro, to reverse engineer a downloader. You will also be able to use a debugger, such as x64dbg, to debug the same downloader and understand what malicious activity is being carried by this downloader.

<br/>

192.168.210.10 / AdminELS / Nu3pmkkfyX

<br/>

---

## Tools

- x64dbg
- IDA Pro
- PEStudio

<br/>

---

## Task 1: General Sample Information

**Question**

Gather general information about the sample using only a debugger.

<br/>

**Answer**

First load (open) the sample into **x64dbg**.

Note:
Attach = Load a running process
Open = Load an Image

![picture 401](images/135d1ad6088f87c7459989a83febee672713929839c8bff014029a095c85b77d.png)  

<br/>

First check the **imported and exported APIs** by navigating to the **Symbols** tab:

![picture 402](images/3e3fa6612a4029f199372c4e5f6c6becd0a8dc9ad338ad5d7351489f44068967.png)  

<br/>

Double clicking `Downloader.exe` on the left will bring us to the disassembly:

![picture 403](images/f66dd2ce3ef50e54783b1a06d634b62f3bd6939aac457e6f006c35619d0ef897.png)  

<br/>

We can search for strings by `Right-click in the disassembly window > Search for > Current Module > String references`:

![picture 404](images/fb13582f3d510cc2c8d4c1bf01881a06aff3edef6483b92048fb90759470008a.png)  


![picture 405](images/d9e41bff31dd2dba435d478ce92f941fe58d5436f91a51c86cebc5f5783c072d.png)  

<br/>

Since the static analysis has been done before, it is skipped in this part. 

---

## Task 2: Function calls and breakpoints

**Question**

This is a malicious sample that was collected, and you need to Figure out what functions are being used and where to place a breakpoint to control the process.

<br/>

**Answer**

The main reason we use a debugger is to **have control of the execution flow** by adding breakpoints.

<br/>

By default, the debugger will stop at either:

- A system entry
- TLS callback
- The program's entrypoint

<br/>

In the **Symbol** tab, the program's entrypoint is highlighted in <red>red</red> (**Address of Entry Point**) - the red highlight mark means that there is a breakpoint at that address location.

![picture 406](images/400efc3b793b047ae386f6b3b02e8271364463b0bab8bc933853fbe447bb1a41.png)  

<br/>

Next, double-click `Downloader.exe` on the left to get back to the disassembly.

Then `right-click in the disassembly window > Search for > Current Module > Intermodular calls`.

![picture 407](images/b90d59d4499de27c41541819edbfab3b6b56cd11e660aae0dacc775ec9dd0c3b.png)  

![picture 408](images/003c95b206843b0388f14ce7259d759a57a999bd1d1f7dc5ac9d7e589b64a5f9.png)  

- New tab titled `Calls`
- Names of the modules are listed in parenthesis on the right
- The first 9 function calls (`ShellExecuteA`, `Sleep`, `URLDownloadToFileA`) are of interest

<br/>

Set breakpoints to the 9 function calls by `right-clicking the function > Toggle Breakpoint` one by one (or you can select the function calls then press `F2`):

![picture 409](images/10b0f0ca99db84593ab9a6b4e19f42a0dd65b8a75a2778654c56b85250c6980e.png)  

<br/>

After that you will see the related addresses highlighted in red:

![picture 410](images/496d0e3e52033270f08bf10f3b9aa876d975d9a83f67727855efc8180768f865.png)  

<br/>

We can also see the breakpoints we have set in the **Breakpoints tab**:

![picture 411](images/1f26c9d69bfadbb51a3fed83d5c5f3fcaa3bf906930d105a1faec8dfac0a428f.png)  

<br/>

After setting the breakpoints, run the program either by:

1. Click the Blue Arrow on the toolbar
2. Press `F9`

Then we should be brought to the **EntryPoint** in the **CPU tab**:

![picture 412](images/57c06660b94431351d380de680c8758ec9d9d2b64db85326c8843350efb35e6a.png)  

![picture 414](images/2898cc24bd96b4cdb43a01f77265ada9a66774bbd816728d32f1d0a5dc371cdb.png)  

- Note the status bar at the bottom shows `Paused`
- It also tells a **software breakpoint** `INT3` is reached at `0x7FF65A1A138C` - the downloader's entrypoint

<br/>

---

## Task 3: Running the Downloader

**Question**

Determine the IOCs that could be created to find and identify this sample on other systems.

<br/>

**Answer**

Continuing Task 2, click on the **Blue Arrow** once again, which brings us to the first function call `ShellExecuteA`:

![picture 415](images/f1f8fcec7959c221d34c1d5904b583fab4d5560fab0f08c9b56c039886c35d7c.png)  

<br/>

Scroll up a few lines to see the instructions before the breakpoint:

![picture 416](images/f3ec7dc40a593228c60e4b5875d51642c03dbfa67cac26a1ce7271352b62575b.png)  

![picture 417](images/ff93334bbe3a961a77f5769853a5588d0853a2cf6e1612af0756822dd355e387.png)  

- `rcx` holds the value `0`
- `rdx` holds the value `open`
- `r8` holds the value `cmd.exe`
- `r9` holds the value `/C bitsadmin.exe /transfer IND1 /.....`

<br/>

---