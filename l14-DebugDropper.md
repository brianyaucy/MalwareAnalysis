# Lab 14 - Debugging a 64-bit Dropper

- [Lab 14 - Debugging a 64-bit Dropper](#lab-14---debugging-a-64-bit-dropper)
  - [Scenario](#scenario)
  - [Tools](#tools)
  - [Task 1: PE and Resource info](#task-1-pe-and-resource-info)
    - [Static Analysis using PEStudio](#static-analysis-using-pestudio)
    - [Static Analysis - Resource Hacker](#static-analysis---resource-hacker)
  - [Task 2: Function calls and Breakpoints](#task-2-function-calls-and-breakpoints)
    - [IDA Pro](#ida-pro)
    - [X64dbg](#x64dbg)
  - [Task 3: Running the Dropper](#task-3-running-the-dropper)
  - [Task 4: Debugging the shellcode](#task-4-debugging-the-shellcode)
  - [Task 5: Explain the Graph Code Blocks](#task-5-explain-the-graph-code-blocks)

---

## Scenario

You’ve been called by a client to examine a sample that was found on one of their developer’s systems. The client thinks this sample could be hiding its true nature of activity.

<br/>

The goal of this lab is to understand how to both debug and reverse engineer a dropper, which is widely used by different threat actors.

<br/>

After completing this lab, you will be able to use a debugger such as x64dbg (and perhaps a disassembler, such as IDA Pro) to debug and reverse engineer a malicious 64-bit Dropper that drops a shellcode from its resource section and executes it. You will learn how to go through the code step-by-step and debug the shellcode to understand its true nature. This also is an excellent lab to learn more about 64-bit assembly and shellcode.

<br/>

192.168.210.10 / AdminELS / Nu3pmkfyX

<br/>

---

## Tools

- x64dbg
- IDA Pro
- PEStudio

<br/>

---

## Task 1: PE and Resource info

**Question**

Gather general information about the sample using different tools (static analysis).

<br/>

**Answer**

### Static Analysis using PEStudio

Load the sample in **PE Studio**.

![picture 440](images/f033375b67ba26f2c09e13c4c0b61c8a1bb190897618eec03b47694e87ee882c.png)  

- MD5: 2d20d19b5ba4239a2d2ea7a09fb1979b
- SHA1: 4e132b88d43e9a135208975dcafc719a0ec22777
- SHA256: 957e6ea1c709265677fa9f5516bf1c077425791125ec77c396f4092b7db2bc32
- 64-bit Console Application
- Windows PE (`4d 5a`)

<br/>

**Indicator**

![picture 441](images/77077d781390287f0a674b8bd1cd1d91d5b099de47fdeb2c0d4c02d956bf127d.png)  

<br/>

**File header**

![picture 442](images/a0fa4bcda00ea311a5a62bc1c325ef7a332d94c9aaf893b42bab0b6b39f417d2.png)  

- Potential compiled time: 29 March 2020 04:04:59 UTC

<br/>

**Sections**

![picture 443](images/2583f4ec115cef7cd24f8286205c32ae18c83af334e14945cfc7247467270912.png)  

- Standard non-packed header names

<br/>

**Strings**

![picture 444](images/ccce5fecc1604556445b4aecfd9ad2daecdb2c88a295b87759c5478fe6fc0835.png)  

- `0x1C3A` - `GetCurentProcessId`
- `0x1C50` - `GetCurrentThreadId`
- `0x1C96` - `RtlCaptureContext`
- `0x1CAA` - `RtlLookupFunctionEntry`

<br/>

**Imports**

![picture 445](images/e5f0c4e5e9acf0543d71ebc36e199b289c1d61fa7d519de2b7dfb543f38e1c4d.png)  

- Similar to **Strings**
- Imports from `kernel32.dll`

<br/>

**Manifest**

![picture 446](images/e693d3389cd27338bc253708c85f7183a26e8f5b3d7a0106079eff39d53f0f60.png)  

- Does not require Admin privilege

<br/>

**Resources**

![picture 447](images/e3f5f5673790be2f3efabc5632f23699750c213c9b39c1a0d724cc1eeaffcc77.png)  

- Non standard resource

<br/>

### Static Analysis - Resource Hacker

Load the sample in **Resource Hacker**.

Check the `IMG` folder:

![picture 448](images/9484aed50deccd395ca227351b1c1b6b758f2f2e4032043cc4c82324bd1a753f.png)  

- Doesn't look like an image!

<br/>

Next try to export this as a binary data:

![picture 449](images/9eccfc2b0b1d31ba9273aa7589a279df5c67c7bb205611c52fa3aed52d6191f6.png)  

![picture 450](images/96e0f0c03b52e4116ece816d8868cd5ce1ce14ac49e63ed2e28ed5ed5bc5d931.png)  

<br/>

Get the file hash of the output file using **PowerShell**:

```
Get-FileHash -Algorithm MD5 .\IMG101.bin
```

![picture 451](images/8cbdd3f8ffb72734a5f1c737381782485053fabfe5fbe24e6fb92081aaa47c8b.png)  

- MD5: EABB4194819818CF0F712D02EA00100E

<br/>

Check this hash on VirusTotal:

- https://www.virustotal.com/gui/file/94752fe0d2e88045ff9e6276c519d82bae098bc6a33273b36a447f97435f0c84/details

![picture 452](images/32f6fd923547c7c4342d539f43f8ee26922b67ddfe7cddc4458ecc03b30ce436.png)  

- 15/55 detection
- Suspicious finding

<br/>

---

## Task 2: Function calls and Breakpoints

**Question**

This is a malicious sample that was collected, and you need to figure out what functions are being used and where to place a breakpoint to control the process.

<br/>

**Answer**

### IDA Pro

Run **IDA Pro 64-bit** as admin, and load the sample. It brings us to the main function disassembly:

![picture 453](images/a796415f5f8dec6268f2fac05205ef11481b29bade0d4e92e94f10ad44e120bd.png)  

1. `FindResourceA` is called
2. `SizeofResource` is called
3. `LoadResource` is called
4. `VirutalAlloc` is called
5. `memcpy` is called
6. `rbx` is called <---- Interesting

<br/>

### X64dbg

Load the sample into **x64dbg**:

![picture 454](images/ec6a1af84d29fd23d70ac265a6c8d320a9f7f029d6ab654713f998a395eae36f.png)  

<br/>

Go to the **Symobol tab** and click `dropme.exe` on the left:

![picture 455](images/2cc970dc22a110acde77162e48092e3a7daef74f2432fd944cd1204ba523daa9.png)  

- Here are the imports and exports of the sample

<br/>




<br/>

---

## Task 3: Running the Dropper

**Question**

Use a debugger to run the dropper and understand what it’s doing.

<br/>

**Answer**





<br/>

---

## Task 4: Debugging the shellcode

**Question**

Use a debugger to trace through the shellcode step-by-step and understand its true nature.

<br/>

**Answer**





<br/>

---

## Task 5: Explain the Graph Code Blocks

**Question**

Generate a graph for the shellcode and explain its blocks. This is a DIY exercise.

<br/>

**Answer**





<br/>

---